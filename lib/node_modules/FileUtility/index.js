!function(){"use strict";function n(n,e,r){var o={},i=function(n,e){return g.isEmpty(n)||g.contains(n,e)},t=g.once(function(n){var e=g.chain(o).mapObject(function(n){return n.getData()}).value();r(w(n),n?void 0:e)});v.open(n,{lazyEntries:!0,autoClose:!0},function(n,r){n&&t(n);var c=function(n){t=g.partial(t,n),r.close()};r.once("close",function(){t()}),r.on("error",function(n){c(n)}),r.readEntry(),r.on("entry",function(n){var t=n.fileName;i(e,t)?(o[t]=new F.ConcatStream,r.openReadStream(n,function(n,e){return n?void c(n):(e.pipe(o[t]),void e.on("end",function(){r.readEntry()}))})):r.readEntry()})})}function e(n,e,r,o){return g.isFunction(o)||(o=r,r={}),E.extractZipToLocation(v,m,a,n,e,r,o)}function r(n,e,r){r||(r=e,e=a),P({times:10,interval:1e3},g.partial(q,n,e),r)}function o(n,e,r){r||(r=e,e=a),P({times:10,interval:1e3},g.partial(C,n,e),r)}function i(n,e,r,o){o||(o=r,r=f.basename(e)),t(e,r,n,function(n,e){return n?(console.log(n),void o(n)):void o(n,e)})}function t(n,e,r,o){a.readdir(n,function(i,c){return i?void o(i):void p.eachSeries(c,function(o,i){var c=f.join(n,o);a.stat(c,function(n,u){return n?void i(n):void("."===o||".."===o?i():u.isDirectory()?t(c,f.join(e,o),r,function(n){i(n)}):r.entry(a.createReadStream(c),{name:f.join(e,o)},function(n){i(n)}))})},function(n){o(n,r)})})}function c(n,e,r){r=g.once(r);var o=new h;o.on("error",function(n){r(n)});var i=a.createWriteStream(e).on("error",function(n){r(n)}).on("finish",function(){r()});o.pipe(i),p.eachSeries(n,function(n,e){var r,i;g.isString(n)?(r=a.createReadStream(n).on("error",e),i=f.basename(n)):(r=n.data,i=n.name),e=g.once(e),o.entry(r,{name:i},function(n){e(n)})},function(n){n&&r(n),o.finalize()})}var a=require("fs"),u=require("zlib"),f=require("path"),s=require("stream"),l=require("events"),d=(require("util"),require("unzip2").Parse),v=require("yauzl"),p=require("async"),m=require("mkdirp"),g=require("underscore"),y=require("uuid"),h=require("zip-stream"),x=require("Environment"),S=require("FileDecryptionUtility"),b=require("./CountingStream"),F=require("StreamUtility"),E=require("./extractZipToLocation.js"),k=function(n,e,r){g.isUndefined(r)&&(r=e,e=void 0),r=g.once(r);var o={},i=a.createReadStream(n);i.on("error",function(n){r(n)}).pipe(d()).on("entry",function(n){var r=n.path;if(!e||g.contains(e,r)){var i=new F.ConcatStream;i.on("finish",function(){o[r]=i.getData()}),n.pipe(i)}else n.autodrain()}).on("error",function(n){i.close(),r(n)}).on("close",function(){r(void 0,o)})},w=function(n){return g.defaults(n,{info:"extractFileFail"})},q=function(n,e,r){var o=function(r,i){e.readdir(r,function(t,c){return t&&"ENOTDIR"===t.code?void e.unlink(r,function(n){i(n)}):t&&"ENOENT"==t.code?void i():t?void i(t):void p.eachSeries(c,function(n,i){var t=f.join(r,n);e.stat(t,function(r,c){return r?void i(r):void("."===n||".."===n?i():c.isDirectory()?o(t,function(n){i(n)}):e.unlink(t,function(n){i(n)}))})},function(o){return o?void i(o):r!==n?void e.rmdir(r,function(n){i(n)}):void i()})})};o(n,function(n){r(n)})},P=function(n,e,r){var o=1,i=function(){e(function(e){e&&o++<n.times?setTimeout(i,n.interval):r.apply(null,arguments)})};i()},C=function(n,e,r){q(n,e,function(o){return o?void r(o):void e.rmdir(n,function(n){return n&&"ENOENT"===n.code?void r():void r(n)})})},D=function(n,e,r){g.isObject(n)&&(n=g.map(n,function(n,e){return{data:n,name:e}})),c(n,e,r)},R=function(n,e,r,o){void 0===o&&(o=r,r={}),o=g.once(o);var i=g.defaults({},r,{allowPartial:!1,progressCallback:void 0}),t=new l.EventEmitter,c={cancel:!1},u={cancel:function(){c.cancel=!0,t.emit("cancel")}};return p.waterfall([function(n){if(i.allowPartial){var r=e+".part";a.stat(r,function(e,o){e?n(void 0,r,0):n(void 0,r,o.size)})}else n(void 0,e,0)},function(e,r,o){var t=a.createReadStream(n,{start:r});if(!t)return void o(new Error("unable to open file for reading"));var c=function(n){o(n)};t.on("error",c),t.once("open",function(){t.removeListener("error",c),a.open(e,i.allowPartial?"a":"w",function(n,i){if(n)return o(new Error("unable to open file for writing")),void t.close();var c=a.createWriteStream(e,{fd:i});o(void 0,t,c,e,r)})})},function(r,o,u,f,l){l=g.once(l);var d=void 0,v=!1;o.once("finish",function(){v=!0,i.allowPartial||l(void 0,"finished")});var p=function(){v||a.unlink(e,function(){l(d,d?void 0:"canceled")})},m=function(n){d=n};i.allowPartial?o.once("close",function(){v?a.rename(u,e,function(n){l(n||d,"finished")}):d&&l(d)}):o.once("close",p),o.once("error",m),r.once("error",m),o.once("error",function(n){r.close()}),r.once("error",function(n){o.close()});var y=new s.PassThrough,h=function(){var n=function(){v||(r.unpipe(y),r.close(),o.close(),g.defer(function(){l(void 0,"canceled")}))};return c.cancel?void n():(t.once("cancel",n),void r.pipe(y).pipe(o))};i.progressCallback?a.stat(n,function(n,e){n?(r.close(),o.close(),l(n)):(y=new b({initialProgress:f}),y.on("progress",function(n){i.progressCallback(n,e.size)}),h())}):h()}],function(n,e){o(n,e)}),u},T=function(n,e,r,o){void 0===o&&(o=r,r={});var i=g.defaults({},r,{progressCallback:void 0}),t={cancel:function(){}},c=i.progressCallback?function(n,e,r,o){i.progressCallback(n+r/o,e)}:void 0;return a.readdir(n,function(r,t){return r?void o(r):void p.map(t,function(r,o){var i=f.join(n,r),t=f.join(e,r);a.stat(i,function(n,e){var r=e&&e.isDirectory();o(n,{isDirectory:r,sourcePath:i,destPath:t})})},function(n,r){n?o(n):p.series([function(n){m(e,function(e){n(e&&"EEXIST"===e.code?void 0:e)})},function(n){var e=0;p.eachSeries(r,function(n,o){n.isDirectory?T(n.sourcePath,n.destPath,{progressCallback:c&&c.bind(void 0,e,r.length)},function(n,t){i.progressCallback&&i.progressCallback(e+=1,r.length),o(n)}):R(n.sourcePath,n.destPath,{progressCallback:c&&c.bind(void 0,e,r.length),allowPartial:!1},function(n,t){i.progressCallback&&i.progressCallback(e+=1,r.length),o(n)})},function(e){n(e)})}],function(n){o(n,"finished")})})}),t},z=function(n,e){a.readFile(n,{encoding:null},function(n,r){u.gunzip(r,function(o,i){e(n,i||r)})})},j=function(n,e,r){r=g.once(r),S.decryptAndDecompressFile(n,e,function(o,i){var t=i?a.createReadStream(n):o;t.on("error",function(o){"Z_DATA_ERROR"!==o.code||e?r(o,null):j(n,!0,r)});var c=[];t.on("data",function(n){c.push(n)}),t.on("end",function(){var n=g.reduce(c,function(n,e){return n+e.length},0);r(void 0,Buffer.concat(c,n))})})},N=function(n,e,r){r=g.once(r);try{n=f.normalize(n)}catch(n){return void r(n)}a.exists(n,function(o){if(o)j(n,!1,function(n,e){r(n,e)});else{var i=e.getFileStream(n);if(!i)return void r(new Error("File Not Found."));var t=f.join(x.temporaryUnTarPath,y()),c=a.createWriteStream(t).on("error",function(n){a.unlink(t,function(e){r(n)})});i.on("error",function(n){c.close(),a.unlink(t,function(e){r(n)})}),i.pipe(c).on("finish",function(){j(t,!1,function(n,e){return n?void r(n):void a.unlink(t,function(n){r(null,e)})})})}})},B=function(n,e,r){r=g.once(r);try{n=f.normalize(n)}catch(n){return void r(n)}a.exists(n,function(o){if(o)r(void 0,a.createReadStream(n));else{var i=e.getFileStream(n);if(!i)return void r(new Error("File Not Found."));r(void 0,i)}})},O=function(n,e,r){a.exists(n,function(o){r(void 0,o||e.exists(n))})},Z=function(n,e){return e?n.replace(/[/\*\?"<>|+,]/g,""):n.replace(/[/\*\?"<>|+,\\:]/g,"")},I=function(n){return n/1024},L=function(n){return function(){return a.createReadStream(n)}};exports.getFileReadStreamGenerator=L,exports.extractZipToLocation=e,exports.extractZipToBuffers=n,exports.getFileBuffersFromZip=k,exports.clearDirectory=r,exports.deleteDirectoryOrFile=o,exports.compressDirectory=i,exports.compressFiles=c,exports.compressBuffers=D,exports.copyDirectory=T,exports.copySingleFile=R,exports.readPossiblyGzippedFile=z,exports.readPossiblyEncryptedFile=j,exports.getFileBuffer=N,exports.getFileStreamWithoutDecrypting=B,exports.checkIfExists=O,exports.removeInvalidFileNameChars=Z,exports.convertBytesToKiloBytes=I,exports.retry=P}();