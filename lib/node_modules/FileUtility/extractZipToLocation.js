"use strict";var _=require("underscore"),events=require("events"),async=require("async"),path=require("path"),stream=require("stream"),CountingStream=require("./CountingStream"),getExtractionError=function(e){return _.defaults(e,{info:"extractFileFail"})},isDirectory=function(e){return/\/$/.test(e)},processEntry=function(e,n,r,t,o,i,c,a,u,s){var f=n.fileName;isDirectory(f)?a(path.join(r,f),function(e){s(e)}):e.openReadStream(n,function(e,n){return e?void s(getExtractionError(e)):void a(path.join(r,path.dirname(f)),function(e){if(e)return void s(e);var a;c?(a=new CountingStream({initialProgress:i}),a.on("progress",c)):a=new stream.PassThrough;var l=u.createWriteStream(path.join(r,f));l.on("error",function(e){s(e)});var p=function(){n.unpipe(a),l.close(),_.defer(function(){s()})};return t.cancel?void s():(o.once("cancel",p),void n.pipe(a).pipe(l).on("close",function(){o.removeListener("cancel",p),s()}))})})};module.exports.extractZipToLocation=function(e,n,r,t,o,i,c){var a=_.once(c),u=new events.EventEmitter,s={cancel:!1},f={cancel:function(){s.cancel=!0,u.emit("cancel")}},l=[];return e.open(t,{lazyEntries:!0,autoClose:!1},function(e,t){if(s.cancel)return void a();if(e)return void c(getExtractionError(e));var f=function(e){a(e,l),t.close()};t.once("close",function(){a(null,l)}),t.on("error",function(e){a(getExtractionError(e))});var p=[],v=0,d=0;t.once("end",function(){return s.cancel?void f():void async.eachSeries(p,function(e,c){if(s.cancel)return void _.defer(function(){c()});var a;if(i.progressCallback){var f=_.throttle(function(){i.progressCallback(d,v)},300);a=function(e){d=e,f()}}l.push(e.fileName),processEntry(t,e,o,s,u,d,a,n,r,c)},function(e){f(e)})}),t.on("entry",function(e){v+=e.uncompressedSize,p.push(e),t.readEntry()}),t.readEntry()}),f},module.exports._processEntry=processEntry;