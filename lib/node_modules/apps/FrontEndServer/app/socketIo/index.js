"use strict";var io=require("socket.io"),_=require("underscore"),protocol=require("Protocol");module.exports=function(e,n){var o,t={},i={},c=[],a={};n.on(protocol.addNamespace,function(e){c.push(e)}),n.on(protocol.socketIoEvent,function(e){var n=e.namespace,o=e.id;a[n]&&a[n][o]&&a[n][o].emit(e.event,e.data)}),n.on(protocol.broadcast,function(e){if(o){var t=e.namespace,c=e.event,a=e.data;if(t){if(i[t])return void i[t].emit(c,a);n.warn("Attempting to send a message to an unregistered namespace")}else o.emit(c,a)}}),n.on(protocol.send,function(e){if(!o)return void n.warn("Attempting to send message before socket io has initialized.");var i="/#"+e.id,c=e.namespace,r=c+"#"+e.id,s=e.event,d=e.data,u=a[c]&&a[c][r]||t[i];u?u.emit(s,d):n.warn("Attempting to send message to an unknown client")}),n.on("start",function(){o=new io(e),o.set("transports",["polling"]),_.each(c,function(e){i[e]||(i[e]=o.of(e),a[e]||(a[e]={}),i[e].on("connection",function(o){a[e][o.id]=o,n.broadcast(protocol.connected,{namespace:e,id:o.id}),o.on("disconnect",function(){n.broadcast(protocol.disconnected,{id:o.id}),delete a[e][o.id]})}))}),o.on("connection",function(e){t[e.id]=e,e.on("disconnect",function(){delete t[e.id]})})})};