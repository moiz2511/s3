"use strict";var express=require("express"),async=require("async"),_=require("underscore"),setup=function(e,s){var r=s.services.offlineServices;r.post("/box/services/login",express.json(),function(r,o){var n=r.body.user;return n?void s.dataManagerClient.getUserObject(n,function(i,d){if(i||!d)return void o.send(401);var t=function(s){r.session.regenerate(function(){r.session.user=d.userId,r.session.acceptedEula=!1,e.info("Added user to session "+r.sessionID),o.send(s)})};s.dataManagerClient.getUserAuthorizedModules(n,function(e,r){return e||0===r.length?void o.send(403):void async.parallel({possibleUserModels:function(e){s.dataManagerClient.getPossibleModelGuidsForUser(d.userId,e)},allowedUserModels:function(e){s.dataManagerClient.getModelGuidsForUser(d.userId,e)}},function(e,s){return!e&&_.isArray(s.allowedUserModels)&&_.isArray(s.possibleUserModels)?void(_.isEmpty(s.allowedUserModels)?o.send(451):t(s.allowedUserModels.length===s.possibleUserModels.length?200:206)):void o.send(451)})})}):void o.send(400)}),r.get("/SAWeb/services/logout",function(e,s){e.session.destroy(function(){s.redirect(e.query&&e.query.TARGET||"/")})}),r.post("/SAWeb/services/acceptEula",function(s,r){return s.session.user?(e.info("Accepted EULA for session "+s.sessionID),s.session.acceptedEula=!0,void r.send(200)):void r.send(403)})};module.exports=setup;