"use strict";var environment=require("Environment"),fs=require("fs"),express=require("express"),winreg=require("Winreg"),middleware=require("../middleware"),setup=function(e,n){var r,i,o,s,t,l,a=n.services.noSessionServices,c=function(){var n=new winreg({hive:winreg.HKLM,key:s}),a=new winreg({hive:winreg.HKLM,key:t}),c=new winreg({hive:winreg.HKLM,key:l});n.values(function(n,i){if(n)e.error("ERROR while fetching Installer version ",n);else for(var o=0;o<i.length;o++)if("DisplayVersion"===i[o].name){r=i[o].value;break}}),a.values(function(n,r){if(n)e.error("ERROR while fetching CAL version ",n);else for(var o=0;o<r.length;o++)if("DisplayVersion"===r[o].name){i=r[o].value;break}}),c.values(function(n,r){if(n)e.error("ERROR while fetching XVDS version ",n);else for(var i=0;i<r.length;i++)if("DisplayVersion"===r[i].name){o=r[i].value;break}})},d=new winreg({hive:winreg.HKLM,key:"\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Environment"});d.values(function(n,r){if(n)e.error("ERROR while fetching Architecture version ",n);else for(var i=0;i<r.length;i++)if("PROCESSOR_ARCHITECTURE"===r[i].name){"AMD64"===r[i].value.toUpperCase()?(s="\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{CA1A1797-B483-452D-BC0A-8D5EB57A386D}",t="\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{510414A2-0F14-4DB8-BDF2-C98A6E1D1367}",l="\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{5DE5512A-6F6F-43FB-82C6-9A523E3AC771}",c()):"X86"===r[i].value.toUpperCase()&&(s="\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{CA1A1797-B483-452D-BC0A-8D5EB57A386D}",t="\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{510414A2-0F14-4DB8-BDF2-C98A6E1D1367}",l="\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{5DE5512A-6F6F-43FB-82C6-9A523E3AC771}",c());break}}),a.use("/license/node_modules",function(e,n){var r="./node_modules"+decodeURIComponent(e.path).replace(/\//g,"\\");n.set("Content-Type","text/html"),n.sendfile(r)}),a.use("/license/application/lib",function(e,n){var r="./lib"+decodeURIComponent(e.path).replace(/\//g,"\\");n.set("Content-Type","text/html"),n.sendfile(r)}),a.use("/license/program",function(e,n){var r=process.env.ProgramFiles+decodeURIComponent(e.path).replace(/\//g,"\\");n.set("Content-Type","text/html"),r=decodeURI(r),n.sendfile(r)}),a.use("/license/custom",function(e,n){var r="./static/licenses"+decodeURIComponent(e.path).replace(/\//g,"\\");r=decodeURI(r),n.set("Content-Type","text/html"),n.sendfile(r)}),a.use("/getLicenseInfo",middleware.addCorsHeaders()),a.use("/getLicenseInfo",function(e,n){var r="./static/licenses"+decodeURIComponent(e.path).replace(/\//g,"\\");n.set("Content-Type","application/json"),n.sendfile(r)}),a.use("/getComponentsVersion",middleware.addCorsHeaders()),a.use("/getComponentsVersion",function(e,n){n.set("Content-Type","application/json");var s={};i&&(s.calVersion=i),o&&(s.xvdsVersion=o),r&&(s.installerVersion=r),n.send(200,s)})};module.exports=setup;