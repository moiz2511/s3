"use strict";var util=require("util"),Store=require("express").session.Store,_=require("underscore"),SessionStore=function(){this.sessions={}};util.inherits(SessionStore,Store);var isExpired=function(s,e){return e&&s>=e},sessionExpiration=function(s){return"string"==typeof s.cookie.expires?new Date(s.cookie.expires):s.cookie.expires};SessionStore.prototype.get=function(s,e){var i=this;process.nextTick(function(){var o=i.sessions[s];if(o){var t=JSON.parse(o),n=sessionExpiration(t);isExpired(new Date,n)?i.destroy(s,e):e(null,t)}else e()})},SessionStore.prototype.set=function(s,e,i){var o=this;process.nextTick(function(){o.sessions[s]||o.emit("sessionCreated",s),o.sessions[s]=JSON.stringify(e),o.emit("sessionUpdated",s,o.sessions[s]),i&&i()})},SessionStore.prototype.destroy=function(s,e){var i=this;process.nextTick(function(){var o=i.sessions[s];delete i.sessions[s],i.emit("sessionDestroyed",s,o),e&&e()})},SessionStore.prototype.all=function(s){var e=_.values(this.sessions);s(null,e)},SessionStore.prototype.expiredSessions=function(s){var e=new Date,i=_.chain(this.sessions).pairs().filter(function(s){var i=JSON.parse(s[1]),o=sessionExpiration(i);return isExpired(e,o)}).object().value();s(null,i)},SessionStore.prototype.clear=function(s){this.sessions={},s&&s()},SessionStore.prototype.length=function(s){s(null,Object.keys(this.sessions).length)},module.exports=SessionStore;