!function(){"use strict";var e=require("fs"),i=(require("url"),require("express")),n=require("handlebars"),t=require("underscore"),o=require("async"),r=require("Environment"),s=require("../middleware"),a=require("../auth/clientValidation"),l=s.noCache(),u=function(e){this.reason=e},c=function(e,i){return e.isOutOfSpace()?new u("outOfSpace"):e.isSetupInWiping()||e.isSetupInWipingFailure()?new u("dataWipeInProgress"):e.isSetup()?i?new u("registrationExpired"):void 0:new u("notSetup")},d=function(u,d){var p=d.services.offlineServices,g=function(i,t){var r=i.query&&i.query.user;r&&i.query.online&&d.lastLoggedInUser(r);var s=r||i.session&&i.session.user;i.generateHybridSession(function(){return{user:s}}),e.readFile("./static/OfflineInstalled.js",{encoding:"utf-8"},function(e,r){return e?void t.send(500):void o.parallel({boxId:function(e){d.registrationClient.getBoxId(function(i){e(void 0,i)})},registrationExpired:function(e){d.getRegistrationExpired(function(i){e(void 0,i)})}},function(e,o){var s=n.compile(r),a=c(d,o.registrationExpired);t.send(s({boxId:o.boxId,onlineUrl:d.hostInfo.onlineUrl,offlineUrl:d.hostInfo.offlineUrl,inOnlineMode:i.query&&i.query.online||!1,localStorageDomain:d.hostInfo.onlineUrl,production:"production"===process.env.NODE_ENV,sessionId:i.hybridSessionId,urlPrefix:d.hostInfo.offlineUrl,offlineUnavailable:JSON.stringify(a)||"undefined"}))})})};d.services.offlineServices.use("/WebSA/OfflineInstalled.js",l),d.services.offlineServices.use("/WebSA/OfflineInstalled.js",g);var S=i.static(r.clientApplicationRoot,{index:!1});p.use("/WebSA",S),p.all("/",function(e,i){u.info("redirecting"),i.redirect("/WebSA/start")});var v=/^\/WebSA\/(applications|lib|test|api_doc)\//;p.get(v,function(e,i){console.log("404ing for request",e.url),i.send(404)});var h=function(e,i,n){n()},I=s.checkFreeSpace(d.isOutOfSpace,function(e,i){i.status(503),i.sendfile("noSpace.htm",{root:r.clientApplicationRoot})}),m=s.ensureAppsStarted(d.appsReady.whenReady);p.get("/WebSA/start",l,m,function(e,i){i.sendfile("choose.htm",{root:r.clientApplicationRoot})}),p.get("/WebSA/*",l,m,h,s.ensureRegistration(d.isRegistered,d.getRegistrationExpired,function(e,i){i.status(503),d.isRegistered()?i.sendfile("registrationExpired.htm",{root:r.clientApplicationRoot}):i.sendfile("notRegistered.htm",{root:r.clientApplicationRoot})}),s.ensureSetup(d.isSetup,d.isSetupInProgress,d.isSetupInProgressSyncing,d.isSetupInWiping,d.isSetupInWipingFailure,function(e,i,n,t,o,s){i.status(503),n?i.sendfile("setupInProgress.htm",{root:r.clientApplicationRoot}):t?i.sendfile("setupSyncing.htm",{root:r.clientApplicationRoot}):o?i.sendfile("setupWiping.htm",{root:r.clientApplicationRoot}):s?i.sendfile("setupWipingFailure.htm",{root:r.clientApplicationRoot}):i.sendfile("notSetup.htm",{root:r.clientApplicationRoot})}),I,a.validateClient(function(e,i){u.error("Failed validation for session "+e.sessionID+", path: "+e.url),i.status(401),i.sendfile("login.htm",{root:r.clientApplicationRoot})}),function(i,o){var r=i.headers["x-user"];d.dataManagerClient.getUserAuthorizedModules(r,function(s,a){return s?void o.send(502):(a=t.map(a.sort(),function(e){return{name:e,data:f(e,r)}}),void e.readFile("./static/index.htm",{encoding:"utf-8"},function(e,t){if(e)return void o.send(404);var r=n.compile(t),s=i.headers["accept-language"]||"";o.send(r({modules:a,locales:JSON.stringify(s)}))}))})})},f=function(e,i){var n;switch(e){case"EnvironmentInformation":n=JSON.stringify({userId:i});break;default:n="undefined"}return n};module.exports=d}();