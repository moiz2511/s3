!function(){"use strict";var e=(require("express"),require("uuid"),require("url")),r=(require("path"),require("fs"),require("Middleware/acceptsCheck.js")),i=(require("./TiledImage.js"),require("./ManualService.js")),t=require("FileUtility"),a="Content-Type",s="Expires",u="Cache-Control",n="If-Modified-Since",o="resize",d="crop",g="output-format",c="/SAWeb/services/Manualservice/getImage/**",l="image/png, image/jpg";module.exports=function(f,v){var p=v.dataPathsClient,q=v.tarIndexManager,m=v.services.offlineServices,M=i.getManualService(f,p);m.get(c,r(l),function(r,i){var c=e.parse(r.url,!0),l=c.query,v=r.get(n),p=r.params[0],m=l[o],h=l[d],x=l[g];if(void 0!=v)return void i.send(304,{});var C=M.getTiledImage(p,m,h,x);i.setHeader(a,C.getFormat()),i.setHeader(s,new Date(Date.now()+6048e5)),i.setHeader(u,"max-age=604800"),t.getFileBuffer(C.getFilePath(),q,function(e,r){!e&&r?i.send(r):(f.error("Error retrieving requested tile.",e),i.send(404))})})}}();