"use strict";var TiledImage=require("./TiledImage.js"),crypto=require("crypto"),environment=require("Environment"),manualService=function(e,t){function n(e,t,n,a,r){return null==e||null==t||null==n||null==a||(e.indexOf("graphics")==-1&&e.indexOf("manuals")==-1||(a.indexOf("jpg")==-1&&a.indexOf("png")==-1||(r.setInputValid(!0),!1)))}function a(e,t){var n=e.split(":");if(2!=n.length)return!1;n=c(n);var a=parseInt(n[0]),r=parseInt(n[1]);return!(a<512&&r<512)&&(t.setWidth(a),t.setHeight(r),t.setZoomLevel(a+"_"+r),t.setZoomLevelValid(!0),!0)}function r(e,t){var n=e.split(":");if(4!=n.length)return!1;n=c(n);var a=parseInt(n[2]),r=parseInt(n[3]),i=parseInt(Math.ceil(t.getWidth()/256)*r/256+a/256);return!(i<0)&&(t.setTileWidth(n[0]),t.setTileHeight(n[1]),t.setXOffset(n[2]),t.setYOffset(n[3]),t.setTileNumber(i),t.setCropValid(!0),!0)}function i(e,t){e.indexOf("graphics")!=-1?(t.setType("graphics"),s(e,t)):(t.setType("manuals"),l(e,t))}function g(e,t){var n=e.split(".");t.setImageName(n[0]),t.setFormat(n[1])}function l(e,n){var a=e.split("/");g(a[4],n);var r=n.getImageName().split("_");n.setPageNumber(r[r.length-1]);for(var i="",l="",s=0;s<r.length-1;s++)l+=r[s],s<r.length-2&&(l+="_");i=m(i,!1,t.getDataPath()),i=m(i,!0,"manuals"),i=m(i,!0,"tiles"),i=m(i,!0,l),i=m(i,!0,n.getImageName()),i=m(i,!0,n.getZoomLevel()),i=m(i,!0,n.getImageName()+"_"+n.getTileNumber()+"."+n.getFormat()),u(i.toString(),n)}function s(e,n){var a=e.split("/");n.setLanguageCode(a[3]),g(a[4],n),o(n);var r="";r=m(r,!1,t.getDataPath()),r=m(r,!0,"graphictiles"),r=m(r,!0,n.getLanguageCode()),r=m(r,!0,n.getMd5()),r=m(r,!0,n.getImageName()),r=m(r,!0,n.getZoomLevel()),r=m(r,!0,n.getImageName()+"_"+n.getTileNumber()+"."+n.getFormat()),u(r.toString(),n)}function u(e,t){t.setFilePath(e)}function o(e){var t=crypto.createHash("md5").update(e.getImageName()).digest("hex");e.setMd5(t.substring(0,3)),console.log("md5",e.getMd5())}function m(e,t,n){return t&&(e+="//"),e+=n}function c(e){for(var t=0;t<e.length;t++)e[t]=e[t].replace("px","");return e}this.getTiledImage=function(t,g,l,s){var u=TiledImage.getTiledObject(e);return!n(t,g,l,s,u)&&a(g,u)&&r(l,u)?(i(t,u),u):u}};exports.getManualService=function(e,t){return new manualService(e,t)};