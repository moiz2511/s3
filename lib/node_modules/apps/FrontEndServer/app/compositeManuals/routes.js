"use strict";var fs=require("fs"),fileUtility=require("FileUtility"),environment=require("Environment"),path=require("path"),_=require("underscore"),yauzl=require("yauzl"),uuid=require("uuid"),util=require("util"),TarRandomAccessReader=require("../../../../TarIndexManager/TarRandomAccessReader.js"),setup=function(e,i){var r=i.services.offlineServices,t=i.dataPathsClient,n=i.tarIndexManager,o={},a=function(i,r,n){var a=t.getManualsDataPath()+decodeURIComponent(i.path).replace(/\//g,"\\"),d=a.split(path.sep),l=_.indexOf(d,"manualbooks")+1;if(0===l)return e.error("Provided path does not contain manualbooks. "+a),void n();if(l>=d.length)return e.error("Provided path does not contain the composite manual's name. "+a),void n();var f=d[l],c=o[f];c&&c.ready?s(f,_.rest(d,l+1).join("/"),function(i,t){return i?(e.error("Failed to get file from composite manual for "+a+".",i),void r.send(404,"Failed to get file")):void t.pipe(r)}):o[f]?o[f].queuedRequests.push({internalPath:_.rest(d,l+1).join("/"),res:r,next:n}):u(f,_.first(d,l+1).join("/")+".zip",function(i){return i?void n():void s(f,_.rest(d,l+1).join("/"),function(i,t){return i?(e.error("Failed to get file from composite manual for "+a+".",i),void n()):void t.pipe(r)})})};r.use("/SAWeb/services/Data/manuals",a),r.use("/WebSA/Data/manuals",a);var u=function(i,r,t){o[i]={ready:!1,isReady:function(){this.ready=!0,this._heartBeat()},queuedRequests:[],entryMap:{},zipFile:void 0,keepAlive:function(){this._keepAlive=!0},_keepAlive:!0,_heartBeat:function(){var e=this;e._keepAlive?(e._keepAlive=!1,_.delay(function(){e._heartBeat()},6e4)):(delete o[i],e.zipFile.close())}};var a=n.getLocationObject(r);if(!a)return delete o[i],void t(new Error("Composite manual was not found in Tar file: "+r));var u=new TarRandomAccessReader(a);yauzl.fromRandomAccessReader(u,u.size,{autoClose:!1},function(r,n){return r?void t(r):(o[i].zipFile=n,void n.on("entry",function(e){o[i].entryMap[e.fileName.toUpperCase()]=e}).on("end",function(){o[i].isReady();var r=o[i].queuedRequests;_.each(r,function(r){s(i,r.internalPath,function(i,t){return i?(e.error("Failed to get file from composite manual for "+filePath+".",i),void next()):void t.pipe(r.res)})}),t()}).on("error",function(e){var r=o[i].queuedRequests;delete o[i],_.each(r,function(e){e.res.send(500,"Failed to get file")}),t(e)}))})},s=function(e,i,r){var t=o[e];t.keepAlive();var n=t.entryMap[i.toUpperCase()];return n?void t.zipFile.openReadStream(n,function(e,i){r(e,i)}):void r(new Error("Entry does not exist in zip file."))}};module.exports=setup;