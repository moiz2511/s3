"use strict";var express=require("express"),path=require("path"),environment=require("Environment"),fileUtility=require("FileUtility"),fs=require("fs"),_=require("underscore"),url=require("url"),setup=function(e,r){var t=r.dataPathsClient,n=r.tarIndexManager,i=r.services.offlineServices,a=express();a.use("/",express.static(t.getDataPath())),t.on("publicDataRootChanged",function(){a.use("/",express.static(t.getDataPath()))}),i.use("/WebSA/Data/readings/Conversion.xml",function(e,r){r.sendfile(environment.SACalConversionXml)}),i.use("/WebSA/Data",a),i.use("/WebSA/Data",function(e,r){var i=n.getFileStream(path.join(t.getDataPath(),e.path));i?r.pipe(i):r.send(404)});var s=function(e){var r=["overview","manuals","remote","reprogramming","diagnostics"];return _.intersection(r,e).concat(_.difference(e,r))};r.services.noSessionServices.get("/SAWeb/services/training/:lang",function(e,t){fs.readdir(environment.trainingDataPath,function(n,i){if(n)return void t.send([]);var a=_.map(s(i),function(t){try{var n=fs.statSync(path.join(environment.trainingDataPath,t));if(!n.isDirectory())return;var i=url.parse(r.hostInfo.offlineUrl);i.pathname="/training/"+t+"/"+e.params.lang+"/story.html";var a=t.charAt(0).toUpperCase()+t.slice(1)}catch(e){return}return{id:t,displayName:a,link:url.format(i)}});t.send(_.compact(a))})}),r.services.noSessionServices.use("/training",express.static(environment.trainingDataPath,{index:!1}))};module.exports=setup;