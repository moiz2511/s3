! function (){
    "use strict";
	var e = (require("url"),require("http")),
	r=require("https"),
	n=require("fs"),
	t=require("underscore"),
	s=require("express"),
	
	o=require("async"),
	i=require("BoxApplication"),
	a=require("server"),u=require("environment"),c=require("apps/Registration/Client"),f=require("apps/Connector/Client"),d=require("apps/DataManager/Client"),l=require("apps/DataPaths/Client"),p=(require("./auth/clientValidation"),require("./serverGroup")),v=require("./middleware"),h=require("./sessionStore"),y=require("./hybridSessionStore"),g=require("./socketIo/index.js"),S=require("Protocol"),q=require("./config.js"),m=a.createServer(q,[]),C=i(q),I=c.create(C),w=f.create(C),k=d.create(C),U=function(){var e=!1;return w.on("networkConnected",function(){e=!0,C.debug("online is true")}),w.on("networkDisconnected",function(){e=!1,C.debug("online is false")}),function(){return e}}(),b=s(),x=s(),D=q.host,L=144e5,P=new h,A=new y({maxAge:L}),E=setInterval(function(){var e=[P,A];t.each(e,function(e){e.expiredSessions(function(r,n){t.each(t.keys(n),function(r){e.destroy(r)}),t.isEmpty(n)||C.verbose("Cleared "+t.size(n)+" expired sessions",t.keys(n))})})},3e4);C.on("stop",function(){clearInterval(E)});var M=!1,N=function(){M||(M=!0,C.broadcast(S.sessionStart))},R=function(){M&&(C.broadcast(S.sessionEnd),M=!1)};P.on("sessionUpdated",function(e,r){var n=JSON.parse(r);n.acceptedEula&&N()}),P.on("sessionCreated",function(e){C.info("Creating new offline session with id "+e)}),A.on("sessionUpdated",function(e,r){r.user&&N()});var z=function(e,r){e.all(function(e,n){var s=t.chain(n).map(function(e,r){try{return JSON.parse(e).acceptedEula?r:void 0}catch(e){return}}).compact().value();r(e,s)})},j=function(e,r){e.all(function(e,n){var s=t.chain(n).map(function(e,r){try{return e.user?r:void 0}catch(e){return}}).compact().value();r(e,s)})},F=function(e,r,n){o.parallel([function(e){z(P,function(r,n){e(r,n)})},function(e){j(A,function(r,n){e(r,n)})}],function(e,r){n(e,e?void 0:t.flatten(r,!0))})};P.on("sessionDestroyed",function(e,r){F(P,A,function(r,n){0===t.size(t.without(n,e))&&R()})}),A.on("sessionDestroyed",function(e,r){F(P,A,function(r,n){0===t.size(t.without(n,e))&&R()})});var G=s.session({key:"sa5offline",store:P,cookie:{maxAge:L,path:"/"}}),T=s.cookieParser("secret"),J=function(){var e=!1,r=[];return{whenReady:function(n){e?n():r.push(n)},ready:function(){e=!0;for(var n;r.length;)(n=r.shift())()}}}();b.use(T),b.use(G),b.use(v.hybridSession(A)),b.use(v.ensureAppsStarted(J.whenReady)),x.use(v.hybridSession(A)),x.use(v.ensureAppsStarted(J.whenReady)),m.use(s.vhost(D.offlinehost,v.ensureNoUser())),m.use(s.vhost(D.offlinehost,x)),m.use(s.vhost(D.offlinehost,b)),m.use(v.ensureNoUser()),m.use(x),m.use(b);var O="";C.on("start",function(){I.getLastLoggedInUser(function(e){O=e,J.ready()})});var B=function(e){return void 0===e?O:void k.getUsers(function(r,n){if(!r){var s=t.find(n,function(r){return r.userId.toUpperCase()===e.toUpperCase()});(0===n.length||s)&&(I.setLastLoggedInUser(e,function(){}),I.updateLoggedInTimeStamp(function(){}),O=e)}})};l.create(C,function(s,o){if(s)return void C.ready(s);try{var i=o.getTarIndexManager()}catch(e){return void C.ready(e)}var a={tarIndexManager:i,registrationClient:I,connectorClient:w,dataManagerClient:k,dataPathsClient:o,services:{offlineServices:b,noSessionServices:x},hostInfo:D,online:U,lastLoggedInUser:B,app:C,appsReady:J};C.use(["./registration/registration","./backend/routes","./data/routes","./manuals/routes","./compositeManuals/routes","./diagnostics/routes","./dtac/routes","./licenseInfo/routes","./backgroundImages/routes","./otherData/routes","./client/routes","./tile/routes","./auth/routes"],module,a);var c=[],f=[q.server],d=e.createServer(m);c.push(d);new g(d,C);try{var l={key:n.readFileSync(u.ssl.server.keyPath),cert:n.readFileSync(u.ssl.server.certPath),ca:t.map(u.ssl.server.authorityChain,function(e){return n.readFileSync(e)}),requestCert:!0,rejectUnauthorized:!1},v=r.createServer(l,m);c.push(v),f.push(q.secureServer)}catch(e){}var h=p.createServerGroup(c);h.listen(f,function(e,r){r=t.compact(),!t.isEmpty(r)||e?(C.error(e,r),C.disconnect(),process.exit(1)):C.ready()}),C.on("stop",function(){h.close(1e3,function(){})})}),C.on("stop",function(){C.disconnect()}),process.on("SIGINT",function(){})}();