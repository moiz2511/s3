"use strict";var url=require("url"),uuid=require("uuid"),ensureAppsStarted=function(e){return function(r,n,s){e(function(){s()})}},ensureRegistration=function(e,r,n){return function(s,i,t){return e()?void r(function(e){e?n(s,i):t()}):void n(s,i)}},ensureSetup=function(e,r,n,s,i,t){return function(o,u,d){e()?d():t(o,u,r(),n(),s(),i())}},proxyWhenOnline=function(e,r,n,s,i){return function(t,o,u){r()?(t.originalUrl&&(t.url=t.originalUrl),n.web(t,o,s,function(r){e.error("An error occurred while proxying a request!",{url:t.url,error:r}),o.send(500)})):i?i(t,o):u()}},redirectWhenOffline=function(e,r){return function(n,s,i){if(e())i();else{var t=url.parse(n.url),o=url.parse(r.target);o.path=t.path,o.pathname=t.pathname,delete o.href,s.redirect(url.format(o))}}},redirectWhenOnline=function(e,r){return function(n,s,i){if(e()&&r){var t=url.parse(n.url),o=url.parse(r.target);o.path=t.path,o.pathname=t.pathname,delete o.href,s.redirect(url.format(o))}else i()}},ensureNoUser=function(){return function(e,r,n){delete e.headers["x-user"],n()}},guessUser=function(e){return function(r,n,s){r.headers["x-user"]=r.headers["x-user"]||r.hybridSession&&r.hybridSession.user||e(),r.refreshHybridSession&&r.refreshHybridSession(),s()}},noCache=function(){return function(e,r,n){r.header("Cache-Control","no-cache, no-store, must-revalidate"),r.header("Pragma","no-cache"),r.header("Expires","0"),n()}},checkFreeSpace=function(e,r){return function(n,s,i){e()?r(n,s):i()}},hybridSession=function(e){var r=function(){e.update(this.hybridSessionId)},n=function(n){var s=this;if(this.hybridSessionId)return this.hybridSessionId;var i=uuid.v4(),t=n();return s.hybridSession=e.store(i,t),s.hybridSession?(s.hybridSessionId=i,s.refreshHybridSession=r,i):void 0};return function(s,i,t){var o=s.headers["x-hybridsession"];e.get(o,function(e){return s.generateHybridSession=n,e?(s.refreshHybridSession=r,s.hybridSessionId=o,s.hybridSession=e,void t()):void t()})}},addCorsHeaders=function(e){return function(r,n,s){e=e||{};var i=e.origin||"*",t=e.headers||"X-Requested-With, Content-Type";t+=", X-Capability";var o=e.methods||"GET, POST, PUT, DELETE, OPTIONS";n.header("Access-Control-Allow-Origin",i),n.header("Access-Control-Allow-Headers",t),n.header("Access-Control-Allow-Methods",o),s()}};exports.ensureAppsStarted=ensureAppsStarted,exports.ensureRegistration=ensureRegistration,exports.ensureSetup=ensureSetup,exports.proxyWhenOnline=proxyWhenOnline,exports.redirectWhenOffline=redirectWhenOffline,exports.redirectWhenOnline=redirectWhenOnline,exports.ensureNoUser=ensureNoUser,exports.guessUser=guessUser,exports.noCache=noCache,exports.checkFreeSpace=checkFreeSpace,exports.hybridSession=hybridSession,exports.addCorsHeaders=addCorsHeaders;