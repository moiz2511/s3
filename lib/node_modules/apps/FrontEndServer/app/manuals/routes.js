!function(){"use strict";var e=(require("fs"),require("./service.js")),r=require("FileUtility"),t=require("path"),a=require("../middleware.js"),i=require("express"),n=require("../auth/clientValidation"),o=function(o,s){var l=s.services.offlineServices,u=s.dataPathsClient,c=s.tarIndexManager;l.use("/WebSA/Data/mastertoc",function(r,t){var a=decodeURIComponent(r.path).replace(/\//g,"\\");t.contentType(a);var i=u.getMastertocDataPath()+a;e.getMasterToc(o,i,u,c,function(e,r){e&&o.error("An error occurred while processing a mastertoc",{file:i,error:e}),r?(t.set({"Content-Type":"application/xml"}),t.send(r)):t.send(404,"File Not Found")})});var d=function(e,a,i){var n=u.getManualsDataPath()+decodeURIComponent(e.path).replace(/\//g,"\\"),s=t.normalize(n);return 0!==s.indexOf(u.getManualsDataPath())?void a.send(401):(a.contentType(n),void(".zip"===t.extname(n)?r.getFileStreamWithoutDecrypting(n,c,function(e,r){return e?(o.error("Unable to read file from file system or tar file, "+n+".",e),void i()):void r.pipe(a)}):r.getFileBuffer(n,c,function(e,r){return e?(o.error("Unable to read file from file system or tar file, "+n+".",e),void i()):void a.send(r)})))},f=i();f.get(/^\/.*\.pdf$/i,d),s.services.noSessionServices.use("/WebSA/Data/manuals",f);var p=i();p.use(a.addCorsHeaders({methods:["GET","HEAD"]}));var v=/^\/manualbooks\/([^/]+)_toc\.xml$/i;p.head(v,d),p.get(v,n.validateClient(function(e,r){r.send(401)}),d),l.use("/SAWeb/services/Data/manuals",p),l.use("/WebSA/Data/manuals",d),l.use("/WebSA/Data/graphics",function(e,t,a){var i=u.getGraphicsDataPath()+decodeURIComponent(e.path).replace(/\//g,"\\");t.contentType(i),r.getFileBuffer(i,c,function(e,r){return e?(o.error("Unable to read file from file system or Tar file, "+i+".",e),void a()):void t.send(r)})})};module.exports=o}();