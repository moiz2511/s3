!function(){"use strict";var e=(require("fs"),require("path")),t=require("async"),i=require("xml2js"),r=new i.Builder,n=require("xml2js").parseString,o=require("underscore"),a=require("FileUtility"),c=function(i,c,u,s,f){function d(t){return o.chain(t.jdmastertoc.classification).map(function(t,i){return o.map(t&&t.book,function(t,r){return{bookPath:e.join(u.getBooksDataPath(),t.$.name+"_toc.xml"),classificationIndex:i,bookIndex:r}})}).flatten(!0).value()}function l(e,t){return o.reduce(t,function(e,t){if(!t.exists){var i=e.jdmastertoc.classification,r=i[t.classificationIndex];delete r.book[t.bookIndex];var n=o.chain(r.book).compact().size().value();o.isEqual(n,0)&&delete i[t.classificationIndex]}return e},e)}a.getFileBuffer(c,s,function(e,i){return e?void f(e):void n(i.toString("utf8"),function(e,n){if(e)return void f(e,i);try{var c=d(n)}catch(e){var u=new Error("Invalid mastertoc")}return u?void f(u,i):void t.mapSeries(c,function(e,t){a.checkIfExists(e.bookPath,s,function(i,r){return i?void t(i):void t(void 0,o.extend({},e,{exists:r}))})},function(e,t){try{var o=l(n,t)}catch(e){var a=e}f(a,o?r.buildObject(o):i)})})})};exports.getMasterToc=c}();