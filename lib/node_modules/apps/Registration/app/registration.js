!function(){"use strict";var t,e,n,o,i=require("underscore"),r=require("async"),a=require("./config.js"),s=require("BoxApplication"),u=require("Environment"),c=require("apps/ConfigStore/Client"),d=require("Protocol"),f=s(a),g=d.authorizationState.unauthorized,p=d.state.unregistered,v=d.setupState.notSetup,m=void 0,h="",S=u.registrationTimout||5184e6,T="",P=new c(f,"registration"),I=function(){return p},x=function(t,e){t!==e&&f.broadcast(d.registrationStateChanged,{state:t,prevState:e})},z=function(t,e,n){t!==e&&f.broadcast(d.setupStateChanged,{state:t,prevState:e,errCode:n})},E=function(t,e){t!==e&&f.broadcast(d.authorizationStateChanged,{authorizationState:t,prevAuthorizationState:e})},A=function(t,e){t!==e&&f.broadcast(d.boxIdChanged,{boxId:t,prevBoxId:e})},R=function(t,e){t!==e&&(f.info("Access token changed."),f.broadcast(d.accessTokenChanged,{accessToken:t,prevAccessToken:e}))},l=function(t,e){t!==e&&(f.info("Authorization expiration changed."),f.broadcast(d.authorizationExpirationChanged,{authorizationExpiration:t,prevAuthorizationExpiration:e}))},U=function(t,e){t!==e&&(f.info("User type changed."),f.broadcast(d.userTypeChanged,{userType:t,prevUserType:e}))},C=function(){var e=new Date;return e-t},k=function(t){var e=new Date,n=new Date(t);return Math.ceil((n-e)/864e5)};f.use(["./checkClock"],module,{}),f.on("start",function(){x(I()),z(v),E(g)}),f.on("registration:boxId",function(t,e){e(h)}),f.on("registration:getRegistrationState",function(t,e){e(p)}),f.on("registration:setRegistrationState",function(t,e){return t?void P.setParameter("registrationState",t,function(n){return n?void e(n):(f.info("Registration State changed to: ",t),x(t,p),p=t,void e())}):void e("error, invalid state")}),f.on("registration:setBoxId",function(t,e){return i.isUndefined(t)?void e("error, invalid boxId"):void P.setParameter("boxId",t,function(n){return n?void e(n):(A(t,h),h=t,void e())})}),f.on("registration:getDaysUntilRegistrationExpires",function(t,e){e(Math.ceil((S-C())/864e5))}),f.on("registration:updateLoggedInTimeStamp",function(e,n){var o=new Date;f.info("Updating last logged in time stamp: "+o),t=o.getTime(),P.setParameter("lastLoggedInTimeStamp",t,n)}),f.on("registration:getRegistrationExpired",function(e,n){if(!t)return void n(!0);var o=C();n(o>S)}),f.on("registration:setLastLoggedInUser",function(t,n){t!==e?(f.info("Last logged in user changed. PrevUser:"+e+" NewUser:"+t),e=t,P.setParameter("lastLoggedInUser",e,n)):n()}),f.on("registration:getLastLoggedInUser",function(t,n){n(e)}),f.on("registration:getSetupState",function(t,e){e({state:v,errCode:m})}),f.on("registration:setSetupState",function(t,e){var n=t.state,o=t.errCode;return n?void P.setParameter("setupState",{state:n,errCode:o},function(t){return t?void e(t):(f.info("Setup State changed to: ",n),z(n,v,o),v=n,m=o,void e())}):void e("error, invalid state")}),f.on(d.getAccessToken,function(t,e){e(T)}),f.on(d.getAuthorizationExpiration,function(t,e){e(n)}),f.on(d.getAuthorizationState,function(t,e){P.getParameter("authorizationState",function(t){e(t)})}),f.on(d.getDaysUntilAuthorizationExpires,function(t,e){P.getParameter("authorizationExpirationTimestamp",function(t){e(k(t))})}),f.on(d.getRefreshToken,function(t,e){P.getParameter("refreshToken",function(t){e(t)})}),f.on(d.setAccessToken,function(t,e){return t?(R(t,T),T=t,void P.setParameter("accessToken",t,function(t){e(t)})):void e("Received no access token.")}),f.on(d.setAuthorizationExpirationTimestamp,function(t,e){return t?(l(t,n),void P.setParameter("authorizationExpirationTimestamp",t,function(o){return o?void e(o):(f.info("Authorization Expiration Timestamp changed to: ",t),n=t,void e())})):void e("Received no new Box authorization expiration timestamp.")}),f.on(d.setAuthorizationState,function(t,e){return t?void P.setParameter("authorizationState",t,function(n){return n?void e(n):(f.info("Authorization State changed to: ",t),E(t,g),g=t,void e())}):void e("Received no new authorization state.")}),f.on(d.setRefreshToken,function(t,e){return t?void P.setParameter("refreshToken",t,function(t){e(t)}):void e("Received no new refresh token.")}),f.on(d.setUserType,function(t,e){return t?void P.setParameter("userType",t,function(n){return n?void e(n):(f.info("User type changed to: ",t),U(t,o),o=t,void e())}):void e("Received no new user type")}),f.on(d.getUserType,function(t,e){e(o)}),f.on("stop",function(){f.disconnect()}),process.on("SIGINT",function(){}),r.series([function(t){P.getParameter("registrationState",function(e){e?(p=e,t()):P.setParameter("registrationState",d.state.unregistered,function(e){t(e)})})},function(t){P.getParameter("setupState",function(e){e&&e.state?(v=e.state,m=e.errCode,t()):P.setParameter("setupState",{state:d.setupState.notSetup},function(e){t(e)})})},function(t){P.getParameter("boxId",function(e){e?(h=e,f.info("********BOX ID: "+e),t()):P.setParameter("boxId","",function(e){t(e)})})},function(e){P.getParameter("lastLoggedInTimeStamp",function(n){t=n,e()})},function(t){P.getParameter("lastLoggedInUser",function(n){e=n,t()})},function(t){P.getParameter("authorizationExpirationTimestamp",function(e){n=e,f.info("********BOX AUTHORIZATION EXPIRATION: "+e),t()})},function(t){P.getParameter("authorizationState",function(e){g=e,f.info("********BOX AUTHORIZATION STATE: "+e),t()})},function(t){P.getParameter("accessToken",function(e){T=e,f.info("********RETRIEVED CURRENT ACCESS TOKEN"),t()})},function(t){P.getParameter("userType",function(e){o=e||"",f.info("********USER TYPE: "+o),t()})}],function(t){f.ready(t)})}();