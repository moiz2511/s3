!function(){"use strict";var e=require("underscore"),r=require("express"),a=require("uuid"),t=require("Environment"),o=require(t.getLocalAddonPath("Reprogramming")),n={},i={boxId:"BX12345",registrationId:"2cda120f-95c2-4d8d-9576-faa246082741",description:"John's Box",state:"registered",syncSetting:"hourly",mode:"box",totalSpaceInMB:1024,spaceAvailableInBytes:1e3,models:["guidA","guidB","guidC"],recordings:{},payloads:{}};i.recordings["fe94c427-5402-43ea-8048-09cad07d8546"]={name:"My favorite recording",filesizeInBytes:2460},i.payloads["4f275f64-945e-49c9-bb04-fc454db08f8a"]={updateName:"CAB",softwareVersion:"RX12345a",filesizeInBytes:104857600};var s={};s={controllerSoftware:{}},s.controllerSoftware["4f275f64-945e-49c9-bb04-fc454db08f8a"]={tla:"ECU",description:"Engine - PE68EXP000421",diagnosticTlas:["ENGINE"],softwareVersion:"SW60103A",softwareVersionFilesizeInKB:"160",availableVersion:"SW60103J",availableVersionFilesizeInKB:"1225",onBox:!0,remoteCertified:!0},s.controllerSoftware[String(Math.random())]={tla:"PTI",description:"PTI - Power Train - IVT Control",diagnosticTlas:["PTI"],softwareVersion:"RE245205",softwareVersionFilesizeInKB:"240",availableVersion:"RE245205",availableVersionFilesizeInKB:"240",onBox:!0,remoteCertified:!0};var d=function(t){t.get("/SAWeb/controllersoftwareupdates/:pin",function(r,a,t){var o=r.accepts("application/vnd.johndeere.sa.controllerSoftwareUpdates.v1+json");if(!o)return void a.send(406);var n=r.params.pin.toUpperCase();return"DY7920V123456"!==n?void a.send(404):void a.send(e.map(s.controllerSoftware,function(r,a){var t={softwareUpdateId:a};return e.extend(t,r),t}))}),t.post("/SAWeb/reprogram",r.json(),function(e,r,t){var s=e.accepts("application/vnd.johndeere.sa.reprogramming.v1+json");if(!s)return void r.send(406);var d=e.body.softwareUpdateId;if(!i.payloads[d])return void r.send(404);var l=a.v4();n[l]={type:"progress",status:"in progress",percentComplete:0,returnCode:0,updated:!1,callbacks:[]},o(function(e){if(n[l].percentComplete=e,n[l].updated=!0,n[l].callbacks.length>0){var r=n[l].callbacks.shift();clearTimeout(r.timeoutId),r.callback()}console.log("Received reprogramming update: "+e+"% complete")}),r.set("Content-Type",s),r.send(201,JSON.stringify({reprogrammingSessionId:l}))}),t.get("/SAWeb/reprogram/:id",function(e,r,a){var t=e.accepts("application/vnd.johndeere.sa.reprogrammingStatus.v1+json");if(!t)return void r.send(406);var o=e.params.id;if(!n[o])return void r.send(404);var i=function(){n[o].updated===!0?(n[o].updated=!1,r.set("Content-Type",t),r.send({type:n[o].type,status:n[o].status,percentComplete:n[o].percentComplete,showCancel:!0,returnCode:n[o].returnCode})):r.send()};if(n[o].updated===!0)i();else{var s=setTimeout(i,3e4);n[o].callbacks.push({callback:i,timeoutId:s})}})};module.exports=d}();