!function(){"use strict";var e,t,r=require("underscore"),o=require(".././reprogrammingLiterals"),n=o.responseType,i=o.reprogrammingCompleteEventStatus,a=require("apps/DataManager/Client"),s=require("Environment"),d=require(s.getLocalAddonPath("GetDeviceMgrInfo")),c=function(e,t,r,o,n,i,a){return{}},p={},u={},l=function(e){delete p[e],delete u[e]},f=function(e){return e&&e.type===n.COMPLETE},g=function(e,t){switch(t.type){case n.PROGRESS:p[e].progressUpdate=t;break;case n.CONTROLLER_LIST:p[e].controllerList.unshift(t);break;case n.ALERT:case n.PROMPT_EDIT:case n.TRIM_DOC:case n.TRIM_VALIDATION:case n.COMPLETE:p[e].otherUpdates.unshift(t)}},m=r.once(function(o,n){e=o.box,t=a.create(e),c=o.getSession,n(r.isFunction(c))}),I=function(o,n,a,s,d,c,p,u,l){l=l||function(){};var f=o?i.successful:i.failed,g=[];n&&r.each(n.sectionDetails,function(e){g.push({tla:e.tla,version:e.availableVersion})});var m={type:"liveReprogramming",softwareUpdateId:c,status:f,equipment:[{pin:d,modelGUID:u}],software:g};s&&(m.jobId=s),t.addActivity(m,a,function(t){t&&e.error(t),l(t)})},v=function(o,n,i){r.isFunction(n)||(n=function(){});var a=o.language,s=o.softwareUpdateId,d=o.payloadFileName,l=o.modelGUID,m=o.controller,v=o.jobId,D=o.pinInContext,U=o.adapter,E=o.donorEcuDetailsId,L=o.capabilities&&o.capabilities.split(","),b=!r.isUndefined(E),T=c(a,{softwareUpdateId:s,payloadFileName:d},l,v,D,U);return r.isObject(T)?void T.reprogram(function(a){if(!a)return e.error("Not able to start reprogramming for software id - "+s+"  Payload file -"+d),void n();p[a]={progressUpdate:{},controllerList:[],otherUpdates:[],userInputCallback:T.sendUserInput,getSoftwareUpdateDetails:T.getSoftwareUpdateDetails},u[a]={sessionId:a,progressUpdate:{},controllerList:[],otherUpdates:[],controller:m,jobId:v,modelGUID:l,donorEcuDetailsId:E};var c=function(n){if(n||n.type){if(!f(n))return void g(a,n);n.data&&n.data.status&&E&&r.contains(L,"donorEcuV2")?t.completeDonorEcuReprogramming(E,o.userId,function(t){t&&e.error("Failed to update donor ECU details",t),g(a,n)}):g(a,n),b||I(n.data.status,n.data.softwareUpdateDetails,o.userId,v,D,s,d,l),i(),T.unSubscribeToUpdates(c)}};T.subscribeToUpdates(c),n(a)}):(e.error("Not able to create reprogramming session for software id - "+s+"  Payload file -"+d),void n())},D=function(e,t){if(p&&p[e]){var o=p[e].controllerList.pop();return o?(u[e].controllerList=r.clone(o),o):(o=r.clone(p[e].progressUpdate))?(u[e].progressUpdate=r.clone(o),p[e].progressUpdate=void 0,o):(o=r.last(p[e].otherUpdates),o&&o.type===n.TRIM_VALIDATION&&p[e].otherUpdates.pop(),u[e].otherUpdates=r.clone(o),r.defer(function(){f(o)&&(t(),l(e))}),r.isEmpty(o)&&(o={reprogrammingSessionId:e,type:n.PROGRESS}),o)}},U=function(e,t,o){if(o.userInputText&&(o.userInputText=o.userInputText.trim()),!p||!p[e])return!1;var n=p[e].userInputCallback||function(){};return p[e].otherUpdates=r.chain(p[e].otherUpdates).reject(function(e){return e&&e.data&&e.data.inputId===t}).value(),n(t,o)},E=function(e){if(!p||r.isEmpty(p))return void e(void 0);var t=r.keys(p)[0];e(u[t]&&!r.isEmpty(u[t])?u[t]:void 0)},L=function(e){var t="USB",r="Jungo",o="EDL",n="EDL3",i={};i={isEDLConnected:void 0,edlDescription:""};try{var a=d.getDeviceMgrInfo(t,r);return 0==a.DeviceMgrInfo?i={isEDLConnected:!1,edlDescription:""}:a.DeviceMgrInfo.forEach(function(e){i=o==e.description||n==e.description?{isEDLConnected:!0,edlDescription:e.description}:{isEDLConnected:!1,edlDescription:e.description}}),void e(i)}catch(e){e.message;return i}};module.exports={name:"ReprogrammingService",initialize:m,startReprogramming:v,getReprogrammingStatus:D,sendUserInput:U,getActiveReprogrammingSession:E,getEDLConnectionInfo:L}}();