!function(){"use strict";var e=require("underscore"),r=require("express"),n=require("./service.js"),o=require("apps/ExclusiveResourceManager/Client"),s=["bus"],i={resourceClaimError:{message:"Another application is using the bus",code:4}},a=function(a,t){var d=t.webServer,u=o.create(a,t.config.name);d.get("/SAWeb/reprogram/getActiveSession",function(e,r,o){var s=e.accepts("application/vnd.johndeere.sa.reprogrammingSession.v1+json");return s?void n.getActiveReprogrammingSession(function(e){e?r.send(200,JSON.stringify(e)):r.send(200,"{}")}):void r.send(406)}),d.get("/SAWeb/reprogram/edllCheck",function(e,r,o){var s=e.accepts("application/vnd.johndeere.sa.edlchecksession.v1+json");return s?void n.getEDLConnectionInfo(function(e){r.send(200,JSON.stringify(e))}):void r.send(406)}),d.post("/SAWeb/reprogram",r.json(),function(r,a,t){var d=r.accepts("application/vnd.johndeere.sa.reprogramming.v1+json");if(!d)return u.releaseResources(s),void a.send(406);var c=function(e,r,o){var i=e.headers["x-user"],a=e.body.controller,t=a.softwareUpdateId,d=a.payloadFileName,c=e.body.donorEcuDetailsId,p=e.body.modelGUID,v=e.body.language,g=e.body.jobId,l=e.body.pinInContext,m=e.body.adapter,f=e.headers["x-capability"];return v||(v="en"),t?void n.startReprogramming({language:v,controller:a,softwareUpdateId:t,payloadFileName:d,modelGUID:p,userId:i,jobId:g,pinInContext:l,adapter:m,donorEcuDetailsId:c,capabilities:f},function(e){return e?void r.send({reprogrammingSessionId:e}):(u.releaseResources(s),void r.send(404,"Software Update ID not found"))},function(){u.releaseResources(s)}):(u.releaseResources(s),void r.send(400))};u.useResources(s,function(n){if(n instanceof o.ResourceClaimError){var s=new Error(i.resourceClaimError.message);s.code=i.resourceClaimError.code,s.blockingApp=e.chain(n.ownedApplications).values().first().value(),a.send(s)}else c(r,a,t)})}),d.get("/SAWeb/reprogram/:id",function(e,r,o){var i=e.accepts("application/vnd.johndeere.sa.reprogrammingStatus.v1+json");if(!i)return void r.send(406);var a=e.params.id,t=n.getReprogrammingStatus(a,function(){u.releaseResources(s)});return t?void r.send(t):void r.send(404,"Reprogramming Session ID not found")}),d.put("/SAWeb/reprogram/:id/input/:inputId",r.json(),function(r,o,s){var i=r.accepts("application/vnd.johndeere.sa.reprogrammingInput.v1+json");if(!i)return void o.send(406);var a=r.params.id,t=r.params.inputId,d=r.body;if(e.isEmpty(d))return void o.send(400);var u=n.sendUserInput(a,t,d);return u?void o.send(200):void o.send(404,"Reprogramming Session or Input ID not found")})};module.exports=a}();