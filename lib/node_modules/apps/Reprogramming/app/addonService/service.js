!function(){"use strict";var e,t,r,a,i,n,o=require("uuid"),s=require("path"),p=require("util"),d=require("underscore"),u=require("Environment"),l=require(u.getLocalAddonPath("GetPayloadInfo")),c=require(".././reprogrammingLiterals").responseType,m=require(".././reprogrammingLiterals").statusType,f=require("iniFiles/IniParser.js"),g="update",T="C://sds//payloadsn//",I=require("FileUtility"),v=function(){return{}},y=d.once(function(n,o){p.inherits(R,n.eventEmitter),t=n.box,r=n.reprogram,a=n.eventEmitter;var s=u.PayloadProcessorAdapterProfiles_ini;e=f(t,s),i=n.dataManagerClient.create(t),v=n.getTrimDocServiceCallback,o(!!r)}),R=function(p,u,f,y,R,h){if(u&&u.softwareUpdateId&&u.payloadFileName){a.call(this);var E,w={},L=this,P=[],b=function(){w={},P=[],E=void 0},D=function(e){w={reprogrammingSessionId:E,type:c.ALERT,data:{status:m.ERROR,message:e}},L.emit(g,w),w.type=c.COMPLETE,w.data={status:!1},d.defer(function(){L.emit(g,w)})},S=function(e,r){i.updateVersion({softwareUpdateId:u.softwareUpdateId},function(e){e&&t.error(e)}),e&&A(r)&&I.deleteDirectoryOrFile(r,d.noop),L.emit("deleteTempTrimFile",E),L.removeAllListeners("deleteTempTrimFile")},O=function(e){var t=!1;t=!(!e.result||"true"!==e.result),r.sendInputs({inputType:"trimOptions",input:t}),i.offTrimData()},A=function(e){return"PDX"===e.split(".").pop().toUpperCase()};this.reprogram=function(a){var f="EDL2";d.isUndefined(e)||(f=e.Adapters[h]);var I=s.join(T,u.payloadFileName),y=l.getPayloadInfo(I,!1);n={sectionDetails:y&&y.sectionDetails},E=o.v4();v();r.reprogram({payloadFilePath:I,language:p,isRollbackEnabled:!1,adapter:f},function(e){if(!e||!e.responseType){var r="Invalid reprogramming response from native payload processor for software id - "+u.softwareUpdateId;return t.error(r),void D(r)}var a=!1;try{switch(w={reprogrammingSessionId:E,type:e.responseType,data:{}},e.responseType){case c.PROGRESS:w.data={status:m.IN_PROGRESS,percentComplete:e.percentComplete,message:e.message,showCancel:!1};break;case c.ALERT:case c.TRIM_VALIDATION:case c.PROMPT_EDIT:var s=o.v4();w.data={inputId:s,title:e.title,text:e.text,buttons:e.buttons,defaultButton:e.defaultButton},e.icon&&(w.data.icon=e.icon),e.responseType===c.TRIM_VALIDATION&&(w.data.isValidated=e.isValidated||!1),c.TRIM_VALIDATION||P.push(s);break;case c.CONTROLLER_LIST:w.data={controllers:e.controllers||[]};break;case c.TRIM_DOC:a=!0,i.sendTrimData(e.propertyFilePath),i.onTrimData(O);break;case c.COMPLETE:w.data={status:e.reprogrammingStatus,softwareUpdateDetails:n},e.reprogrammingStatus||t.error("Reprogramming completed with failed status for software id - "+u.softwareUpdateId),S(e.reprogrammingStatus,I);break;default:throw new Error("Some Unknown update")}}catch(e){return t.error(e),void D(e.message)}a||L.emit(g,w)}),a(E)},this.subscribeToUpdates=function(e){E&&(e.call(this,w),L.on(g,e))},this.unSubscribeToUpdates=function(e){E&&(L.removeListener(g,e),b())},this.sendUserInput=function(e,t){return!(!d.contains(P,e)&&!t)&&(r.sendInputs(t),P=d.without(P,e),!0)}}};module.exports={name:"ReprogrammingAddonService",initialize:y,getReprogrammingSession:function(e,t,r,a,i,n){return new R(e,t,r,a,i,n)}}}();