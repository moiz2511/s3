!function(){"use strict";var e=require("underscore"),r=(require("fs"),require("path")),o=require("url"),n=require("xmlbuilder"),t=require("Environment"),i=require("FileUtility"),a=require("async"),c=(require("mkdirp"),require("child_process")),d=require("./utils.js"),l=function(e,r){this._app=e,this._config=r.config,this._networkContext=r.networkContext,this._dataPathsClient=r.dataPathsClient,this._currentlyLoadingJobsCore=!1,this._pendingLoadJobsCoreCallbacks=[]};l.prototype.mergePartialIndex=function(r,n,t,c,l){var s=this,u=s._networkContext;if(l=e.once(l),"Solutions"!==n&&"Manuals"!==n)return void l(new Error('Only "Manuals" or "Solutions" can receive have indexes partially merged'));if(!r)return void l(new Error("File path is missing to merge index data"));var p=function(e){var r=0;try{r=JSON.parse(e).response.numFound}catch(e){return{error:e}}return{error:!1,count:r}},f=function(r,o,n,t){function i(c,d){if(c)return void t(c);if(200!=d.statusCode)return void t(new Error(d.body));var l=p(d.body);return l.error!==!1?void t(l.error):void(n(l.count)?t():e.delay(function(){a.expired()?t(new Error("The timer expired and the expected result was not returned")):(s._app.debug("Will do another SOLR SELECT query check."),r(i))},o).unref())}var a=d.getTimer(1e4);r(i)};s._app.info("Begin merging of index "+t+" in SOLR core "+n),a.series([function(e){s.deleteIndex(t,n,function(r){r&&s._app.error("Error occurred while deleting index",r),e(r)},!0)},function(e){var r=o.format(d.buildSelectUrl(t,n));s._app.debug("Checking if Index deletion returns 0 documents with URL: ",r);var i,a=d.getSelectRequestFunction(u,r),c=function(e){return i=e,0==e};f(a,2e3,c,function(o){o&&i&&s._app.error("Expected Select Query for: "+r+" to returned 0 documents after index deletion.We got "+i+" instead"),e(o)})},function(e){var t=o.format(d.buildMergeUrl(r,n));s._app.info("Solr Merge URL: "+t),u.post({url:t,headers:{"Content-Type":"application/x-www-form-urlencoded"}},function(r,o){return r||200!=o.statusCode?(s._app.error("SOLR index merge failed, response statusCode: ",o.statusCode),s._app.error("SOLR index merge failed, response received: ",o.body),r||(r=new Error(o.body),r.info="Merge Error"),void e(r)):void e()})},function(e){var r=o.format(d.buildCommitUrl(n,c));s._app.info("Commit merged changes to SOLR with URL: ",r),u.get({url:r},function(r,o){var t=function(r){s._app.error("SOLR commit failed - try and reload core",r),s.reloadCore(n,e)};if(r)return void e(r);var i;try{i=0==JSON.parse(o.body).responseHeader.status}catch(r){return void e(r)}return i?void e():void t(new Error(o.body))})},function(e){var r=o.format(d.buildSelectUrl(t,n));s._app.debug("Checking if committed merged changes are applied with URL: ",r);var i,a=d.getSelectRequestFunction(u,r),c=function(e){return i=e,e>0};f(a,2e3,c,function(o){o&&0==i&&(s._app.error("Expected Select Query for: "+r+" to returned 1 or more documents after index merge.We got "+i+" instead"),o.info="Merge Error"),e(o)})},function(e){i.deleteDirectoryOrFile(r,function(o){o?s._app.debug("Merged dir: "+r+" failed to delete"):s._app.debug("Merged dir:"+r+" deleted"),e(o)})}],function(e){e||s._app.info("SOLR index merge successful"),l(e)})},l.prototype.checkIfIndexExists=function(r,n){var t,i=this,a=i._networkContext;"Solutions"==r?t=i._config.selectSolutionsUrl:"Manuals"==r?t=i._config.selectManualsUrl:"Jobs"==r&&(t=i._config.selectJobsUrl);var c={q:"*:*",rows:1,wt:"json"},d=o.format({protocol:i._config.protocol,hostname:i._config.hostname,port:i._config.port,pathname:t,query:c});a.get({url:d},function(r,o){if(r||200!==o.statusCode)r=r||new Error("Invalid status code from SOLR"),n(r,!1);else{var t=JSON.parse(o.body),i=t.response.numFound;n(null,!e.isUndefined(i)&&0!==i)}})},l.prototype.mergeWholeIndex=function(e,r,o,n){var t=this;t.clearIndex(e,function(a){a?t._app.error("Error occurred while clearing Solr index",a):t._app.info("Cleared the Solr index for "+e),c.exec("net stop SolrService",function(a){a?t._app.error("Error occurred while stopping the Solr service",a):t._app.info("SolrService has been stopped"),i.deleteDirectoryOrFile(r,function(r){r?t._app.error("Error occurred while clearing Solr index directory",r):t._app.info("Cleared the Solr index directory for "+e),o(function(r){r?t._app.error("Error occurred while merging Solr indexes",r):t._app.info("Successfully merged Solr indexes",e),c.exec("net start SolrService",function(o){o?t._app.error("Error occurred while starting the Solr service",o):t._app.info("SolrService has been started"),i.retry({times:9,interval:1e4},function(r){t.checkIfIndexExists(e,function(e,o){e&&"ECONNREFUSED"===e.code?r(e):r(null,o)})},function(e,o){e?n(r||e):r?n(r):o?n():n(new Error("Index empty after merge"))})})})})})})},l.prototype.mergeCompressedIndex=function(e,o,n,a){var c=this;e&&o||c._app.warn("Missing information required for merging zipped index: ",e||o),c.mergeWholeIndex(o,r.join(t.solrPath,o),function(o){i.extractZipToLocation(e,r.join(t.solrPath),{progressCallback:function(e,r){n(e/r)}},function(e){o(e)})},a)},l.prototype.mergeIndex=function(e,o,n,a,c,d){var l=this;e&&o||l._app.warn("Missing information required for merging index: ",e||o),n?l.mergePartialIndex(e,o,a,d):l.mergeWholeIndex(o,r.join(t.solrPath,o),function(n){i.copyDirectory(e,r.join(t.solrPath,o,"index"),{progressCallback:function(e,r){c(e/r)}},function(e){n(e)})},d)},l.prototype.createJobsIndex=function(r){var n=this._networkContext,t=this;if(t._pendingLoadJobsCoreCallbacks.push(r),!t._currentlyLoadingJobsCore){t._currentlyLoadingJobsCore=!0;var i=t._pendingLoadJobsCoreCallbacks;t._pendingLoadJobsCoreCallbacks=[];var a={command:"full-import",commit:"true"},c=o.format({protocol:t._config.protocol,hostname:t._config.hostname,port:t._config.port,pathname:t._config.jobIndexUrl,query:a});n.post({url:c,headers:{"Content-Type":"application/x-www-form-urlencoded"}},function(r,o){e.each(i,function(e){e(r)}),t._currentlyLoadingJobsCore=!1,e.isEmpty(t._pendingLoadJobsCoreCallbacks)||t.createJobsIndex(e.noop)})}},l.prototype.reloadCore=function(e,r){var n=this,t=n._networkContext,i={action:"RELOAD",core:e,wt:"json"},a=o.format({protocol:n._config.protocol,hostname:n._config.hostname,port:n._config.port,pathname:n._config.urlBegin,query:i});t.post({url:a,headers:{"Content-Type":"application/x-www-form-urlencoded"}},function(o,t){o||200!=t.statusCode||n._app.info(e+" Core reloaded on Solr"),r(o)})},l.prototype.deleteIndex=function(r,t,i,a){var c=this,d=c._networkContext;if(e.isEmpty(r))return void i(new Error("Delete list for ("+t+") is missing"));var l,s;"Solutions"==t?(l=a?n.create("delete").ele("query").text('solution_id:("'+r+'")').end():n.create("delete").ele("query").text('model:("'+r.join('" "')+'")').end(),s=c._config.deleteSolutionsUrl):(l=n.create("delete").ele("query").text('bookId:("'+r.join(" ")+'")').end(),s=c._config.deleteManualsUrl);var u={commit:!0,"stream.body":l,wt:"json"},p=o.format({protocol:c._config.protocol,hostname:c._config.hostname,port:c._config.port,pathname:s,query:u});c._app.info("SOLR delete URL: "+p),d.get({url:p},function(e,r){e||200!=r.statusCode?e?c._app.error(t+" index deletion failed in solr "+e):c._app.info(t+" index deletion statusCode from solr "+r.statusCode):c._app.info(t+" index deleted from solr"),i(e)})},l.prototype.clearIndex=function(e,r){var n,t=this,i=t._networkContext;switch(e){case"Solutions":n=t._config.deleteSolutionsUrl;break;case"Manuals":n=t._config.deleteManualsUrl;break;case"Jobs":n=t._config.deleteJobsUrl}var a={commit:!0,"stream.body":"<delete><query>*:*</query></delete>"},c=o.format({protocol:t._config.protocol,hostname:t._config.hostname,port:t._config.port,pathname:n,query:a});i.post({url:c,headers:{"Content-Type":"application/x-www-form-urlencoded"}},function(e,o){r(e,o)})},l.prototype.clearIndexes=function(r){var o=this;a.series([function(r){o.clearIndex("Solutions",function(n,t){n?r(n,t):e.delay(function(){o.reloadCore("Solutions",r)},3e3)})},function(r){o.clearIndex("Manuals",function(n,t){n?r(n,t):e.delay(function(){o.reloadCore("Manuals",r)},3e3)})},function(r){o.clearIndex("Jobs",function(n,t){n?r(n,t):e.delay(function(){o.reloadCore("Jobs",r)},3e3)})}],function(e,n){e?(o._app.error("ClearIndexes failed. ",e),r(e)):r(void 0,n)})},module.exports=l}();