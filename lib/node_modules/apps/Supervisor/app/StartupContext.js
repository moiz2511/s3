"use strict";var childProcess=require("child_process"),util=require("util"),events=require("events"),_=require("underscore"),StartupContext=function(e,t,r){events.EventEmitter.call(this);var i=this,n=new events.EventEmitter,o=!1,a=void 0,u={},d=(process._debugPort||5858)+1,s=function(r){var i=require.resolve(r.name);e.info("Starting "+r.name);var o=[i].concat(r.args);if(r.debug||t.debugAll){var a=d;d+=1,"break"===r.debug?o.unshift("--debug-brk="+a):o.unshift("--debug="+a)}var s=childProcess.spawn(process.execPath,o,{silent:!0,detached:!0,stdio:t.background?"ignore":["ignore","pipe","pipe"]});return(r.debug||t.debugAll)&&e.info("Started "+r.name+" with pid "+s.pid),u[i]=s,t.background?s.unref():(s.stdout.pipe(process.stdout),s.stderr.pipe(process.stderr)),s.on("exit",function(){e.debug(r.name+" exited"),delete u[i],n.emit("child-exit")}),s.moduleFileName=i,s.appModule=r.name,s},c=function(e,t,r){_.delay(function(){r()},t.delay)},l=function(r,i,n){var o="break"===i.debug||i.noTimeout?void 0:setTimeout(function(){e.removeListener("ready",a),n({error:new Error("Child startup timed out."),failedChild:r})},i.maxStartupTime||t.maxAppStartupTime||3e4),a=function(t){t.name===r.moduleFileName&&(e.removeListener("ready",a),clearTimeout(o),void 0===t.err?(e.info(r.appModule+" is ready"),n(void 0)):t.err.message?n({error:_.extend(new Error(t.err.message),_.omit(t.err,"message")),failedChild:r}):(e.error(t.name+' reported it is unable to start: "'+t.err+'"'),n({error:new Error(t.err),failedChild:r})))};e.on("ready",a)},f=function(e,t){var r=s(e);r.appInfo=e,e.delay?c(r,e,t):l(r,e,t)},p=function(t,r){void 0===_.first(t)||o?r(void 0):(e.setMaxListeners(t.length),f(_.first(t),function(e){e?r(e):p(_.rest(t),r)}))},m=function(t,r){r=_.once(r);var i=setTimeout(function(){r(new Error("Not all children shut down in time."))},15e3),n=_.after(_.keys(t).length,function(){clearTimeout(i),r()});_.each(t,function(e){e.on("exit",n)}),e.broadcast("stop")},h=function(t,r){if(_.isEmpty(t))return void _.defer(r);var i=_.after(_.keys(t).length,function(){r()});_.each(t,function(t){e.warn("Forcibly killing "+t.appModule),t.on("exit",i),t.kill("SIGINT")})},v=function(t){m(u,function(){h(u,function(){t()})}),e.disconnect()},g=function(e){v(function(){i.emit("childFailed",e)})};this.start=function(i){p(r,function(r,u){o||(r?(r.failedChild&&e.error(r.failedChild.appModule+' reported that it was unable to start: "'+r.error.message+'"'),g(!1),i(new Error("Failed to start children"))):(a=g.bind(this,!0),n.once("child-exit",a),e.broadcast("start",function(){t.background&&e.disconnect(),e.on("ready",function(t,r){e.queue("start",void 0,r.from)})}),i()))})},this.shutdown=function(t){e.info("Shutting down successfully"),a&&n.removeListener("child-exit",a),o=!0,v(function(){t()})}};util.inherits(StartupContext,events.EventEmitter),module.exports=StartupContext;