!function(){"use strict";var e,t,i,a,s,n,r,o,u,d=require("uuid"),c=require("util"),l=require("underscore"),S=require("path"),p=require("Environment"),f=require("iniFiles/PayloadProcessorSA5.js"),A=require(".././sdaLiterals").responseType,D=require(".././sdaLiterals").statusType,E=require(".././sdaLiterals").sdaCompleteEventStatus,T="update",m=require("iniFiles/IniParser.js"),h=l.once(function(d,l){c.inherits(y,d.eventEmitter),e=d.box,t=d.smartDiagnosticsAssemblies,i=d.eventEmitter,a=d.dataManagerClient.create(e),s=f(e),n=p.SDAConfigPath,u=m(e,n),s&&s.Files?(r=s.Files.SDAReturn?s.Files.ReturnFolder:p.copyRtnFileAtPath,o=s.Files.SDAFolder?s.Files.SDAFolder:p.SDAFolder):(r=p.copyRtnFileAtPath,o=p.SDAFolder),l(!!t)}),v=function(t,i){var s=function(s){var n=[];l.each(t.modelContext,function(e){e.pin&&n.push({modelGUID:e.modelGUID,pin:e.pin})}),s=s||function(){};var r=function(){return i?E.successful:E.failed}(),o={type:"liveSDA",payloadFileName:t.payloadFileName,language:t.language,status:r,equipment:n};t.jobId&&(o.jobId=void 0!=t.jobId?t.jobId:null),a.addActivity(o,t.userId,function(t){t&&e.error(t),s()})};s()},y=function(a){var s=a.payloadFileName;i.call(this);var c,p={},f=this,E=[],m=!0,h=function(){p={},E=[],c=void 0},y=function(e){p={data:{status:D.ERROR,message:e}},f.emit(T,p),p.data={status:D.COMPLETED},l.defer(function(){f.emit(T,p)})},F=t.SDAProcessor();this.startSdaExecution=function(t,i){var E="EDL_USB";l.isUndefined(u)||l.isUndefined(u.Adapters)||(E=u.Adapters[a.adapterType],l.isUndefined(E)&&(E="EDL_USB")),c=d.v4();var h=S.join(o,s);F.startSdaExecution({sdaConfigPath:n,adapter:E,sdaFilePath:h,copyRtnFileAtPath:r},function(t){try{p={type:t.type,data:{}},t.type===A.SDA_PROCESS_UPDATE&&(p.data={status:t.status},t.status===D.COMPLETED&&F.cleanupSession(),t.status!==D.STARTED_STATUS_NO_ECUS&&t.status!==D.STARTED_STATUS_NOT_CONNECTED&&t.status!==D.STARTED_STATUS_INVALID_PAYLOAD&&t.status!==D.ERROR||(m=!1)),t.type===A.RECORDING_UPDATE&&(p.data={status:t.status,id:t.recNumber})}catch(t){return e.error(t),void y(t.message)}if(p.sdaSessionId=c,f.emit(T,p),t.status===D.COMPLETED){var i=a.modelContext,s=!1;i&&i.length>0&&l.each(i,function(e){e.pin&&(s=!0)}),(s||a.jobId)&&v(a,m)}}),t(c)},this.setUserInput=function(e){"addNote"===e.type?F.addNote(e.noteData):"start"===e.type?F.forceStartRecordings():F.stopSdaExecution()},this.subscribeToUpdates=function(e){c&&(e.call(this,p),f.on(T,e))},this.unSubscribeToUpdates=function(e){c&&(f.removeListener(T,e),h())},this.getSdaDetails=function(e){(e=e||function(){})([])}};module.exports={name:"SdaAddonService",initialize:h,getSdaSession:function(e){return new y(e)}}}();