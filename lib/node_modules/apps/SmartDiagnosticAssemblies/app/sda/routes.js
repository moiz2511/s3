!function(){"use strict";var e=require("underscore"),s=require("express"),n=require("./service.js"),o=require("apps/ExclusiveResourceManager/Client"),r=["bus"],a={resourceClaimError:{message:"Another application is using the bus",code:4}},t=function(t,i){var d=i.webServer,u=o.create(t,i.config.name);d.get("/SAWeb/sda/getActiveSession",function(e,s,o){var r=e.accepts("application/vnd.johndeere.sa.sdaSession.v1+json");return r?void n.getActiveSdaSession(function(e){e?(s.send(200,JSON.stringify(e)),"COMPLETED"===e.progressUpdate.status&&n.clearActiveSessionData(e.sessionId)):s.send(200,"{}")}):void s.send(406)}),d.post("/SAWeb/sda/startExecution",s.json(),function(s,t,i){var d=s.accepts("application/vnd.johndeere.sa.sdaExecution.v1+json");if(!d)return u.releaseResources(r),void t.send(406);var c=function(e,s,o){var a=e.headers["x-user"],t=e.body.language,i=e.body.payloadFileName,d=e.body.jobId,c=e.body.modelContext,p=e.body.adapterType;t||(t="en"),n.startSdaExecution({language:t,payloadFileName:i,jobId:d,modelContext:c,adapterType:p,userId:a},function(e){return e?void s.send({sdaExecutionSessionId:e}):(u.releaseResources(r),void s.send(404,"Software Update ID not found"))},function(){u.releaseResources(r)})};u.useResources(r,function(n){if(n instanceof o.ResourceClaimError){var r=new Error(a.resourceClaimError.message);r.code=a.resourceClaimError.code,r.blockingApp=e.chain(n.ownedApplications).values().first().value(),t.send(r)}else c(s,t,i)})}),d.post("/SAWeb/sda/userInput/:id",s.json(),function(e,s,o){var r=e.accepts("application/vnd.johndeere.sa.sdaUserInput.v1+json");if(!r)return void s.send(406);var a=e.body.inputType;if(!a)return void s.send(400);var t={sessionId:e.params.id,type:a,noteData:e.body.noteData};n.setUserInput(t),s.send(200)}),d.get("/SAWeb/sda/status/:id",function(e,s,o){var a=e.accepts("application/vnd.johndeere.sa.sdaStatus.v1+json");if(!a)return void s.send(406);var t=e.params.id,i=n.getSdaStatus(t,function(){u.releaseResources(r)});return i?void s.send(i):void s.send(404,"SDA Session ID not found")})};module.exports=t}();