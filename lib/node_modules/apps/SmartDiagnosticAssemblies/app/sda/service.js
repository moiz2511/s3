!function(){"use strict";var t,e,s=require("underscore"),r=require(".././sdaLiterals").responseType,i=require(".././sdaLiterals").statusType,n=function(t){return{}},a={},o={},u=function(t){delete a[t],delete o[t]},d=function(t){return t&&t.status===i.COMPLETED},c=function(t,e){switch(e.type){case r.SDA_PROCESS_UPDATE:a[t].progressUpdate.unshift(e.data);break;case r.RECORDING_UPDATE:a[t].recordingList.unshift(e.data)}},p=s.once(function(e,r){t=e.box,n=e.getSession,r(s.isFunction(n))}),g=function(t,s,r){e=n(t),e.startSdaExecution(function(i){a[i]={progressUpdate:[],recordingList:[],otherUpdates:[],getSdaDetails:e.getSdaDetails},o[i]={sessionId:i,progressUpdate:[],recordingList:[],jobId:t.jobId?t.jobId:null,modelContext:t.modelContext?t.modelContext:null,sdaFileName:t.payloadFileName};var n=function(t){(t||t.type)&&(c(i,t),d(t)&&(r(),e.unSubscribeToUpdates(n)))};e.subscribeToUpdates(n),s(i)},t.userId)},l=function(t,e){if(a&&a[t]){var r={};return 0==a[t].progressUpdate.length?(a[t].recordingList.length>0&&(r=a[t].recordingList.pop(),o[t]=E(o[t],r)),r):1!=a[t].progressUpdate.length?r=a[t].progressUpdate.pop():(r=a[t].progressUpdate.pop(),r.status===i.COMPLETED?a[t].recordingList.length>0?(a[t].progressUpdate.push(r),o[t].progressUpdate=r,r=a[t].recordingList.pop(),o[t]=E(o[t],r),r):(s.defer(function(){d(r)&&(e(),u(t))}),r):r)}},E=function(t,e){var r=!1;return s.each(t.recordingList,function(t){t.id===e.id&&(t.status===i.MONITORING_TRIGGERS_CONDITION&&e.status===i.RECORDING_STOPPED?(t.restrictStatusOverride=!0,t.status=e.status):t.status===i.RECORDING_COMPLETE||t.status===i.ECU_DISCONNECTED||t.status===i.ERROR_OCCURRED||t.restrictStatusOverride?e.status=t.status:t.status=e.status,r=!0)}),r||t.recordingList.push({id:e.id,status:e.status,restrictStatusOverride:!1}),t},f=function(t){if(a&&a[t.sessionId])return e.setUserInput(t),!0},S=function(t){if(!a||s.isEmpty(a))return void t(void 0);var e=s.keys(a)[0];t(o[e]&&!s.isEmpty(o[e])?o[e]:void 0)},O=function(t){o[t]=void 0};module.exports={name:"SdaService",initialize:p,startSdaExecution:g,getSdaStatus:l,setUserInput:f,getActiveSdaSession:S,clearActiveSessionData:O}}();