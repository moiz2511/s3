"use strict";var _=require("underscore"),express=require("express"),uuid=require("uuid"),frontEndServerClient=require("apps/FrontEndServer/Client"),ConfigFile=require("./ConfigFile"),DataManagerApp=require("apps/DataManager/Client"),environment=require("Environment"),path=require("path"),fs=require("fs"),canTraceWrapper=require("CANTraceWrapper"),utility=require("FileUtility"),mkdirp=require("mkdirp"),ini=require("ini");module.exports=function(e,a){var t,n=a.webServer,r=new ConfigFile(e,a.configStoreClient),i=frontEndServerClient.create(e),o=i.getNamespaceWrapper("/canTrace"),s=DataManagerApp.create(e),c=a.canTraceEvents,d=a.canTrace,u=["EDL_USB","EDL_BT","EDL_V3_USB","EDL_V3_BT"],l=["CAN1","CAN2","CAN3","CAN1_CAN2","CAN1_CAN3","CAN2_CAN3"],f={hasPartialRecording:1001,failedToZip:1002,canTraceExitedUnexpectedly:1003},p=function(){return{canTraceId:"",adapter:"",channel:"",iniFile:"",fileSizeInKb:0,startedTime:"",statusCode:null,detailedErrorCode:null,fileLocation:"",durationInSeconds:null,userId:"",jobId:null,equipment:null}},m={};try{var v=ini.decode(fs.readFileSync(environment.canTraceConfig,"utf-8"));t=utility.convertBytesToKiloBytes(v.Logging.MinSizeForUsefulFileInBytes),v=void 0}catch(e){t=1}var C=function(a){var t=a.equipment;t=_.map(t,function(e){return{model:e.modelGUID,pin:e.modelPIN}});var n="";try{n=path.join(environment.canTraceDataPath,uuid.v4())}catch(a){return void e.error("Failed to create CAN trace destination file path",a)}var r={type:"canTrace",activityTime:new Date,jobId:a.jobId,equipment:t,filesizeInKB:a.fileSizeInKb,durationInSeconds:a.durationInSeconds,canTraceUrl:a.fileLocation,fileName:a.fileName,fileMetaData:[{type:"canTrace",currentFilePath:a.filePath,filePath:n,fileName:a.fileName,userId:a.userId,models:t}]};s.addActivity(r,a.userId,function(a){a&&e.error(a.message)})},h=function(a,t){r.saveFile(a.path,a.name,function(a){a&&e.error("Failed to save the new config file",a),a instanceof ConfigFile.InvalidFileTypeError?t.status(400):a?t.status(500):(e.debug("The new config file was successfully saved"),t.status(200)),t.end()})};n.post("/SAWeb/services/cantrace/configFile",express.multipart({keepExtensions:!0}),function(a,t){e.debug("Attempting to update the user provided config file ...");var n=_.result(a.files,"file");n?h(n,t):(e.debug("The config file was missing from the request"),t.status(400).end())},function(e,a,t,n){t.status(e.status||500).end()});var b=function(){var a=_.first(_.values(m));return a?a:void e.warn("Received a can trace event with no active session")};c.on("started",function(e,a){var t=b();t&&(a!==canTraceWrapper.statusCode.success&&delete m[t.canTraceId],t.statusCode=a,t.startedTime=(new Date).toUTCString(),o.broadcast("started",t))}),c.on("fileSize",function(e){var a=b();a&&(a.fileSizeInKb=utility.convertBytesToKiloBytes(e),o.broadcast("update",_.pick(a,"canTraceId","fileSizeInKb","statusCode","detailedErrorCode")),a.fileSizeInKb>a.maxSizeInKb&&d.stop())}),c.on("stopped",function(n,r,i){var s=b();if(s){delete m[s.canTraceId],s.statusCode=n,s.detailedErrorCode=r,s.durationInSeconds=(new Date-new Date(s.startedTime))/1e3;var c=function(){o.broadcast("stopped",_.pick(s,"canTraceId","fileSizeInKb","statusCode","detailedErrorCode","fileLocation","durationInSeconds"))};if(i&&(s.fileSizeInKb>t||n===canTraceWrapper.statusCode.success)){var d;try{d=path.basename(i,".txt"),d+=".zip"}catch(a){return e.error("Failed to parse the file name",a),s.statusCode=f.failedToZip,void c()}mkdirp.sync(environment.temporaryCanTracesPath);var u=path.join(environment.temporaryCanTracesPath,d);utility.compressFiles([i],u,function(t){return fs.unlink(i,function(e){}),t?(e.error("Failed to zip the CAN trace recording.",t),s.statusCode=f.failedToZip,void c()):(s.fileLocation=a.offlineUrl+"/SAWeb/services/cantrace/"+d,s.filePath=u,s.fileName=d,n===canTraceWrapper.statusCode.startFailedCannotSetBaudrateOrDriverUnknown?s.statusCode=f.hasPartialRecording:n!==canTraceWrapper.statusCode.success&&(s.statusCode=f.canTraceExitedUnexpectedly),c(),void C(s))})}else c()}}),n.post("/SAWeb/services/cantrace",express.json(),function(a,t){var n=a.body&&a.body.adapter,i=a.body&&a.body.channel,o=a.body&&a.body.iniFile||!1,s=a.body&&a.body.maxSizeInKb,c=a.body&&a.body.equipment,f=a.headers["x-user"],v=a.headers["x-jobid"];if(!(n&&_.contains(u,n)&&i&&_.contains(l,i)&&d.isInitialized()))return e.debug("The CAN trace failed to start, required parameters were missing from the request or CAN trace is not initialized"),void t.send(400);if(d.isRecording()){e.debug("The CAN trace failed to start because a CAN trace is already running");var C=b();return void t.send({canTraceId:C&&C.canTraceId})}var h=uuid.v4();m[h]=_.extend(p(),{statusCode:"0",canTraceId:h,adapter:n,channel:i,iniFile:o,maxSizeInKb:s,userId:f,jobId:v,equipment:c}),t.send({canTraceId:h});var T=function(a){e.debug("Starting the CAN trace",n,i,environment.temporaryCanTracesPath,a),mkdirp.sync(environment.temporaryCanTracesPath),d.start(n,i,environment.temporaryCanTracesPath,a)};o?r.getFileRecord(function(a){var t=a&&a.filePath||"";t||e.warn("User requested that the advanced config file be used, but none is available"),T(t)}):T("")}),n.delete("/SAWeb/services/cantrace/:id",function(a,t){e.debug("Attempting to stop the CAN trace...");var n=a.params.id;return m[n]?(t.send(),void d.stop()):(e.debug("Failed to stop the CAN trace, the session ID was not found"),void t.send(404))}),n.get("/SAWeb/services/cantrace",function(e,a){r.getFileRecord(function(e){a.send({configFile:{timestamp:e&&e.timestamp,name:e&&e.name},sessions:_.values(m)})})}),n.get("/SAWeb/services/cantrace/:fileName",function(a,t){var n;try{mkdirp.sync(environment.temporaryCanTracesPath),n=path.join(environment.temporaryCanTracesPath,a.params.fileName),fs.exists(n,function(e){e?t.download(n):s.getCanTraceFilePath(a.params.fileName,function(e,a,n){return e?void t.send(500):void(a&&n?t.download(a,n):t.send(404))})})}catch(a){e.error("Failed to build file path",a),t.send(500)}}),e.once("start",function(){r.onFileRecordChange(function(e){o.broadcast("configFileChange",{timestamp:e&&e.timestamp,name:e&&e.name})})})};