var events=require("events"),_=require("underscore"),async=require("async"),environment=require("Environment"),canTraceWrapper=require("CANTraceWrapper"),_canTraceWrapper,_canTraceEvents=new events.EventEmitter,_initialized=function(e,a){_canTraceEvents.emit("initialized",e,a)},_uninitialized=function(e,a){_canTraceEvents.emit("uninitialized",e,a)},_started=function(e,a){_canTraceEvents.emit("started",e,a)},_stopped=function(e,a,r){_canTraceEvents.emit("stopped",e,a,r)},_fileSizeUpdated=function(e){_canTraceEvents.emit("fileSize",e)},setup=function(e,a){_canTraceWrapper=new canTraceWrapper.CANTrace;var r=function(a){var r=function(r){e.error(a+" - "+r)};switch(a){case canTraceWrapper.statusCode.initializeFailedIniFileNotFound:r("Failed to initialize CAN trace, the INI file was not found");break;case canTraceWrapper.statusCode.intializeFailedCannotCreateLogger:r("Failed to initialize CAN trace, failed to create the logger");break;case canTraceWrapper.statusCode.intializeFailedCannotInitialize:r("Failed to initialize CAN trace");break;case canTraceWrapper.statusCode.intializeFailedAlreadyInitialized:r("Failed to initialize CAN trace, it is already initialized");break;case canTraceWrapper.statusCode.startFailedCannotStartRecorder:r("CAN trace failed to start, cannot start the recorder");break;case canTraceWrapper.statusCode.startFailedCannotSetBaudrateOrDriverUnknown:r("CAN trace failed to start, cannot set baud rate or driver unknown");break;case canTraceWrapper.statusCode.startFailedRecorderIsNotLicensed:r("CAN trace failed to start, recorder is not licensed");break;case canTraceWrapper.statusCode.startFailedInvalidAdapter:r("CAN trace failed to start, invalid adapter");break;case canTraceWrapper.statusCode.startFailedInvalidChannelId:r("CAN trace failed to start, invalid channel id");break;case canTraceWrapper.statusCode.startFailedRecordingLogPathNotFound:r("CAN trace failed to start, recording log path not found");break;case canTraceWrapper.statusCode.startFailedRecorderIniFileNotFound:r("CAN trace failed to start, recorder INI file not found");break;case canTraceWrapper.statusCode.startFailedCanTraceIsAlreadyStarted:r("CAN trace failed to start, a CAN trace is already running");break;case canTraceWrapper.statusCode.cannotStopRecorder:r("CAN trace failed to stop");break;case canTraceWrapper.statusCode.uninitializeFailedCanTraceIsStarted:r("Failed to uninitialize CAN trace, a CAN trace is running");break;case canTraceWrapper.statusCode.canTraceNotInitialized:r("CAN trace error: CAN trace not initialized");break;case canTraceWrapper.statusCode.unknownError:r("CAN trace error: Unknown Error")}};_canTraceEvents.on("initialized",function(a,t){t===canTraceWrapper.statusCode.success?e.debug("CAN trace has been initialized"):r(t)}),_canTraceEvents.on("uninitialized",function(a,t){t===canTraceWrapper.statusCode.success?e.debug("CAN trace has been uninitialized"):r(t)}),_canTraceEvents.on("started",function(a,t){t===canTraceWrapper.statusCode.success?e.debug("CAN trace has started"):r(t)}),_canTraceEvents.on("stopped",function(a,t,n){a===canTraceWrapper.statusCode.success?e.debug("CAN trace has stopped",a,t,n):r(a)});var t=function(a){e.error("An uncaught exception was thrown in a CAN Trace callback: ",a?a.message:void 0,a?a.stack:void 0,a)};e.once("start",function(){_canTraceWrapper.setCanTraceEventsCallbacks({onInitialized:_initialized,onUninitialized:_uninitialized,onStart:_started,onStop:_stopped,onFileSize:_fileSizeUpdated,onUncaughtError:t}),e.debug("Initializing CAN Trace...");var a=_canTraceWrapper.initialize(environment.canTraceConfig);"success"!==a&&(e.error("Failed to create the CAN Trace shell. Do you have CAN Trace installed?"),e.error(a))}),e.once("stop",function(){async.series([function(a){_canTraceWrapper.isRecording()?(_canTraceEvents.once("stopped",function(){a()}),e.debug("Stopping the CAN trace recording because we are shutting down."),_canTraceWrapper.stop()):a()},function(a){_canTraceWrapper.isInitialized()?(_canTraceEvents.once("uninitialized",function(){a()}),_.defer(function(){e.debug("Uninitializing the CAN trace"),_canTraceWrapper.uninitialize()})):a()}],function(){_canTraceWrapper.shutdown()})}),a.canTrace=_canTraceWrapper,a.canTraceEvents=_canTraceEvents};module.exports=setup;