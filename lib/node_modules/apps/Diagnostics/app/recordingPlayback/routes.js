"use strict";var url=require("url"),fs=require("fs"),express=require("express"),unzip=require("unzip2"),DataManagerApp=require("apps/DataManager/Client"),async=require("async"),xml2js=require("xml2js"),path=require("path"),_=require("underscore"),Translations=require("../diagnostics/readingsConnection/Translations.js"),utility=require("FileUtility"),xmldom=require("xmldom"),recordingParserUtility=require("RecordingParserUtility"),uuid=require("uuid"),crypto=require("crypto"),mkdirp=require("mkdirp"),acceptsCheck=require("Middleware/acceptsCheck.js"),environment=require("Environment"),CAL=require("CAL"),calUtils=require("../CAL/utils.js"),offlineConnectionUtils=require("../cal/offlineConnectionUtils.js");module.exports=function(e,n){var i=n.webServer,t=DataManagerApp.create(e),r=calUtils.getConnectionCallbackHandler("dataPoints"),o=new offlineConnectionUtils.OfflineConnectionUtils(e,n),a=function(e,n){var i=this,t=r.getCallback(i);t&&t(e,n)},c={},d=function(e,n){var i={expecting:null,callback:function(){try{c[e.getId()].shift()}catch(e){}n.apply(void 0,arguments)},controllers:[],begin:function(e,n){_.isEmpty(e)||(i.callback(e),delete i.callback),i.expecting=n,n||i.callback(void 0,[])},each:function(e){i.controllers.push(e),i.expecting-=1,0===i.expecting&&i.callback(void 0,i.controllers)}},t=c[e.getId()]||[];t.push(i),c[e.getId()]=t,e.getControllers()},l=function(){try{var e=c[this.getId()];e[0].begin.apply(void 0,arguments)}catch(e){}},s=function(){try{var e=c[this.getId()];e[0].each.apply(void 0,arguments)}catch(e){}},u=function(n,i){e.debug("Reading recording information.");var t=["connection.xml"];utility.getFileBuffersFromZip(n,t,function(n,t){return n?(e.error("Failed to read recording!"),void i(n)):void i(void 0,{connectionXml:t["connection.xml"]})})},g=function(e,n,i,t){return n?void o.connectOffline(e,n.toString("utf8"),i,{onDataPoints:a,onBeginControllers:l,onController:s},function(e,n){t(e,n)}):void _.defer(function(){t(new Error("No connection XML has been provided"))})},f=function(e,n,i){return _.chain(e).map(function(e){var t=e.dataPoint,r=(e.category,t.getUniqueKey());if(!i||_.contains(i,r)){var o=n&&n.dataPoints[r],a={unitSet:t.getUnitSet(),name:t.getName(),resources:o&&_.chain(o.resources).map(function(e){return[e,t.lookupResource(e)]}).object().value()};return[r,a]}}).compact().object().value()},p=function(n){try{var i={};i.controllers=_.chain(n.header.controllers).map(function(e){return[e.strId,"0"]}).object().value(),i.dataPoints=_.chain(n.header.dataPoints).map(function(e){var n=_.map(e.resourceIds,function(e){return e.toString()});return[e.uniqueKey,{resources:n}]}).object().value();var t=_.indexBy(n.header.controllers,"id");return i.dtcs=_.map(n.header.dtcs,function(e){var n=t[e.controllerId];return{controller:n.strId,controllerTla:n.name,dtcCode:e.code}}),i}catch(n){return e.error("Failed to build translations JSON",n),""}},v=function(e,n){var i=crypto.createHash("sha1"),t=fs.ReadStream(e);t.on("data",function(e){i.update(e)}),t.on("end",function(){var e=i.digest("hex");n(e)})},m=function(e,n){var i=_.find(e,function(e){return e.pin});return!(!i&&!n)},y=function(e,n,i){v(e,function(e){t.getRecordings({hash:e},function(t,r){if(t)return void i(null,e);var o=_.find(r,function(e){return e.createdBy.userId.toUpperCase()===n.toUpperCase()});i(null,e,o)})})};i.post("/SAWeb/services/recording",express.bodyParser({limit:"2gb"}),express.multipart(),function(n,i){try{var r=_.result(n.files,"recordingFile"),o=uuid.v4(),a=o+".zip",c=path.join(environment.tempRecordingsPath,a),d=path.join(environment.tempRecordingsPath,o),l=JSON.parse(n.body.equipment)||[],s=n.headers["x-user"]}catch(e){return void i.send(400)}return!r||_.isEmpty(l)?void i.send(400):void y(r.path,s,function(u,g,f){return f?void i.send(409,{id:f.localId,url:"/SAWeb/services/Recordingservice/getRecording/"+f.localId}):void async.auto({recordingFileBuffers:function(e){utility.getFileBuffersFromZip(r.path,function(n,i){e(n,i)})},parsedRecording:["recordingFileBuffers",function(e,n){var i=n.recordingFileBuffers["1\\recording_data"]||n.recordingFileBuffers["1/recording_data"];return i?void recordingParserUtility.parseRecording(i,function(n){e(null,n)}):void e(new Error("Failed to find recording in zip file"))}],createRecordingPath:function(e){mkdirp(environment.tempRecordingsPath,function(n){e(n,!0)})},copyZipFile:["createRecordingPath",function(e){utility.copySingleFile(r.path,c,function(n){e(n,!0)})}],recordingMetaData:["parsedRecording","copyZipFile",function(e,i){var t=i.parsedRecording;fs.stat(c,function(i,r){try{var a={path:c,title:n.body.name,createdBy:s,filesizeInKB:Math.ceil(utility.convertBytesToKiloBytes(r.size)),completedTime:(new Date).toISOString(),durationInSecs:_.last(t.header.frameIndexes).stopTime,recordingId:o,description:n.body.description||"",models:_.map(l,function(e){return{modelPIN:e.pin,modelGUID:e.modelGUID}})};e(null,a)}catch(n){e(n)}})}],recordingDetails:["parsedRecording","recordingMetaData",function(n,i){var t=i.parsedRecording;i.recordingMetaData;try{var r,o,a=function(e){return _.chain(e.attributes).map(function(e){return[e.name,e.value]}).object().value()},c=t.header.connectXmls[0].connection,d=(new xmldom.DOMParser).parseFromString(c),s=d.getElementsByTagName("dataPoint"),u=_.chain(t.header.dataPoints).values().indexBy("uniqueKey").value(),g=_.indexBy(t.header.controllers,"id"),f=_.chain(s).map(function(e){var n=a(e);return n.uniqueKey}).without("Connection_Status","Vehicle_PIN").map(function(e){var n=u[e],i=g[n.controllerId];return{controllerTla:i.name,detailId:i.idDetail,id:n.uniqueKey,key:n.key}}).value(),p=_.isEmpty(t.header.triggers)?void 0:t.header.triggers[0].trigger;if(p){var v,m=(new xmldom.DOMParser).parseFromString(p),y=function(e){return _.filter(e,function(e){return"trigger"===e.nodeName})},h=y(m.documentElement.childNodes),b=_.map(h,function(e){return a(e).type});v=2===h.length&&_.contains(b,"UserTrigger")&&_.contains(b,"TriggerCombiner")?_.find(h,function(e){var n=a(e);return"TriggerCombiner"===n.type}):m.documentElement;var R={"-1":"<",0:"=",1:">"},D={1:"or",2:"and"},P=function(e){var n=a(e);switch(n.type){case"DataPointTrigger":var i=u[n.dataPoint]||{},t=g[i.controllerId]||{};return{type:"dataPoint",dataPointId:n.dataPoint,unit:n.thresholdUnit,value:Number(n.thresholdValue),comparator:R[n.thresholdType],key:n.dataPointKey,detailId:t.idDetail,controllerTla:t.name};case"TriggerCombiner":return{type:"combination",combinationType:D[n.combinationType],triggers:_.chain(y(e.childNodes)).map(function(e){return P(e)}).compact().value()};case"AnyDtcTrigger":return{type:"anyDtc"};case"DtcTrigger":return{type:"dtc",code:n.dtc}}},T=_.first(m.getElementsByTagName("triggerAction"));r=a(T);var I,x=a(m.documentElement);I="UserTrigger"===x.type&&6e4!==Number(r.totalRecordingTime)?{type:"user"}:v?P(v):void 0,o=I?[{type:"startTrigger",trigger:I}]:[]}var q={preTriggerTime:I&&r?Number(r.preRecordingTime):void 0,totalRecordingTime:I&&r?Number(r.totalRecordingTime):void 0,triggers:o,dataPoints:f,equipment:l};n(null,q)}catch(i){e.error("Failed to build recording details while importing a recording"),n(null,null)}}],writeRecordingMetaData:["recordingMetaData","recordingDetails",function(e,n){var i=n.recordingMetaData,t=n.recordingDetails,r=_.clone(i);r.recordingDetails=t;var o=JSON.stringify(r);fs.writeFile(d,o,function(n){e(n,!0)})}],activity:["recordingDetails","recordingMetaData",function(e,i){var r=i.recordingMetaData,o=i.recordingDetails;try{if(!m(l,n.body.jobId))return void _.defer(function(){e()});var d=_.defaults({},r,{type:"recording",fileName:a,filePath:path.join(environment.recordingsPath,a),currentFilePath:c,hash:g}),s={type:"importRecording",jobId:n.body.jobId||"",title:r.title,description:r.description,activityTime:new Date,equipment:l,totalRecordings:1,fileMetaData:[d],recordingDetails:o}}catch(n){return void _.defer(function(){e(void 0,null)})}t.addActivity(s,r.createdBy,function(n,i){e(void 0,s)})}]},function(n){n?(e.error("Failed to import recording",n),i.send(400)):i.send({id:o,url:"/SAWeb/services/Recordingservice/getRecording/"+o})})})},function(e,n,i,t){i.send(500)}),i.get("/SAWeb/services/recordingDetails/:id",function(n,i){var o=n.headers["x-user"],a=[];if(n.query&&n.query.languages&&_.isArray(n.query.languages)&&(a=n.query.languages),!o)return e.error("Missing user ID when loading recording"),void i.send(400);a.push("en");var c=!1,d=[],l=function(e){c?e():d.unshift(e)},s=function(){e.debug("Cleaning up offline connection data"),_.each(d,function(e){e()})};async.auto({recordingDetails:function(e){t.getRecordingDetails(n.params.id,function(n,i){if(!i){var t=new Error("Failed to find recording details");return t.code="notFound",void e(t)}e(n,i)})},relatedActivity:function(e){var i=_.pick(n,"protocol","headers","body");t.getActivity({recordingDetailsId:n.params.id},i,function(n,i){e(n,i)})},findLocalizableTriggers:["recordingDetails",function(e,n){var i={dataPoints:[],dtcs:[]},t=function(e){switch(e=e||{},e.type){case"dtc":i.dtcs.push(e);break;case"dataPoint":i.dataPoints.push(e);break;case"combination":_.each(e.triggers,function(e){t(e)})}},r=n.recordingDetails&&n.recordingDetails.triggers,o=_.findWhere(r,{type:"startTrigger"});t(o&&o.trigger),e(null,i)}],getRecording:["relatedActivity",function(e,i){var r=i.relatedActivity,o=r&&r.recordings&&_.first(r.recordings);t.getRecording(o&&o.id||n.params.id,function(n,i){return n||i?void e(n,i):void e(new Error("Failed to find the recording"))})}],readRecording:["getRecording",function(e,n){var i=n.getRecording&&n.getRecording.path;u(i,function(n,i){e(n,i)})}],connectOffline:["readRecording","findLocalizableTriggers",function(n,i){var t=i.findLocalizableTriggers.dataPoints,r=i.recordingDetails&&i.recordingDetails.dataPoints||[];return _.isEmpty(t)&&_.isEmpty(r)?void _.defer(function(){n(null)}):void g(o,i.readRecording&&i.readRecording.connectionXml,a,function(i,t){i||l(function(){e.debug("Disconnecting from offline connection"),t.disconnect()}),n(i,t)})}],getDataPoints:["connectOffline",function(n,i){return e.debug("Getting data points."),i.connectOffline?void r.callAction(i.connectOffline,function(i,t){e.debug("Got data points.",i),n(void 0,t||[])}):void _.defer(function(){n(null,[])})}],localizeDataPoints:["findLocalizableTriggers","getDataPoints",function(e,n){var i=n.findLocalizableTriggers.dataPoints,t=n.recordingDetails&&n.recordingDetails.dataPoints,r=_.union(_.pluck(i,"dataPointId"),_.pluck(t,"id")),o=f(n.getDataPoints,void 0,r);_.each(i,function(e){var n=o[e.dataPointId]||{},i=_.indexBy(_.values(n.unitSet),"unit");e.dataPointDisplayName=n.name||e.dataPointId,e.unit=i[e.unit]&&i[e.unit].displayText||e.unit}),n.recordingDetails.dataPoints=_.chain(t).each(function(e){e.displayName=o[e.id]&&o[e.id].name}).filter(function(e){return e.displayName}).value(),e(null)}],getUserObject:["relatedActivity","getRecording",function(e,n){var i=n.getRecording&&n.getRecording.createdBy;!n.relatedActivity&&_.isString(i)?t.getUserObject(i,function(n,i){e(null,i)}):e(null)}],formattedDetails:["localizeDataPoints","relatedActivity","getUserObject",function(e,n){var i=n.relatedActivity;if(!i){var t=n.getRecording||{};i={type:"liveRecording",title:t.title,description:t.description,activityTime:t.completedTime,createdBy:n.getUserObject}}var r={recordingDetails:n.recordingDetails,relatedActivity:i};e(null,r)}]},function(e,n){c=!0;var t=n.formattedDetails;e&&"notFound"===e.code?i.send(404):e?i.send(500):i.send(t),s()})}),i.get("/SAWeb/services/Recordingservice/getRecording/:id/data",acceptsCheck("application/octet-stream"),function(n,i){var r=function(n){if(!n||!n.path)return void i.send(404);var t=!1,r=_.once(function(n,r){t||(r&&e.error("getRecording Error",r),i.send(n,r))});fs.createReadStream(n.path).on("error",function(e){r(500,e)}).pipe(unzip.Parse()).on("entry",function(e){var n=e.path;e.type,e.size;"1\\recording_data"===n||"1/recording_data"===n?(e.pipe(i),t=!0):e.autodrain()}).on("close",function(){r(500,new Error("Missing recording data"))}).on("error",function(e){r(500,e)})};t.getRecording(n.params.id,function(e,n){return e?void i.send(500,e):void r(n)})}),i.get("/SAWeb/services/Recordingservice/getRecording/:id",acceptsCheck("application/vnd.johndeere.sa.recording.getRecordingData.v1+json"),function(i,o){var a=i.headers["x-user"],c=[];if(!a)return e.error("Missing user ID when loading recording"),void o.send(400);i.query&&i.query.languages&&_.isArray(i.query.languages)&&(c=i.query.languages),c.push("en");var l=!1,s=[],u=function(e){l?e():s.unshift(e)},v=function(){e.debug("Cleaning up offline connection data"),_.each(s,function(e){e()})};async.auto({getRecording:function(n){e.debug("Getting recording information from data manager.");var r=function(i){return i&&i.path?void n(void 0,i):(e.error("Recording path missing!"),void o.send(404))};t.getRecording(i.params.id,function(e,i){return e?void n(e):void r(i)})},readRecording:["getRecording",function(n,i){e.debug("Reading recording information.");var t=["connection.xml"],r=["1\\recording_data","1/recording_data"];utility.getFileBuffersFromZip(i.getRecording.path,t.concat(r),function(i,r){if(i)return e.error("Failed to read recording!"),void n(i);var a=_.find(t,function(e){return!_.has(r,e)});if(a)return e.info("Recording file is missing localization data. Have files: "+JSON.stringify(_.keys(r))),void o.send(500);var c=r["1\\recording_data"]||r["1/recording_data"];return c?void recordingParserUtility.parseRecording(c,function(i){if(i){var t=p(i);n(void 0,{translations:t,connectionXml:r["connection.xml"]})}else e.error("unable to parse recording for playback"),o.send(500)}):(e.error("Recording doesn't contain a recording."),void o.send(500))})}],getExportTypes:["readRecording",function(n,i){try{e.debug("Reading export types from connection.xml");var t=[],r=i.readRecording.connectionXml.toString("utf8"),o=(new xmldom.DOMParser).parseFromString(r),a=o.getElementsByTagName("recordingParam"),c=_.find(a,function(e){return"supportedExportFormats"===e.getAttribute("name")?e:void 0});if(c){var d=parseInt(c.getAttribute("value")),l=1,s=2;l&d&&t.push("DPV"),s&d&&t.push("CAN")}n(void 0,{exportTypes:t})}catch(i){e.error("Failed to parse connection.xml"),n(i)}}],connectOffline:["readRecording",function(n,i){g(a,i.readRecording.connectionXml,c,function(i,t){i||u(function(){e.debug("Disconnecting from offline connection"),t.disconnect()}),n(i,t)})}],getDataPoints:["connectOffline",function(n,i){e.debug("Getting data points."),r.callAction(i.connectOffline,function(i,t){e.debug("Got data points.",i),n(void 0,t||[])})}],getControllers:["connectOffline",function(n,i){e.debug("Getting controllers."),d(i.connectOffline,function(i,t){e.debug("Got controllers",i),n(void 0,t||[])})}],localizeDataPoints:["readRecording","getDataPoints",function(n,i){e.debug("Localizing data point information");var t=i.readRecording.translations,r=f(i.getDataPoints,t,_.keys(t.dataPoints));e.debug("Finished localizing data point information"),n(void 0,r)}],buildCategoryTree:["getDataPoints","readRecording",function(n,i){e.debug("Building category information");var t={},r={},o=i.readRecording.translations;_.each(i.getDataPoints,function(e){var n=e.dataPoint,i=e.category,a=n.getUniqueKey();if(_.has(o.dataPoints,a)&&i&&(t[i.getId()]=i,i.getType()==CAL.categoryType.normal)){var c=r[i.getId()]||[];c.push(a),r[i.getId()]=c}});var a=_.chain(i.getDataPoints).pluck("dataPoint").indexBy(function(e){return e.getUniqueKey()}).value(),c=calUtils.determineModelLinkingData(i.readRecording.connectionXml.toString("utf8")),d=calUtils.buildCategoryTree(r,t,c,function(e,n){var i=a[n];if(!i)return!1;var t=i.getController();return!!t&&(c.detailIdToModelMap[t.getIdDetail()]===e||c.detailIdToModelMap[t.getId()]===e)});e.debug("Finished building categories."),n(void 0,d)}],localizeControllers:["readRecording","getControllers",function(n,i){e.debug("Localizing controller information");var t=i.readRecording.translations,r=_.chain(i.getControllers).map(function(e){return[e.getId(),e]}).object().value(),o=_.chain(t.controllers).keys().map(function(e){if(_.has(r,e)){var n=r[e].getDescription();return[e,{description:n}]}}).compact().object().value();e.debug("Finished localizing controller information"),n(void 0,o)}]},function(t,r){if(l=!0,t)e.error("An error occurred while localizing recording",t),o.send(500,t);else{e.info("Successfully localized recording");var a={languages:c,recordingName:r.getRecording.title,description:r.getRecording.description||"",dataPoints:r.localizeDataPoints,controllers:r.localizeControllers,categories:r.buildCategoryTree,exportTypes:r.getExportTypes.exportTypes,exportUrl:n.offlineUrl+"/SAWeb/services/recordings/"+i.params.id+"/export",recordingDetailsId:r.getRecording.boxRecordingDetailsId,connectionXml:r.readRecording.connectionXml.toString("utf8")};o.send(a)}v()})})};