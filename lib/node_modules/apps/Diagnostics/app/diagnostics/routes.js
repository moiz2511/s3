!function(){"use strict";var e=require("underscore"),s=require("express"),i=(require("uuid"),require("Middleware/acceptsCheck.js")),n=require("Middleware/parseBody.js"),d=require("apps/DataManager/Client"),r=require("./ReadingsConnection/readingsConnection.js"),o=(require("./ReadingsConnection/DataPoints.js"),require("./ReadingsConnection/Procedures.js")),t=(require("Protocol"),require("util"),require("async"),require("../cal/CalSession.js"));module.exports=function(a,c){var u=function(s){return e.chain(s).filter(function(e){return c.config.calLanguageMap[e.toUpperCase()]}).first().value().toLowerCase()},g=c.appEvents,p=c.webServer,S=o(a,c.tarIndexManager),b=(r(a,S,c.tarIndexManager),c.cal),v=t.GetSessionManager(a,b,c);c.sessionManager=v;var m=d.create(a);b.on("disconnected",function(){}),p.options("/SAWeb/services/diagnostics*",function(e,s){s.send(200)}),p.post("/SAWeb/services/diagnostics/connect",s.json(),function(s,i){var n=s.headers["x-user"],d=s.headers["x-jobid"];i.send(),b.once("connected",function(e,s,i){g.emit("calConnected",e,s,i,d,n)});var r=e.isUndefined(s.body.languages)?[]:s.body.languages;r.push("en");var o=u(r);b.connect(n,o,s.body.adapter,s.body.models)}),p.put("/SAWeb/services/diagnostics/units",s.json(),function(e,s){b.setUnits(e.body.units),s.send()}),p.put("/SAWeb/services/diagnostics/models",s.json(),function(e,s){b.updateModelPins(e.body.models),s.send()}),p.delete("/SAWeb/services/diagnostics/connect/:id",function(e,s){v.calDisconnect()?s.send():s.send(503)}),p.all("/SAWeb/services/diagnostics/:id*",function(e,s,i){return v.isSessionActive(e.params.id)?void i():(a.error("Received a request with an invalid or expired session ID"),void s.send(404))}),p.post("/SAWeb/services/diagnostics",i("application/vnd.johndeere.sa.diagnosticSession.v1+json, application/json"),s.json(),function(e,s){v.createNewSession(e.headers["x-user"],e.headers["x-jobid"],e.body.templateSession,e.body.socketSessionId,e.body.languages,function(e,i){e?s.send(500):s.send(201,i)})}),p.put("/SAWeb/services/diagnostics/:id/languages",s.json(),function(e,s){v.updateLanguages(e.params.id,e.body.languages),s.send()}),p.delete("/SAWeb/services/diagnostics/:id",function(e,s){v.terminateSession(e.params.id,function(e){e?s.send(500):s.send(200)})}),p.get("/SAWeb/services/diagnostics/:id",i("application/vnd.johndeere.sa.diagnosticSession.v1+json, application/json"),function(s,i){var n=e.isArray(s.query.languages)?s.query.languages:[];v.getSessionInformation(s.params.id,n,function(e,s){e?i.status(500).end():i.status(200).json(s)})});p.get("/SAWeb/services/diagnostics/:id/dtcs",s.json(),function(e,s){var i=e.headers["x-user"],n=e.headers["x-jobid"],d=e.params.id,r=e.query.userClickedRefresh;s.send();var o="true"===r;o&&b.once("dtcs",function(e,s){g.emit("dtcsRefreshed",e,s,n,i)}),v.getDtcs(o,d)}),p.get("/SAWeb/services/diagnostics/:id/controllers",function(e,s){var i=e.params.id,n="true"===e.query.refresh;s.send(),v.getControllers(n,i)}),p.get("/SAWeb/services/diagnostics/:id/readingsData",function(e,s){var i=e.params.id;e.headers["x-user"];s.send(),v.getReadingsData(i)}),p.post("/SAWeb/services/diagnostics/:id/startProcedure",i("application/json"),s.json(),function(e,s){return e.body&&e.body.procedureId?void v.startProcedure(e.params.id,e.body.procedureId,e.body.procedureType,e.headers["x-user"],e.headers["x-jobid"],function(e,i){e?(a.error(e.message,e),e.code===v.startProcedure.missingSession?s.send(404):e.code==v.startProcedure.procedureAlreadyStarted?s.send(503):s.send(500)):s.send(201,{procedureSessionId:i})}):void s.send(400)}),p.post("/SAWeb/services/diagnostics/:id/procedureSession/:procedureSessionId/sendInputs",n(),function(e,s){var i=e.body.toString("utf-8");v.sendInputs(e.params.id,e.params.procedureSessionId,e.headers["x-user"],i,e.headers["x-clear-message"],function(e){if(e)switch(e.code){case v.sendInputs.missingSession:case v.sendInputs.missingProcedureSession:s.send(404)}else s.send(200)})}),p.post("/SAWeb/services/diagnostics/:id/procedureSession/:procedureSessionId/saveState",function(e,s){v.saveProcedureState(e.params.id,e.params.procedureSessionId,e.headers["x-user"],function(e){if(e)switch(e.code){case v.sendInputs.missingSession:case v.sendInputs.missingProcedureSession:s.send(404)}else s.send(200)})}),p.get("/SAWeb/services/diagnostics/:id/activeProcedures",function(e,s){v.getActiveProcedures(e.params.id,function(e){s.send(e)})}),p.post("/SAWeb/services/diagnostics/:id/dataPointSubscriptions",i("application/vnd.johndeere.sa.diagnosticSession.subscription.v1+json, application/json"),s.json(),function(e,s){return e.body.dataPointId?void v.createDataPointSubscription(e.params.id,e.body.dataPointId,function(e,i){return e?(a.error(e.message,e),void s.send(506,e.message)):void s.send(201,i)}):void s.send(400)}),p.put("/SAWeb/services/diagnostics/:id/dataPointSubscriptions/:subscriptionId",s.json(),function(e,s){return e.body.unitId?void v.updateDataPointSubscription(e.params.id,e.params.subscriptionId,e.body.unitId,function(e){e?(a.error(e.message,e),s.send(506,e.message)):s.send()}):void s.send(400)}),p.delete("/SAWeb/services/diagnostics/:id/dataPointSubscriptions/:subscriptionId",function(e,s){v.removeDataPointSubscription(e.params.id,e.params.subscriptionId,function(e){e?(a.error(e.message,e),s.send(506,e.message)):s.send()})}),p.get("/SAWeb/services/diagnostics/:id/triggerTemplateList",s.json(),function(e,s){m.getTriggerTemplateList(function(e){e.err?s.send(500):s.send(e.triggerTemplateList)})}),p.get("/SAWeb/services/diagnostics/:id/triggerTemplate/:triggerId",s.json(),function(e,s){m.getTriggerTemplate(e.params.triggerId,function(e){e.err?s.send(500):e.triggerTemplate?s.send(e.triggerTemplate):s.send(404)})}),p.post("/SAWeb/services/diagnostics/:id/triggerTemplate",s.json(),function(e,s){e.body.createdBy=e.headers["x-user"],e.body.createdTime=new Date,m.saveTriggerTemplate(e.body,function(e){e?s.send(500):s.send(200)})}),p.del("/SAWeb/services/diagnostics/:id/triggerTemplate/:triggerId",function(e,s){m.deleteTriggerTemplate(e.params.triggerId,function(e){e?s.send(500):s.send(200)})}),p.post("/SAWeb/services/diagnostics/:id/recordingSessions",s.json(),function(e,s){s.send(201,{recordingSessionId:v.startRecordingSession(e.headers["x-user"],e.headers["x-jobid"],e.body||{})})}),p.post("/SAWeb/services/diagnostics/:id/recordings/:recordingId/note",s.json(),function(e,s){return e.body||e.body.note?(v.addNote(e.params.id,e.params.recordingId,e.body.note),void s.send(200)):void s.send(406)}),p.post("/SAWeb/services/diagnostics/:id/savedRecordings",s.json(),function(e,s){v.saveRecording(e.params.id,e.body.recordingId,e.body.name,e.body.description),s.send(200)}),p.put("/SAWeb/services/diagnostics/:id/recordings/:recordingId",s.json(),function(e,s){v.updateRecording(e.params.id,e.params.recordingId,e.body.name,e.body.description,function(e){e?s.send(400):s.send(200)})}),p.put("/SAWeb/services/diagnostics/:id/recordings/:recordingId/stop",function(e,s){v.stopRecording(e.params.id,e.params.recordingId),s.send(200)}),p.delete("/SAWeb/services/diagnostics/:id/recordings/:recordingId",function(e,s){v.deleteRecording(e.params.id,e.params.recordingId),s.send(200)}),p.delete("/SAWeb/services/diagnostics/:id/recordingSessions/:recordingSessionId",function(e,s){v.deleteRecordingSession(e.params.id,e.params.recordingSessionId),s.send(200)}),p.delete("/SAWeb/services/diagnostics/:id/recordingSessions/:recordingSessionId/summary",function(e,s){console.log(e.params.id,e.params.recordingSessionId),v.deleteRecordingSessionSummary(e.params.id,e.params.recordingSessionId),s.send(200)}),p.put("/SAWeb/services/diagnostics/:id/recordingSessions/:recordingSessionId/start",function(e,s){v.forceStartRecording(e.params.id,e.params.recordingSessionId),s.send(200)}),p.delete("/SAWeb/services/diagnostics/:id/dtcs",function(e,s){var i=e.headers["x-user"],n=e.headers["x-jobid"],d=e.params.id;s.send(),b.once("dtcsCleared",function(e){g.emit("dtcsCleared",e,n,i)}),v.clearDtcs(d,i,n)}),p.delete("/SAWeb/services/diagnostics/:id/dtcs/:controllerId",function(e,s){var i=e.headers["x-user"],n=e.headers["x-jobid"],d=e.params.controllerId,r=e.params.id;s.send(),b.once("dtcsCleared",function(e){g.emit("dtcsCleared",e,n,i)}),v.clearDtcs(r,i,n,d)}),p.post("/SAWeb/services/diagnostics/:id/saveSnapshotData",function(e,s){var i=e.headers["x-user"],n=e.params.id;s.send(),v.saveSnapshotData(n,i)})}}();