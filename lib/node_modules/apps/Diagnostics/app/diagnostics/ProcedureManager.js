!function(){"use strict";var e=require("underscore"),r=require("async"),a=require("uuid"),n=require("apps/DataManager/Client"),t=function(a,t,i,d){this.box=a,this.mdt=t,this.readingsConnection=i,this.sessionManager=d,this.activeProcedures={},this.pendingUpdates={waiting:!1,queue:[]},this.dataManagerClient=n.create(a);var s=this,c=this.activeProcedures;t.on("surfaceUpdated",function(n,t){c[n]&&u(s,t.surface,c[n].language,function(i){c[n].surface=i,c[n].values={};var u=e.map(t.initialValues,function(e,r){return{value:e,key:r}});r.each(u,function(e,r){o(s,e.value,c[n].language,function(a){c[n].values[e.key]=a,r()})},function(e){e?a.error(e):d.addUpdate(c[n].ownerId,{message:"surfaceUpdate",data:{procedureSessionId:n,surface:c[n].surface,values:c[n].values}})})})}),t.on("procedureValueUpdated",function(n,t){if(c[n]){var i=e.map(t,function(e,r){return{value:e,key:r}});r.each(i,function(e,r){o(s,e.value,c[n].language,function(a){var t={};t[e.key]=a,d.addUpdate(c[n].ownerId,{message:"procedureValue",data:{procedureSessionId:n,update:t}}),c[n].values[e.key]=a,r()})},function(e){e&&a.error(e)})}}),t.on("procedureFinished",function(r){c[r]&&(d.addUpdate(c[r].ownerId,{message:"procedureFinished",data:{procedureSessionId:r}}),s.dataManagerClient.addActivity({type:"TestAndCalibrations",activityTime:new Date,initiatedBy:c[r].initiatedBy,procedureId:c[r].procedureId,status:"Successful",testArtifacts:["1","2"],model:[{pin:"DY7920V123456",modelGUID:"B2240104-1BD9-4E02-8E93-29712CD77701"}]},c[r].initiatedBy,e.noop),delete c[r])})},i=function(e,r){var a=e.sessionManager,n=e.activeProcedures;n[r]&&a.addUpdate(n[r].ownerId,{message:"surfaceUpdate",data:{procedureSessionId:r,surface:n[r].surface,values:n[r].values}})},o=function(e,a,n,t){var i,u=e.readingsConnection;return a?void(a.resId?u.getTranslation(n,a.resId,function(u){i=u||"";var d=a.params||[];r.eachSeries(d.reverse(),function(r,t){var u=a.params.indexOf(r);r.resId&&o(e,r,n,function(e){i=i.replace("%"+(u+1),e,"g"),t()}),r.value&&(i=i.replace("%"+(u+1),r.value,"g"),t())},function(){t(i)})}):t(void 0!==a.value&&null!==a.value?a.value:"")):void t("")},u=function(e,a,n,t){var i=e.readingsConnection,o=a.match(/\{Resource \d+\}/g)||[];r.each(o,function(e,r){var t=e.match(/ (.+)}/);t?i.getTranslation(n,t[1],function(n){a=a.replace(e,n,"g"),r()}):r()},function(){t(a)})},d=function(e){var r=e.pendingUpdates,a=e.activeProcedures,n=e.mdt;if(!r.waiting&&r.queue.length>0){r.waiting=!0;var t=r.queue.shift();n.updateProcedure(t.name,t.value,t.handle,function(n){r.waiting=!1,a[t.procedureSessionId].values[t.name]=t.value,t.callback(n),d(e)})}};t.prototype.executeProcedure=function(r,n,t,o,u,d,s){var c=this.box,v=this.activeProcedures,l=this.mdt;if(c.info("Starting Procedure: "+t),e.isEmpty(v)){var p=a.v4();v[p]={initiatedBy:d,workflowId:t,ownerId:r,surface:void 0,values:{},procedureId:n,language:o},l.executeProcedure(t,p,u,function(e,r){return e?(delete v[p],void s(e)):(v[p].handle=r,void s(null,p))})}else{var f=void 0;if(e.each(v,function(e,a){e.ownerId!==r&&void 0!==e.ownerId||e.procedureId!==n||(f=a)}),f)s(null,f),v[f].ownerId=r,i(this,f);else{var h=new Error("Another procedure is already in progress");h.code=1,s(h)}}},t.prototype.abandonProcedures=function(r){var a=(this.box,this.activeProcedures);e.each(a,function(e){e.ownerId===r&&(e.ownerId=void 0)})},t.prototype.updateProcedure=function(e,r,a,n,t){var i=this.activeProcedures,o=this.pendingUpdates,u=this;return i[r]?i[r].ownerId!==e?void t(new Error("You are not the owner of this procedure")):(o.queue.push({name:a,value:n,handle:i[r].handle,procedureSessionId:r,callback:t}),void d(u)):void t(new Error("There is no active procedure with the given ID"))},t.prototype.getActiveProcedures=function(r,a){var n=this.activeProcedures,t=e.groupBy(n,function(a){return a.ownerId==r?"owned":e.isUndefined(a.ownerId)?"available":"otherUser"});t=e.defaults(t,{owned:[],notOwned:[]}),a(t)},module.exports=t}();