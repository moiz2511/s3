"use strict";var events=require("events"),uuid=require("uuid"),_=require("underscore"),util=require("util"),DataManagerApp=require("apps/DataManager/Client"),fs=require("fs"),environment=require("Environment"),path=require("path"),recording=require("./RecordingManager.js"),procedureManagerApp=require("./ProcedureManager.js"),protocol=require("Protocol"),async=require("async"),SessionManager=function(e,t,n,i,r){events.EventEmitter.call(this);var o=this,s={},a={},d={},c=DataManagerApp.create(e),u={},p={},g=new procedureManagerApp(e,t,n,o);t.on("pinsDetected",function(t){var n=_.difference(_.keys(p),t);_.each(n,function(t){var n={pin:t,modelGUID:p[t]};r.emit("modelUndetected",n),e.broadcast(protocol.modelDisconnected,n),delete p[t]}),_.each(t,function(t){p[t]||c.getModelGuids(t,function(n){var i=n.modelGuids;_.isArray(i)&&1===i.length&&(p[t]=_.first(i));var o={pin:t,modelGUID:p[t]};e.info("Found model GUID for pin "+o.pin+": "+o.modelGUID),r.emit("modelDetected",o),e.broadcast(protocol.modelConnected,o)})})});var f=function(n){s[n].recorderManager=recording.GetRecordingManager(e,t,o),s[n].recorderManager.on("recordingStarted",function(e,t){s[n]&&(s[n].updates.push({data:{recordingId:t,recordingSessionId:e},message:"recordingStarted"}),o.emit("checkUpdates"))}),s[n].recorderManager.on("recordingSaved",function(e){s[n]&&(s[n].updates.push({data:{recordingId:e},message:"recordingStopped"}),o.emit("checkUpdates"))}),s[n].recorderManager.on("triggerStateUpdate",function(e,t){s[n]&&(s[n].updates.push({data:{triggerStates:e,recordingSessionId:t},message:"triggerStates"}),o.emit("checkUpdates"))}),s[n].recorderManager.on("recordingSessionStopped",function(e,t){s[n]&&(s[n].updates.push({data:{activity:t,recordingSessionId:e},message:"recordingSessionStopped"}),o.emit("checkUpdates"))})};t.on("dataPointSubscriptionEnded",function(e,t,n){var i=[];_.each(s,function(e,r){e.subscriptions[t]&&e.subscriptions[t][n]&&_.each(e.subscriptions[t][n],function(t){e.updates.push({message:"dataPointSubscriptionStopped",subscriptionId:t}),i.push({sessionId:r,subscriptionId:t})})}),_.each(i,function(e){var t=d[e.subscriptionId];M(e.sessionId,e.subscriptionId,t),a[t.id]&&a[t.id][t.unitId]&&(a[t.id][t.unitId]-1<=0?(delete a[t.id][t.unitId],_.isEmpty(a[t.id])&&delete a[t.id]):a[t.id][t.unitId]-=1),delete d[e.subscriptionId]}),o.emit("checkUpdates")}),t.on("modelConnected",function(e,t){t&&(a={},d={},_.each(s,function(e){_.each(e.subscriptions,function(t){_.each(t,function(t){_.each(t,function(t){e.updates.push({message:"dataPointSubscriptionStopped",subscriptionId:t})})})}),e.subscriptions={},e.updates.push({message:"modelContextChanged"}),e.recorderManager&&(e.recorderManager.sessionExpired(!1),delete e.recorderManager)}),o.emit("checkUpdates"))});var h=function(n){g.abandonProcedures(n),_.each(s[n].subscriptions,function(e,i){_.each(e,function(e,r){a[i][r]-=e.length,_.each(e,function(e){delete d[e]}),a[i][r]<=0&&(delete a[i][r],t.unsubscribeToDataPoint(i,r,function(){})),_.each(u,function(e){e.ownerId===n&&(e.ownderId=void 0)})})}),s[n].recorderManager&&(s[n].recorderManager.sessionExpired(!0),delete s[n].recorderManager),delete s[n],o.emit("userDisconnected"),e.info("Session with ID "+n+" has expired")};this.createNewSession=function(e,n){var r=uuid.v4(),a=setTimeout(function(){h(r)},i);return s[r]={updates:[],subscriptions:{},timeoutId:a},t.userSessionStarted(),o.emit("userConnected",e,n),r},this.terminateSession=function(e,t){return s[e]?(s[e].recorderManager&&(s[e].recorderManager.sessionExpired(!1),delete s[e].recorderManager),clearTimeout(s[e].timeoutId),h(e),void t()):void t(new Error("Invalid SessionId"))},this.isSessionActive=function(e){return!!s[e]&&(clearTimeout(s[e].timeoutId),s[e].timeoutId=setTimeout(function(){h(e)},i),!0)},this.clearDtcs=function(e,n,i,a){t.clearDtcs(a,function(t){return t?void(s&&s[e]&&s[e].updates&&(s[e].updates.push({message:"error",data:{message:t.message,origin:"clearDtcs"}}),o.emit("checkUpdates"))):(r.emit("userClearedDtcs",n,i),void o.getDtcs(e))})},this.getDtcs=function(e){t.getDtcs(function(t,n){s&&s[e]&&s[e].updates&&(t?s[e].updates.push({message:"error",data:{message:t.message,origin:"getDtcs"}}):s[e].updates.push({message:"dtcs",data:n}),o.emit("checkUpdates"))})},this.getControllers=function(e){t.getControllers(function(t,n){s&&s[e]&&s[e].updates&&(t?s[e].updates.push({message:"error",data:{message:t.message,origin:"getControllers"}}):s[e].updates.push({message:"controllersUpdated",data:_.values(n)}),o.emit("checkUpdates"))})},this.getReadingsData=function(e,n){t.getDataPoints(function(t,i){s&&s[e]&&s[e].updates&&(t?s[e].updates.push({message:"error",data:{message:t.message,origin:"getReadingsData"}}):s[e].updates.push({message:"readingsData",data:{dataPoints:i,ecuAccessLevel:n}}),o.emit("checkUpdates"))})};var l=function(e,n){var i=t.getDataPoint(e);if(i){var r=i.values&&i.values[n],o=i.resIds&&i.resIds[n],s=i.unitMap&&i.unitMap[n],a=i.highLow&&i.highLow[n],d=a&&a.high,c=a&&a.low;return{dataPointId:e,value:r,resId:o,unitId:n,unitResId:s,low:c,high:d}}},v=function(e,t,i){n.getTranslation(t,e,function(e){i(null,e)})},m=function(e,t,n,i){var r=l(e,t);return r?void async.parallel({unit:function(e){var t=r.unitResId;t?v(t,n,e):e(null)},value:function(e){var t=r.resId;t?v(t,n,e):e(null,r.value)}},function(n,o){n?i(n):i(null,_.extend({low:r.low,high:r.high,unitId:"noUnit"===t?void 0:t,dataPointId:e},o))}):void i(null)},I=function(e){return _.chain(e).map(function(e,t){return _.chain(e).map(function(e,n){return _.map(e,function(e){return{dataPointId:t,subscriptionId:e,unitId:n}})}).flatten().value()}).flatten().value()},b=function(e,t,n){var i=I(s[e].subscriptions);async.map(i,function(e,n){m(e.dataPointId,e.unitId,t,function(t,i){return t?void n(t):i?void n(null,_.extend({},e,i)):void n(null,e)})},n)};this.getSessionInformation=function(e,t,n){var i={sessionId:e,recordingSessions:[]};s[e].recorderManager&&(i.recordingSessions=s[e].recorderManager.getSessionInformation()),b(e,t,function(e,t){e?n(e):n(null,_.extend(i,{subscriptions:t}))})},this.addUpdate=function(e,t){s[e]&&(s[e].updates.push(t),o.emit("checkUpdates"))},t.on("controllers",function(e){_.each(s,function(t){t.updates.push({message:"controllersUpdated",data:_.values(e)})})}),t.on("dataPointUpdated",function(e){_.each(s,function(t){t.subscriptions[e.dataPointId]&&_.each(t.subscriptions[e.dataPointId][e.unitId],function(n){t.updates.push({message:"dataPointUpdated",data:{subscriptionId:n,id:e.dataPointId,unit:e.unitResId,value:e.value,resId:e.resId,high:e.high,low:e.low}})})}),o.emit("checkUpdates")}),t.on("dtcsUpdated",function(e){_.each(s,function(t){t.updates.push({message:"dtcsUpdated",data:e}),t.recorderManager&&t.recorderManager.onDtc(e)}),o.emit("checkUpdates")}),t.on("connected",function(){_.each(a,function(e,n){_.each(e,function(e,i){t.subscribeToDataPoint(n,i,function(){})})})}),this.executeProcedure=function(e,t,n,i,r,o,s){g.executeProcedure(e,t,n,i,r,o,function(e,t){s(e,t)})},this.updateProcedure=function(e,t,n,i,r){g.updateProcedure(e,t,n,i,function(e){r(e)})},this.getActiveProcedures=function(e,t){g.getActiveProcedures(e,function(e){t(e)})};var M=function(e,t,n){s[e].subscriptions[n.id][n.unitId]=_.without(s[e].subscriptions[n.id][n.unitId],t),0===s[e].subscriptions[n.id][n.unitId].length&&delete s[e].subscriptions[n.id][n.unitId]};this.createInternalDataPointSubscription=function(e,n,i){n=void 0===n?"noUnit":n;var r=function(t){if(t)return a[e]&&a[e[n]]&&delete a[e][n],_.isEmpty(a[e])&&delete a[e],void i(void 0,t);var r=uuid.v4();d[r]={id:e,unitId:n},i(r)};a[e]||(a[e]={}),a[e][n]?(a[e][n]+=1,r()):(a[e][n]=1,t.subscribeToDataPoint(e,n,r))},this.createDataPointSubscription=function(e,t,n,i){n=void 0===n?"noUnit":n,o.createInternalDataPointSubscription(t,n,function(r,o){return o?void i(void 0,o):(s[e].subscriptions[t]||(s[e].subscriptions[t]={}),s[e].subscriptions[t][n]||(s[e].subscriptions[t][n]=[]),s[e].subscriptions[t][n].push(r),s[e].recorderManager&&s[e].recorderManager.onDataPointSubscribed(t,n),void i(r))})},this.removeDataPointSubscription=function(t,n,i){var r=d[n];return r?void o.removeInternalDataPointSubscription(n,function(o){return o?(e.error(o.message),void i(o)):(M(t,n,r),s[t].recorderManager&&s[t].recorderManager.onDataPointUnsubscribed(r.id),void i())}):(e.info("Attempting to unsubscribe from a datapoint with an invalid subscription ID"),void i())},this.removeInternalDataPointSubscription=function(n,i){var r=d[n];return r?void(a[r.id]&&a[r.id][r.unitId]?a[r.id][r.unitId]-1<=0?t.unsubscribeToDataPoint(r.id,r.unitId,function(e){return e?void i(e):(delete d[n],delete a[r.id][r.unitId],_.isEmpty(a[r.id])&&delete a[r.id],void i())}):(delete d[n],a[r.id][r.unitId]-=1,i()):i()):(e.info("Attempting to unsubscribe from a datapoint with an invalid subscription ID"),void i())},this.updateDataPointSubscription=function(e,n,i,r){var o=d[n];o||r(new Error("Data point subscription not found")),a[o.id][o.unitId]-1<=0&&t.unsubscribeToDataPoint(o.id,o.unitId,function(e){}),M(e,n,o),t.subscribeToDataPoint(o.id,i,function(t){return t?void r(t):(a[o.id][o.unitId]-=1,a[o.id][o.unitId]<=0&&delete a[o.id][o.unitId],d[n].unitId=i,a[o.id][i]||(a[o.id][i]=0),a[o.id][i]+=1,s[e].subscriptions[o.id]||(s[e].subscriptions[o.id]={}),s[e].subscriptions[o.id][i]||(s[e].subscriptions[o.id][i]=[]),s[e].subscriptions[o.id][i].push(n),void r())})},this.startRecordingSession=function(e,t,n,i){var r=uuid.v4();return s[e].updates.push({data:{recordingSessionId:r},message:"recordingSessionStarted"}),o.emit("checkUpdates"),s[e].recorderManager||f(e),s[e].recorderManager.startRecordingSession(r,e,s[e].subscriptions,t,n,i),r},this.addNote=function(e,t,n,i){s[e].recorderManager?(s[e].recorderManager.addNote(t,n),i()):i(new Error("Recording Not Found"))},this.saveRecording=function(e,t,n,i,r){s[e].recorderManager&&s[e].recorderManager.saveRecording(t,n,i,r)},this.updateRecording=function(e,t,n,i,r){s[e].recorderManager&&s[e].recorderManager.updateRecording(t,n,i,r)},this.stopRecording=function(e,t,n){s[e].recorderManager&&s[e].recorderManager.stopRecording(t),n()},this.deleteRecording=function(e,t,n){s[e].recorderManager&&s[e].recorderManager.deleteRecording(t),n()},this.deleteRecordingSession=function(e,t,n){s[e].recorderManager&&s[e].recorderManager.deleteRecordingSession(t),n()},this.forceStartRecording=function(e,t,n){s[e].recorderManager&&s[e].recorderManager.forceStartRecording(t),n()},this.getUpdates=function(e){if(s[e]){var t=s[e].updates;return s[e].updates=[],t}return[]},this.shutdown=function(){_.each(s,function(e){e.recorderManager&&e.recorderManager.shutdown(),clearTimeout(e.timeoutId)})}};util.inherits(SessionManager,events.EventEmitter),exports.GetSessionManager=function(e,t,n,i,r){return new SessionManager(e,t,n,i,r)};