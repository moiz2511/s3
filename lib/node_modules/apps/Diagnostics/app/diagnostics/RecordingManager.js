"use strict";var events=require("events"),_=require("underscore"),async=require("async"),util=require("util"),uuid=require("uuid"),fs=require("fs"),DataManagerApp=require("apps/DataManager/Client"),environment=require("Environment"),path=require("path"),recording=require("Recording"),os=require("os"),RecordingManager=function(t,e,n){events.EventEmitter.call(this);var i=new recording.Recorder,r=setInterval(function(){i.update()},1e3),o={},a={},d={},s={},c=!1,u=this,g=DataManagerApp.create(t),l=function(t){e.getControllers(function(e,n){_.each(n,function(t){_.each(o,function(e){e.translationsData.controllers[t.controllerId]||(e.translationsData.controllers[t.controllerId]=t.resId)});var e={name:t.j1939ControllerDetails.tla,description:t.identifier,sourceAddress:t.j1939ControllerDetails.sourceAddress.toString(),bus:t.j1939ControllerDetails.busId.toString(),id:t.controllerId.toString(),idDetail:t.identifier,isDisconnected:t.disconnected};i.addController(e)}),t()})},f=function(t){_.each(o,function(e){e.translationsData.dtcs[t.dtcId]||(e.translationsData.dtcs[t.dtcId]={controller:t.controllerId,dtcCode:t.dtcCode})});var e={id:t.dtcId.toString(),code:t.dtcCode,controllerId:t.controllerId&&t.controllerId.toString()||"",count:t.j1939DtcUpdateDetails.count,status:t.j1939DtcUpdateDetails.status,isCountValid:!0};i.onDtc(e)},p=function(t){_.each(e.getKnownDtcs(),f),t()},m=function(t,n){var i=e.getDataPoint(t);n&&n.translationsData&&n.translationsData.dataPoints&&!n.translationsData.dataPoints[i.dataPointUniqueName]&&(n.translationsData.dataPoints[i.dataPointUniqueName]={},n.translationsData.dataPoints[i.dataPointUniqueName].unitSet=i.unitSet,n.translationsData.dataPoints[i.dataPointUniqueName].resources=_.map(i.enumDetails,function(t){return t.resId}))},I=function(t,n,r){var a=e.getDataPoint(t);_.each(o,function(e){m(t,e)});var d=_.find(a.unitSet,function(t){return t.id==n}),s={value:a.values&&a.values[n],id:t.toString(),controllerId:a.controllerId.toString(),uniqueKey:a.dataPointUniqueName,key:a.dataPointUniqueName,rawUnits:d&&d.rawUnit||"",isSubscribed:r};i.onDataPointSubscribed(s)},v=function(e,n){n.version="5",n.fileName=path.join(os.tmpdir(),uuid.v4()+".zip"),o[e].triggerRecording&&(o[e].recordingState="monitoring",o[e].preTriggerTimestamp=new Date),i.setTriggers(n,e,function(e){if(!o[e])return void t.error("Unknown recording session");o[e].recordingState="started",o[e].startTimestamp=new Date,t.info("Starting recording "+(o[e].completedRecordings+1)+" of "+o[e].totalRecordings);var n=uuid.v4();a[n]=e,o[e].recordings.push({recordingId:n}),u.emit("recordingStarted",e,n)},function(n,i,r){if(!o[n])return void t.error("Unknown recording session");var a=_.last(o[n].recordings);o[n].completedRecordings+=1,t.info("Finished recording "+o[n].completedRecordings+" of "+o[n].totalRecordings),u.emit("recordingSaved",a.recordingId),a.duration=r,a.fileName=i,o[n].completedRecordings===o[n].totalRecordings?o[n].recordingState="stopped":o[n].triggerRecording&&(o[n].recordingState="monitoring",o[e].preTriggerTimestamp=new Date,o[e].startTimestamp=0),o[n].triggerRecording?D(n,a.recordingId,void 0,void 0,function(t){o[n].totalRecordings!==o[n].completedRecordings||t||S(n,function(){o[n].totalRecordings===o[n].completedRecordings&&h(n)})}):c&&(a.name?D(n,a.recordingId,void 0,void 0,function(t){t||S(n,function(){h(n)})}):u.deleteRecording(a.recordingId))},function(e){return o[e]?{translationsData:o[e].translationsData}:void t.error("Unknown recording session")},function(n){return o[e]?void(_.isEmpty(n)||u.emit("triggerStateUpdate",n,e)):void t.error("Unknown recording session")})},D=function(e,n,i,r,a){var d=o[e];if(!d)return t.error("Unknow recording session ID"),void a(new Error("Unknown recording session ID"));i&&(d.name=i),r&&(d.description=r);var s=_.find(d.recordings,function(t){return t.recordingId===n}),c=path.join(environment.recordingsPath,path.basename(s.fileName));fs.rename(s.fileName,c,function(t){if(t)a(t);else{s.fileName=c;var e={path:s.fileName,title:d.name,description:d.description,createdBy:d.userName,filesizeInKB:0,createdTime:new Date,durationInSecs:s.duration,models:[{pin:"DY7920V123456",modelGUID:"B2240104-1BD9-4E02-8E93-29712CD77701"}]};fs.stat(s.fileName,function(t,n){e.filesizeInKB=Math.ceil(n.size/1024),g.addRecording(e,function(t,e){s.dataManagerRecordingId=e,a(t)})})}})},S=function(e,n){if(!o[e])return t.error("Unknown recording session"),void n();var i=o[e],r={type:"liveRecording",jobId:i.jobId,title:i.name,activityTime:new Date,status:"Successful",model:[{pin:"DY7920V123456",modelGUID:"B2240104-1BD9-4E02-8E93-29712CD77701"}],totalRecordings:i.recordings.length};r.recordings=_.map(i.recordings,function(t,e){return{boxRecordingId:t.dataManagerRecordingId,currentRecordingNumber:e+1}}),g.addActivity(r,i.userName,function(t,o){r.activityId=o,i.activityId=o,u.emit("recordingSessionStopped",e,r),n()})},h=function(t){var e=_.after(_.size(s),function(){s={},i.deleteSession(t),delete o[t],c&&_.isEmpty(o)&&(clearInterval(r),_.each(d,function(t){n.removeInternalDataPointSubscription(t.subscriptionId,function(){})}))});return _.size(s)<=0?void e():void _.each(s,function(t){n.removeInternalDataPointSubscription(t.subscriptionId,function(){e()})})};this.getSessionInformation=function(){return _.map(o,function(t,e){var n=_.pick(t,["completedRecordings","description","name","preTriggerTime","recordings","recordingState","totalRecordings","totalRecordingTime","trigger","triggerRecording","triggerStates"]);if(n.recordingSessionId=e,n.recordings=_.map(n.recordings,function(t){return{recordingId:t.recordingId,boxRecordingId:t.dataManagerRecordingId,duration:t.duration}}),"stopped"!==n.recordingState){if(n.triggerRecording){var i=new Date,r=1e3*n.preTriggerTime;"started"===n.recordingState?n.currentTime=t.startTimestamp-t.preTriggerTimestamp>r?r+(i-t.startTimestamp):i-t.preTriggerTimestamp:n.currentTime=i-t.preTriggerTimestamp>r?r:i-t.preTriggerTimestamp}else n.currentTime=new Date-t.startTimestamp;n.currentTime/=1e3}return n})},this.startRecordingSession=function(t,e,i,r,a,c){var u=[],g={};if(c.trigger){var f=function(t){switch(g[t.id]=!1,t.type){case"combination":_.each(t.triggers,f);break;case"dataPoint":t.dataPointId=t.dataPointId.toString(),u.push({id:t.dataPointId,unitId:t.unitId})}};f(c.trigger)}o[t]={recordings:[],translationsData:{dataPoints:{},controllers:{},dtcs:{}},totalRecordings:c.reArmCount?c.reArmCount+1:1,completedRecordings:0,triggerRecording:!!c.trigger,triggerStates:g,name:c.name,description:c.description,userName:r,userSessionId:e,jobId:a,trigger:c.trigger,recordingState:"stopped",preTriggerTime:c.preTriggerTime||0,totalRecordingTime:c.length||0,startTimestamp:0,preTriggerTimestamp:0},async.series([l,p,function(e){var r=_.size(u)+_.size(i);return r<=0?void e():(e=_.after(r,e),_.each(u,function(i){return s[i.id]?(m(i.id,o[t]),void e()):void n.createInternalDataPointSubscription(i.id,i.unitId,function(t,n){n||(s[i.id]={unit:i.unitId,subscriptionId:t},I(i.id,i.unitId,!1),e())})}),void _.each(i,function(i,r){if(d[r])return m(r,o[t]),void e();var a=_.first(_.keys(i));n.createInternalDataPointSubscription(r,a,function(t,n){n||(d[r]={unit:a,subscriptionId:t},I(r,a,!0),e())})}))},function(e){v(t,c),e()}])},e.on("dataPointUpdated",function(t){(d[t.dataPointId]&&d[t.dataPointId].unit===t.unitId||s[t.dataPointId]&&s[t.dataPointId].unit===t.unitId)&&(t.dataPointId=t.dataPointId.toString(),i.onDataPointUpdated(t))}),this.onDataPointUpdated=function(t){t.dataPointId=t.dataPointId.toString(),i.onDataPointUpdated(t)},this.onDtc=function(t){_.each(t,function(t){f(t)})},this.onDataPointSubscribed=function(t,e){d[t]||n.createInternalDataPointSubscription(t,e,function(n,i){i||(d[t]={unit:e,subscriptionId:n},I(t,e,!0))})},this.onDataPointUnsubscribed=function(t){d[t]&&n.removeInternalDataPointSubscription(d[t].subscriptionId,function(){delete d[t],i.onDataPointUnsubscribed({id:t.toString()})})},this.addNote=function(t,e){i.addNote(e,a[t])},this.saveRecording=function(t,e,n,i){var r=a[t];D(r,t,e,n,function(t){t||S(r,function(){h(r)})}),i()},this.updateRecording=function(t,e,n,i){var r=a[t];o[r]&&(o[r].name=e,o[r].description=n),i()},this.stopRecording=function(t){i.stopRecording(a[t])},this.deleteRecording=function(t){fs.unlink(_.last(o[a[t]].recordings).fileName,function(t){}),u.emit("recordingSessionStopped",a[t],void 0),h(a[t])},this.deleteRecordingSession=function(t){i.deleteSession(t),u.emit("recordingSessionStopped",t,void 0),h(t)},this.forceStartRecording=function(t){i.forceStart(t)},this.sessionExpired=function(t){if(_.isEmpty(o))return clearInterval(r),void _.each(d,function(t){n.removeInternalDataPointSubscription(t.subscriptionId,function(){})});c=!0;var e=[];_.each(o,function(n,r){n.triggerRecording===!1?i.stopRecording(r):(n.trigger&&"user"===n.trigger.type||t===!1)&&e.push(r)}),_.each(e,function(t){h(t)})},this.shutdown=function(){_.each(o,function(t,e){i.deleteSession(e)}),clearInterval(r)}};util.inherits(RecordingManager,events.EventEmitter),exports.GetRecordingManager=function(t,e,n){return new RecordingManager(t,e,n)};