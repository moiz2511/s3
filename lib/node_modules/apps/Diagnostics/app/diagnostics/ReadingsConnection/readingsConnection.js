!function(){var i=require("events"),n=require("underscore"),e=require("util"),t=require("Environment"),o=require("./Translations.js"),r=require("./Categories.js"),a=require("FileUtility"),c=require("path"),s=require("async"),u=function(e,u,d){i.EventEmitter.call(this);var l=this,f=[],g=["en"],v={},h=!1,p=[],y=r(e,u,d),m={},D="readings_connectivity.json";this.loadData=function(i){h=!1,s.eachSeries(i,function(i,n){return i.modelGUID?void w(i,n):void n()},function(i){F()})};var w=function(i,n){s.waterfall([function(n){var o=c.join(t.readingsDataPath,D);q(i.modelGUID,o,function(i,t,o){return i?(e.error(i.message),void n(i)):void n(void 0,t,o)})},function(n,o,r){var a=c.join(t.categoriesDataPath,n);y.loadCategories(a,i.modelGUID,function(i){return i?(e.error(i.message),e.info("Attempting to return readings data without categories"),void r(i)):void r(void 0,o)})},function(i,n){if(!u)return void n();var o=c.join(t.proceduresDataPath,i);u.loadProcedures(o,function(i){return i?(e.error(i.message),e.info("Attempting to return readings data without procedures"),void n(i)):void n()})}],function(i){n()})};this.getCategoryData=function(i,n,e,t){h===!1?p.push(function(){T(i,n,e,t)}):T(i,n,e,t)},this.buildRecordingDataCategoryTree=function(i,n,e,t,o){h===!1?p.push(function(){y.buildRecordingDataCategoryTree(i,n,e,t,o)}):y.buildRecordingDataCategoryTree(i,n,e,t,o)},this.getDataPointResIds=function(i){h===!1?p.push(function(){y.getDataPointResIds(i)}):y.getDataPointResIds(i)};var F=function(){n.each(p,function(i){i()}),p=[],h=!0},P=function(i,e){n.has(v,i)?e(v[i]):l.loadTranslationFiles(i,function(n){return n?void e():void e(v[i])})},T=function(i,n,e,t){n=n.concat(g),s.eachSeries(n,function(i,n){P(i,function(){n()})},function(o){y.categorizeItems(i,v,n,e,function(i){t(i)})})};this.clearData=function(){e.info("Clearing stored data"),f=[],v={},u.clearProcedures(),y.clearCategories(),h=!1};var E=function(i,n,o){n=n||"Unknown_Model";var r=c.join("/",n+i+"_resources.xml"),a=t.translationsDataPath+r;v[i].loadTranslations(a,function(n){n&&e.error("Failed to load "+i+" translations file: "+r),o()})};this.loadTranslationFiles=function(i,t){return n.has(v,i)?void t(void 0,v[i]):(v[i]=new o(e),void s.each(f,function(n,e){E(i,n,e)},function(n){t(n,v[i])}))},this.lockTranslationsObject=function(i){n.has(v,i)&&(m[i]?m[i]=m[i]+1:m[i]=1)},this.unlockTranslationsObject=function(i){m[i]&&(m[i]=m[i]-1,m[i]<0&&(m[i]=0))},this.getTranslation=function(i,e,t){n.isArray(i)||(i=i?[i]:[]),s.detectSeries(i.concat(g),function(i,n){j(i,e,function(i){n(void 0!==i)})},function(i){i?j(i,e,t):t()})};var j=function(i,n,e){P(i,function(i){i?i.getTranslation(n,e):e()})},q=function(i,t,o){e.info("Attempting to load readings connectivity file: "+t),a.getFileBuffer(t,d,function(r,a){if(r)return e.error("Failed to load readings connectivity file: "+r.message),void o(r);e.info("Successfully read readings connectivity file "+t+" from the disk"),e.info("Attempting to parse through readings connectivity data");try{var c=JSON.parse(a)}catch(i){return e.error("Failed to parse through readings connectivity file: "+i.message),void o(i)}if(e.info("Successfully parsed through readings connectivity file "+t),!c.models||!c.readings_applications)return void o(new Error("Encountered missing property value while accessing readings connectivity data"));var s=n.indexBy(c.models,"guid"),u=c.readings_applications;if(!s[i])return void o(new Error("Model GUID not found, unable to determine which connectivity file to load"));var d,l;if(!s[i].logicalbus)return void o(new Error("Encountered missing property value while accessing readings connectivity data"));var g=n.filter(s[i].logicalbus,function(i){return!n.isUndefined(i.readings_application_id)}),h=n.pluck(g,"readings_application_id"),p=n.indexBy(u,"id");n.each(h,function(i){p[i]&&(d=p[i].categoryFile,l=p[i].proceduresFile,f.push(p[i].resourceFilePrefix),n.each(v,function(n,e){E(e,p[i].resourceFilePrefix,function(){})}))}),e.info("Finished parsing readings connectivity data"),o(void 0,d,l)})}};e.inherits(u,i.EventEmitter),module.exports=function(i,n,e){return new u(i,n,e)}}();