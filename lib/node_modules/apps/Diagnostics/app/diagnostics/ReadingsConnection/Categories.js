!function(){var e=require("FileUtility"),t=require("xml2js"),i=(require("events"),require("underscore")),r=new t.Parser({mergeAttrs:!0}),o=require("async"),n=function(t,n,a){var c,s=this,u={};s.loadCategories=function(o,n,c){t.info("Attempting to load categories file: "+o),e.getFileBuffer(o,a,function(e,a){return e?(t.error("Failed to load categories file: "+e.message),void c(e)):i.isEmpty(a)?(e=new Error("Empty categories file"),t.error("Empty categories file",e),void c(e)):(t.info("Successfully loaded categories file "+o),void r.parseString(a.toString("utf8"),function(e,i){return e?(t.error("Failed to parse through categories file",e),void c(e)):i?i.categories?(t.info("Successfully parsed through categories file "+o),u[n]=i,void c()):void c(new Error("Encountered missing object property value while building categories data")):(e=new Error("No data in category file"),t.error("Parsing the category file returned no data",e),void c(e))}))})},s.clearCategories=function(){u={}},s.categorizeItems=function(e,t,r,a,c){o.series({dataPointCategories:function(i){s.buildRecordingDataCategoryTree(t,r,e.getAllDataPoints(),a,function(e){i(null,e)})},procedureCategories:function(e){s.buildProcedureCategoryTree(t,r,a,function(t){e(null,t)})},dataPoints:function(t){s.getDataPointResIds(function(n,a){o.map(i.toArray(e.getAllDataPoints()),function(e,t){g(r,a[e.dataPointUniqueName],e.dataPointUniqueName,function(i){var r={controller:e.controllerId,id:e.dataPointId,name:i,unitSet:e.unitSet,enumDetails:e.enumDetails,dataPointUniqueName:e.dataPointUniqueName};t(null,r)})},function(e,i){t(e,i)})})},procedures:function(e){l("procedures",function(t,a){o.map(i.toArray(n.getProcedures()),function(e,t){g(r,a[e.id],e.id,function(i){var r={controller:e.controller?e.controller.id:void 0,id:e.id,name:i};t(null,r)})},function(t,i){e(t,i)})})}},function(e,t){c({dataPointCategories:t.dataPointCategories,procedureCategories:t.procedureCategories,dataPoints:t.dataPoints,procedures:t.procedures})})};var d=function(e,t,r){return i.chain(e).map(function(e){var o=e&&i.first(e.id);return e.accessLevel=e.accessLevel||1,o&&t[o]&&e.accessLevel<=r?o:void 0}).compact().value()},f=function(e,t,r,n,a,c){return e?void o.map(e,function(e,o){var c=d(e.item,r,n);f(e.category,t,r,n,a,function(r,n){i.isEmpty(c)&&i.isEmpty(n)?o(null,void 0):g(t,i.first(e.resId),i.first(e.name),function(e){var t={name:e,categories:n};t[a]=c,o(null,t)})})},function(e,t){c(e,i.compact(t))}):void c(null,[])};this.buildRecordingDataCategoryTree=function(e,t,r,o,n){c=e;var a=[],s=function(){n(a)},l=i.after(i.size(u),s);i.size(0===u)&&s(),i.each(u,function(e,n){var c,s;e&&e.categories&&e.categories.datapoints&&i.first(e.categories.datapoints)&&(c=i.first(e.categories.datapoints).category,s=i.first(e.categories.datapoints).item),f(c,t,r,o,"dataPoints",function(e,t){var c=d(s,r,o);i.isEmpty(t)&&i.isEmpty(c)||a.push({name:n,dataPoints:c,categories:t}),l()})})},this.buildProcedureCategoryTree=function(e,t,r,o){c=e;var a=[],s=function(){o(a)},l=i.after(i.size(u),s);i.size(0===u)&&s(),i.each(u,function(e,o){var c,s;e&&e.categories&&e.categories.procedures&&i.first(e.categories.procedures)&&(c=i.first(e.categories.procedures).category,s=i.first(e.categories.procedures).item),f(c,t,n.getProcedures(),r,"procedures",function(e,t){var c=d(s,n.getProcedures(),r);i.isEmpty(t)&&i.isEmpty(c)||a.push({name:o,procedures:c,categories:t}),l()})})};var l=function(e,t){var r={},o=function(e){i.each(e.item,function(e){r[i.first(e.id)]=i.first(e.resId)}),i.each(e.category,o)};i.each(u,function(t){t.categories&&t.categories[e]&&o(i.first(t.categories[e]))}),t(void 0,r)};this.getDataPointResIds=function(e){l("datapoints",e)};var g=function(e,t,i,r){c||r(i),o.detectSeries(e,function(e,i){c[e]?c[e].getTranslation(t,function(e){i(e?!0:!1)}):i(!1)},function(e){e&&c[e]?c[e].getTranslation(t,function(e){r(e||i)}):r(i)})}};module.exports=function(e,t,i){return new n(e,t,i)}}();