"use strict";var DataManagerApp=require("apps/DataManager/Client"),_=require("underscore"),async=require("async"),utility=require("FileUtility"),xml2js=require("xml2js"),offlineConnectionUtils=require("../cal/offlineConnectionUtils.js");module.exports=function(t,e){var n=DataManagerApp.create(t),i=e.webServer,a=new offlineConnectionUtils.OfflineConnectionUtils(t,e),o={},r=function(t,e,n){var i={expecting:null,callback:function(){try{o[t.getId()].shift()}catch(t){}n.apply(void 0,arguments)},dataPoints:[],begin:function(t,e,n){return _.isEmpty(t)?0===n?void i.callback(void 0,void 0):void(i.expecting=n):(i.callback(t),void delete i.callback)},each:function(t){i.dataPoints.push(t),i.expecting-=1,0===i.expecting&&i.callback(void 0,i.dataPoints)}},a=o[t.getId()]||[];a.push(i),o[t.getId()]=a,t.queryDataPoint(e)},c=function(){try{var t=o[this.getId()];t[0].begin.apply(void 0,arguments)}catch(t){}},s=function(){try{var t=o[this.getId()];t[0].each.apply(void 0,arguments)}catch(t){}},l=function(e,n,i,o,l){return _.isEmpty(n)?void l(null,{}):void async.waterfall([function(t){a.connectOffline(e,i,o,{onDataPointQueryBegin:c,onDataPointQuery:s},function(e,n){t(e,n)})},function(e,i){var a={};async.each(n,function(t,n){r(e,t,function(e,i){if(e)return void n(e);var o=_.first(i);o&&(a[t]={name:o.getName(),units:o.getUnitName(),unitSets:o.getUnitSet()}),n()})},function(n){t.debug("Disconnecting from offline connection"),e.disconnect(),i(n,a)})}],function(t,e){l(t,e)})},u=function(e,n){return e?(t.debug("Unzipping snapshots"),void utility.extractZipToBuffers(e,[],function(e,i){if(e||!i)return t.error("Failed to unzip snapshots"),void n(e,{});var a={};async.each(_.values(i),function(t,e){var n=new xml2js.Parser;n.parseString(t.toString("utf8"),function(t,n){if(t)return void e(t);var i=n&&n.snapshots&&_.first(n.snapshots.snapshot),o=i&&_.first(i.dtc);o=o&&o.$;var r=i&&_.first(i.controller);r=r&&r.$;var c=i&&_.first(i.snapshotOccurrenceInfo);c=c&&c.$;var s=i&&_.first(i.snapshotParameters),l=_.map(s.parameter,function(t){var e=t.$;if(e)return{displayName:e.name,units:e.units,value:e.value}});return l=_.compact(l),o&&r?(c?a[o.code+r.controllerId]={cumulativeDuration:c.cumulativeDuration,occurrenceTimes:{first:c.firstOccurrence,latest:c.latestOccurrence},dataPoints:l}:a[o.code+r.controllerId]={dataPoints:l},a[r.name+" "+o.code+r.controllerId]=a[o.code+r.controllerId],void e()):void e()})},function(e){e&&t.error("Failed to parse the snapshots",e),n(e,a)})})):void n(null,[])};i.get("/SAWeb/services/DTCInfo/:id/:language",function(t,e){var i=t.headers["x-user"];async.parallel({activity:function(e){var i=_.pick(t,"protocol","headers","body");n.getActivity(t.params.id,i,e)},rawActivity:function(e){n.getNonExtendedActivity(t.params.id,e)},snapshotsFilePath:function(e){n.getSnapshotFilePath(t.params.id,e)}},function(n,a){if(n)return void e.send(500);var o=a.activity,r=a.rawActivity;return o&&r?void u(a.snapshotsFilePath,function(n,a){a=a||{};var c=_.chain(a).pluck("dataPoints").flatten().pluck("displayName").uniq().value(),s=t.query&&t.query.lang?t.query.lang.split(","):[],u=s.concat([t.params.language,"en"]);l(i,c,r.connectionXml,u,function(n,i){_.each(a,function(t){t&&(t.dataPoints=_.map(t.dataPoints,function(t){if(t){var e=i[t.displayName];if(e){var n=t.value,a=t.units;t.displayName=e.name||t.displayName,t.values={value:{unit:a,value:n}},t.unitSet=e.unitSets||{metric:{},alt:{},english:{}}}return t}}))});var c={relatedActivity:o,dtcSetId:o.id,codes:[]};r.controllers=_.indexBy(r.controllers,"id"),c.codes=_.map(r.dtcs,function(t){var e=r.controllers[t.controllerId];return{code:t.code,dtcCode:t.code,controllerTla:e.details.tla,displayCode:t.code,count:t.details.count,status:t.details.status,controller:{tla:e.details.tla,bus:e.details.bus,sourceAddress:e.details.sourceAddress,id:t.controllerId,controllerDetailId:e.controllerDetailId},snapshot:a[t.code+t.controllerId]}});var s=t.query&&t.query.models&&t.query.models.split("+");s=_.map(s,function(t){return{modelGUID:_.last(t.split(":"))}}),c.connectionXml=r.connectionXml,e.send(c)})}):void e.send(404)})})};