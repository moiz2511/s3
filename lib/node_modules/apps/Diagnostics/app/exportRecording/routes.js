"use strict";var calWrapper=require("CAL"),fs=require("fs"),mkdirp=require("mkdirp"),DataManagerApp=require("apps/DataManager/Client"),async=require("async"),path=require("path"),_=require("underscore"),uuid=require("uuid"),calUtils=require("../CAL/utils.js"),fileUtility=require("FileUtility"),events=require("events"),Zip=require("zip-stream"),acceptsCheck=require("Middleware/acceptsCheck.js"),environment=require("Environment");module.exports=function(e,n){var r=n.webServer,i=DataManagerApp.create(e),t=new events.EventEmitter,o=calUtils.getConnectionCallbackHandler("recordings"),c=(calUtils.getConnectionCallbackHandler("export"),function(e){return _.chain(e).map(function(e){return n.config.calLanguageMap[e.toUpperCase()]}).compact().first().value()}),a=function(n){_.each(n,function(n){e.error("CAL error "+n.code+": "+n.message)})},u=function(e,n){var r=this,i=o.getCallback(r),c=[],a=function(r){c.push(r),_.size(c)===n&&(t.removeListener("recording",a),i(e,c))};if(i)return 0===n?void i(e,c):void t.on("recording",a)},d=function(e){t.emit("recording",e)};r.get("/SAWeb/services/recordings/:id/export",function(r,t){var g=r.query.format,s=r.query.unit;if(e.debug("Received request to export recording to "+g),!g)return void t.send(400);switch("metric"!==s&&"english"!==s&&"alt"!==s&&(s="metric"),s=calWrapper.units[s],g.toLowerCase()){case"dpv":g=calWrapper.exportTypes.csv;break;case"can":g=calWrapper.exportTypes.can;break;default:return void t.send(400)}var l=[];r.query&&r.query.languages&&_.isArray(r.query.languages)&&(l=r.query.languages),l.push("en");var p=r.params.id,f=[];async.auto({getRecording:function(n){e.debug("Getting recording information from data manager."),i.getRecording(p,function(r,i){return r?void n(r):i&&i.path?void n(void 0,i):(e.error("Recording path missing!"),void t.send(404))})},cleanRecordingName:["getRecording",function(e,n){var r=n.getRecording.title||uuid.v4(),i=fileUtility.removeInvalidFileNameChars(r);e(void 0,i)}],connectWithCal:["getRecording",function(r,i){e.debug("Building recording playback connection xml");var t=c(l);e.debug("Using "+t+" as the language to connect.");var o=calUtils.getRecordingConnectionXml(i.getRecording.path,t);e.debug("Starting a recording playback connection with CAL"),n.connect(o,{onBeginRecordings:u,onRecording:d},function(n,i,t){return!n&&t&&t.isConnected()?(f.push(function(){e.debug("Disconnecting from offline connection"),t.disconnect()}),e.debug("Connected to CAL",i),void r(void 0,t)):(e.error("Failed to connect to CAL"),a(i),void r(new Error("Failed to connect")))})}],makeTempDir:["cleanRecordingName","connectWithCal",function(n,r){var i=path.join(environment.userTempPath,uuid.v4()),t=path.join(i,r.cleanRecordingName+".fdp");e.debug("Making temporary folder at "+t),mkdirp(t,function(r){r||f.push(function(){e.debug("Deleting directory at "+i),fileUtility.deleteDirectoryOrFile(i,function(n){n&&e.error(n)})}),n(r,t)})}],getRecordingConnections:["connectWithCal","makeTempDir",function(n,r){e.debug("Getting recording connections"),o.callAction(r.connectWithCal,function(e,r){a(e),_.isEmpty(r)?n(new Error("Could not get recording connections")):n(void 0,r)})}],exportRecording:["getRecordingConnections",function(n,r){e.debug("Export recording");var i=[],t=[],o=_.after(r.getRecordingConnections.length,function(){a(t),_.isEmpty(i)?n(new Error("Failed to export recording")):n(void 0,i)}),c=function(e,n){t=e,i.push(n),o()};_.each(r.getRecordingConnections,function(e){e.setEventCallbacks({onRecordingExported:function(n,r){c(n,r),e.disconnect()},onUnitsSet:function(){e.getDataPoints()},onDataPoints:function(){e.exportRecording(g,r.makeTempDir)}}),e.setUnits(s)})}]},function(n,i){var o=function(){_.each(f,function(e){e()})};if(n)return e.error("An error occurred while exporting a recording",n),t.send(500,n.message),void o();var c=i.cleanRecordingName+"_"+r.query.format,a=new Zip;a.on("error",function(n){e.err(n),o()}).on("end",function(){e.debug("Successfully sent zipped file to the client"),o()}),t.writeHead(200,{"Content-Type":"application/zip","Content-disposition":"attachment; filename="+c+".zip"}),a.pipe(t),fileUtility.compressDirectory(a,_.first(i.exportRecording),c,function(n,r){n&&(e.error(n),t.end(),o()),r&&r.finalize()})})})};