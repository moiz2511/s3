"use strict";var _=require("underscore"),async=require("async"),calUtils=require("../cal/utils.js"),events=require("events"),CAL=require("CAL");module.exports=function(e,n){var t=n.webServer,r=n.dataManagerClient.create(e),o=new events.EventEmitter,i=function(e){return _.chain(e).filter(function(e){return n.config.calLanguageMap[e.toUpperCase()]}).first().value().toLowerCase()},c=calUtils.getConnectionCallbackHandler("procedures"),a=calUtils.getConnectionCallbackHandler("dataPoints"),u=function(e,n){var t=a.getCallback(this);t&&t(e,n)},s=function(e,n,t){var r=this,i=c.getCallback(r);if(i){var a={},u={},s=function(e,n){a[n.getId()]=n,u[n.getId()]=u[n.getId()]||[],u[n.getId()].push(e),d()},d=_.after(n,function(){o.removeListener("procedure",s),i(void 0,u,a)});return 0===n?void i(void 0,u,a):void(e&&!_.isEmpty(e)?i(e):o.on("procedure",s))}},d=function(e,n){o.emit("procedure",e,n)};t.get("/SAWeb/services/diagnostics/dataPointsAndProceduresReference",function(t,o){var l=!1,g=[],f=function(e){l?e():g.unshift(e)},v=function(){e.debug("Cleaning up offline connection data"),_.each(g,function(e){e()})},C=t.headers["x-user"],p=[],m=[];return t.query&&t.query.languages&&_.isArray(t.query.languages)&&(p=t.query.languages),p.push("en"),t.query&&t.query.models&&_.isArray(t.query.models)?(m=_.map(t.query.models,function(e){return{modelGUID:e}}),void async.auto({getConnectionXml:function(t){e.debug("Build offline connection XML"),n.cal.buildOfflineConnectionXml(C,i(p),m,function(e,n){t(e,n)})},connectOffline:["getConnectionXml",function(t,r){e.debug("Connect to CAL"),n.connect(r.getConnectionXml,{onDataPoints:u,onBeginProcedures:s,onProcedure:d},function(n,r,o){return!n&&o&&o.isConnected()?(f(function(){e.debug("Disconnecting from offline connection"),o.disconnect()}),void t(void 0,o)):void t(new Error("Failed to connect ot CAL"))})}],getDataPoints:["connectOffline",function(n,t){e.debug("Getting DataPoints"),a.callAction(t.connectOffline,function(t,r){if(t&&!r)return void n(new Error("Failed to Get Data Points"));e.debug("Got dataPoints"),r=r||[];var o={},i={};_.each(r,function(e){var n=e.dataPoint,t=e.category,r=n.getName();if(t&&(o[t.getId()]=t,t.getType()===CAL.categoryType.normal)){var c=i[t.getId()]||[];c.push(r),i[t.getId()]=c}});var c=calUtils.buildCategoryTree(i,o);n(void 0,c)})}],getProcedures:["connectOffline",function(n,t){e.debug("Getting Procedures"),c.callAction(t.connectOffline,function(t,o,i){if(e.debug("Got procedures"),t)return _.each(t,function(n){e.error("CAL error "+n.code+": "+n.message)}),void n(new Error("Failed to get procedures"));var c=_.object(_.keys(o),_.map(o,function(e){return _.map(e,function(e){return e.getName()})}));r.getCalComponentsList(function(t,r){if(t||!r)return response.send(500,"Internal Server Error"),void e.error("An error occurred while getting the CalComponentsToExcludeForCustomer list",t);var o=r;c=_.mapObject(c,function(e,n){return _.each(e,function(n){_.each(o,function(t){n==t&&(e=_.without(e,n))})}),e});var a;try{a=calUtils.buildProceduresCategoryTree(c,_.values(i)),n(void 0,a)}catch(e){n(new Error("Failed to parse procedures categories"))}})})}]},function(n,t){if(l=!0,n)e.error("An error occurred while retrieving diagnostics reference data",n),o.send(500,n);else{e.info("Successfully retrieved diagnostics reference data");var r={dataPointsList:t.getDataPoints,tests:t.getProcedures&&t.getProcedures.tests?t.getProcedures.tests:[],interactiveCalibrations:t.getProcedures&&t.getProcedures.interactive?t.getProcedures.interactive:[],dataInputCalibrations:t.getProcedures&&t.getProcedures.data_input?t.getProcedures.data_input:[]};o.set("cache-control","max-age=3600"),o.set("vary","cookie"),o.send(r)}v()})):void o.send(400)})};