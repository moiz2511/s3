!function(){function e(e,l,u,d){var f=t.create(e),v=function(t,u,d,v,p,m){v=n.map(v,function(e){return{model:e.modelGUID,pin:e.modelPIN}}),o.waterfall([function(e){l.saveSnapshots({snapshotCapture:!0},function(t,n){e(null,n)})},function(t,o){if(!t||n.isEmpty(t))return e.info("No snapshots saved for live activity"),void o();var l=r.v4()+".zip",d=s.join(c.temporarySnapshotsPath,l),f=s.join(c.snapshotDataPath,l);i.compressFiles(t,d,function(r){if(n.each(t,function(e){a.unlink(e,function(e){})}),r)return e.error("Failed to zip snapshots for a live activity.",r),void o();var i={type:"snapshots",userId:u,models:v,fileName:l,filePath:f,currentFilePath:d};o(null,i)})}],function(r,o){m=n.map(m,function(e){return{controllerId:e.controllerId,code:e.dtcCode,networkType:"J1939",details:{count:e.j1939DtcUpdateDetails.count,status:0===e.j1939DtcUpdateDetails.status?"stored":"active"}}}),p=n.map(p,function(e){var t={id:e.controllerId,controllerDetailId:e.controllerDetailId,resId:e.resId,identifier:e.identifier},n=function(e){switch(e){case"CAN1":return 1;case"CAN2":return 0;case"CAN3":return 2;default:return}};switch(e.networkType){case 1:t.networkType="J1939",t.details={tla:e.j1939ControllerDetails.tla,bus:n(e.j1939ControllerDetails.bus),sourceAddress:e.j1939ControllerDetails.sourceAddress}}return t});var i={type:t,activityTime:new Date,jobId:d,equipment:v,controllers:p,dtcs:m,connectionXml:l.getConnectionXml(),fileMetaData:o?[o]:[]};f.addActivity(i,u,function(t,n){t&&e.error(t.message),o&&o.currentFilePath&&a.unlink(o.currentFilePath,function(e){})})})};d.on("calConnected",function(e,t,r,o,i){if(!e){var c,s,a=n.after(2,function(){l.removeListener("disconnected",f),v("connectedLive",i,o,r,c,s)}),u=function(e){c=e,a()},d=function(e){s=e,a()},f=function(){a=n.noop,l.removeListener("controllers",u),l.removeListener("dtcs",d)};l.once("controllers",u),l.once("dtcs",d),l.once("disconnected",f)}}),d.on("dtcsCleared",function(e,t,n){var r=function(r){l.removeListener("disconnected",o),v("liveClearRetrieveDtc",n,t,e,l.getKnownControllers(),r)},o=function(){l.removeListener("dtcs",r)};l.once("dtcs",r),l.once("disconnected",o)}),d.on("dtcsRefreshed",function(e,t,n,r){v("liveRetrieveDtc",r,n,t,l.getKnownControllers(),e)})}var t=require("../../../DataManager/Client/lib/index.js"),n=require("underscore"),r=require("uuid"),o=require("async"),i=require("FileUtility"),c=require("Environment"),s=require("path"),a=require("fs");exports.createLiveDiagnosticActivities=e}();