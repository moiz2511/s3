var path=require("path"),events=require("events"),async=require("async"),_=require("underscore"),environment=require("Environment"),resourceClient=require("apps/ExclusiveResourceManager/Client"),oneClient=require("apps/OneManager/Client"),CAL=require("./CAL.js"),calWrapper=require("CAL"),_cal,_initializationState="uninitialized",_calEvents=new events.EventEmitter,_connections={},_initialized=function(n,e){_initializationState=n===calWrapper.initializedStatus.calInitializedOk?"initialized":"failed",_calEvents.emit("initialized",_initializationState,e)},_uninitialized=function(){_calEvents.emit("uninitialized"),_cal.shutdown()},_connectionCallbacks=[],_connected=function(n,e){var i=_connectionCallbacks.shift();if(e){var t=e.disconnect;e.disconnect=function(){delete _connections[this.getId()],t.apply(this,arguments)};var a=_.extend({},i.eventCallbacks,{onDisconnected:function(){_calEvents.emit("disconnected",this),i.eventCallbacks.onDisconnected&&i.eventCallbacks.onDisconnected.apply(this,arguments)}});e.setEventCallbacks(a)}e&&e.isConnected()&&(_connections[e.getId()]=e),_calEvents.emit("connected",e),i.callback(void 0,n,e)},_disconnect=function(n,e){var i=function(t){n.getId()===t.getId()&&(_calEvents.removeListener("disconnected",i),e())};_calEvents.on("disconnected",i),n.disconnect()},setup=function(n,e){var i=resourceClient.create(n,e.config.name),t=oneClient.create(n),a=function(n,e,i){var a=function(){_connectionCallbacks.push({callback:i,eventCallbacks:e}),t.startXvdsServer(function(){_cal.connect(n)})},c=function(){i(new Error("Cal Failed to initialize"))};switch(_initializationState){case"initialized":return void a();case"failed":return void c();case"uninitialized":return void _calEvents.once("initialized",function(n){"initialized"===n?a():c()})}};_cal=new calWrapper.CAL,_calEvents.on("initialized",function(e,i){_.each(i,function(e){n.error("CAL error "+e.code+": "+e.message)}),n.info("The CAL has been initialized, state: ",e)}),_calEvents.on("uninitialized",function(){n.info("The CAL has been uninitialized")}),e.appEvents.once("stop",function(){async.parallel([function(n){async.eachSeries(_.values(_connections),function(n,e){_disconnect(n,function(){e()})},function(){n()})},function(n){async.eachSeries(_connectionCallbacks,function(n,e){n.callback=function(n,i,t){t&&t.isConnected()&&_disconnect(t,function(){e()})}},function(){n()})}],function(){"initialized"===_initializationState&&_.defer(function(){_cal.uninitialize()})})});var c=function(e){n.error("An uncaught exception was thrown in a CAL callback: ",e?e.message:void 0,e?e.stack:void 0,e)};e.appEvents.once("start",function(){_cal.setCalEventsCallbacks({onInitialized:_initialized,onUninitialized:_uninitialized,onConnected:_connected,onUncaughtError:c}),n.info("Initializing the CAL..."),_cal.initialize(environment.calConfig)||(_initializationState="failed",n.error("Failed to create the CAL object. Do you have the CAL installed?"))}),e.connect=a;var o=CAL(n,a,e.tarIndexManager,e.appEvents,i);e.cal=o};module.exports=setup;