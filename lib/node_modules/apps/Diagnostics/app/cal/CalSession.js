"use strict";var events=require("events"),uuid=require("uuid"),_=require("underscore"),util=require("util"),async=require("async"),path=require("path"),xmldom=require("xmldom"),environment=require("Environment"),recordingSession=require("./RecordingSessionManager.js"),DataManagerApp=require("apps/DataManager/Client"),frontEndServerClient=require("apps/FrontEndServer/Client"),Zip=require("zip-stream"),fs=require("fs"),utility=require("FileUtility"),calWrapper=require("CAL"),makeError=function(e,n){return e.code=n,e},SessionManager=function(e,n,r){events.EventEmitter.call(this);var t=this,i=frontEndServerClient.create(e),o=i.getNamespaceWrapper("/diagnostics"),s=null,a=void 0,c=DataManagerApp.create(e),d={},u=!1,g={},p=function(r){var i=_.values(d[r].subscriptions);delete d[r];var o=function(){_.isEmpty(d)&&_.isEmpty(g)&&t.calDisconnect(),e.info("Session with ID "+r+" has expired")};i.length>0?async.each(i,function(e,r){n.unsubscribeToDataPoint(e,function(){r()})},o):o()};o.on("disconnected",function(n){var t=_.map(d,function(e,r){if("/diagnostics#"+e.socketSessionId===n)return r});t=_.compact(t),_.isEmpty(t)||(_.each(t,function(n){e.debug("Scheduling diagnostics session with id "+n+" for cleanup"),d[n].socketSessionId=void 0}),_.delay(function(){_.each(t,function(e){p(e)})},r.config.sessionTimeout).unref())}),this.createNewSession=function(e,n,r,t,i,o){if(!t)return void o(new Error("Need a socket ID to create a diagnostics session"));var s=this,a=uuid.v4();d[a]={subscriptions:{},socketSessionId:t,languages:i||[]},r&&d[r]?async.each(_.values(d[r].subscriptions),function(e,n){s.createDataPointSubscription(a,e,function(){n()})},function(){s.getSessionInformation(a,[],o)}):this.getSessionInformation(a,[],o)},this.updateLanguages=function(e,n){d[e]&&(d[e].languages=n||[])},this.terminateSession=function(e,n){return d[e]?(p(e),void n()):void n(new Error("Invalid SessionId"))},this.isSessionActive=function(e){return!!d[e]},this.clearDtcs=function(e,r,i,o){n.clearDtcs(o,function(){t.getDtcs(!0,e)})},this.getDtcs=function(e,r){n.getDtcs(e,function(e,n){b(r,"dtcs",n)})},this.getControllers=function(e,r){n.getControllers(e,function(e,n){b(r,"controllersUpdated",n)})},this.getReadingsData=function(e){async.parallel({dataPoints:function(e){n.getDataPoints(function(n,r){e(void 0,r)})},procedures:function(e){n.getProcedures(function(n,r){e(void 0,r)})}},function(n,r){if(d[e]){var t=_.isEmpty(r.procedures)?{}:{procedures:r.procedures.procedures,procedureCategories:r.procedures.procedureCategories},i=_.extend({},r.dataPoints,t);b(e,"readingsData",i)}})};var l=function(e){return _.chain(e).values().sortBy("version").map(function(e){return _.pick(e,"region","content")}).value()},f=function(e){return _.map(e,function(e){var n=l(e.regions);return{procedureSessionId:e.sessionId,procedureId:e.procedureId,procedureType:e.procedureType,updates:n}})};this.getSessionInformation=function(e,r,t){var i={sessionId:e,recordingSessions:s?s.getSessionInformation():a||[],subscriptions:[],logBus:[],isSavingSnapshots:u,procedureSessions:f(g)};i.subscriptions=_.map(d[e].subscriptions,function(e,r){return _.extend(n.getDataPoint(e),{subscriptionId:r})}),_.extend(i,n.getConnectionInfo()),n.getConnectionLogBus(function(e,n){t(null,_.extend(i,{logBus:n}))})},n.on("dataPointUpdated",function(e){_.each(v(e.id),function(n){var r=n.sessionId,t=n.subscriptionId;b(r,"dataPointUpdated",_.extend(_.clone(e),{subscriptionId:t}))}),t.emit("checkUpdates")});var v=function(e){return _.flatten(_.map(d,function(n,r){return _.compact(_.map(n.subscriptions,function(n,t){if(n===e)return{subscriptionId:t,sessionId:r}}))}))};n.on("dtcUpdate",function(e){_.each(d,function(n,r){b(r,"dtcsUpdated",[e])})}),n.on("clearingCodes",function(e){I("clearingCodes",e?e.getId():void 0)}),n.on("triggerExecutionStarted",function(){if(s){s.setRecordingStarted();var e=s.getMessage("recordingStarted");I(e.message,e.data)}}),n.on("triggerExecutionComplete",function(){if(s){s.recordingCompleted(),s.isUserTriggerSession()||s.saveRecording({},h);var e=s.getMessage("recordingStopped");I(e.message,e.data)}}),n.on("triggerMet",function(e){if(s&&!s.isUserTriggerSession()){s.updateTriggerState(e,!0);var n=s.getMessage("triggerStates");I(n.message,n.data)}}),n.on("triggerUnMet",function(e){if(s&&!s.isUserTriggerSession()){s.updateTriggerState(e,!1);var n=s.getMessage("triggerStates");I(n.message,n.data)}});var m=function(n){e.info("Completed recording session");var r=s.getMessage("recordingSessionStopped");n&&(r.data.activity=n),I(r.message,r.data),n&&(a=s.getSessionInformation()),s=null},h=function(n){return n&&e.error(n),s.isRecordingSavingQueueEmpty()?0===s.getNumberOfSavedRecordings()&&0===s.getNumberOfRecordingsInQueue()?void m(null):void(0===s.getNumberOfRecordingsInQueue()&&S()):void e.info("Waiting for next completed recording to be saved")},S=function(){e.info("Finishing recording session with saved recordings"),s.generateAndSaveActivity(function(n,r){return n?(e.error(n.message),void m(s.getPseudoActivity())):void m(r)})},I=function(e,n){o.broadcast("update",{message:e,data:n})},b=function(e,n,r){if(d[e]){var t=d[e].socketSessionId;t&&o.send(t,"update",{message:n,data:r})}};n.on("connected",function(r,t,i){if(r&&r.code===n.errors.resourceClaimError.code)var o={error:r.code,blockingApp:r.blockingApp};else o={error:r&&r.code,id:t,models:i};n.getConnectionLogBus(function(n,r){n&&e.error(n.message,n),o.logBus=r,I("connected",o)})}),n.on("disconnected",function(){R(),g={},I("disconnected")}),n.on("unitsSet",function(e){I("unitsSet",{units:e})}),n.on("connecting",_.partial(I,"connecting")),n.on("disconnecting",_.partial(I,"disconnecting")),n.on("interrupted",_.partial(I,"interrupted")),n.on("recovered",_.partial(I,"recovered"));var y=function(e){switch(e){case void 0:case calWrapper.procedureStatus.success:return"completed";case calWrapper.procedureStatus.aborted:return"cancelled";case calWrapper.procedureStatus.failed:return"failed";default:return"failed"}},D=function(n,r,t,i){var o=n.recordingFileLocation;async.waterfall([function(n){fs.stat(o,function(r,t){return r?(e.error("Unable to get file stats for "+o),void n(r)):void n(void 0,o,utility.convertBytesToKiloBytes(t.size))})},function(e,i,o){var s=path.extname(n.recordingFileLocation),a=path.basename(n.recordingFileLocation,s),c={path:e,title:a,description:n.recordingDescription,createdBy:t,filesizeInKB:i,completedTime:new Date,durationInSecs:void 0,models:r.models,recordingId:uuid.v4()};o(void 0,c,a)}],function(n,t,o){n?e.error("Unable to add recording to data manager. File remains in the temporary recording location."):r.artifacts.push({type:"recording",name:o,recordingData:t}),i(n)})};this.startProcedure=function(r,t,i,o,s,a){var u=this;if(!d[r])return e.error("A request to start a procedure was received, but with an invalid session ID"),void a(makeError(new Error("no such session"),this.startProcedure.missingSession));if(0==_.isEmpty(g))return e.error("A request to start a procedure was received, but a procedure is already in progress."),void a(makeError(new Error("procedure already in session"),this.startProcedure.procedureAlreadyStarted));var p={sessionId:uuid.v4(),procedureType:i,procedureId:t,version:0,regions:{},lastProcedureStatus:void 0,engine:void 0,artifacts:[],models:n.getConnectionInfo().models||[],jobId:s};g[p.sessionId]=p,a(void 0,p.sessionId);var l=function(){e.debug("Procedure started.")},f=function(e,n,r){var t=p.version+1;p.version=t,p.regions[n]={version:t,region:n,content:r},I("updateRegion",{procedureSessionId:p.sessionId,region:n,content:r})},v=function(e,n){I("procedureStatus",{procedureSessionId:p.sessionId,status:n}),p.lastProcedureStatus=n,u.saveProcedureState(r,p.sessionId,o,function(){})},m=function(n,r){console.log("onProcedureData",arguments);var t=(new xmldom.DOMParser).parseFromString(r),i=t.getElementsByTagName("param"),s=_.chain(i).map(function(e){return[e.getAttribute("name"),e.getAttribute("value")]}).object().value();_.has(s,"recordingFileLocation")&&_.has(s,"recordingDescription")&&_.has(s,"recordingDuration")&&(e.info("Received an IDM recording message from a procedure. Processing it."),D(s,p,o,function(){e.debug("IDM recording processed.")}))},h=function(r,i){e.info("Procedure ended.");var a=n.getProcedureKey(t);if(console.log(a),"Internal Data Monitor"===a)var d=_.where(p.artifacts,{type:"recording"}),u=_.first(d),l=_.map(d,function(e){var n=e.recordingData,r=uuid.v4()+".zip";return _.extend({},n,{type:"recording",filePath:path.join(environment.recordingsPath,r),fileName:r,currentFilePath:e.recordingData.path})}),f={type:"liveIdmRecording",jobId:s,title:u?u.name:"",description:(u?u.recordingData.description:"")||"",activityTime:new Date,disposition:y(p.lastProcedureStatus),equipment:_.map(p.models,function(e){return{pin:e.modelPIN,modelGUID:e.modelGUID}}),totalRecordings:_.size(d),fileMetaData:l,recordingDetails:{totalRecordings:1}};else var v=["xml"],f={type:"liveTestCalibration",name:n.getProcedureName(t),jobId:s,procedureType:"test",disposition:y(p.lastProcedureStatus),resultPages:_.filter(p.artifacts,function(e){return _.contains(v,e.type)}),equipment:_.map(p.models,function(e){return{modelGUID:e.modelGUID,pin:e.modelPIN}})};c.addActivity(f,o,function(e,n){console.log("Activity created")}),I("procedureEnded",{procedureSessionId:p.sessionId,errors:r}),delete g[p.sessionId]};n.startProcedure(t,l,f,v,m,h,function(n,r,o){return e.info("Procedure initialized."),I("procedureStarted",{procedureSessionId:p.sessionId,procedureId:t,procedureType:i,errors:o?r:[{code:-1,message:"could not initialize procedure"}]}),o?void(p.engine=o):(e.error("An error occurred while initializing the procedure.",{error:n,procedureEngine:o,calErrors:r}),void delete g[p.sessionId])})},this.startProcedure.missingSession=1,this.startProcedure.procdureAlreadyStarted=2,this.sendInputs=function(e,n,r,t,i,o){if(!d[e])return void o(makeError(new Error("no such session"),this.sendInputs.missingSession));if(!g[n])return void o(makeError(new Error("no such procedure session"),this.sendInputs.missingProcedureSession));i&&delete g[n].regions.MessageBox;var s=g[n].engine;s?(s.sendInputs(t),o()):o(makeError(new Error("procedure not initialized"),this.sendInputs.procedureNotInitialized))},this.sendInputs.missingSession=1,this.sendInputs.missingProcedureSession=2,this.sendInputs.procedureNotInitialized=3;var P=function(e){var n=l(e),r=new xmldom.DOMParser,t=r.parseFromString('<procedure><region id="inlineTitle" /><region id="page" /></procedure>'),i=_.reduce(n,function(e,n){var t=e.getElementById(n.region);if(t){_.each(t.childNodes,function(e){t.removeChild(e)});var i=r.parseFromString(n.content),o=e.importNode(i.documentElement,!0);t.appendChild(o)}return e},t);return(new xmldom.XMLSerializer).serializeToString(i)};this.saveProcedureState=function(e,n,r,t){if(!d[e])return void t(makeError(new Error("no such session"),this.sendInputs.missingSession));var i=g[n];if(!i)return void t(makeError(new Error("no such procedure session"),this.sendInputs.missingProcedureSession));var o={type:"xml",content:P(i.regions)};i.artifacts.push(o),t()},this.sendInputs.missingSession=1,this.sendInputs.missingProcedureSession=2,this.getActiveProcedures=function(e,n){},this.createDataPointSubscription=function(e,r,t){var i=d[e].subscriptions;n.subscribeToDataPoint(r,function(e){return e?t(e):void t(null,E(i,r))})},this.getAllSubscribedDataPoints=function(){return _.chain(d).map(function(e){return _.values(e.subscriptions)}).flatten().uniq().map(function(e){return[e,n.getDataPointInstance(e)]}).object().value()};var E=function(e,n){var r=uuid.v4();return e[r]=n,{subscriptionId:r}},R=function(){_.each(d,function(e){e.subscriptions={}})};this.removeDataPointSubscription=function(e,r,t){var i=d[e].subscriptions[r];delete d[e].subscriptions[r],n.unsubscribeToDataPoint(i,function(e){t()})},this.startRecordingSession=function(r,i,o){if(s)return s.getSessionId();n.once("triggerSet",function(e,n){var r=s.getMessage("recordingSessionStarted");I(r.message,r.data)});var a=o,d=o?o.trigger:void 0;return s=recordingSession.GetRecordingSessionManager(d,a,n,i,r,c,e,t.getAllSubscribedDataPoints()),s.getSessionId()},this.addNote=function(e,r,t){n.addNote(t)},this.saveRecording=function(e,n,r,t){var i={name:r,description:t};s&&s.isUserTriggerSession()&&s.saveRecording(i,h)},this.updateRecording=function(e,n,r,t){},this.stopRecording=function(e,n){s&&s.stopRecording()},this.deleteRecording=function(n,r){if(s){var i=s.discardCurrentRecording();i!=r&&e.warn("Deleted recording: "+i+"\nClient expected: "+r+" to be deleted"),0===s.getNumberOfRecordingsInQueue()&&t.deleteRecordingSession()}},this.deleteRecordingSession=function(e,n){if(s){if(s.isUserTriggerSession())return void m();s.getNumberOfRecordingsInQueue()>0&&s.discardNextRecordings(),h()}},this.deleteRecordingSessionSummary=function(e,n){_.isEmpty(a)||a[0].recordingSessionId!==n||(a=void 0)},this.forceStartRecording=function(e,n,r){s&&s.startRecording()},this.calDisconnect=function(){return _.isEmpty(g)?(s&&!s.isUserTriggerSession()?s.isRecordingInProgress()?(n.once("recordingSaved",function(){n.disconnect()}),s.setRecordingsAsDone(),s.stopRecording()):s.getNumberOfSavedRecordings()>0?(s.setRecordingsAsDone(),n.disconnect(),S()):(n.disconnect(),m()):s?(s.isRecordingSavingQueueEmpty()&&m(),n.disconnect()):n.disconnect(),!0):(e.warn("Attempting to disconnect while a procedure in session"),!1)},this.getUpdates=function(e){if(d[e]){var n=d[e].updates;return d[e].updates=[],n}return[]},this.saveSnapshotData=function(r,t){I("savingSnapshots"),u=!0;var i=n.getConnectionInfo().models||[];n.saveSnapshots({snapshotCapture:!0,snapshotRecording:!0},function(n,r){return n?(u=!1,e.error("Failed to save snapshots",n),void I("snapshotsSaved",{error:"failedToSaveSnapshots"})):0===r.length?(u=!1,void I("snapshotsSaved",{error:"noSnapshots"})):void w(r,t,i)})};var w=function(n,r,t){t=_.map(t,function(e){return{model:e.modelGUID,pin:e.modelPIN}});var i=uuid.v4()+".zip",o=path.join(environment.temporarySnapshotsPath,i),s={userId:r,models:t,fileName:i,filePath:o},a=function(r){return _.each(n,function(e){fs.unlink(e,function(e){})}),r?(u=!1,e.error("Failed to zip snapshots",r),void I("snapshotsSaved",{error:"failedToSaveSnapshots"})):void c.addSnapshotData(s,function(n,r){u=!1,n?(e.error("Failed to add snapshots to data manager",n),I("snapshotsSaved",{error:"failedToSaveSnapshots"})):r?I("snapshotsSaved"):I("snapshotsSaved",{error:"retryUploadLater"})})};utility.compressFiles(n,o,a)}};util.inherits(SessionManager,events.EventEmitter),exports.GetSessionManager=function(e,n,r){return new SessionManager(e,n,r)};