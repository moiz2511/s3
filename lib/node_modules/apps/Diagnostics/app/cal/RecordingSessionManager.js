"use strict";var _=require("underscore"),uuid=require("uuid"),path=require("path"),environment=require("Environment"),fs=require("fs"),mkdirp=require("mkdirp"),utility=require("FileUtility"),config;try{config=require("../../../../../../config.js")}catch(e){config={}}var DataPointTrigger=function(e,t){this.id=e.id,this.triggered=!1,this.getType=function(){return"dataPoint"};var i=t.getDataPointInstance(e.dataPointId);this.getFormattedData=function(){return e.value=_.isNumber(e.value)?e.value.toString():e.value,{type:"dataPoint",value:e.value,thresholdType:e.comparator,dataPoint:i,id:e.id}}},DtcTrigger=function(e){this.id=e.id,this.triggered=!1,this.getType=function(){return"dtc"},this.getFormattedData=function(){return{type:"dtc",dtcCode:e.code,controllerName:e.controllerTla,controllerDetail:e.controllerDetailId,id:e.id}}},AnyDtcTrigger=function(e){this.id=e.id,this.triggered=!1,this.getType=function(){return"anyDtc"},this.getFormattedData=function(){return{type:"anyDtc",id:e.id}}},UserTrigger=function(e){this.id=e.id,this.triggered=!1,this.getType=function(){return"user"},this.getFormattedData=function(){return{type:"user",id:e.id}}},TimeTrigger=function(e){this.id=e.id,this.triggered=!1,this.getType=function(){return"time"},this.getFormattedData=function(){return{type:"time",id:e.id}}},CombinationTrigger=function(e,t,i){this.id=e.id,this.triggered=!1,this.getType=function(){return"combination"};var r=this,n=_.without(i,r);this.getFormattedData=function(){return{type:"combination",id:e.id,groupTriggerId:t,combinationType:e.combinationType,triggers:_.map(n,function(e){return e.getFormattedData()})}}},RecordingSession=function(e,t,i,r,n,o,a,d){var g=this,s=config.maxRecordingSize||parseInt(process.env.npm_config_adl_maxRecordingSize,10)||5242880,c="recordingSession",u="topLevelTrigger",m=!1,p=[],f={},l=void 0,v=!1,h=1,T=0,y=[],I=[],R={},S={},D=!1,b=[],w=!1,P=i.getConnectionInfo().models,C=function(e,t){t&&(d[t.getUniqueKey()]=t)};i.on("subscribedToDataPoint",C);var U,A=(function(){var e=!_.chain(P).find(function(e){return e.modelPIN}).isUndefined().value(),t=!!r;return t||e}(),function(e){return{preRecordingTime:e.preTriggerTime?e.preTriggerTime:0,totalRecordingTime:e.length?e.length:0,recordingCount:e.reArmCount?e.reArmCount+1:1}}),N=function(){return environment.tempRecordingsPath},q=function(){l=void 0;var e=uuid.v4();y.push(e),S[e]={setTime:U}},x=function(e,t){t===u&&(m=!0),U=new Date,q()},F=function(){var e={};return _.each(p,function(t){e[t.id]=t.triggered}),e},z=function(){return l?l:F()},E=function(){var e=function(e){return _.map(e,function(e){return t(e)})},t=function(t){var r={type:t.type};switch(t.type){case"combination":r.combinationType=t.combinationType,r.triggers=e(t.triggers);break;case"dtc":r.code=t.code;break;case"dataPoint":var n=i.getDataPointInstance(t.dataPointId),o=n.getController(),a=_.chain(n.getUnitSet()).values().indexBy("displayText").value();r.dataPointId=t.dataPointId,r.unit=a&&a[t.unit]&&a[t.unit].unit||t.unit,r.value=t.value,r.comparator=t.comparator,r.key=n.getKey(),r.detailId=o?o.getIdDetail():void 0,r.controllerTla=o?o.getName():void 0}return r},r=R.trigger?t(R.trigger):void 0,n=r?[{type:"startTrigger",trigger:r}]:[],o=_.map(d,function(e,t){var i=e.getController();return{controllerTla:i&&i.getName(),detailId:i&&i.getIdDetail(),id:t,key:e.getKey()}});return{preTriggerTime:R.preTriggerTime,totalRecordings:(R.reArmCount||0)+1,totalRecordingTime:R.length,triggers:n,dataPoints:o,equipment:Q()}},k=function(e,t,i,r,n){return r&&!_.isEmpty(r)?(b=_.without(b,t),void i(new Error("Unable to save recording file to data location."))):void fs.stat(n,function(r,o){if(r)return b=_.without(b,t),void i(r);e.filesizeInKB=Math.ceil(utility.convertBytesToKiloBytes(o.size)),e.path=n,I.push(e),b=_.without(b,t);try{var a=_.clone(e);a.recordingDetails=E();var d=JSON.stringify(a),g=path.basename(n,".zip"),s=path.join(environment.tempRecordingsPath,g)}catch(e){return void i(e)}fs.writeFile(s,d,function(e){i(e)})})},B=function(e){if(!e)return new TimeTrigger({id:u});switch(e.type){case"dataPoint":return new DataPointTrigger(e,i);case"dtc":return new DtcTrigger(e);case"anyDtc":return new AnyDtcTrigger(e);case"combination":var t=_.map(e.triggers,K);return new CombinationTrigger(e,u,t);case"user":return u=e.id?e.id:u,new UserTrigger({id:u});default:return a.warn("Unknown trigger type. Creating an user trigger"),new UserTrigger({id:u})}},K=function(e){var t=B(e);return t&&"user"!=t.getType()&&"time"!=t.getType()&&(p.push(t),f[t.id]=t),t},j=function(){return _.chain(y).filter(function(e){return _.isUndefined(S[e].stopTime)}).last().value()},M=function(){return _.chain(y).filter(function(e){return!_.isUndefined(S[e].stopTime)}).last().value()},O=function(){var e=M();return!!e&&!_.find(I,function(t){return t.recordingId===e})},Q=function(){var e=i.getConnectionInfo().models;return _.isEmpty(e)&&(e=P),_.map(e,function(e){return{pin:e.modelPIN,modelGUID:e.modelGUID}})};i.once("triggerSet",x),function(){R=t;var r,n=K(e);v=_.isEmpty(p)&&_.isEmpty(t);var o=n.getFormattedData();if(v)h=1,r={trigger:o};else{var a=A(t);"user"!=o.type&&(o.groupTriggerId=o.groupTriggerId?o.groupTriggerId:u),h=a.recordingCount,r=_.extend(a,{trigger:o})}r.maxRecordingSize=s,i.setTrigger(r)}(),this.updateTriggerState=function(e,t){var i=f[e];i&&(i.triggered=t)},this.getSessionId=function(){return c},this.isUserTriggerSession=function(){return v},this.setRecordingStarted=function(){var e=new Date,t=j();S[t]?S[t].startTime=e:a.error("Attempted to start a recording when no trigger is monitoring."),l=z()},this.recordingCompleted=function(){var e=new Date;T+=1;var t=j();S[t]?S[t].stopTime=e:a.error("Attempted to complete a recording when no recording is in progress"),0!==this.getNumberOfRecordingsInQueue()&&q()},this.getNumberOfRecordingsInQueue=function(){return D?0:h-T},this.getNumberOfSavedRecordings=function(){return I.length},this.isRecordingSavingQueueEmpty=function(){return _.isEmpty(b)},this.isRecordingInProgress=function(){var e=j();return e&&!_.isUndefined(S[e].startTime)},this.startRecording=function(){v||g.getNumberOfRecordingsInQueue()>0&&m&&i.startRecording()},this.stopRecording=function(){i.stopRecording()},this.saveRecording=function(e,t){var r=M();if(_.contains(b,r)||_.findWhere(I,{recordingId:r}))return void a.warn("Attempt to save a recording that is currently being saved.");b.push(r);var o=N(),d=path.join(o,r+".zip");R.name=e.name?e.name:R.name,R.description=e.description?e.description:R.description;var g=S[r].stopTime.getTime(),s=S[r].startTime.getTime(),c=S[r].setTime.getTime(),u=(s-c)/1e3,m=u>A(R).preRecordingTime?A(R).preRecordingTime:u,p=(g-s)/1e3+m,f={path:void 0,title:R.name,description:R.description,createdBy:n,filesizeInKB:0,completedTime:new Date,durationInSecs:p,models:i.getConnectionInfo().models,recordingId:r},l=k.bind(void 0,f,r,t);i.once("recordingSaved",l),a.debug("Creating recording location if it doesn't exist"),mkdirp(o,function(){i.saveRecording(d)})},this.discardCurrentRecording=function(){var e=y.pop();return e&&i.discardRecording(),e},this.discardNextRecordings=function(){D=!0,i.deleteTrigger()},this.setRecordingsAsDone=function(){D=!0},this.generateAndSaveActivity=function(e){if(i.removeListener("subscribedToDataPoint",C),w)return void e(new Error("A liveRecording activity was already requested"));var t={type:"liveRecording",jobId:r,title:R.name,description:R.description||"",activityTime:new Date,equipment:Q(),totalRecordings:I.length,recordingDetails:E()};t.fileMetaData=_.chain(I).sortBy(function(e){return S[e.recordingId].stopTime}).map(function(e){var t=path.basename(e.path),i=path.join(environment.recordingsPath,t);return _.extend(e,{type:"recording",fileName:t,filePath:i,currentFilePath:e.path})}).value(),o.addActivity(t,n,function(t,i){return D=!0,t?void e(t):void e(void 0,g.getPseudoActivity())})},this.getPseudoActivity=function(){var e={type:"liveRecording",title:R.name||"",description:R.description||"",equipment:_.map(i.getConnectionInfo().models,function(e){return{pin:e.modelPIN}}),totalRecordings:I.length};return e.recordings=_.chain(I).sortBy(function(e){return S[e.recordingId].stopTime}).map(function(e,t){var i=path.basename(e.path,".zip");return{id:i,index:t+1,url:"/SAWeb/services/Recordingservice/getRecording/"+i}}).value(),e},this.getMessage=function(e){switch(e){case"recordingSessionStarted":var t=v?"user":"trigger";return{message:"recordingSessionStarted",data:{recordingSessionId:c,type:t,details:R||{}}};case"recordingStarted":return{message:"recordingStarted",data:{recordingId:j(),recordingSessionId:c}};case"recordingStopped":return{message:"recordingStopped",data:{recordingId:M()}};case"recordingSessionStopped":return{message:"recordingSessionStopped",data:{recordingSessionId:c}};case"triggerStates":return{message:"triggerStates",data:{recordingSessionId:c,triggerStates:F()}}}},this.getSessionInformation=function(){var e=function(){var e=j();return D?"finished":_.isUndefined(S[e])?"stopped":_.isUndefined(S[e].startTime)?"monitoring":_.isUndefined(S[e].stopTime)?"started":"stopped"},t=function(){var t=j(),i=e();if("stopped"!==i&&t){if(v)return(new Date-S[t].startTime)/1e3;var r=new Date,n=1e3*R.preTriggerTime,o=S[t];return"started"===i?(o.startTime-o.setTime>n?n+(r-o.startTime):r-o.setTime)/1e3:(r-o.setTime>n?n:r-o.setTime)/1e3}},i=O(),r=function(){if(i){var e=M(),t=S[e].stopTime.getTime(),r=S[e].startTime.getTime(),n=S[e].setTime.getTime(),o=(r-n)/1e3,a=o>A(R).preRecordingTime?A(R).preRecordingTime:o;return(t-r)/1e3+a}},n={completedRecordings:T,totalRecordings:h,triggerRecording:!v,recordingSessionId:c,totalRecordingTime:R.length,preTriggerTime:R.preTriggerTime,name:R.name,description:R.description,recordingState:e(),currentTime:t(),trigger:R.trigger,triggerStates:z(),recordings:_.map(I,function(e){var t=path.basename(e.path,".zip");return{recordingId:t,boxRecordingId:e.dataManagerRecordingId,duration:e.durationInSecs,url:"/SAWeb/services/Recordingservice/getRecording/"+t}}).concat(i||this.isRecordingInProgress()?[{recordingId:j()||M(),duration:r()}]:[])};return[n]}};exports.GetRecordingSessionManager=function(e,t,i,r,n,o,a,d){return new RecordingSession(e,t,i,r,n,o,a,d)};