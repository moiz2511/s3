"use strict";var path=require("path"),punycode=require("punycode"),_=require("underscore"),events=require("events"),util=require("util"),calWrapper=require("CAL"),environment=require("Environment"),builder=require("xmlbuilder"),async=require("async"),fileUtility=require("FileUtility"),xml2js=require("xml2js"),xmldom=require("xmldom"),DataManagerApp=require("apps/DataManager/Client"),resourceClient=require("apps/ExclusiveResourceManager/Client"),calUtils=require("./utils.js");try{var config=require("../../../../../../config.js")}catch(e){var config={}}var modelSpecificEngineConnection=void 0==config.modelSpecificEngineConn||config.modelSpecificEngineConn,resourceClaims=["bus","xvds"],_asyncSerialized=function(e){var n=[],t=function(){n.shift(),i(_.first(n))},i=function(n){n&&e.apply(n[0],n[1].concat([t]))};return function(){for(var e=[],t=0;t<arguments.length;++t)e.push(arguments[t]);n.push([this,e]),1===n.length&&i(_.first(n))}},Cal=function(e,n,t,i,o){events.EventEmitter.call(this),this.setMaxListeners(0);var r,a,c=this,s="notConnected",d=[],u={},l={},f={},m=1,g="metric",p=new events.EventEmitter,v=[],C=null,h=null,y=[],U=[],b=DataManagerApp.create(e),D={cs:"CSY",nl:"NLB",en:"ENU",zh:"ZHO",fr:"FRA",de:"DEU",hu:"HUN",it:"ITA",pl:"PLK",pt:"PTG",ru:"RUS",es:"ESP",da:"DAN",tr:"TRK",hi:"HIN",bn:"BEN",kn:"KAN",te:"TEL",ta:"TAM"},P={failedToConnect:{message:"Failed to connect to the CAL",code:1},diagnosticsUnavailable:{message:"Failed to initialize the CAL, diagnostics is unavailable",code:2},alreadyConnected:{message:"A connection has already been established",code:3},resourceClaimError:{message:"Another application is using the bus",code:4}};this.errors=P;var E=function(){return"disconnecting"===s},I=function(n,t,i){var o={readingsApps:[],engineModels:void 0,engineName:void 0};if(!n)return e.debug("No readings connectivity data to process."),o;try{var r=JSON.parse(n)}catch(n){return e.error("Failed to parse through readings connectivity file: "+n.message),o}var a=_.indexBy(r.models,"guid"),c=_.pluck(t,"modelGUID"),s=_.chain(c.concat(i)).map(function(e){var n=a[e]&&a[e].requiredApplications;return _.map(n,function(n){return{readings_application_id:n.readings_application_id,model:e,busGuid:n.guid}})}).flatten(!0).value();e.debug("Readings Apps for connection for all models: "+JSON.stringify(s));var d=_.indexBy(r.readings_applications,"id"),u=_.indexBy(s,"readings_application_id");e.debug("Trimmed readings apps to connection: "+JSON.stringify(u));var l,f=_.chain(u).map(function(e){var n=d[e.readings_application_id];if(n&&void 0!=n.binFile&&void 0!=n.dllFile)return{model:e.model,appId:e.readings_application_id,busGuid:e.busGuid,dllFile:n.dllFile,binFile:n.binFile,name:n.name}}).compact().value();f.forEach(function(e){e.name.toUpperCase().indexOf("FPT")!==-1?l="fpt":e.name.toUpperCase().indexOf("JDDENSO")!==-1?l="jddenso":e.name.toUpperCase().indexOf("CUMMINS")!==-1?l="cummins":e.name.toUpperCase().indexOf("YANMAR")!==-1?l="yanmar":e.name.toUpperCase().indexOf("LIEBHERR")!==-1&&(l="liebherr")}),void 0==l&&(l="aea");var m=_.chain(f).filter(function(e){return"ECU"===e.dllFile.toUpperCase()&&"ECU"===e.binFile.toUpperCase()}).pluck("model").uniq().sort().value();return{readingsAppsForModels:f,engineModels:m,engineModelName:l}},N=function(n,i,o,r,a,c){e.info("Building the connection XML..."),async.parallel({ecuAccessLevel:function(e){b.getEcuAccessLevel(n,function(n,t){!n&&t||(t=1),e(null,t)})},accessoryModels:function(t){a?_.defer(function(){t(void 0,[])}):b.getAccessoryModelGuidsForUser(n,function(n,i){n&&e.warn("An error occurred while retrieving the accessory models. Continuing with provided models.  Error = "+n,n),t(void 0,i||[])})},userModelInformation:function(n){b.getModelsByIds(void 0,_.pluck(r,"modelGUID"),function(t,i){t&&e.warn("Unable to get model information for the requested connection models. We'll try our best."),n(void 0,i||[])})},readingsConnectivityData:function(n){var i=path.join(environment.readingsDataPath,"readings_connectivity.json");fileUtility.getFileBuffer(i,t,function(t,i){t?(e.error("Unable to read readings_connectivity.json",t),n(void 0,"")):n(void 0,i)})}},function(n,t){if(n)return e.error("An error occured preparing to build the connection XML: "+n),void c(n);var s=I(t.readingsConnectivityData,r,t.accessoryModels),d=D[i]||"ENU",u=builder.create("CalConnectionParams",{encoding:"UTF-8",version:"1.0"}),l=config.connectivityApplications||{},f=_.findWhere(t.userModelInformation,{isVehicle:!0});e.debug("Connection XML Model decision data: "+JSON.stringify({vehicleModel:_.pick(f,"isVehicle","mG"),userModels:r,userModelInfo:_.map(t.userModelInformation,function(e){return _.pick(e,"isVehicle","mG")}),engineModels:s.engineModels}));var m=function(e){this.modelGUID=e},g=f?[new m(f.mG)]:_.isEmpty(s.engineModels)===!1?[new m(_.first(s.engineModels))]:[_.chain(r).sortBy("modelGUID").first().value()],p=f?[new m(f.mG)]:_.isEmpty(s.engineModels)===!1?[new m(_.first(s.engineModels))]:void 0,v=_.indexBy(r,"modelGUID"),C=u.e("userModelInfo",_.first(p)?{defaultEngineModel:_.first(p).modelGUID,isVehicle:!!f}:void 0);_.each(t.userModelInformation,function(e){if(e.mG&&e.d){var n={modelId:e.mG,decal:e.d};v[e.mG]&&v[e.mG].modelPIN&&(n.pin=v[e.mG].modelPIN),C.e("model",n)}}),!_.isUndefined(l.xvds)&&!l.xvds||_.each(s.readingsAppsForModels,function(e){if(e&&"ECU"!==e.dllFile&&"ECU"!==e.binFile){var n=u.e("ConnectionParam",{type:"xvds",masterCategory:"category"}),t=function(e,t){n.e("param",{name:e,value:t})};t("langCode",d),t("DLLFile",e.dllFile),t("BINFile",e.binFile),t("XvdsBus","XVDS_BUS_VEHICLE"),t("category",e.model),o&&t("adapter",o)}});var h=function(e,n,i){var r=u.e("ConnectionParam",{type:e,masterCategory:"category"});r.e("param",{name:"langCode",value:d}),o&&r.e("param",{name:"adapter",value:o}),r.e("param",{name:"category",value:n}),i&&r.e("param",{name:"logBus",value:i}),r.e("param",{name:"paramView",value:t.ecuAccessLevel})};if((1==l[s.engineModelName]||_.isUndefined(l[s.engineModelName]))&&(a?_.each(s.readingsAppsForModels,function(e){"ECU"===e.dllFile&&"ECU"===e.binFile&&h(s.engineModelName,e.model,e.busGuid)}):"aea"==s.engineModelName?_.each(_.isEmpty(p)?g:p,function(e){h(s.engineModelName,e.modelGUID)}):_.each(g,function(e){h(s.engineModelName,e.modelGUID)})),modelSpecificEngineConnection||"jddenso"==s.engineModelName&&"fpt"==s.engineModelName||(!_.isUndefined(l.aea)&&!l.aea&&"aea"==s.engineModelName||(a?_.each(s.readingsAppsForModels,function(e){"ECU"===e.dllFile&&"ECU"===e.binFile&&h("aea",e.model,e.busGuid)}):_.each(_.isEmpty(p)?g:p,function(e){h("aea",e.modelGUID)})),!_.isUndefined(l.yanmar)&&!l.yanmar&&"yanmar"==s.engineModelName||(a?_.each(s.readingsAppsForModels,function(e){"ECU"===e.dllFile&&"ECU"===e.binFile&&h("yanmar",e.model,e.busGuid)}):_.each(g,function(e){h("yanmar",e.modelGUID)})),!_.isUndefined(l.liebherr)&&!l.liebherr&&"liebherr"==s.engineModelName||(a?_.each(s.readingsAppsForModels,function(e){"ECU"===e.dllFile&&"ECU"===e.binFile&&h("liebherr",e.model,e.busGuid)}):_.each(g,function(e){h("liebherr",e.modelGUID)})),!_.isUndefined(l.cummins)&&!l.cummins&&"cummins"==s.engineModelName||(a?_.each(s.readingsAppsForModels,function(e){"ECU"===e.dllFile&&"ECU"===e.binFile&&h("cummins",e.model,e.busGuid)}):_.each(g,function(e){h("cummins",e.modelGUID)})),!s.hasFptModel||!_.isUndefined(l.fpt)&&!l.fpt||(a?_.each(s.readingsAppsForModels,function(e){"ECU"===e.dllFile&&"ECU"===e.binFile&&h("fpt",e.model,e.busGuid)}):_.each(g,function(e){h("fpt",e.modelGUID)}))),!_.isUndefined(l.test)&&l.test){var y=u.e("ConnectionParam",{type:"test",masterCategory:"category"}),U=config.testConnectivityAppSettings||{};y.e("param",{name:"langCode",value:d}),y.e("param",{name:"category",value:"data"}),y.e("param",{name:"numControllers",value:_.isUndefined(U.numControllers)?2:U.numControllers}),y.e("param",{name:"numDataPointCategories",value:_.isUndefined(U.numDataPointCategories)?4:U.numDataPointCategories}),y.e("param",{name:"numDataPointsPerCategory",value:_.isUndefined(U.numDataPointsPerCategory)?13:U.numDataPointsPerCategory}),y.e("param",{name:"numCalibrationCategories",value:_.isUndefined(U.numCalibrationCategories)?2:U.numCalibrationCategories}),y.e("param",{name:"numCalibrationsPerCategory",value:_.isUndefined(U.numCalibrationsPerCategory)?2:U.numCalibrationsPerCategory}),y.e("param",{name:"numTestCategories",value:_.isUndefined(U.numTestCategories)?2:U.numTestCategories}),y.e("param",{name:"numTestsPerCategory",value:_.isUndefined(U.numTestsPerCategory)?2:U.numTestsPerCategory}),y.e("param",{name:"numDtcs",value:_.isUndefined(U.numDtcs)?2:U.numDtcs}),y.e("param",{name:"dataPointUpdateRate",value:_.isUndefined(U.dataPointUpdateRate)?.5:U.dataPointUpdateRate}),y.e("param",{name:"dtcUpdateRate",value:_.isUndefined(U.dtcUpdateRate)?5:U.dtcUpdateRate})}u.att("offline",a?"true":"false"),e.info("The connection XML has been built"),c(null,u.end())})},M=function(n){_.each(n,function(n){e.error("CAL error "+n.code+": "+n.message)})},T=function(e,n){try{var t=(new xmldom.DOMParser).parseFromString(n),i=t.getElementsByTagName("ConnectionParam"),o=_.chain(i).map(function(e){var n=e.getAttribute("masterCategory"),t=e.getElementsByTagName("param"),i=_.reduce(t,function(e,n){var t=n.getAttribute("name"),i=n.getAttribute("value");return e[t]=i,e},{});return i[n]}).compact().uniq().value();return o}catch(n){return e.error("Caught an exception while processing the connected connection XML: "+n,n),[]}},S=function(n,t){if(M(n),!t.isConnected()){d=[],s="notConnected";var i=new Error(P.failedToConnect.message);return i.code=P.failedToConnect.code,o.releaseResources(resourceClaims),void c.emit("connected",i)}if(e.info("The CAL has successfully connected"),a)return void e.warn("A new connection has started, but a connection already exists");a=t,b.getCalComponentsList(function(n,t){n?e.error("Error occurred while getting CAL components list from Data Manager",n):U=t});var r=a.getConnectionXml(),u=T(e,r);e.debug("Connected to "+u.join(", "));var l=_.indexBy(d,"modelGUID"),f=_.map(u,function(e){var n=l[e];return n?{modelGUID:n.modelGUID,modelPIN:n.modelPIN}:{modelGUID:e}});d=f,a.getControllers(),a.subscribeToDtcs(),s="connected",w(),c.emit("connected",null,m,f)},F=function(n){M(n),e.info("The CAL has disconnected");try{_.each(v,function(e){e(new Error("disconnected"))})}catch(e){}v=[],C=null,h=null,u={},l={},r=null,f={},U=[],d=[],s="notConnected",a=void 0,o.releaseResources(resourceClaims),c.emit("disconnected")};c.on("dataPointUpdated",function(e){"Connection_Status"===e.id&&("connected"===s&&"Connected"!==e.value?(s="interrupted",c.emit("interrupted")):"interrupted"===s&&"Connected"===e.value&&(s="connected",c.emit("recovered")))});var w=function(){var n=function(){c.subscribeToDataPoint("Connection_Status",function(n){n&&e.error("Failed to start monitoring connection status")})},t=function(){c.removeListener("dataPoints",n)};c.once("dataPoints",n),c.once("disconnected",t)},A=function(e){M(e),c.emit("controllersRefreshed")},L=function(e,n){if(M(e),0===n)return void p.emit("controllers",[]);var t=[],i=_.after(n,function(){p.removeListener("controller",o),p.emit("controllers",t)}),o=function(e){t.push(e),i()};p.on("controller",o)},R=function(e){return _.map(e,function(e){var n=Number(e.getSourceAddress());return{controllerId:e.getId(),controllerDetailId:"N/A"===e.getIdDetail()?void 0:e.getIdDetail(),disconnected:e.isDisconnected(),j1939ControllerDetails:{tla:e.getName(),bus:e.getBus(),sourceAddress:_.isNaN(n)?void 0:n},name:"N/A"!==e.getDescription()?e.getDescription():e.getName(),networkType:1}})},G=function(e){p.emit("controller",e)},x=function(n,t){var i=n.getController(),o={dtcId:i.getId()+n.getCode(),dtcCode:n.getDisplayCode(),controllerId:i.getId(),controllerTla:i.getName(),j1939DtcUpdateDetails:{status:n.getStatus()===calWrapper.dtcStatus.stored?0:n.getStatus(),count:n.getCount()},networkType:1,name:n.getName(),description:n.getDescription()},r=function(e){t(_.extend(o,{snapshotCapture:e}))},a=n.getSnapshotCapture();if(!a||E())_.defer(function(){r()});else{var c=a.getNumberOfSnapshotOccurrencesHavingData();if(c<=0)_.defer(function(){r()});else{var s=a.getSnapshotDataConnectionForOccurrence(c-1);if(!s)return void _.defer(function(){r()});var d=s.getConnectionXml();if(_.isUndefined(d))return e.error("Connection XML is undefined"),void r();var u=new xml2js.Parser;u.parseString(d,function(n,t){if(n)return e.error("Failed to parse snapshot connection XML",n),void r();if(!t)return e.error("Parsed an empty connection XML"),void r();var i={dataPoints:[]},o=_.first(t.CalConnectionParams&&t.CalConnectionParams.recordingInfo);o=_.pluck(o&&o.recordingParam,"$"),o=_.indexBy(o,"name"),o&&(i.occurrenceTimes={first:Number(o.occurrenceTimeFirst&&o.occurrenceTimeFirst.value),latest:Number(o.occurrenceTimeLatest&&o.occurrenceTimeLatest.value)},i.cumulativeDuration=Number(o.cumulativeDuration&&o.cumulativeDuration.value));var a=function(e,n){i.dataPoints=_.chain(n).map(function(e){if(e=e.dataPoint,"Connection_Status"!==e.getName())return{displayName:e.getName(),units:e.getUnitName(),value:e.getValue()}}).compact().sortBy("displayName").value(),r(i)},c=s.getEventCallbacks();c||(c=new events.EventEmitter,s.setEventCallbacks(c)),c.once("onUnitsSet",function(){c.once("onDataPoints",a.bind(s)),s.getDataPoints()}),s.setUnits(calWrapper.units[g])})}}},q=function(e,n){M(e);var t=[],i=function(){var e=v.shift();p.emit("rawDtcs",t),e&&e(null,t)};if(0===n)return void i();var o=_.after(n,function(){p.removeListener("dtc",r),i()}),r=function(e){var n=e.getController();n.getId()+e.getCode();t.push(e),o()};p.on("dtc",r)},B=function(e){p.emit("dtc",e)},k=function(e){M(e),p.emit("dtcsCleared",d)},K=function(e,n){if(M(e),0===n)return void c.emit("categories",[]);var t=[],i=_.after(n,function(){p.removeListener("category",o)}),o=function(e){t.push(e),i()};p.on("category",o)},j=function(e){p.emit("category",e)},O=function(e){var n={},t={},i=_.map(e,function(e){var i=e.dataPoint,o=e.category;if(i){o&&(t[o.getId()]=o,o.getType()===calWrapper.categoryType.normal&&(n[o.getId()]?n[o.getId()].push(i.getUniqueKey()):n[o.getId()]=[i.getUniqueKey()]));var r=i.getController(),a={controller:r?r.getId():void 0,id:i.getUniqueKey(),key:i.getKey(),unitSet:{metricUnitDetails:{id:0},englishUnitDetails:{id:0},alternateUnitDetails:{id:0}},dataPointUniqueName:i.getUniqueKey(),name:i.getName(),unit:i.getUnitName()};return a}});i=_.compact(i);var o=_.indexBy(i,"id"),r=calUtils.determineModelLinkingData(a.getConnectionXml()),c=calUtils.buildCategoryTree(n,t,r,function(e,n){var t=o[n];return!!t&&r.detailIdToModelMap[t.controller]===e});return{dataPointCategories:c,dataPoints:i}},X=function(e,n,t){M(e),l=_.chain(n).map(function(e){return[e.dataPoint.getUniqueKey(),e]}).object().value(),r=O(n),c.emit("dataPoints",r)},V=function(e,n){c.emit("subscribedToDataPoint",e,n)},z=function(e,n){c.emit("unsubscribedToDataPoint",e,n)},W=function(e){var n={id:e.getUniqueKey(),unit:e.getUnitName(),value:e.getValue(),high:e.getHighValue(),low:e.getLowValue(),timestamp:Date.now()};c.emit("dataPointUpdated",n)},H=function(e){var n=_.chain(e).map(function(e){var n=e.procedure;if(n)return{id:n.getUniqueKey(),key:n.getKey(),name:n.getName()}}).compact().value(),t={},i={};_.each(e,function(e){var n=e.procedure,o=e.category;t[o.getId()]=o,i[o.getId()]=i[o.getId()]||[],i[o.getId()].push(n.getUniqueKey())});var o=calUtils.buildProceduresCategoryTree(i,t);return{procedures:n,procedureCategories:o}},J=function(e,n){f=_.chain(n).map(function(e){return[e.procedure.getUniqueKey(),e]}).object().value();var t=H(n);p.emit("formattedProcedures",{procedures:t.procedures,procedureCategories:t.procedureCategories})},Y=function(e,n,t){if(M(e),0===n)return void J(e,[],t);var i=[],o=_.after(n,function(){p.removeListener("procedure",r),J(e,i,t)}),r=function(e,n){_.contains(U,e.getName())||i.push({procedure:e,category:n}),o()};p.on("procedure",r)},Z=function(e,n){p.emit("procedure",e,n)},$=function(e,n,t){p.emit("procedureInitialized",e,n,t)},Q=function(e,n,t){p.emit("snapshotCapture",e,n,t)},ee=function(e){M(e)},ne=function(e){M(e)},te=function(e){p.emit("rawDtcUpdate",e),x(e,function(e){p.emit("formattedDtcUpdate",e)})},ie=function(e,n){M(e),c.emit("triggerSet",e,n)},oe=function(){c.emit("triggerExecutionComplete")},re=function(){c.emit("triggerExecutionStarted")},ae=function(e){c.emit("triggerMet",e)},ce=function(e){c.emit("triggerUnMet",e)},se=function(e){c.emit("triggerComplete",e)},de=function(n,t){n&&!_.isEmpty(n)&&e.info("If disconnecting while recording is in progress expect CAL error 10"),M(n),c.emit("recordingSaved",n,t)},ue=function(e,n){M(e),p.emit("unitsSet",g)};p.on("controllers",function(e){u=_.chain(e).map(function(e){return[e.getId(),e]}).object().value(),c.emit("controllers",R(e))}),p.on("unitsSet",function(e){h=null,c.emit("unitsSet",g)}),p.on("rawDtcs",function(e){C=e,h=null}),p.on("formattedDtcs",function(e){h=e,c.emit("dtcs",e,d)}),p.on("clearingCodes",function(e){e?(C=_.reject(C,function(n){var t=n.controller;return!t||e.getId()===t.getId()}),h=_.reject(h,function(n){return n.controllerId===e.getId()})):(C=null,h=null),c.emit("clearingCodes",e)}),p.on("dtcsCleared",function(){c.emit("dtcsCleared",d)}),p.on("rawDtcUpdate",function(e){if(C){var n=e.getController(),t=n?n.getId():void 0,i=e.getCode(),o=_.findIndex(C,function(o){var r=e.getController(),a=r?n.getId():void 0,c=o.getCode();return a===t&&c===i});o===-1?C.push(e):C[o]=e}}),p.on("formattedDtcUpdate",function(e){if(h){var n=_.findIndex(h,function(n){return n.dtcId===e.dtcId});n===-1?h.push(e):h[n]=e}c.emit("dtcUpdate",e)}),this.buildOfflineConnectionXml=function(e,n,t,i){N(e,n,void 0,t,!0,function(e,n){i(e,n)})};var le=function(e,t,i,r){s="connecting",c.emit("connecting"),d=r,N(e,t,i,r,!1,function(e,t){if(e){var i=new Error(P.diagnosticsUnavailable.message);return i.code=P.diagnosticsUnavailable.code,d=[],s="notConnected",o.releaseResources(resourceClaims),void c.emit("connected",i)}n(t,{onDisconnected:F,onControllersRefreshed:A,onBeginControllers:L,onController:G,onBeginDtcs:q,onDtc:B,onDtcsCleared:k,onDtcsClearedByController:k,onSnapshotReady:Q,onBeginCategories:K,onCategory:j,onDataPoints:X,onSubscribedToDataPoint:V,onDataPointUpdate:W,onUnsubscribedToDataPoint:z,onSubscribedToDtcs:ee,onUnsubscribedToDtcs:ne,onTriggerSet:ie,onTriggerExecutionComplete:oe,onTriggerExecutionStarted:re,onTriggerComplete:se,onRecordingSaved:de,onTriggerMet:ae,onTriggerUnMet:ce,onDtcUpdate:te,onUnitsSet:ue,onBeginProcedures:Y,onProcedure:Z,onProcedureInitialized:$},function(e,n,t){if(e){s="notConnected";var i=new Error(P.diagnosticsUnavailable.message);i.code=P.diagnosticsUnavailable.code,o.releaseResources(resourceClaims),c.emit("connected",i)}else S(n,t)})})};this.connect=function(e,n,t,i){if("connected"===s||"disconnecting"===s){var r=new Error(P.alreadyConnected.message);return r.code=P.alreadyConnected.code,void c.emit("connected",r,m,d)}"connecting"!==s&&o.useResources(resourceClaims,function(o){if(o instanceof resourceClient.ResourceClaimError){var r=new Error(P.resourceClaimError.message);r.code=P.resourceClaimError.code,r.blockingApp=_.chain(o.ownedApplications).values().first().value(),c.emit("connected",r)}else le(e,n,t,i)})},this.updateModelPins=function(n){e.debug("Updating model PINs from "+JSON.stringify(d)+" to "+JSON.stringify(n)),_.each(n,function(e){var n=_.find(d,function(n){return n.modelGUID===e.modelGUID});n&&(n.modelPIN=e.modelPIN)})},this.disconnect=function(){a&&"disconnecting"!==s&&(s="disconnecting",c.emit("disconnecting"),a.disconnect())},this.setUnits=function(e){e&&calWrapper.units[e]&&a&&(g=e,a.setUnits(calWrapper.units[e]))},this.getConnectionXml=function(){if(a)return a.getConnectionXml()},this.getConnectionLogBus=function(e){calUtils.getConnectionLogBus(c.getConnectionXml(),e)},this.getConnectionInfo=function(){return{connectionState:s,models:d,connectionId:"connected"===s||"interrupted"===s?m:void 0,units:g}},this.getControllers=function(n,t){var i=function(){a?(e.info("Getting controllers..."),p.once("controllers",function(n){e.info("Received controllers"),t(null,R(n))}),a.getControllers()):t(null,[])};if(a)if(n)c.once("controllersRefreshed",function(){i()}),e.info("Refreshing controllers..."),a.refreshControllers();else{if(!_.isEmpty(u))return void t(null,R(_.values(u)));i()}else t(null,[])},this.getKnownControllers=function(){return R(_.values(u))};var fe=function(n){return a?(v.push(function(e,t){n(null,t)}),e.info("Getting dtcs..."),void a.getDtcs()):void n(new Error("Not Connected"))},me=function(n,t){async.mapSeries(n,function(e,n){x(e,function(e){n(null,e)})},function(n,i){p.emit("formattedDtcs",i),e.info("Received dtcs"),t(null,i)})};this.getDtcs=_asyncSerialized(function(n,t,i){a&&(n||null===C)?(e.info("Refreshing DTC information from the CAL."),fe(function(n,o){e.info("Received DTCs from the CAL, formatting them for return."),me(o,function(n,o){e.info("DTCs formatted, returning"),t(n,o),i()})})):a&&!h?(e.info("DTCs are cached, but not yet formatted. Formatting DTCs."),me(C,function(e,n){t(null,n),i()})):a?(e.info("Formatted DTCs are available."),t(null,h),i()):(t(null,[]),i())});var ge=function(){var n=_.first(y);n&&c.getCachedDtcs(function(t,i){var o=n.options||{},r=n.callback,s=[];e.info("Saving snapshots...");var d=function(e,n,t,i){if(M(e),n&&_.isEmpty(e)){var o=n.getSnapshotFileName();o&&s.push(o)}i()},u=_.once(function(n){e.info("Snapshots have been saved."),y.shift(),c.removeListener("disconnected",u),r(n,s),_.defer(ge)});return t?void u(t):(c.on("disconnected",u),0===_.size(i)||!o.snapshotCapture&&!o.snapshotRecording||E()||!a?void u():void async.eachSeries(i,function(e,n){async.series([function(n){if(!E()&&a){if(!o.snapshotCapture)return void n();var t=e.getSnapshotCapture();if(!t)return void n();p.once("snapshotCapture",function(e,t,i){d(e,t,i,n)}),t.saveSnapshotWithPath(environment.temporarySnapshotsPath)}},function(n){if(!E()&&a){if(!o.snapshotRecording)return void n();var t=e.getSnapshotRecording();if(!t)return void n();p.once("snapshotCapture",function(e,t,i){d(e,t,i,n)}),t.saveSnapshotWithPath(environment.temporarySnapshotsPath)}}],function(e){n(e)})},function(e){u(e)}))})};this.saveSnapshots=function(e,n){y.push({options:e,callback:n}),1===y.length&&ge()},this.getCachedDtcs=function(e){C?e(null,C):fe(function(n){e(null,n)})},this.clearDtcs=function(n,t){a?(c.once("dtcsCleared",function(){e.info("Dtcs cleared"),t()}),e.info("Clearing dtcs..."),n?(p.emit("clearingCodes",u[n]),a.clearDtcsByController(u[n])):(p.emit("clearingCodes"),a.clearDtcs())):t()},this.getDataPoints=_asyncSerialized(function(n,t){a&&r?(n(null,r),t()):a?(c.once("dataPoints",function(i){e.info("Received data points"),n(null,i),t()}),e.info("Getting data points"),a.getDataPoints()):(n(null,{}),t())}),this.subscribeToDataPoint=function(e,n){if(a){if(!l[e])return void n(new Error("Unknown data point"));var t=function(i,o){if(!o||o.getUniqueKey()===e)return M(i),c.removeListener("subscribedToDataPoint",t),0!==i.length?n(new Error("Failed to subscribe to data point")):void n()};c.on("subscribedToDataPoint",t),a.subscribeToDataPoint(l[e].dataPoint)}else n(new Error("Connection not established"))},this.unsubscribeToDataPoint=function(e,n){if(a){if(!l[e])return void n(new Error("unknown datapoint"));var t=function(i,o){o&&o.getUniqueKey()!==e||(M(i),c.removeListener("unsubscribedToDataPoint",t),n())};c.on("unsubscribedToDataPoint",t),a.unsubscribeToDataPoint(l[e].dataPoint)}else n(new Error("Connection not established"))},this.getDataPoint=function(e){var n=l[e]?l[e].dataPoint:void 0;return n?{dataPointId:e,unitId:0,unit:n.getUnitName(),value:n.getValue(),low:n.getLowValue(),high:n.getHighValue(),timestamp:Date.now()}:{}},this.getDataPointInstance=function(e){return l[e]?l[e].dataPoint:void 0},this.getProcedures=_asyncSerialized(function(n,t){a&&!_.isEmpty(f)?(n(null,H(f)),t()):a?(p.once("formattedProcedures",function(i){e.info("Received procedures"),n(null,i),t()}),e.info("Getting procedures"),a.getProcedures()):(n(null,{}),t())}),this.getProcedureName=function(e){return f[e]?f[e].procedure.getName():""},this.getProcedureKey=function(e){return f[e]?f[e].procedure.getKey():""};var pe=function(e){var n=punycode.ucs2.decode(e),t=_.filter(n,function(e){return 9===e||10===e||13===e||32<=e&&e<=55295||57344<=e&&e<=65533||65536<=e&&e<=1114111});return punycode.ucs2.encode(t)};this.startProcedure=_asyncSerialized(function(e,n,t,i,o,r,c,s){if(a){var d=f[e]?f[e].procedure:void 0;if(!d)return c(new Error("no such procedure"),[]),void s();a.initializeProcedure(d),p.once("procedureInitialized",function(e,a,d){var u=new events.EventEmitter;u.on("onProcedureStarted",function(){n()}),u.on("onUpdateRegion",function(e,n,i){t(e,n,pe(i))}),u.on("onProcedureStatus",function(e,n){i(e,n)}),u.on("onProcedureData",function(e,n){o(e,n)}),u.on("onProcedureEnded",function(e,n){r(e,n)}),d&&d.setEventCallbacks(u),c(void 0,e,d),s()})}else c(new Error("not connected")),s()}),this.setTrigger=function(n){return a?void a.setTrigger(n):void e.error("Connection not established")},this.startRecording=function(){return a?(a.startRecording(),void c.emit("recordingStarted")):void e.error("Connection not established")},this.stopRecording=function(){return a?void a.stopRecording():void e.error("Connection not established")},this.saveRecording=function(n){return a?void a.saveRecording(n):void e.error("Connection not established")},this.discardRecording=function(){return a?void a.discardRecording():void e.error("Connection not established")},this.deleteTrigger=function(){return a?void a.deleteTrigger():void e.error("Connection not established")},this.addNote=function(n){return a?void a.addNote(n):void e.error("Connection not established")}};util.inherits(Cal,events.EventEmitter),module.exports=function(e,n,t,i,o){return new Cal(e,n,t,i,o)};