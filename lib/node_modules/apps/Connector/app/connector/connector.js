!function(){"use strict";function e(e,u){var l,f,d,p,g,m=this,v=u.networkContext,w=s.create(e),h=a.create(e),S=null,k=null,q={},y=null,C=null,b=!1,P=!1,U=0,N=function(e){var t=n.parse(r.serverLocation);return n.format({protocol:t.protocol,hostname:t.hostname,port:t.port,pathname:e})},V=function(n,t){U=n?U+1:0;var o=!n||U<u.maxFailureCount;return n&&n.message!==p&&(p=n.message,e.error("Ping to check connection state failed: "+n.message,n)),o&&!t?(e.info("Network Connection Detected"),e.broadcast(c.networkConnected)):!o&&t?(e.info("Network Connection Disconnected"),e.broadcast(c.networkDisconnected)):n&&t&&e.info("Ping Failed, failure count: ",U),o},x=function(e){d=v.requestJson(v.getNetworkOptions(e),function(n,t,o){P=V(n,P),d=void 0,b||(C=setTimeout(function(){x(e)},u.connectionStatePingFrequency))})},T=function(e,n){f=v.requestWithTokenValidation(v.getNetworkOptions(e),function(t,o,i){n(t,o,i),f=void 0,b||(y=setTimeout(function(){e.json.systemSoftware=q,T(e,n)},u.pingFrequency))})};this.setSoftwareUpdate=function(e){var n=function(e){k?e():h.getPendingSystemUpdate(function(n){k=n,e()})},t=function(e){h.getInstalledSoftwareVersion(function(n){S=n,e()})};i.parallel([n,t],function(){e()})},this.startBoxPing=function(n){i.parallel([this.setSoftwareUpdate],function(){if(!l&&n){m.close(),b=!1,m.startCheckingConnectionState(),l=n,g=N(t.format(u.pingUrlPath,l));var i={installedVersion:S,newVersion:k?k.newVersion:void 0},i=o.omit(i,function(e){return o.isUndefined(e)||o.isNull(e)});q=i;var r=o.omit({systemSoftware:i},function(e){return o.isUndefined(e)||o.isNull(e)});console.log("_boxPingUrl=",g);var s={method:"PUT",url:g,headers:{"Content-Type":"application/vnd.johndeere.sa.boxNetwork.boxPing.v1+json",accept:"application/vnd.johndeere.sa.boxNetwork.boxPingResponse.v1+json"},json:r},a=function(n,t,o){n?P&&e.error("Error pinging the server (we are now offline): "+n.message):t.statusCode>=200&&t.statusCode<300?(e.broadcast(c.serverPinged),"quick"===o.syncRequested?(e.info("Quick Sync requested by Server"),e.broadcast(c.quickSync)):"full"===o.syncRequested&&(e.info("Full Sync requested by Server"),e.broadcast(c.fullSync,o.fullSyncOptions))):e.info("Unexpected server response "+t.statusCode)};T(s,a)}})},w.on("newInstallationVersion",function(e){k=e,q.newVersion=k.newVersion}),w.on("installedVersion",function(e){S=e}),this.start=function(){i.parallel([this.setSoftwareUpdate],function(){var e={installedVersion:S,newVersion:k?k.newVersion:void 0},e=o.omit(e,function(e){return o.isUndefined(e)||o.isNull(e)});console.log("_buildUrl('ping'),=",N("ping"));var n=o.omit({method:"OPTIONS",url:N("ping"),json:{systemSoftware:e}},function(e){return o.isUndefined(e)||o.isNull(e)});T(n,function(){}),m.startCheckingConnectionState()})},this.startCheckingConnectionState=function(){e.info("Starting ping to check connection state...");var n={method:"OPTIONS",url:N("ping")};x(n)},this.close=function(){b=!0,clearTimeout(y),clearTimeout(C),void 0!==f&&f.abort(),void 0!==d&&d.abort()}}var n=require("url"),t=require("util"),o=require("underscore"),i=require("async"),r=require("Environment"),s=require("apps/SystemUpdateInstaller/Client"),a=require("apps/DataManager/Client"),c=require("Protocol");module.exports=function(n,t){return new e(n,t)}}();