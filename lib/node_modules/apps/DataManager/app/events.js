"use strict";function setup(e,r){function t(e){var r={reprogramDonorEcu:"uploadDonorEcuReturnFile",reprogramSuspectEcu:"uploadSuspectEcuReturnFile"};return r[e]}var o=r.database,n=r.databaseManager,i=r.connectorClient,c=r.registrationClient,a=r.systemUpdateInstallerClient,d=r.configStoreClient,l=r.frontEndServerClient,s=new ActivityProvider(e,n,o,c),u=new PinSearchDataProvider(e,o),f=new UsersDataProvider(e,n,c),g=new ModelsDataProvider(e,n,o,c),p=new TriggerTemplateDataProvider(e,n),v=new SystemUpdateProvider(e,o,a),y=new ControllerDataProvider(e,o),m=new CalComponentsToExcludeForCustProvider(e,n,c),S=new RecordingDataProvider(e,n),D=new JDLMDataProvider(e,n,o);url.parse(environment.serverLocation);i.on("networkConnected",function(){n.resumeSyncs()}),i.on("quickSync",function(){c.getSetupState(function(e){n.getSyncStatus().quickSyncRunning===!1&&c.isSetup(e)&&n.startQuickSync()})}),i.on("fullSync",function(e){c.getSetupState(function(r){n.getSyncStatus().fullSyncRunning===!1&&c.isSetup(r)&&(e?n.queueCustomFullSync(e.models||[],e.dtacData||[],e.syncType,function(){}):n.startFullSync())})}),i.on("serverPinged",function(){d.setParameter("lastPingTime",new Date,function(r){r&&e.error("Error setting last ping time: ",r)})}),l.on("sessionStart",function(){certificateUtil.installPdfCertificates(r.ONEManager,function(r){r&&e.error("Error installing pdf certificates: ",r)})}),l.on("sessionEnd",function(){r.ONEManager.unInstallPdfCertificates()}),a.on("newInstallationVersion",function(r){v.setPendingInstalledSoftwareVersion(r.newVersion,r.isSoftwareUpdateCritical,function(r){r&&e.error("Error setting pending installed software version: ",r)})}),a.on("installationComplete",function(){e.info("Application update detected. Notifying Server and getting readings data updates.");var r=[],t=[];n.startQuickSync(new syncOptionTypes.QuickSyncOptions(!0,new syncOptionTypes.CustomFullSyncOptions(r,t,"generalUpdates",!0)),function(){})}),a.on("reInstallationComplete",function(){e.info("Application reinstallation detected. Getting readings data updates.");var r=[],t=[];n.queueCustomFullSync(r,t,"generalUpdates",_.noop)}),e.on(protocol.addRecording,function(r,t){e.info("Add recording message received"),r?S.addRecording(r,function(e,r){t({err:errorUtility.encodeErrorObject(e),recordingId:r})}):t({err:errorUtility.encodeErrorObject(new Error("No File"))})}),e.on(protocol.getRecording,function(e,r){var t=path.join(environment.tempRecordingsPath,e);fs.readFile(t,{encoding:"utf-8"},function(t,o){if(t)S.getRecording(e,function(e,t){r({err:errorUtility.encodeErrorObject(e),recording:t})});else{try{o=JSON.parse(o)}catch(e){return void r({err:errorUtility.encodeErrorObject(e)})}o.recordingDetails&&(delete o.recordingDetails,o.boxRecordingDetailsId=e),r({recording:o})}})}),e.on(protocol.getRecordings,function(e,r){S.getRecordingsByQuery(e,function(e,t){r({err:errorUtility.encodeErrorObject(e),recordings:t})})}),e.on(protocol.addReturnFile,function(e,r){}),e.on(protocol.getInstalledSoftwareVersion,function(e,r){v.getInstalledSoftwareVersion(function(e,t){r(e?"UNKNOWN":t)})}),e.on(protocol.readInstalledSoftwareVersion,function(e,r){v.readInstalledSoftwareVersion(function(e,t){r(e?"UNKNOWN":t)})}),e.on(protocol.getPendingSystemUpdate,function(e,r){v.getPendingSystemUpdate(function(e,t){r(e?{}:t)})}),e.on(protocol.getTriggerTemplateList,function(e,r){p.getTriggerTemplateList(function(e,t){r({err:errorUtility.encodeErrorObject(e),triggerTemplateList:t})})}),e.on(protocol.getTriggerTemplate,function(e,r){p.getTriggerTemplate(e,function(e,t){r({err:errorUtility.encodeErrorObject(e),triggerTemplate:t})})}),e.on(protocol.saveTriggerTemplate,function(e,r){p.addNewTriggerTemplate(e,r)}),e.on(protocol.deleteTriggerTemplate,function(e,r){p.deleteTriggerTemplate(e,function(e){r(e)})}),e.on(protocol.getSoftwareUpdateDetailsOnCSN,function(e,r){y.getSoftwareUpdateDetailsOnCSN(e,function(e){r(e)})}),e.on(protocol.getSoftwareUpdateDetails,function(e,r){y.getSoftwareUpdateDetails(e,function(e){r(e)})}),e.on(protocol.updateVersion,function(e,r){r()}),e.on(protocol.addActivity,function(e,r){e?s.addActivity(e.activity,e.userId,function(e,t){r(e?{err:errorUtility.encodeErrorObject(e)}:{id:t})}):r({err:errorUtility.encodeErrorObject(new Error("No Activity"))})}),e.on(protocol.completeDonorEcuReprogramming,function(e,r){var o=e.id,i=e.userId;async.waterfall([function(e){n.getDataById("DonorEcuDetails",o,function(r,t){e(r,t)})},function(e,r){return e?(e.currentStep=t(e.currentStep)||e.currentStep,e.boxRevisionId+=1,void n.updateData("DonorEcuDetails",o,e,function(t){r(t,e)})):void _.defer(function(){r(new Error("Donor ECU details not found"))})},function(e,r){s.updateDonorEcuActivity(i,e.id||e.localId,e.status,void 0,r)}],function(e){r({err:errorUtility.encodeErrorObject(e)})})}),e.on(protocol.getNonExtendedActivity,function(e,r){e?s.getNonExtendedActivity(e.activityId,function(e,t){r(e?{err:e,activity:null}:{err:null,activity:t})}):r({err:new Error("No Activity")})}),e.on(protocol.getActivity,function(e,r){s.getActivity(e.queryInfo,e.originData,function(e,t){r(e?{err:errorUtility.encodeErrorObject(e)}:{activity:t})})}),e.on(protocol.getModelGuids,function(e,r){u.getModelGUIDsByPin(e,function(e,t){r({error:errorUtility.encodeErrorObject(e),modelGuids:t})})}),e.on(protocol.getEcuAccessLevel,function(e,r){f.getECUAccessLevel(e,function(e,t){r({error:errorUtility.encodeErrorObject(e),ecuAccessLevel:t})})}),e.on(protocol.getUsers,function(e,r){f.getUsers(function(e,t){r({error:errorUtility.encodeErrorObject(e),users:t})})}),e.on(protocol.getUserObject,function(e,r){f.getUserObject(e,function(e,t){r({error:errorUtility.encodeErrorObject(e),userObject:t})})}),e.on(protocol.getUserAuthorizedModules,function(e,r){f.getUserAuthorizedModules(e,function(e,t){r({error:errorUtility.encodeErrorObject(e),modules:t})})}),e.on(protocol.getModelGuidsForUser,function(e,r){g.getModelGuidsForUser(e,function(e,t){r({error:errorUtility.encodeErrorObject(e),modelGuids:t})})}),e.on(protocol.getPossibleModelGuidsForUser,function(e,r){g.getPossibleModelGuidsForUser(e,function(e,t){r({error:errorUtility.encodeErrorObject(e),modelGuids:t})})}),e.on(protocol.getAccessoryModelGuidsForUser,function(e,r){g.getAccessoryModelGuidsForUser(e,function(e,t){r({error:errorUtility.encodeErrorObject(e),modelGuids:t})})}),e.on(protocol.getModelsByIds,function(e,r){g.getModelsByGUIDs(e.modelIds,e.userId,function(e,t){r({error:errorUtility.encodeErrorObject(e),modelGuids:t})})}),e.on(protocol.sendTrimData,function(e,t){r.ONEManager.sendTrimData(e,t)}),e.on(protocol.onTrimData,function(e,t){r.ONEManager.onTrimData(t)}),e.on(protocol.offTrimData,function(e,t){r.ONEManager.offTrimData(t)}),e.on(protocol.addSnapshotData,function(r,t){e.info("Add Snapshot Data message received.");var o=r.filePath;try{r.filePath=path.join(environment.snapshotDataPath,path.basename(o))}catch(e){return void t({error:errorUtility.encodeErrorObject(e)})}n.addData("SnapshotData",r,function(e){return e?void t({error:errorUtility.encodeErrorObject(e)}):void utility.copySingleFile(o,r.filePath,function(e){if(fs.unlink(o,function(e){}),e)return void t({error:errorUtility.encodeErrorObject(e)});var r=n.getSyncStatus(),i=r.quickSyncRunning?2:1,c=function(){n.removeListener("quickSyncFinished",a),n.removeListener("quickSyncError",c),n.removeListener("quickSyncStartFailed",c),t({error:null,uploaded:!1})},a=_.after(i,function(){n.removeListener("quickSyncFinished",a),n.removeListener("quickSyncError",c),n.removeListener("quickSyncStartFailed",c),t({error:null,uploaded:!0})});n.on("quickSyncFinished",a),n.on("quickSyncError",c),n.on("quickSyncStartFailed",c),n.startQuickSync()})})}),e.on(protocol.getSnapshotFilePath,function(e,r){n.getDataByQuery("SnapshotData",{activityId:e},function(e,t){if(e)return void r({error:errorUtility.encodeErrorObject(e)});var o=_.first(t);r({filePath:o&&o.filePath})})}),e.on(protocol.getCanTraceFilePath,function(e,r){n.getDataByQuery("CanTrace",{activityId:e},function(e,t){if(e)return void r({error:errorUtility.encodeErrorObject(e)});var o=_.first(t);r({filePath:o&&o.filePath,fileName:o&&o.fileName})})}),e.on(protocol.resetJDLMDetail,function(e,r){D.resetJDLMInfo(function(e){r(e?{err:errorUtility.encodeErrorObject(e)}:{})})}),e.on(protocol.getJDLMDetail,function(e,r){D.getJDLMInfo(function(e,t){r(e?{err:errorUtility.encodeErrorObject(e)}:{licenseInfo:t})})}),e.on(protocol.updateJDLMDetail,function(e,r){D.updateJDLMInfo(e,function(e){r(e?{err:errorUtility.encodeErrorObject(e)}:{})})}),e.on(protocol.getRecordingDetails,function(e,r){var t=path.join(environment.tempRecordingsPath,e);fs.readFile(t,{encoding:"utf-8"},function(t,o){if(t)n.getDataById("RecordingDetails",e,function(e,t){return e?void r({error:errorUtility.encodeErrorObject(e)}):(t&&delete t.localId,void r({details:t}))});else{try{o=JSON.parse(o)}catch(e){return void r({error:errorUtility.encodeErrorObject(e)})}var i=o.recordingDetails;r({details:i})}})}),e.on(protocol.getCalComponentsList,function(e,r){m.getCalComponentsList(function(e,t){r(e?{err:errorUtility.encodeErrorObject(e)}:{calComponentsList:t})})}),e.on(oneProtocol.startXvdsServer,function(t,o){var n=void 0,i=_.once(function(t){clearTimeout(n),r.ONEManager.offEXEInvokeCall(i),t&&("true"!==t.result?e.warn('The ONE failed to launch the xVDS server. Continuing with the connection attempt. The error reported was "'+t.errorMessage+'"'):e.info("The ONE was able to launch the xVDS server.")),o()});r.ONEManager.onEXEInvokeCall(i);var c=path.join(environment.xvdsInstallationDirectory,"xvds.exe");r.ONEManager.invokeApp(c,""),n=setTimeout(function(){e.warn("Failed to launch the xVDS server."),i()},5e3)}),r.onReady()}var _=require("underscore"),async=require("async"),path=require("path"),environment=require("Environment"),errorUtility=require("ErrorUtility"),url=require("url"),protocol=require("Protocol"),oneProtocol=require("apps/OneManager/node_modules/Protocol"),utility=require("FileUtility"),certificateUtil=require("./certificateUtility.js"),fs=require("fs"),syncOptionTypes=require("./databaseManagement/syncManagement/syncOptions"),ActivityProvider=require("./dataProviders/ActivityProvider.js"),PinSearchDataProvider=require("./dataProviders/pinSearchDataProvider.js"),UsersDataProvider=require("./dataProviders/UsersDataProvider.js"),ModelsDataProvider=require("./dataProviders/ModelsDataProvider.js"),TriggerTemplateDataProvider=require("./dataProviders/TriggerTemplateDataProvider.js"),SystemUpdateProvider=require("./dataProviders/SystemUpdateProvider.js"),RecordingDataProvider=require("./dataProviders/RecordingDataProvider.js"),ControllerDataProvider=require("./dataProviders/ControllerDataProvider.js"),JDLMDataProvider=require("./dataProviders/JDLMDataProvider.js"),CalComponentsToExcludeForCustProvider=require("./dataProviders/CalComponentsToExcludeForCustProvider.js");module.exports=setup;