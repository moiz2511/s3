"use strict";var WebSocketServer=require("ws").Server,http=require("http"),express=require("express"),_=require("underscore"),async=require("async"),events=require("events"),util=require("util"),WinReg=require("winreg"),hive;hive=process.env.NODE_ENV&&"production"===process.env.NODE_ENV?WinReg.HKLM:WinReg.HKCU;var registryKey=new WinReg({hive:hive,key:"\\SOFTWARE\\ServiceADVISOR5\\System\\ONE"}),webSocketHelper=function(e,t){var r=this;r._app=e,events.EventEmitter.call(r),r._lastSentMessage=void 0;var s=http.createServer(express());s.listen(0),e.on("stop",function(){s.close(),_.each(r._wss.clients,function(e){e.terminate()})}),async.series([function(e){e=_.once(e);var t=function(t){r._wss.removeListener("listening",n),e(t)},n=function(){r._wss.removeListener("error",t),e()};r._wss=new WebSocketServer({server:s}).once("error",t).once("listening",n)},function(t){r._wss.on("connection",function(e){r._lastSentMessage&&e.send(JSON.stringify(r._lastSentMessage)),e.on("message",function(t){try{t=JSON.parse(t)}catch(t){return void e.send(JSON.stringify({type:"error",data:{}}))}r.emit(t.type,t.data)})}),r._wss.on("error",function(t){e.error("ONE websocket server error: ",t)}),t()},function(t){registryKey.set("port","REG_DWORD",s.address().port,function(r){r?e.error("Failed to set registry key for the ONE, ",r.message):e.info("Port for the ONE set to ",s.address().port),t(r)})}],function(e){t(e)})};util.inherits(webSocketHelper,events.EventEmitter),webSocketHelper.prototype.sendMessage=function(e,t){var r=this;_.isEmpty(r._wss.clients)&&r._app.warn("Attempting to send message to the ONE but none are connected! Message type: ",e),r._lastSentMessage={type:e,data:t},_.each(r._wss.clients,function(r){r.send(JSON.stringify({type:e,data:t}))})},module.exports=webSocketHelper;