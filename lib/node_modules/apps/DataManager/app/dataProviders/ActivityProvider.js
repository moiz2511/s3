"use strict";var _=require("underscore"),async=require("async"),url=require("url"),uuid=require("uuid-v4"),JobsDataProvider=require("./JobsDataProvider.js"),RecordingDataProvider=require("./RecordingDataProvider.js"),path=require("path"),environment=require("Environment"),utility=require("FileUtility"),fs=require("fs"),ActivityProvider=function(t,i,e,o){var n={canTrace:"CanTrace",snapshots:"SnapshotData",recording:"Recording"},r=new JobsDataProvider(t,i,e,o),c=new RecordingDataProvider(t,i),d=function(t,e,o){e&&(t.boxRecordingDetailsId=e),i.addData("Activity",t,function(t,i){return t?void o(t):void g(i,o)})},a=function(t,i){return _.extend(new Error(i),{statusCode:t})},u=function(t,i){var e=[],o=function(t,i){return{id:i.localId,completed:i.completedTime,index:t,playbackDurationInSecs:i.durationInSecs,url:"/SAWeb/services/Recordingservice/getRecording/"+i.localId}};if("liveRecording"===t.type||"liveIdmRecording"===t.type||"importRecording"===t.type){if(_.isEmpty(t.recordings))return t.recordingCount=0,delete t.totalRecordings,void i(null,t);t.recordingCount=t.totalRecordings,delete t.totalRecordings,_.each(t.recordings,function(t){e.push(function(i){var e=o.bind(void 0,t.currentRecordingNumber);c.getRecording(t.boxRecordingId,function(t,o){var n;_.isEmpty(o)||(n=e(o)),i(null,n)})})}),async.parallel(e,function(e,o){e?i(e,t):(t.recordings=_.compact(o),i(null,t))})}else i(null,t)},l=function(i,e){var o=i.jobId;return o?void r.getJob(o,function(o,n){o&&t.error("An error occurred while retrieving a Job",o),n&&!o?e(null,_.extend(i,{jobName:n.name,isJobShared:n.shared})):e(null,i)}):void e(null,i)},v=function(t,e){i.getDataByQuery("Recording",{boxActivityId:t.localId},function(o,n){return!_.isEmpty(n)||o?void e(o,n):void i.getDataByQuery("Recording",{activityId:t.id},function(t,i){e(t,i)})})},s=function(t,e,o){switch(t.type){case"liveRetrieveDtc":case"liveClearRetrieveDtc":case"connectedLive":if(t.activeCodes=t.dtcs&&t.dtcs.length,t.activeCodes=t.activeCodes||0,e&&e.headers&&e.protocol){var n=url.format({protocol:e.protocol,host:e.headers["x-originalhost"],pathname:"/SAWeb/services/DTCInfo/"}),r=e.body&&e.body.language||"en";t.dtcSet=n+t.localId+"/"+r}t.title=t.type,delete t.snapshotData,delete t.connectionXml,delete t.controllers,delete t.dtcs,_.defer(o);break;case"canTrace":e&&e.headers&&e.protocol&&(t.canTraceUrl=url.format({protocol:e.protocol,host:e.headers["x-originalhost"],pathname:"/SAWeb/services/cantrace/"+t.localId})),delete t.fileName,_.defer(o);break;case"liveRecording":case"liveIdmRecording":case"importRecording":if(t.recordingDetailsId=t.boxRecordingDetailsId||t.recordingDetailsId,delete t.boxRecordingDetailsId,t.recordings)return void _.defer(o);v(t,function(i,e){t.recordings=_.chain(e).sortBy("completedTime").map(function(t,i){return{boxRecordingId:t.localId,currentRecordingNumber:i+1}}).value(),o(i)});break;case"donorEcu":i.getDataById("DonorEcuDetails",t.boxDonorEcuDetailsId||t.donorEcuDetailsId,function(i,e){e&&(e.donorEcuDetailsId=e.id||e.localId,delete e.id,delete e.localId,t.donorEcuDetails=e,delete t.boxDonorEcuDetailsId,delete t.donorEcuDetailsId),o(i)});break;default:_.defer(o)}},f=function(t,i,e){async.waterfall([function(i){s(t,e,function(){i()})},function(i){if(e&&e.headers&&e.protocol){var o=url.format({protocol:e.protocol,host:e.headers["x-originalhost"],pathname:"/SAWeb/services/activity/"}),n=o+t.localId;i(null,_.extend(t,{updateUrl:n,addNoteUrl:n+"/note"}))}else i(null,t)},u,l],i)},y=function(t){return function(i,e){e||(e=i,i=void 0),i?f(i,e,t):e()}},p=function(t,i){var e=[];return t?void async.each(t,function(t,i){r.getJob(t,function(t,o){o&&(e.push(o.jobId),e.push(o.boxJobId)),i(t)})},function(t){return t?void i(t):void i(void 0,_.compact(_.unique(e)))}):void i(void 0,e)},g=function(t,i){async.waterfall([function(i){_.isArray(t)&&(t=_.compact(t)),i(void 0,t)},I,D,b,A,h],i)},I=function(t,i){var e=!0;_.isArray(t)||(t=[t],e=!1),t=_.map(t,function(t){if(t)return t.revisionId=t.boxRevisionId,delete t.boxRevisionId,t}),e?i(void 0,t):i(void 0,_.first(t))},D=function(t,i){var e=!0;_.isArray(t)||(t=[t],e=!1),async.each(t,function(t,i){r.getJob(t.jobId,function(e,o){o&&o.boxJobId&&(t.jobId=o.boxJobId),i()})},function(o){return o?void i(o):void(e?i(void 0,t):i(void 0,_.first(t)))})},b=function(t,i){var e=!0,o=[];_.isArray(t)||(t=[t],e=!1),_.each(t,function(t){t.id=t.localId||t.id,delete t.localId,o.push(t)}),e?i(void 0,o):i(void 0,_.first(o))},A=function(t,i){var e=!0,o=[];_.isArray(t)||(t=[t],e=!1),_.each(t,function(t){_.each(t.notes,function(t){t.noteId=t.boxNoteId||t.noteId,delete t.boxNoteId}),o.push(t)}),e?i(void 0,o):i(void 0,_.first(o))},h=function(t,i){var e=!0,o=[];_.isArray(t)||(t=[t],e=!1),_.each(t,function(t){switch(t.type){case"executedDiagProc":t.diagProcDetailId=t.boxDiagProcDetailId||t.diagProcDetailId,delete t.boxDiagProcDetailId}o.push(t)}),e?i(void 0,o):i(void 0,_.first(o))},m=function(t,e,o,n,r){async.parallel([function(e){return t?void i.undoAdd(t,function(t){e()}):void _.defer(function(){e()})},function(t){return _.isEmpty(o)?void _.defer(function(){t()}):void async.each(o,function(t,e){i.undoAdd(t,function(t){e()})},function(i){t()})},function(t){i.undoAdd(e,function(i){t()})},function(t){return _.isEmpty(n)?void _.defer(function(){t()}):void async.each(n,function(t,i){utility.deleteDirectoryOrFile(t.filePath,function(t){i()})},function(i){t()})}],function(t){r(t)})},x=function(t,e,o,r){return _.isEmpty(t)?void _.defer(function(){r(null,[])}):void async.map(t,function(t,r){return t?(o&&(t.activityId=o),e&&(t.boxRecordingDetailsId=e),void i.addData(n[t.type],t,function(t,i){r(t,i.localId)})):void r()},function(t,i){r(t,_.compact(i))})},P=function(t,i){return _.isEmpty(t)?void _.defer(function(){i(null)}):void async.each(t,function(t,i){t||i(),utility.copySingleFile(t.currentFilePath,t.filePath,function(t){i(t)})},function(t){i(t)})},R=function(t,e){return t?void i.addData("RecordingDetails",t,function(t,i){e(t,i&&i.localId)}):void _.defer(function(){e(null)})},w=function(t,i,e,o){async.waterfall([function(t){R(i,function(i,e){t(i,e)})},function(t,i){d(e,t,function(e,o){i(e,t,o&&o.id)})},function(i,e,o){x(t,i,e,function(t,n){o(t,i,e,n)})},function(i,e,o,n){P(t,function(t){n(t,i,e,o)})}],function(t,i,e,n){o(t,i,e,n)})},E=function(t,e,o,n){var r=function(t,o,r,c){!t&&r?(i.startQuickSync(),n(null,r)):m(o,r,c,e,function(){n(t||a(500,"Failed to add activity"))})};w(e,o,t,function(t,i,e,o){r(t,i,e,o)})};ActivityProvider.prototype.addActivity=function(t,i,e){var o=new Date;if(!i)return void e(a(500,"Failed to add activity"));t.createdBy=i,t.lastModifiedBy=i,t=_.defaults(t,{revisionId:1,activityTime:o,lastModifiedTime:o});var n=t.fileMetaData;delete t.fileMetaData;var r=t.recordingDetails;delete t.recordingDetails,E(t,n,r,e)},ActivityProvider.prototype._getActivity=function(t,e){t=_.isObject(t)?t:{activityId:t},t.activityId?i.getDataById("Activity",t.activityId,function(t,i){e(t,i)}):t.recordingDetailsId?i.getDataByQuery("Activity",{recordingDetailsId:t.recordingDetailsId},function(t,i){var o=i&&_.first(i.activities);e(t,o)}):t.donorEcuDetailsId?i.getDataByQuery("Activity",{donorEcuDetailsId:t.donorEcuDetailsId},function(t,i){var o=i&&_.first(i.activities);e(t,o)}):e(new Error("No valid Id provided for activity query"))},ActivityProvider.prototype.getActivity=function(t,i,e){var o=this;o._getActivity(t,function(t,o){return t||!o?void e(t):void async.waterfall([y(i).bind(void 0,o),function(t,i){g(t,i)}],function(t,i){e(t,i)})})},ActivityProvider.prototype.getNonExtendedActivity=function(t,i){var e=this;e._getActivity(t,function(t,e){return t||!e?void i(t):void async.waterfall([function(t){t(null,e)},l,u,function(t,i){g(t,i)}],function(t,e){i(t,e)})})},ActivityProvider.prototype.getActivities=function(t,e,o){t.context&&!_.isEmpty(t.context)||e(a(400,"Query context property must be set"));var n,r=new Date;async.waterfall([function(i){p(t.context.jobId,function(e,o){o&&(t.context.jobId=o),i(e)})},function(e){t=t||{},t.count=t.count||10,i.getDataByQuery("Activity",t,function(t,i){return i.activities=_.reject(i.activities,function(t){var i=_.some(t.equipment,function(t){return null!==t.pin});return!t.jobId&&!i||_.isString(t.createdBy)||_.isString(t.lastModifiedBy)}),t||!i?void e(t):(i.lastActivity&&(n=i.lastActivity.activityTime||i.lastActivity.lastModifiedTime),void e(void 0,i.activities))})},function(t,i){return _.isEmpty(t)?void i(null,[]):void async.map(t,y(o),i)},g],function(t,i){if(t)return void e(t);var o,c;i&&_.size(i)&&(o=i[i.length-1].activityTime,c=i[0].activityTime),e(null,{dateStart:o,dateEnd:r,activities:i,newestUpdate:c,oldestDate:n})})},ActivityProvider.prototype._updateActivity=function(t,e,o,n,r){e.revisionId=r,async.waterfall([function(o){i.updateData("Activity",t,e,function(t,i){o(t,i)})},y(n),g],o)},ActivityProvider.prototype.updateActivityJobId=function(t,e,o,n,r,c){var d=this;if(!_.isString(e)&&null!==e)return void r(a(400,"jobId must be a String or null"));var u=function(i){d._updateActivity(t,{jobId:e,lastModifiedBy:n},i,c,o)},l=function(t,o){switch(t.type){case"executedDiagProc":null===e?i.updateData("DiagnosticProcedureDetail",t.diagProcDetailId,{jobId:null,boxJobId:null},function(i,e){o(i,t)}):o(void 0,t);break;default:o(void 0,t)}},v=function(t,e){i.startQuickSync(),e(void 0,t)};async.waterfall([u,l,v],r)},ActivityProvider.prototype.addActivityNote=function(t,e,o,n,r){var c=uuid(),d=new Date,a={boxNoteId:c,noteText:e,lastModifiedBy:o,lastModifiedTime:d};async.waterfall([function(e){i.getDataById("Activity",t,function(t,i){return t?void e(t):void e(void 0,i)})},function(e,n){if(!e)return void n(new Error("Activity not found"));var r=e.notes||[];r.push(a),i.updateData("Activity",t,{notes:r,lastModifiedBy:o,lastModifiedTime:new Date},function(t,e){return t?void n(t):(i.startQuickSync(),void n(void 0,e))})},y(r),g],function(t,i){return t?void n(t):void n(t,{activity:i,noteId:c})})},ActivityProvider.prototype.updateActivityNote=function(t,e,o,n,r,c){var d=this,u=new Date;async.waterfall([function(i){d._getActivity(t,i)},function(r,c){var d=_.findWhere(r.notes,{noteId:e});return d||(d=_.findWhere(r.notes,{boxNoteId:e})),d?(d.noteText=o,d.lastModifiedBy=n,d.lastModifiedTime=u,void i.updateData("Activity",t,{notes:r.notes,lastModifiedBy:n,lastModifiedTime:u},function(t,e){return t?void c(t):(i.startQuickSync(),void c(void 0,e))})):void c(a(404,"Activity note does note exist"))},y(c),g],function(t,i){r(t,i)})},ActivityProvider.prototype.updateDonorEcuActivity=function(t,e,o,n,r){var c=this,d=new Date,a={lastModifiedBy:t,lastModifiedTime:d};o&&"inProgress"===o?a.activityTime=null:o&&(a.activityTime=d),async.waterfall([function(t){c._getActivity({donorEcuDetailsId:e},t)},function(t,e){i.updateData("Activity",t.localId,a,function(t,o){return t?void e(t):(i.startQuickSync(),void e(void 0,o))})},y(n),g],function(t,i){r(t,i)})},ActivityProvider.prototype.removeActivityNote=function(t,e,o,n,r){var c=this;async.waterfall([function(i){c._getActivity(t,i)},function(n,r){var c=_.findWhere(n.notes,{noteId:e});if(c||(c=_.findWhere(n.notes,{boxNoteId:e})),!c)return void r(a(404,"Activity note does note exist"));var d=_.without(n.notes,c);i.updateData("Activity",t,{notes:d,lastModifiedBy:o,lastModifiedTime:new Date},function(t,e){return t?void r(t):(i.startQuickSync(),void r(void 0,e))})},y(r),g],function(t,i){n(t,i)})}};module.exports=ActivityProvider;