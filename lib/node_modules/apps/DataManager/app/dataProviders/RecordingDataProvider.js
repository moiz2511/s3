"use strict";var fs=require("fs"),_=require("underscore"),async=require("async"),fileUtility=require("fileUtility"),RecordingDataProvider=function(o,r){this._app=o,this._dbManager=r};RecordingDataProvider.prototype.getRecording=function(o,r){return o?void this._dbManager.getDataById("Recording",o,function(o,i){return o?void r(o):void r(void 0,i)}):void r()},RecordingDataProvider.prototype.getRecordingsByQuery=function(o,r){o=o||{},this._dbManager.getDataByQuery("Recording",o,function(o,i){return o?void r(o):void r(void 0,i)})},RecordingDataProvider.prototype.addRecording=function(o,r){var i=this;async.waterfall([function(e){o.importFromLocation?(i._app.debug("Incoming recording has a temporary file location. Moving file to final location: "+o.path),fileUtility.copySingleFile(o.importFromLocation,o.path,function(o){o?r(new Error("Unable to import file")):e()})):e()},function(r){var e=_.omit(o,"importFromLocation");i._dbManager.addData("Recording",e,function(o,i){!o&&i?r(void 0,i.localId):r(o||new Error("Failed to add recording."))})}],function(e,t){var n;e&&o.importFromLocation?(i._app.debug("Recording could not be added to the database. Deleting the imported file."),n=o.path):o.importFromLocation&&(i._app.debug("Deleting recording temporary file."),n=o.importFromLocation),n?fs.unlink(n,function(o){o&&i._app.warning("Unable to delete file after adding recording.",o),r(e,t)}):r(e,t)})},RecordingDataProvider.prototype.getRecordings=function(o){var r=this;r._dbManager.getDataByQuery("Recording",{},function(r,i){i=_.map(i,function(o){return _transformIds(o)}),o(void 0,i)})};var _transformIds=function(o){if(o)return o.boxRecordingId=o.localId||o.boxRecordingId,o.serverRecordingId=o.id||o.serverRecordingId,_.omit(o,"localId","id")};module.exports=RecordingDataProvider;