"use strict";var _=require("underscore"),async=require("async"),ModelsDataProvider=require("./ModelsDataProvider.js"),UsersDataProvider=require("./UsersDataProvider.js"),JobsDataProvider=function(t,o,a,e){this._app=t,this._dbManager=o,this._modelsDataProvider=new ModelsDataProvider(t,o,a,e),this._usersDataProvider=new UsersDataProvider(t,o,e)};JobsDataProvider.prototype.addNewJob=function(t,o,a){var e=this;t.createdBy=o,e._dbManager.addData("Job",{type:"newJob",data:t},function(t,o){return t?void a(t):(e._dbManager.startQuickSync(),void a(void 0,o))})},JobsDataProvider.prototype.addJobBookmark=function(t,o,a){var e=this;e._dbManager.updateData("Job",t,{type:"bookmarkAdd",data:o},function(t,o){return t?void a(t):(e._dbManager.startQuickSync(),void a(void 0,o))})},JobsDataProvider.prototype.deleteJobBookmark=function(t,o,a,e){var r=this;r._dbManager.updateData("Job",t,{type:"bookmarkDelete",data:{type:o,itemId:a}},function(t,o){return t?void e(t):(r._dbManager.startQuickSync(),void e(void 0,o))})},JobsDataProvider.prototype.getAllJobs=function(t){var o=this;o._dbManager.getDataByQuery("Job",{getAllJobs:!0},function(o,a){t(o,a)})},JobsDataProvider.prototype.getJobs=function(t,o,a,e,r,i,n,d){var u=this;u._dbManager.getDataByQuery("Job",{count:t,startDate:o,endDate:a,olderThan:e,state:r,user:i,requestingUser:n},function(t,o){d(t,o)})},JobsDataProvider.prototype.getJob=function(t,o){var a=this;return t?void a.getJobWithUser(t,void 0,o):void o()},JobsDataProvider.prototype.getJobWithUser=function(t,o,a){var e=this;return t?void async.waterfall([function(o){e._dbManager.getDataById("Job",t,function(t,a){a||(t=new Error("Job not found."),t.statusCode=404),o(t,a)})},function(t,o){e.applyDataFencingGroups([t],function(t,a){o(t,_.first(a))})},function(t,a){o?e._usersDataProvider.getUsersDataFencingGroups(o,function(o,r,i){return o?void a(o):e.determineAuthorization(r,i,t.dataFencingGroups)?void a(void 0,t):(o=new Error("Not data fenced for this job."),o.statusCode=403,void a(o))}):a(void 0,t)}],function(t,o){return t?void a(t):(o.jobId=o.id,o.boxJobId=o.localId,void a(void 0,o))}):void a()},JobsDataProvider.prototype.applyDataFencingGroups=function(t,o){var a=this,e={},r=function(t){var o=_.map(t,function(t){return e[t]}),a=_.findWhere(o,{isVehicle:!0});return a?a.dataFencingGroups||[]:a?void 0:_.reduce(o,function(t,o){return _.union(t,o?o.dataFencingGroups:[void 0])},[])},i=_.chain(t).map(function(t){return _.pluck(t.models,"modelGUID")}).flatten().compact().uniq().value();async.each(i,function(t,o){a._modelsDataProvider.getModelByGUID(t,function(a,r){return a?void o(a):(e[t]=r,void o())})},function(a){if(a)return void o(a);var e=_.map(t,function(t){var o=_.pluck(t.models,"modelGUID");return t.dataFencingGroups=r(o),t});o(void 0,e)})},JobsDataProvider.prototype.determineAuthorization=function(t,o,a){var e=!_.contains(a,void 0),r=!_.isEmpty(_.intersection(a,t)),i=!_.isEmpty(_.intersection(a,o)),n=_.isEmpty(a);if(e&&r&&i||n)return!0},JobsDataProvider.prototype.updateJobWithoutSync=function(t,o,a,e){o.lastModifiedTime=(new Date).toISOString(),o.lastModifiedBy=a;var r=this;r._dbManager.updateData("Job",t,{type:"jobUpdate",data:o},function(t,o){return t?void e(t):void e(void 0,o)})},JobsDataProvider.prototype.updateJob=function(t,o,a,e){var r=this;r.updateJobWithoutSync(t,o,a,function(t,o){return t?void e(t):(r._dbManager.startQuickSync(),void e(void 0,o))})},JobsDataProvider.prototype.requestJobDownload=function(t,o){var a=this;a._dbManager.addData("Job",{type:"jobDownload",data:t},function(t){o(t)})},module.exports=JobsDataProvider;