"use strict";var _=require("underscore"),async=require("async"),UsersDataProvider=require("../dataProviders/UsersDataProvider.js"),ModelsDataProvider=function(e,r,o,t){this._app=e,this._dbManager=r,this._db=o,this._usersProvider=new UsersDataProvider(e,r,t)};ModelsDataProvider.prototype.getModelsByDataFencingGroups=function(e,r,o){var t=this._app,i=this;if(_.isEmpty(e)||_.isEmpty(r)){var n="No authorized data fencing groups provided";return t.error(n),void o(new Error(n))}async.parallel({prevUserModels:function(e){i.getModelsByDataFencingGroup(r,e)},newUserModels:function(r){i.getModelsByDataFencingGroup(e,r)}},function(e,r){if(e)return void o(e);var t=_.indexBy(r.newUserModels,"localId"),i=_.filter(r.prevUserModels,function(e){return e.mG=e.localId,delete e.localId,delete e.id,_.has(t,e.mG)});o(void 0,i)})},ModelsDataProvider.prototype.getModelsByDataFencingGroup=function(e,r){var o=this._app,t=this._dbManager;t.getDataByQuery("Model",{dataFencingGroups:e},function(e,t){if(e){var i="Database error attempting to query Models collection. "+e;return o.error(i),void r(new Error(i))}r(null,t)})},ModelsDataProvider.prototype.getModelsAllowedForUser=function(e,r){var o=this;o._usersProvider.getFullUserObjectAndLastLoggedInUserObject(e,function(e,t,i){return e?(o._app.error("Error getting full user object. ",e),void r(e)):void o.getModelsByDataFencingGroups(t.dataFencingGroups,i.dataFencingGroups,function(e,t){e&&o._app.error("Error getting models by data fencing groups. ",e),r(e,t)})})},ModelsDataProvider.prototype.getModels=function(e,r,o){this._app;this.getModelsAllowedForUser(r,function(r,t){if(r)return void o(r);var i=_.chain(t).filter(function(e){return e.hasData}).map(function(r){var o="en";if(r.translations[e])o=e;else if(!r.translations[o]){var t=_.keys(r.translations);if(0==_.size(t))return;o=t[0]}return{mG:r.mG,d:r.d,di:r.di,piModelKey:r.piModelKey,isVehicle:r.isVehicle,m:r.translations[o].m,c:r.translations[o].c,s:r.translations[o].s}}).value();o(void 0,_.compact(i))})},ModelsDataProvider.prototype.getAllModels=function(e,r,o){this._app;this.getModelsAllowedForUser(r,function(r,t){if(r)return void o(r);var i=_.map(t,function(r){var o="en";if(r.translations[e])o=e;else if(!r.translations[o]){var t=_.keys(r.translations);if(0==_.size(t))return;o=t[0]}return{mG:r.mG,d:r.d,di:r.di,piModelKey:r.piModelKey,isVehicle:r.isVehicle,m:r.translations[o].m,c:r.translations[o].c,s:r.translations[o].s}});o(void 0,_.compact(i))})},ModelsDataProvider.prototype.getModelGuidsForUser=function(e,r){var o=this;o.getModelsAllowedForUser(e,function(e,o){r(e,_.pluck(o,"mG"))})},ModelsDataProvider.prototype.getPossibleModelGuidsForUser=function(e,r){var o=this;o._usersProvider.getFullUserObject(e,function(e,t){return e?(o._app.error("Error getting full user object. ",e),void r(e)):void o.getModelsByDataFencingGroup(t.dataFencingGroups,function(e,t){e&&o._app.error("Error getting models by data fencing groups. ",e),r(e,_.pluck(t,"mG"))})})},ModelsDataProvider.prototype.getAccessoryModelGuidsForUser=function(e,r){var o=this;o.getModelsAllowedForUser(e,function(e,o){var t=_.chain(o).filter(function(e){return 4===e.modelType||5===e.modelType}).pluck("mG").value();r(e,t)})},ModelsDataProvider.prototype.getModelsByGUIDs=function(e,r,o){var t=this._dbManager,i=this;o||(o=r,r=void 0),t.getDataByIds("Model",e,function(e,t){if(e)return void o(e);var n=function(e){return _.map(e,function(e){return _.extend(_.omit(e,"localId","id"),{mG:e.localId})})};r?i._usersProvider.getUsersDataFencingGroups(r,function(e,r,i){var a=_.intersection(r,i),s=_.reject(t,function(e){return _.isEmpty(_.intersection(e.dataFencingGroups,a))});o(void 0,n(s))}):o(void 0,n(t))})},ModelsDataProvider.prototype.getModelByGUID=function(e,r){var o=this._dbManager;o.getDataById("Model",e,function(e,o){return e?void r(e):void(o?(o.mG=o.localId,r(void 0,_.omit(o,"localId","id"))):r())})},ModelsDataProvider.prototype.getPinInfoFromPinPrefixMatch=function(e,r,o){var t=this._dbManager,i=this._usersProvider;async.waterfall([function(e){i.getUsersDataFencingGroups(r,e)},function(r,o,i){async.map(e,function(e,i){t.getDataByQuery("Model",{userDataFencingGroups:r,allowedDataFencingGroups:o,pinPrefix:e.trim().substr(0,13)},function(r,o){return r?void i(r):void i(null,{pin:e,modelGUIDs:_.pluck(o,"localId")})})},i)}],o)},ModelsDataProvider.prototype.flagAllModelsAsHasData=function(e){var r=this,o=r._db;o.collection("Models").update({hasData:!1},{$set:{hasData:!0}},{multi:!0},function(r){e(r)})},ModelsDataProvider.prototype.removeModelsFromModelsCollection=function(e,r){var o=this;if(0===e.length)return void r();var t=o._db.collection("Models").initializeUnorderedBulkOp();_.each(e,function(e){t.find({localId:e}).remove()}),t.execute(function(e){r(e)})},module.exports=ModelsDataProvider;