"use strict";var _=require("underscore"),async=require("async"),fs=require("fs"),path=require("path"),environment=require("Environment"),documentId="PendingSystemUpdate",SystemUpdateProvider=function(t,e,n){this._app=t,this._db=e,this._systemUpdateInstallerClient=n;var o=this;this._systemUpdateInstallerClient.on("newInstallationVersion",function(t){}),SystemUpdateProvider.prototype.setPendingInstalledSoftwareVersion=function(t,e,n){var o=this._db,i={newVersion:t,installationProgress:"pending"};e&&(i.isCriticalUpdateRequired=e,i.postPoneCountForCriticalUpdate=3),o.collection("SystemUpdateInformation").update({id:documentId},{$set:i},{upsert:!0},function(t){n(t)})},SystemUpdateProvider.prototype.getPendingSystemUpdate=function(t){var e=this._db;e.collection("SystemUpdateInformation").findOne({id:documentId},function(e,n){t(e,n||{})})},SystemUpdateProvider.prototype.checkForPendingSystemUpdate=function(t,e){e||(e=t,t=fs);var n=this;n.getPendingSystemUpdate(function(o,i){if(!o&&i&&i.newVersion){var r=path.join(environment.updateStagingPath,i.newVersion,environment.updateFileName);t.exists(r,function(t){t?e(null,i):n.clearPendingSystemUpdate(i.installedVersion,function(t,n){e(t,n)})})}else e(o,i)})},SystemUpdateProvider.prototype.clearPendingSystemUpdate=function(t,e){var n=this._db;n.collection("SystemUpdateInformation").remove({id:documentId},function(o){if(o)e(o);else{var i={id:documentId,installedVersion:t};n.collection("SystemUpdateInformation").insert(i,function(t){e(t,i)})}})},SystemUpdateProvider.prototype.getAvailableSoftwareVersion=function(t){var e=this._db;e.collection("SystemUpdateInformation").findOne({id:documentId},function(e,n){n?(o._app.info("Currently available software version: ",n.installedVersion),t(e,n.newVersion)):t(e,null)})},SystemUpdateProvider.prototype.readInstalledSoftwareVersion=function(t){var e=this,n=this._db;n.collection("SystemUpdateInformation").findOne({id:documentId},function(n,o){o?(e._app.info("Currently installed software version: ",o.installedVersion),e.installedVersion=o.installedVersion,t(n,o.installedVersion)):t(n,null)})},SystemUpdateProvider.prototype.setSoftwareInstalledObject=function(t,e){var n=this._db;n.collection("SystemUpdateInformation").insert({id:documentId,installedVersion:t},function(t){e(t)})},SystemUpdateProvider.prototype.setInstalledSoftwareVersion=function(t,e){var n=this._db;n.collection("SystemUpdateInformation").update({id:documentId},{$set:{installedVersion:t}},function(t){e(t)})}};SystemUpdateProvider.prototype.getInstalledSoftwareVersion=function(t){this.installedVersion?t(void 0,this.installedVersion):this.readInstalledSoftwareVersion(t)},SystemUpdateProvider.prototype.addInstallationSummary=function(t,e){var n=this._db;n.collection("SystemUpdateInstallationSummary").insert(t,function(t){e(t)})},SystemUpdateProvider.prototype.retrieveInstallationSummaries=function(t){var e=this._db;e.collection("SystemUpdateInstallationSummary").find({}).toArray(function(e,n){t(e,n)})},SystemUpdateProvider.prototype.clearInstallationSummaries=function(t){var e=this._db;e.collection("SystemUpdateInstallationSummary").remove({},function(e){t(e)})},SystemUpdateProvider.prototype.setForceInstallAfter=function(t,e){var n=this;n._db.collection("SystemUpdateInformation").update({id:documentId},{$set:{forceInstallAfter:t}},function(t){e(t)})},SystemUpdateProvider.prototype.setSoftwareDownload=function(t,e){var n=new Date,o=this._db;o.collection("SystemUpdateInformation").findOne({id:documentId},function(i,r){i?e(i,null):o.collection("SystemUpdateInformation").update({id:documentId},{$set:{downloadInitiatedBy:t,downloadTime:n}},function(t){return t?void e(t):void o.collection("SystemUpdateInformation").findOne({id:documentId},function(t,n){n?e(t,n.newVersion):e(t,null)})})})},SystemUpdateProvider.prototype.startSoftwareInstallation=function(t,e){var n=new Date,o=this,i=this._db;i.collection("SystemUpdateInformation").findOne({},function(r,a){r?e(r,null):i.collection("SystemUpdateInformation").update({id:documentId},{$set:{installationInitiatedBy:t,installationStartTime:n,installationProgress:"progress"}},function(i){return i?void e(i):void o._systemUpdateInstallerClient.startInstallation(n,t,a.newVersion,function(t){e(t)})})})},module.exports=SystemUpdateProvider;