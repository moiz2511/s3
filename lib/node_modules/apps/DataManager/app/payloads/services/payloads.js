"use strict";function PayloadsService(a,e){app=a,networkContext=e,this.payloadProcessorIsAvailable=payloadProcessorIsAvailable,this.fetchPayload=fetchPayload,this.validatePayload=validatePayload,this.getPayloadType=getPayloadType,this.movePayload=movePayload,this.postProcessPayload=postProcessPayload}function payloadProcessorIsAvailable(a,e){return a?void e():void e(new Error("Payload Processor SA5 configuration is missing"))}function fetchPayload(a,e,o,r,i,t){var l={protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.reprogrammingServiceBasePath.concat(e),query:a};try{l=url.format(l),l=url.parse(l)}catch(a){return void t(a)}var n={method:"GET",url:l,headers:{USER:o,accepts:"application/octet-stream"}};_fetchPayload(n,r,i,t)}function validatePayload(a,e,o,r){function i(a,e){FileUtility.deleteDirectoryOrFile(e,_.noop),r(new Error(a))}app.info("Validating payload: "+e);var t=path.join(a,e),l=o.download.headers["status-id"],n=o.download.digest;if(!l)return void i("Error validating payload: The Status-ID header is missing",t);var d={protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.reprogrammingServiceBasePath.concat("/payloads/status/"+l)};try{d=url.format(d),d=url.parse(d)}catch(a){return void i("Error validating payload: Internal error occurred.",t)}var s={url:d,headers:{Accept:"application/json"}};networkContext.getJson(networkContext.getNetworkOptions(s),function(a,o,l){if(a)return void i("Error validating payload: Request to get payload status failed",t);if(200!==o.statusCode)return void i("Error validating payload: Get payload status returned an error (statusCode:"+o.statusCode+" , message:"+l.message+")",t);if("error"===l.generationResult)return void i("Error validating payload: JDCP generation of payload failed",t);var d=fs.statSync(t).size;return d!==l.totalSize?void i("Error validating payload: File size did not match",t):n!==l.digest?void i("Error validating payload: Digest did not match",t):void r(a,e)})}function getPayloadType(a,e,o,r,i){var t=[new ServicePayload(a),new GsixPayload(a),new SdaPayload(a),new DocCalibrationPayload(a),new DpfCalibrationPayload(a),new InjCalibrationPayload(a),new ScrCalibrationPayload(a),new VtgCalibrationPayload(a),new S42CalibrationPayload(a),new AarPayload(a),new PdxPayload(a)],l=_.find(t,function(a){return a.isMatch(e)});l.filename=e,l.userId=o,l.query=r,i(null,l)}function movePayload(a,e,o){var r=path.join(a,e.filename),i=path.join(e.filePath,e.filename);async.series([_makePayloadStorageDirectory(e.filePath),_movePayloadToDestinationFilePath(r,i)],function(a){FileUtility.deleteDirectoryOrFile(r,function(){o(a,e)})})}function postProcessPayload(a,e,o,r){function i(e){r(e,a)}a.postProcess(i,app,e,o)}function _fetchPayload(a,e,o,r){function i(a){var e=FileUtility.convertBytesToKiloBytes(a);o.onProgress(e)}function t(a,e){return a?void r(a):void r(null,e.filename)}var l=networkContext.downloadFile(a,e,void 0,t);l.on("progress",_.throttle(i,5e3)),l.on("filename",function(a){o.filename=a,app.info("Downloading: "+a)}),o.download=l}function _makePayloadStorageDirectory(a){return function(e){mkdirp(a,e)}}function _movePayloadToDestinationFilePath(a,e){return function(o){fs.rename(a,e,function(a){o(a)})}}var _=require("underscore"),fs=require("fs"),async=require("async"),path=require("path"),mkdirp=require("mkdirp"),FileUtility=require("FileUtility"),config=require("../../config.js"),url=require("url"),environment=require("Environment"),serverBaseUrl=url.parse(environment.serverLocation),ServicePayload=require("../models/payloadTypes/ServicePayload.js"),GsixPayload=require("../models/payloadTypes/GsixPayload.js"),SdaPayload=require("../models/payloadTypes/SdaPayload.js"),DocCalibrationPayload=require("../models/payloadTypes/DocCalibrationPayload.js"),DpfCalibrationPayload=require("../models/payloadTypes/DpfCalibrationPayload.js"),InjCalibrationPayload=require("../models/payloadTypes/InjCalibrationPayload.js"),ScrCalibrationPayload=require("../models/payloadTypes/ScrCalibrationPayload.js"),VtgCalibrationPayload=require("../models/payloadTypes/VtgCalibrationPayload.js"),S42CalibrationPayload=require("../models/payloadTypes/S42CalibrationPayload.js"),AarPayload=require("../models/payloadTypes/AarPayload.js"),PdxPayload=require("../models/payloadTypes/PdxPayload.js"),networkContext,app;module.exports=PayloadsService;