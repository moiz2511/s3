!function(){"use strict";var e=require("underscore"),a=require("async"),r=require("express"),o=require("Middleware/requiredQueryParams.js"),t=require("./services/payloads.js"),s=require("../dataProviders/ControllerDataProvider"),n=require("apps/FrontEndServer/Client"),d=require("Environment"),i=require("iniFiles/PayloadProcessorSA5.js"),l=require("NetUtility").boxAuth.errors,c=require("./models/PayloadStream"),u=function(u,p){function m(e,a,r){var o=e.headers["x-request-id"];if(!o){var t=new Error("x-request-id header is missing");return t.status=400,void r(t)}var s=new c(o,e.headers["x-file-size-kb"]);return s.on("progress",function(e){e.complete||x.broadcast("payloadRequestUpdate",e.getProgressData())}),q[o]?void a.send(202):(q[o]=s,x.broadcast("payloadRequestStarted",s.getProgressData()),a.locals.stream=s,void r())}function y(e,a,r){a.send(202),g(e.query,e.path,e.headers["x-user"],a.locals.stream)}function f(a,r,o){var t=a.body,s=[];if(e.isEmpty(t)){var n=new Error("List of request IDs required");return n.status=400,void o(n)}e.each(t,function(e){var a=q[e];a&&a.download&&(a.download.abort(),s.push(e))}),r.send(s)}function g(e,r,o,t){a.waterfall([function(e){E.payloadProcessorIsAvailable(w,e)},function(a){E.fetchPayload(e,r,o,S,t,a)},function(e,a){E.validatePayload(S,e,t,a)},function(a,r){E.getPayloadType(w,a,o,e,r)},function(e,a){E.movePayload(S,e,a)},function(e,a){E.postProcessPayload(e,b,D,a)}],function(e,a){e&&"aborted"!==e.message?P(e,t):v(a,t),delete q[t.id]})}function v(a,r){var o={statusCode:200,status:"OK"};a&&e.extend(o,a.postProcessMetaData),e.extend(o,r.getProgressData()),r.complete=!0,r.download.aborted?(o.status="ABORTED",u.info("Successfully cancelled payload download: "+r.filename)):u.info("Successfully downloaded payload: "+r.filename),x.broadcast("payloadRequestComplete",o)}function P(a,r){var o={statusCode:500,status:"INTERNAL_SERVER_ERROR"};e.extend(o,r.getProgressData()),r.complete=!0;var t=a.message;t&&t.toUpperCase()===l.BOX_UNAUTHORIZED.toUpperCase()&&(o.statusCode=401,o.status="BOX_UNAUTHORIZED"),u.error("Error downloading payload:",a.message),x.broadcast("payloadRequestComplete",o)}var q={},N=p.webServer,b=new s(u,p.database),E=new t(u,p.networkContext),S=d.userTempPath,w=i(u),D=p.ONEManager,R=n.create(u);R.addNamespace("/payloads");var x=R.getNamespaceWrapper("/payloads");x.on("connection",function(a){var r=e.mapObject(q,function(e){return e.getProgressData()});a.emit("payloadsDownloadState",r)}),N.get("/payloads/service",o("componentSerialNo","controller"),m,y),N.get("/payloads/replacement/ecu",o("engineSerialNo","replacementEcuSerialNo","replacementEcuPartNo"),m,y),N.get("/payloads/replacement/engine",o("engineSerialNo","replacementEngineSerialNo"),m,y),N.get("/payloads/replacement/engine-ecu",o("engineSerialNo","replacementEngineSerialNo","replacementEcuSerialNo","replacementEcuPartNo"),m,y),N.get("/payloads/bundled",o("productSerialNo","softwareBundleId"),m,y),N.get("/payloads/calibrated-component",o("calibratedDeviceType","calibratedDeviceSerialNo","calibratedDevicePartNo"),m,y),N.post("/payloads/abort",r.json(),f)};module.exports=u}();