"use strict";var config=require("../config"),environment=require("Environment"),url=require("url"),serverBaseUrl=url.parse(environment.serverLocation),usageDataCollection="UsageData",retrieveLastUploadTime=function(e,t,o){e.getParameter(t,function(e){o(e)})},updateLastUploadTime=function(e,t,o,r){e.setParameter(t,o,function(e){r(e)})},save=function(e,t,o){e.collection(usageDataCollection).insert(t,function(e){o(e)})},retrieve=function(e,t){e.collection(usageDataCollection).find({}).count(function(o,r){return o?void t(o):void(r>0?e.collection(usageDataCollection).find({}).limit(0).toArray(function(e,o){return e?void t(e):void t(e,o)}):t())})},upload=function(e,t,o){retrieve(e,function(r,n){if(r)return void o(r);if(!n)return void o();var a=url.format({protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.uploadUsageDataUrl}),i={url:a,headers:{"Content-Type":"application/vnd.johndeere.sa.usageData.v1+json"},method:"POST",body:JSON.stringify(n)};t.requestWithTokenValidation(t.getNetworkOptions(i),function(t,r){return t?void o(t):200!==r.statusCode?(t=new Error("Invalid statusCode."),t.statusCode=r.statusCode,void o(t)):(remove(e,n),void o(t,n.length))})})},remove=function(e,t){t.forEach(function(t){e.collection(usageDataCollection).remove({_id:t._id},function(e){})})};exports.save=save,exports.retrieve=retrieve,exports.upload=upload,exports.retrieveLastUploadTime=retrieveLastUploadTime,exports.updateLastUploadTime=updateLastUploadTime;