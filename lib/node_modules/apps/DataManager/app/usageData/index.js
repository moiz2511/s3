"use strict";var usageDataOps=require("./usageDataOperations"),async=require("async"),protocol=require("Protocol"),setup=function(a,e){var t=e.connectorClient,o=e.database,s=require("apps/ConfigStore/Client"),n=new s(a,"usageData"),r=e.networkContext,i=0,u=1,l=!1;usageDataOps.retrieveLastUploadTime(n,"lastUsageDataUploadTime",function(a){i=a||0}),t.on("networkConnected",function(){d()?usageDataOps.upload(o,r,function(e,t){e?a.error("Error while uploading Usage data: ",e):t&&(a.info("Successfully uploaded usage data, ",t," item(s) were uploaded."),p())}):a.info("Usage data not uploaded as last upload time is less than 24 hours. LastUploadTime: "+i)}),a.on(protocol.saveUsageData,function(e,s){usageDataOps.save(o,e,function(e){s(e),t.isOnline()&&(d()&&!l?(l=!0,usageDataOps.upload(o,r,function(e,t){e?a.error("Error Uploading Usage Data: ",e):t&&(a.info("Successfully uploaded Usage data, ",t," item(s) were uploaded."),p()),l=!1,a.info("setting isDataUploadInProgress to false")})):a.info("Usage data not uploaded. isUploadAllowed flag: "+d()+" uploadAlreadyInProgress flag: "+l))})});var d=function(){var a=new Date;return a.setDate(a.getDate()-u),i<a.getTime()},p=function(){var e=(new Date).getTime();usageDataOps.updateLastUploadTime(n,"lastUsageDataUploadTime",e,function(t){t?a.error("Error in saving update time "+t):(i=e,a.info("Last upload Usage Data Time updated in configStore: "+i))})};e.onReady()};module.exports=setup;