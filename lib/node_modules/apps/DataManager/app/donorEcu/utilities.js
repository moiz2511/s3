"use strict";function nextStep(e){var o={downloadDonorEcuPayload:"reprogramDonorEcu",reprogramDonorEcu:"uploadDonorEcuReturnFile",downloadSuspectEcuPayload:"reprogramSuspectEcu",reprogramSuspectEcu:"uploadSuspectEcuReturnFile"};return o[e]}var _=require("underscore"),async=require("async");module.exports.updateDonorEcuDetails=function(e,o,a,t){var u=a.id,r=a.userId;async.waterfall([function(o){e.getDataById("DonorEcuDetails",u,function(e,a){o(e,a)})},function(o,t){return o?(a.payloadFileName&&(o.donorEcuDetails=o.donorEcuDetails||{},o.suspectEcuDetails=o.suspectEcuDetails||{},"downloadDonorEcuPayload"===o.currentStep?o.donorEcuDetails.payloadFileName=a.payloadFileName:"downloadSuspectEcuPayload"===o.currentStep&&(o.suspectEcuDetails.payloadFileName=a.payloadFileName)),o.currentStep=nextStep(o.currentStep)||o.currentStep,o.boxRevisionId+=1,void e.updateData("DonorEcuDetails",u,o,function(e){t(e,o)})):void _.defer(function(){t(new Error("Donor ECU details not found"))})},function(e,a){o.updateDonorEcuActivity(r,e.id||e.localId,e.status,void 0,a)}],function(e){t(e)})};