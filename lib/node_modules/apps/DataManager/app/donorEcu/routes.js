"use strict";var express=require("express"),_=require("underscore"),async=require("async"),DataManagerApp=require("apps/DataManager/Client"),ActivityProvider=require("../dataProviders/ActivityProvider.js");module.exports=function(e,t,n){var o=t.webServer,i=t.databaseManager,d=new ActivityProvider(e,i,t.database,t.registrationClient),a=function(e,t){i.getDataById("DonorEcuDetails",e,function(e,n){n&&(n.donorEcuDetailsId=n.id||n.localId,delete n.id,delete n.localId),t(e,n)})},r=function(e,t,n,o){d.addActivity({type:"donorEcu",jobId:t,equipment:_.map(e.equipment,function(e){return{pin:e.pin,model:e.modelGUID,esn:e.esn}}),boxDonorEcuDetailsId:e.localId,activityTime:null},n,o)},s=function(e,t){i.addData("DonorEcuDetails",e,t)},u=function(e,t){async.waterfall([function(t){i.getDataById("DonorEcuDetails",e.donorEcuDetailsId,function(e,n){t(e,n)})},function(t,n){return t?(e.update.boxRevisionId=t.boxRevisionId+1,void i.updateData("DonorEcuDetails",e.donorEcuDetailsId,e.update,function(e){n(e,t)})):void _.defer(function(){n({statusCode:404})})},function(t,n){var o;e.update.status&&e.update.status!==t.status&&(o=e.update.status),d.updateDonorEcuActivity(e.userId,t.id||t.localId,o,e.req,n)}],function(e,n){t(e,n)})};o.put("/SAWeb/services/donorecudetails/:id",express.json(),function(e,t){var n=_.pick(e,"protocol","headers","body"),o={donorEcuDetailsId:e.params.id,update:e.body,userId:e.headers["x-user"],req:n};u(o,function(e,n){return e?void t.send(e.statusCode||500):n?void t.send(n):void t.send(404)})}),o.post("/SAWeb/services/donorecudetails",express.json(),function(e,t){async.waterfall([function(t){s(e.body,t)},function(t,n){r(t,e.body.jobId,e.headers["x-user"],n)},function(t,n){d.getActivity(t,e,n)}],function(e,n){return e?void t.send(500):void t.send(n)})}),o.get("/SAWeb/services/donorecudetails/:id",function(e,t){a(e.params.id,function(e,n){return e?void t.send(500):n?void t.send(n):void t.send(404)})}),n()};