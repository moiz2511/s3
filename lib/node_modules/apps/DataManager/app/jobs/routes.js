"use strict";var express=require("express"),acceptsCheck=require("Middleware/acceptsCheck.js"),url=require("url"),_=require("underscore"),async=require("async"),DiagnosticProcedureDetailProvider=require("./../dataProviders/DiagnosticProcedureDetailProvider"),JobsDataProvider=require("../dataProviders/JobsDataProvider.js"),ActivityProvider=require("../dataProviders/ActivityProvider.js"),ModelsDataProvider=require("../dataProviders/ModelsDataProvider.js"),jsonToXml=require("JsonToXml"),boxAuth=require("NetUtility").boxAuth,boxAuthMessages=boxAuth.messages,boxAuthErrors=boxAuth.errors,setup=function(e,o,s){var r=o.webServer,i=new JobsDataProvider(e,o.databaseManager,o.database,o.registrationClient),n=new ActivityProvider(e,o.databaseManager,o.database,o.registrationClient),d=new ModelsDataProvider(e,o.databaseManager,o.database,o.registrationClient),t=new DiagnosticProcedureDetailProvider(e,o.databaseManager,o.database,o.registrationClient),a=o.solrClient,u=o.databaseManager,c=function(e,o){var s=_.compact([e.jobId,e.boxJobId]);t.getNewestDiagProcDetailIdObjects(s,function(s,r){return s?void o(s):(e.diagnosticProcedureDetails=r,void o(void 0,e))})},v=function(e){if(e)return e.jobId=e.id,e.boxJobId=e.localId,e.revisionId=e.boxRevisionId,_.omit(e,"localId","id","boxRevisionId","users","dataFencingGroups")},b=function(e){return e.jobId=e.id,e.boxJobId=e.localId,e.revisionId=e.boxRevisionId,_.omit(e,"localId","id","boxRevisionId")};r.get("/box/services/box/solr/jobs",function(o,s){e.info("SOLR is requesting jobs"),i.getAllJobs(function(o,r){if(o)return void s.send(500);r=_.map(r,function(e){return b(e)});try{_.each(r,function(e){e.createdByJSON=JSON.stringify(e.createdBy),e.lastModifiedByJSON=JSON.stringify(e.lastModifiedBy),e.modelsJSON=JSON.stringify(e.models)})}catch(o){return e.error("Get All Jobs Error, ",o),void s.send(500)}var i=_.chain(r).map(function(e){return _.pluck(e.models,"modelGUID")}).flatten().compact().uniq().value();d.getModelsByGUIDs(i,function(o,i){var n=_.indexBy(i,"mG");_.each(r,function(e){_.isArray(e.models)&&_.each(e.models,function(e){e.modelDecal=n[e.modelGUID]&&n[e.modelGUID].d})});var d=jsonToXml.convertArray(r,"jobs");e.info("SOLR is finished requesting jobs"),s.send(d.end())})})}),r.get("/SAWeb/services/jobs",acceptsCheck("application/vnd.johndeere.sa.jobs.v1+json"),function(e,o){var s=e.query.user||e.headers["x-user"];i.getJobs(e.query.count,e.query.startDate,e.query.endDate,e.query.olderThan,e.query.state,s,e.headers["x-user"],function(e,s){return e?void o.send(500):void async.map(s,function(e,o){e=v(e),c(e,o)},function(e,s){o.send(s)})})}),r.get("/SAWeb/services/jobs/:jobId",function(e,o){i.getJobWithUser(e.params.jobId,e.headers["x-user"],function(e,s){return e?void o.send(e.statusCode||500):s?(s=v(s),void c(s,function(e,s){return e?void o.send(500):void o.send(s)})):void o.status(404).end()})}),r.post("/SAWeb/services/jobs",express.json(),acceptsCheck("application/vnd.johndeere.sa.addJob.v1+json"),function(o,s){var r={};return o.body.name?(r.name=o.body.name,r.description=o.body.description,r.repairOrder=o.body.repairOrder,r.segment=o.body.segment,r.models=o.body.models,void i.addNewJob(r,o.headers["x-user"],function(o,r){return o&&"Invalid UserId"===o.message?void s.send(403):o||!r?void s.send(500):(r=v(r),void c(r,function(o,r){return o?void s.send(500):(s.send(r),void a.createJobsIndex(function(o){o&&e.error(o)}))}))})):void s.send(400)}),r.post("/SAWeb/services/jobs/:id/bookmark",express.json(),function(e,o,s){var r=e.body,n=r.itemId,d=r.type;return d&&n?void i.addJobBookmark(e.params.id,r,function(s){return s?void o.send(500):void i.getJob(e.params.id,function(e,s){return e?void o.send(500):(s=v(s),void c(s,function(e,s){return e?void o.send(500):void o.send(s)}))})}):void o.send(400)}),r.delete("/SAWeb/services/jobs/:id/bookmark/:type/:itemId",function(e,o,s){var r=e.params.itemId,n=e.params.type,d=e.params.id;return n&&r?void i.deleteJobBookmark(d,n,r,function(s){return s?void o.send(500):void i.getJob(e.params.id,function(e,s){return e?void o.send(500):(s=v(s),void c(s,function(e,s){return e?void o.send(500):void o.send(s)}))})}):void o.send(400)}),r.put("/SAWeb/services/jobs/:jobId",express.json(),function(o,s){i.updateJob(o.params.jobId,o.body,o.headers["x-user"],function(o,r){return o&&"Invalid UserId"===o.message?void s.send(400):o?void s.send(500):r?(r=v(r),void c(r,function(o,r){return o?void s.send(500):(s.send(r),void a.createJobsIndex(function(o){o&&e.error(o)}))})):void s.send(404)})}),r.post("/SAWeb/services/jobs/:jobId/note",express.json({strict:!1}),acceptsCheck("application/vnd.johndeere.sa.activity.v1+json"),function(e,o){i.getJob(e.params.jobId,function(s,r){return s?void o.send(500):r?void n.addActivity({type:"jobNote",jobId:e.params.jobId,noteText:e.body,notes:[]},e.headers["x-user"],function(s,r){return s&&"Invalid UserId"===s.message?void o.send(400):s?void o.send(500):void n.getActivity(r,e,function(e,s){return e?void o.send(500):void o.send(s)})}):void o.send(404)})}),r.get("/SAWeb/services/jobs/:jobId/diagprocdetails/:diagProcDetailId",function(e,o){t.get(e.params.diagProcDetailId,function(e,s){return e?void o.status(e.statusCode||500).end():void(s?o.status(200).json(s):o.status(404).end())})}),r.post("/SAWeb/services/jobs/:jobId/diagprocdetails",express.json(),function(e,o){t.add(e.params.jobId,e.headers["x-user"],e.body,function(e,s){return e&&"Invalid UserId"===e.message?void o.send(403):void(e||!s?o.status(e&&e.statusCode||500).end():o.status(200).json({diagProcDetailId:s.boxDiagProcDetailId}))})}),r.put("/SAWeb/services/jobs/:jobId/diagprocdetails/:diagProcDetailId",express.json(),function(e,o){t.update(e.params.jobId,e.params.diagProcDetailId,e.body,function(e){e?o.status(e.statusCode||500).end():o.status(200).end()})}),r.post("/box/services/box/:jobId/downloadJob",express.json(),function(e,o){var s={ADD_JOB_TO_STATE_CHANGES_FAILED:{messageCode:"ADD_JOB_TO_STATE_CHANGES_FAILED"},GET_JOB_FAILED:{messageCode:"GET_JOB_FAILED"}};i.requestJobDownload(e.params.jobId,function(r){r&&o.send(500,s.ADD_JOB_TO_STATE_CHANGES_FAILED),u.startQuickSync(function(r,n){if(r)return void o.send(500,boxAuthMessages.QUICK_SYNC.START_FAILED);var d=function(r){i.getJob(e.params.jobId,function(e,i){return e||!i?(c(),void o.send(400,s.GET_JOB_FAILED)):void(r===n&&(c(),o.send(200,boxAuthMessages.QUICK_SYNC.COMPLETED)))})},t=function(){u.getSyncStatus().quickSyncRunning||(c(),o.send(202,boxAuthMessages.QUICK_SYNC.START_FAILED))},a=function(e,s){c(),s&&s.message&&s.message.toUpperCase()===boxAuthErrors.BOX_UNAUTHORIZED.toUpperCase()?o.send(500,boxAuthMessages.COMMON.BOX_UNAUTHORIZED):o.send(500,boxAuthMessages.QUICK_SYNC.FAILED)},c=function(){u.removeListener("quickSyncFinished",d),u.removeListener("quickSyncStartFailed",t),u.removeListener("quickSyncError",a)};u.on("quickSyncFinished",d),u.on("quickSyncStartFailed",t),u.on("quickSyncError",a)})})}),s()};module.exports=setup;