"use strict";var _=require("underscore"),async=require("async"),fs=require("fs"),FortyFiveDaysInMS=3888e6,OneDayInMS=864e5,setup=function(o,e,i){var n,t=function(){cleanUpClosedJobs(o,e,function(o){o||(n=setTimeout(t,OneDayInMS))})};o.on("stop",function(){clearTimeout(n)}),t(),i()},cleanUpClosedJobs=function(o,e,i){async.waterfall([function(i){findAllOldClosedJobIds(e,function(e,n){e&&o.error("Error cleaning up old jobs in findAllOldClosedJobIds: ",e),i(e,{jobIdsToRemove:n||[]})})},function(i,n){findAllActivitiesToRemove(e,i.jobIdsToRemove,function(e,t){e&&o.error("Error cleaning up old jobs in findAllActivitiesToRemove: ",e),i.activitiesToRemove=t||[],n(e,i)})},function(i,n){removeLiveRecordingActivityArtifacts(e,i.activitiesToRemove,function(e){e&&o.error("Error cleaning up old jobs in removeLiveRecordingActivityArtifcats: ",e),n(e,i)})},function(i,n){removeActivityObjects(e,i.activitiesToRemove,function(e){e&&o.error("Error cleaning up old jobs in removeActivityObjects: ",e),n(e,i)})},function(i,n){removeJobObjects(e,i.jobIdsToRemove,function(e){e&&o.error("Error cleaning up old jobs in removeJobObjects: ",e),n(e,i)})}],function(o){i(o)})},findAllOldClosedJobIds=function(o,e){var i=new Date((new Date).getTime()-FortyFiveDaysInMS);o.collection("Jobs").find({state:"closed",lastModifiedTime:{$lte:i.toISOString()},id:{$exists:!0,$ne:null}}).toArray(function(o,i){if(o)return void e(o);var n=_.compact(_.pluck(i,"id")),t=_.compact(_.pluck(i,"localId"));e(void 0,_.union(n,t))})},removeJobObjects=function(o,e,i){o.collection("Jobs").remove({$or:[{id:{$in:e}},{localId:{$in:e}}]},function(o){i(o)})},findAllActivitiesToRemove=function(o,e,i){o.collection("Activities").find({jobId:{$in:e}}).toArray(function(o,e){i(o,e)})},removeActivityObjects=function(o,e,i){var n=_.pluck(e,"_id");o.collection("Activities").remove({_id:{$in:n}},function(o){i(o)})},removeLiveRecordingActivityArtifacts=function(o,e,i){var n=_.filter(e,function(o){return"liveRecording"===o.type}),t=_.map(n,function(o){return o.boxRecordingId});async.series([function(e){findAllRecordingObjectsToRemove(o,t,function(i,n){return i?void e(i):void removeRecordingBinaryFiles(o,n,function(o){e(o)})})},function(e){removeRecordingObjects(o,t,function(o){e(o)})}],function(o){i(o)})},findAllRecordingObjectsToRemove=function(o,e,i){o.collection("Recordings").find({localId:{$in:e}}).toArray(function(o,e){i(o,e)})},removeRecordingObjects=function(o,e,i){o.collection("Recordings").remove({localId:{$in:e}},function(o){i(o)})},removeRecordingBinaryFiles=function(o,e,i){async.eachSeries(e,function(o,e){fs.unlink(o.path,function(o){o&&"ENOENT"===o.code?e():e(o)})},function(o){i(o)})};module.exports=setup;