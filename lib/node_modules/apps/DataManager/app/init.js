"use strict";function setup(e,n){var r=n.onReady;mkdirp.sync(environment.payloadsPath),mkdirp.sync(environment.recordingsPath),mkdirp.sync(environment.returnFilesPath),mkdirp.sync(environment.temporaryDataSyncPath),mkdirp.sync(environment.temporaryUnTarPath),mkdirp.sync(environment.updatesPath),mkdirp.sync(environment.updateStagingPath),mkdirp.sync(environment.manifestsPath),mkdirp.sync(environment.logsToUpload),mkdirp.sync(environment.defaultPublicDataRoot),mkdirp.sync(environment.tempRecordingsPath),mkdirp.sync(environment.snapshotDataPath),n.connectorClient=connector.create(e),n.solrClient=solr.create(e),n.systemUpdateInstallerClient=systemUpdateInstaller.create(e),n.frontEndServerClient=frontEndServer.create(e),n.configStoreClient=new configStore(e,"dataManager"),n.exclusiveResourceClient=exclusiveResourceClient.create(e,config.name),n.loggerClient=logger.create(e);var t=function(e){n.httpServer.listen(0,"127.0.0.1",e)},a=function(e){MongoClient.connect("mongodb://localhost:27017/DataManager",function(r,t){r?e(r):(n.database=t,e())})},i=function(r){dataPaths.create(e,function(e,t){return e?void r(e):(n.dataPathsClient=t,void r())})},o=function(r){async.series([function(r){n.ONEManager=new ONEManagerApp(e,r)},function(r){n.databaseManager=new DatabaseManagerApp(e,n.database,n.ONEManager,n.networkContext,n.connectorClient,n.registrationClient,n.solrClient,n.systemUpdateInstallerClient,n.configStoreClient,n.dataPathsClient,n.exclusiveResourceClient,r)},function(r){supervisorClient.create(e).on("boxRecovered",function(r,t){r<=2&&!t?e.info("Box recovered from an issue while starting up the first time. Suppressing the send details prompt."):(e.info("Box recovered from crash: Showing Send Details prompt."),n.ONEManager.onBoxRecovered())}),r()}],function(e){r(e)})},s=function(r){n.ONEManager.onRetrySync(function(){n.databaseManager.resumeSyncs()}),n.ONEManager.onSendCrashDetails(function(){e.info("User clicked Send Details."),n.logUploader.saveAndUploadLogs(void 0,function(){e.info("Box logs uploaded successfully.")})}),r()},l=function(r){var t=ECULP_ini(e),a=PayloadProcessorSA5_ini(e),i=t&&t.Files&&t.Files.LogFolder,o=a&&a.Files&&a.Files.LogFolder;i=!!_.isString(i)&&i,o=!!_.isString(o)&&o,n.logUploader=new logUploader(e,n.database,n.networkContext,n.registrationClient,n.loggerClient,o,i),r()},c=function(r){var t=["./cors.js","./events.js","./box","./datasets","./models","./languages","./logs","./activities","./systemUpdates","./jobs","./feedback","./usageData","./support","./resourceManagement","./controllerSoftwareUpdates","./smartDiagnosticsAssemblies","./fileServer","./donorEcu","./payloads"];async.each(t,function(r,t){n.onReady=_.once(function(e){t(e)}),e.use(r,module,n)},function(e){r(e)})};async.series([t,a,i,o,s,l,c],function(e){r(e)}),e.on("stop",function(){n.ONEManager&&n.ONEManager.unInstallPdfCertificates()})}var DatabaseManagerApp=require("./databaseManagement"),ONEManagerApp=require("./ONEManagement"),MongoClient=require("mongodb").MongoClient,events=require("events"),diagnostics=require("apps/Diagnostics/Client"),connector=require("apps/Connector/Client"),solr=require("apps/SolrManager/Client"),systemUpdateInstaller=require("apps/SystemUpdateInstaller/Client"),frontEndServer=require("apps/FrontEndServer/Client"),exclusiveResourceClient=require("apps/ExclusiveResourceManager/Client"),logger=require("apps/Logger/Client"),configStore=require("apps/ConfigStore/Client"),environment=require("Environment"),dataPaths=require("apps/DataPaths/Client"),supervisorClient=require("apps/Supervisor/Client"),path=require("path"),fs=require("fs"),mkdirp=require("mkdirp"),async=require("async"),_=require("underscore"),config=require("./config.js"),PayloadProcessorSA5_ini=require("iniFiles/PayloadProcessorSA5.js"),ECULP_ini=require("iniFiles/ECULP.js"),logUploader=require("./logs/logUploader.js");module.exports=setup;