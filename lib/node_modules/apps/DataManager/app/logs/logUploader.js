"use strict";var url=require("url"),environment=require("Environment"),config=require("../config.js"),serverBaseUrl=url.parse(environment.serverLocation),utility=require("FileUtility"),http=require("http"),https=require("https"),Zip=require("zip-stream"),fs=require("fs"),_=require("underscore"),async=require("async"),uuid=require("uuid"),path=require("path"),PendingUploadLogMetaDataCollection="PendingUploadLogMetaData",LogUploader=function(o,e,t,n,r,i,a){var s=this;s._app=o,s._db=e,s._networkContext=t,s._registrationClient=n,s._loggerClient=r,s._PayloadProcessorLogPath=i,s._ECULPLogPath=a};LogUploader.prototype.uploadPendingLogs=function(o){var e=this,t=function(o){e._db.collection(PendingUploadLogMetaDataCollection).find({}).toArray(function(e,t){o(e,t)})},n=function(o,t){return 0===o.length?void t():void async.eachSeries(o,function(o,t){e.uploadLog(o,function(o){t(o)})},function(o){t(o)})};async.waterfall([t,n],function(e){o(e)})},LogUploader.prototype.uploadLog=function(o,e){var t=this;fs.readFile(o.path,function(n,r){if(n&&"ENOENT"===n.code)return void removeLog(t._db,o,e);if(n)return void e(n);var i=function(e){switch(o.type){case"box":t._registrationClient.getBoxId(function(t){e(void 0,{url:{protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,path:config.urlBegin.concat(t).concat(config.uploadLogsURL)},formData:{user:{value:function(){return JSON.stringify({userId:o.user})},options:{contentType:"application/vnd.johndeere.sa.boxNetwork.uploadBoxLogs.v1+json"}},logFile:{value:utility.getFileReadStreamGenerator(o.path),options:{filename:"logFile",contentType:"application/zip"}}}})});break;case"client":e(void 0,{url:{protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.uploadClientLogsURL},formData:{user:{value:function(){return JSON.stringify({userId:o.user})},options:{contentType:"application/vnd.johndeere.sa.boxNetwork.uploadApplicationLogs.v1+json"}},logFile:{value:utility.getFileReadStreamGenerator(o.path),options:{filename:"logFile",contentType:o["content-type"]}}}});break;default:e(new Error("Invalid log type: ",o.type))}};i(function(n,r){return n?void e(n):void uploadLog(t._networkContext,r,function(n){return n&&"Invalid statusCode."!==n.message?void e(n):(n&&"Invalid statusCode."===n.message&&(t._app.error("Bad Server Response Uploading Log: ",r),t._app.error("Server Response For Logs: ",n)),void removeLog(t._db,o,e))})})})},LogUploader.prototype.saveOfflineLogs=function(o,e){e=_.once(e);var t=this,n={user:o,path:path.join(environment.logsToUpload,uuid()),type:"box"},r=[],i=function(o){t._registrationClient.getBoxId(function(e){var i=new Zip;i.on("error",function(e){o(e)});var a=fs.createWriteStream(n.path).on("error",function(e){o(e)}).on("finish",function(){o()});i.pipe(a);var s=e.concat("-Logs"),u=function(o){utility.compressDirectory(i,environment.logRoot,s,function(e){e&&r.push(e),o()})},c=function(o){utility.compressDirectory(i,environment.calLogs,path.join(s,"Cal Logs"),function(e){e&&r.push(e),o()})},p=function(o){var e=t._ECULPLogPath,n=t._PayloadProcessorLogPath;return e||n?void(e&&n&&e.toLowerCase()!==n.toLowerCase()?async.series([function(o){utility.compressDirectory(i,e,path.join(s,"ECULP Logs"),function(e){e&&r.push(e),o()})},function(o){utility.compressDirectory(i,n,path.join(s,"Payload Logs"),function(e){e&&r.push(e),o()})}],function(e){o(e)}):utility.compressDirectory(i,e||n,path.join(s,"ECULP And Payload Logs"),function(e){e&&r.push(e),o()})):void o()};async.series([u,c,p],function(e){i.finalize(),e&&o(e)})})},a=function(o){var e=function(o){t._loggerClient.clearBoxLogs(function(e){e&&t._app.error("Error clearing box logs! ",e),o()})},n=function(o){utility.clearDirectory(environment.calLogs,function(e){e&&"EBUSY"!==e.code&&t._app.error("Error clearing CAL logs! ",e),o()})};async.series([e,n],function(e){o(e)})};async.series([storeLogMetaData.bind(void 0,t._db,n),i,a],function(o){_.each(r,function(o){t._app.error("Error zipping logs",o)}),e(o,n)})},LogUploader.prototype.storeClientLog=function(o,e,t,n){var r=this,i={user:o,path:path.join(environment.logsToUpload,uuid()),"content-type":e,type:"client"},a=function(o){o=_.once(o);var e=fs.createWriteStream(i.path).on("error",function(e){o(e)}).on("finish",function(){o()});t.pipe(e).on("error",function(e){o(e)})};async.series([storeLogMetaData.bind(void 0,r._db,i),a],function(o){n(o,i)})};var storeLogMetaData=function(o,e,t){o.collection(PendingUploadLogMetaDataCollection).insert(e,function(o){t(o)})},removeLog=function(o,e,t){var n=function(o){fs.unlink(e.path,function(e){e&&"ENOENT"!==e.code?o(e):o()})},r=function(t){o.collection(PendingUploadLogMetaDataCollection).remove({path:e.path},function(o){t(o)})};async.series([n,r],function(o){t(o)})},uploadLog=function(o,e,t){o.uploadMultipartFormData(o.getNetworkOptions(e),function(o,e){!o&&e.statusCode>=200&&e.statusCode<300?t():o?t(o):(o=new Error("Invalid statusCode."),o.statusCode=e.statusCode,t(o))})};LogUploader.prototype.saveAndUploadLogs=function(o,e){var t=this;t.saveOfflineLogs(o,function(o,n){return o?void t._app.error("Saving Box Logs Error: ",o):void t.uploadLog(n,function(o){o?t._app.error("Uploading Box Logs Error: ",o):e()})})},module.exports=LogUploader;