"use strict";var _=require("underscore"),async=require("async"),fs=require("fs"),environment=require("Environment"),payloadInfo=require(environment.getLocalAddonPath("GetPayloadInfo")),utility=require("FileUtility"),reprogramming=require(environment.getLocalAddonPath("Reprogramming")),mkdirp=require("mkdirp"),path=require("path"),formatPayloads=function(e,t){var a={};return _.each(e,function(e){a[e]={controllerSoftwareUpdates:[]}}),_.each(t,function(t){var n;n=/[^a-zA-Z0-9]/.test(t.pin)||_.contains(e,t.componentSerialNumber)&&!_.contains(e,t.pin)?t.componentSerialNumber:t.pin,t.filesizeInKB=t.filesizeInKB/1024,a[n]=a[n]||{controllerSoftwareUpdates:[]},a[n].controllerSoftwareUpdates.push(t)}),a},_notifyOneOfGSixData=function(e,t,a,n){var i,o=_.once(function(r){clearTimeout(i),e.offGSixData(o),r&&"true"===r.result?n(null,!0):async.eachSeries(t,function(e,t){mkdirp(a,function(n){utility.copySingleFile(e,path.join(a,path.basename(e)),function(a){utility.deleteDirectoryOrFile(e,function(e){t()})})})},function(e){n(null,!1)})}),r=_.reduce(t,function(e,t){return e+'"'+t+'" '},"");i=setTimeout(function(){o(!1)},2e3),e.onGSixData(o),e.sendGSixData(reprogramming.getSoftwareManagerPath(),r)},updateMetaData=function(e,t,a,n,i,o){var r={payloadFileName:t,addedBy:a,isSupportPayload:n,fileList:i};e.addPayloadMetaData(r,function(e){o(e)})},processGSixPayload=function(e,t,a,n,i,o){utility.extractZipToLocation(t,n,function(r,l){return r?(e.error("Failed to unzip plz file",r),void o()):void utility.deleteDirectoryOrFile(t,function(e){var t=_.chain(l).filter(function(e){return _.isEqual(path.extname(e).toUpperCase(),".XML")}).map(function(e){return path.join(n,e)}).value();_notifyOneOfGSixData(i,t,a,function(e,t){var i=_.find(l,function(e){return _.isEqual(path.extname(e).toUpperCase(),".PLD")}),r=_.map(l,function(e){return path.join(n,e)});t||(r=_.chain(l).filter(function(e){return _.isEqual(path.extname(e).toUpperCase(),".XML")}).map(function(e){return path.join(a,e)}).value().concat(r));var u={payloadFileName:i,gSixErrorResult:t||null,fileList:l,internalFileList:r};o(e,u)})})})},_processGSixPayloads=function(e,t,a,n,i){async.waterfall([function(e){fs.readdir(n,function(t,a){e(t,a)})},function(i,o){var r=_.filter(i,function(e){return _.isEqual(path.extname(e).toUpperCase(),".PLZ")});async.mapSeries(r,function(i,o){var r=path.join(n,i);processGSixPayload(e,r,a,n,t,function(e,t){o(e,t)})},function(e,t){o(e,t)})}],function(e,t){i(e,_.indexBy(t,"payloadFileName"))})},_getSoftwareId=function(e,t){var a;return e.sectionDetails.length>1?(e.sectionDetails=_.rest(e.sectionDetails),a=_.reduce(e.sectionDetails,function(e,t){return e+"^"+t.tla},t[1])):2===t.length?a=13===t[1].length||17===t[1].length?t[1]+"^"+t[0]:e.serialNumber+"^"+t[0]:1===t.length?(a=e.serialNumber+"^ENGINE",/[^a-zA-Z0-9]/.test(e.serialNumber)&&(e.isOem=!0)):a=e.serialNumber+"^"+e.sectionDetails[0].tla,a},prepareSectionDetailsFromPayloadFile=function(e){var t=_.map(e.sectionDetails,function(e){return _.extend({},e,{description:e.diagnosticTLA[0],diagnosticTLA:e.description.split(" ")})});return t},_buildPayloadObject=function(e,t,a,n,i,o,r,l,u){var s,c,d,f,p=path.join(t,a),m=a.split("."),y=m[0].split("_"),g=!0;if(2!==y.length||13!==y[1].length&&17!==y[1].length||(s=y[1],g=!1),c=payloadInfo.getPayloadInfo(p,g),!c||!c.sectionDetails)return e.debug("Invalid payload",p),void _.defer(function(){u()});s=s||c.serialNumber,d=_getSoftwareId(c,y),f=prepareSectionDetailsFromPayloadFile(c);var S={softwareUpdateId:d,pin:s,filesizeInKB:1024*c.payloadFileSize,payloadFileName:a,fileName:a,name:c.contollerName,addedTime:c.dateRequested,expirationDate:c.expirationDate,sectionDetails:f,onBox:!0,isOem:!!c.isOem&&c.isOem,componentSerialNumber:y[1]?y[1]:y[0]},P=function(){var e;if(n[a]&&(e=n[a].internalFileList,delete n[a].internalFileList,_.extend(S,n[a])),i[a])_.extend(S,i[a]),_.defer(function(){u(null,S)});else{S.addedBy=o,S.isSupportPayload=r;var t={payloadFileName:S.payloadFileName,addedBy:S.addedBy,isSupportPayload:r,fileList:e||[p]};l.addPayloadMetaData(t,function(e){u(null,S)})}};S.addedTime?P():fs.stat(p,function(e,t){S.addedTime=t.mtime,P()})},getPayloads=function(e,t,a,n,i,o,r,l,u,s){e.info("Start getting payloads ..."),async.waterfall([function(t){_processGSixPayloads(e,r,l,u,function(e,a){t(null,a)})},function(e,t){fs.readdir(u,function(a,n){var i=_.filter(n,function(e){return _.isEqual(path.extname(e).toUpperCase(),".PLD")});t(a,e,i)})},function(e,t,a){o.removeOldPayloads(t,function(n){a(n,e,t)})},function(e,t,a){o.getPayloads(t,function(n,i){a(n,e,t,_.indexBy(i,"payloadFileName"))})},function(e,a,n,o){i.getUserObject(t,function(t,i){o(t,e,a,n,i)})},function(t,a,i,r,l){async.mapSeries(a,function(a,l){_buildPayloadObject(e,u,a,t,i,r,n,o,function(e,t){l(null,t)})},function(e,t){l(e,_.compact(t))})}],function(t,a){e.info("Finished getting payloads"),s(t,a)})};module.exports.getPayloads=getPayloads,module.exports.formatPayloads=formatPayloads,module.exports.processGSixPayload=processGSixPayload,module.exports.updateMetaData=updateMetaData,module.exports.prepareSectionDetailsFromPayloadFile=prepareSectionDetailsFromPayloadFile;