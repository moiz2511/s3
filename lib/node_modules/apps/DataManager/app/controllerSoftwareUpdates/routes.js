!function(){"use strict";var e=require("Middleware/acceptsCheck.js"),a=require("../dataProviders/ControllerDataProvider.js"),r=require("express"),o=require("underscore"),d=require("apps/FrontEndServer/Client"),s=require("./downloadPayload.js"),n=require("../donorEcu/utilities.js"),i=require("../dataProviders/ActivityProvider.js"),t=require("iniFiles/PayloadProcessorSA5.js"),l=require("./payloadManager.js"),c=require("../dataProviders/UsersDataProvider.js"),p=require("Environment"),u=function(u,v,y){var f=v.database,b=v.databaseManager,P=v.registrationClient,F=new i(u,b,f,P),w=new c(u,v.databaseManager,v.registrationClient),j=d.create(u);j.addNamespace("/controllerSoftwareUpdates");var g=j.getNamespaceWrapper("/controllerSoftwareUpdates"),S=t(u),m=new a(u,v.database),N=require("./service.js").getControllerSoftwareUpdatesService(u,v,m),q=v.webServer;q.get("/SAWeb/services/boxes/controllersoftwareupdates/:pin",e("application/vnd.johndeere.sa.controllerSoftwareUpdates.v1+json"),function(e,a){var r=e.headers["x-user"],o=e.params.pin.split(",");if(!S)return u.error("Failed to load payload processor INI"),void a.send(500);var d=S.Files&&S.Files.MissedXmlFolder||p.MissedXmlFolder,s=S.Files&&S.Files.PayloadFolderSN||"";l.getPayloads(u,r,o,!0,w,m,v.ONEManager,d,s,function(e,r){e?(u.error("Failed to get payloads",e),a.send(500)):a.send(l.formatPayloads(o,r))})}),q.post("/SAWeb/services/boxes/downloadPayloads/:softwareUpdateId",r.json(),function(e,a){s.downloadPayload(u,N,v.ONEManager,g,o.bind(n.updateDonorEcuDetails,void 0,b,F),e.headers.accept,e,a)}),q.post("/SAWeb/services/boxes/downloadPayload",r.json(),function(e,a){s.downloadPayload(u,N,v.ONEManager,g,o.bind(n.updateDonorEcuDetails,void 0,b,F),e.headers.accept,e,a)}),q.get("/SAWeb/services/boxes/getPayloads",e("application/vnd.johndeere.sa.Payloads.v1+json"),function(e,a){var r=e.headers["x-user"],o=[];if(!S)return u.error("Failed to load payload processor INI"),void a.send(500);var d=S.Files&&S.Files.MissedXmlFolder||p.MissedXmlFolder,s=S.Files&&S.Files.PayloadFolderSN||"";l.getPayloads(u,r,o,!0,w,m,v.ONEManager,d,s,function(e,r){e?(u.error("Failed to get payloads",e),a.send(500)):a.send(r)})}),q.post("/SAWeb/services/boxes/deletePayload",r.json(),function(e,a){var r=e.body,o=e.accepts("application/vnd.johndeere.sa.deletePayload.v1+json");return o?void N.deletePayload(r,function(e){e?(u.error("Error occurred in deleting payload: "+r.softwareUpdateId+" Payload File Name:"+r.payloadFileName,e),a.send(200,"Failed")):a.send(200,"Success")}):void a.send(406)}),q.post("/SAWeb/services/boxes/downloadCalibratedComponents",r.json(),function(e,a){var r=e.accepts("application/vnd.johndeere.sa.downloadCalibratedComponents.v1+json");if(!r)return void a.send(406);var o=e.body.calibratedSoftwareUpdateId,d={fileName:e.body.fileName,softwareUpdateId:o};N.downloadPayload(o,d,v.ONEManager,!0,function(e,r){return e?void a.send(500):void(r?a.send(200,{status:"success"}):a.send(500))})}),y()};module.exports=u}();