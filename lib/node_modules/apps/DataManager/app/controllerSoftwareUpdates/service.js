!function(){"use strict";var e=require("underscore"),r=require("../config.js"),o=require("fs"),i=require("url"),t=require("async"),n=require("path"),a=require("Environment"),d=i.parse(a.serverLocation),s=require("../dataProviders/UsersDataProvider.js"),l=require("FileUtility"),p=require("mkdirp"),c=require("iniFiles/PayloadProcessorSA5.js"),u=require("./payloadManager.js"),f=function(e,r,o){this._app=e,this._dm=r.database,this._controllerDataProvider=o,this._networkContext=r.networkContext,this._usersProvider=this._usersProvider=new s(e,r.databaseManager,r.registrationClient),this._payloadProcessorSA5Object=c(e),this._dbManager=r.databaseManager};f.prototype.deletePayload=function(r,i){var n=(this._app,this._controllerDataProvider);t.waterfall([function(o){n.getPayloads([r.payloadFileName],function(r,i){o(r,e.first(i))})},function(e,r){t.eachSeries(e.fileList,function(e,r){o.unlink(e,function(e){r()})},function(e){r()})},function(e){n.removePayload(r.payloadFileName,function(r){e()})}],function(e){i()})};var v=function(e,r,i,t,n){p(t,function(t){if(t)return e.error("Error in creating directory",t),void n(t);o.createReadStream(r).pipe(o.createWriteStream(i)).on("error",function(r){e.error("Error in copying file ",r),n(r)}).on("finish",function(r){return r?(e.error("Error in copying file ",r),void n(r)):void n()})})},y=function(e){var r=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(e);return r?r[1]:void 0};f.prototype.downloadPayload=function(t,s,c,f,h){h=e.once(h);var m=this._app,F=this._networkContext,P=this._controllerDataProvider,j=this._payloadProcessorSA5Object,C=s.downloadPayloadUrl;if(!this._payloadProcessorSA5Object)return m.error("Not able to find payloadProcessor.ini file"),void h(new Error("Not able to find payloadProcessor.ini file"));var g,_=j.Files.PayloadFolderSN,S=j.Files.MissedXmlFolder;if(C){var w=i.parse(C,!0);g={protocol:d.protocol,hostname:d.hostname,port:d.port,path:w.path,method:"GET",headers:{accepts:"application/octet-stream"}}}else g=f?{protocol:d.protocol,hostname:d.hostname,port:d.port,path:r.downloadCalibratedCompnentPath.concat(t),method:"GET",headers:{accepts:"application/octet-stream"}}:{protocol:d.protocol,hostname:d.hostname,port:d.port,path:r.payloadDownloadPath.concat(s.softwareUpdateId),method:"GET",headers:{accepts:"application/octet-stream"}};m.info("Downloading payload",g);var E=!1;F.requestForProtocol(F.getNetworkOptions(g),function(r,i){if(r)return E=!0,void h(r);if(m.info("payload "+(s.softwareUpdateId||C)+" status: "+i.statusCode),200!=i.statusCode)return m.error("Error in response form server with statusCode",i.statusCode),void h(!0);var t=s.fileName||y(i.headers["content-disposition"]);if(!t){var r=new Error("Missing file name: ",s||i.headers);return m.error("Error getting payload file name from response: ",r),void h(r)}var d=n.join(a.userTempPath,t),f=function(r){r=r||e.noop,l.deleteDirectoryOrFile(d,r)};s.path=n.join(_,t),p(_,function(e){if(e)return m.error("Error in creating directory",e),void h(e);var r=o.createWriteStream(d);i.pipe(r),r.on("finish",function(){return E?void f():void r.close(function(e){return e?void h(e):void l.copySingleFile(d,s.path,function(e){f(function(){if(e)return void h(e);var r=n.extname(t);if(r&&".PLZ"===r.toUpperCase())u.processGSixPayload(m,n.join(_,t),S,_,c,function(e,r){var o;s.addedBy&&s.addedBy.userId&&s.addedBy.displayName&&(o={userId:s.addedBy.userId,userName:s.addedBy.displayName}),u.updateMetaData(P,r.payloadFileName,o,!1,r.internalFileList,function(){h(null,!0,!!r.gSixErrorResult,t)})});else if(r&&".PLD"===r.toUpperCase()){var o="",i=!1;if(!j.Files||!j.Files.CalibrationFolder)return m.error("payloadProcessor.ini file is not found"),void h(new Error("payloadProcessor.ini file is not found"));o=j.Files.CalibrationFolder;var d,p=n.join(_,t);if(t.toUpperCase().indexOf("_SDA")!=-1)d=j.Files.SDAFolder,y=n.join(d,t),i=!0;else if(t.toUpperCase().indexOf("_SCR")!=-1)d=n.join(o,"SCR"),y=n.join(d,t),i=!0;else if(t.toUpperCase().indexOf("_VTG")!=-1)d=n.join(o,"turbo"),y=n.join(d,t),i=!0;else if(t.toUpperCase().indexOf("_DPF")!=-1)d=n.join(o,"DPF"),y=n.join(d,t),i=!0;else if(t.toUpperCase().indexOf("_DOC")!=-1)d=n.join(o,"DOC"),y=n.join(d,t),i=!0;else if(t.toUpperCase().indexOf("_INJ")!=-1)d=n.join(o,"injector"),y=n.join(d,t),i=!0;else if(t.toUpperCase().indexOf("_S42")!=-1)d=n.join(o,"S42"),y=n.join(d,t),i=!0;else{var f;s.addedBy&&s.addedBy.userId&&s.addedBy.displayName&&(f={userId:s.addedBy.userId,userName:s.addedBy.displayName}),u.updateMetaData(P,t,f,!1,[s.path],function(){h(null,!0,null,t)})}i&&v(m,p,y,d,function(e){return l.deleteDirectoryOrFile(p,function(e){e&&m.error("Error in removing file")}),e?(m.error("Error in copying file"),void h(e)):void h(null,!0,null,t)})}else if(r&&".AAR"===r.toUpperCase()){var p=n.join(_,t),d="";d=j.Files&&j.Files.AARFileFolder?j.Files.AARFileFolder:a.AARFileFolder;var y=n.join(d,t);v(m,p,y,d,function(e){return l.deleteDirectoryOrFile(p,function(e){e&&m.error("Error in removing file")}),e?(m.error("Error in copying file"),void h(e)):void h(null,!0,null,t)})}})})})}),r.on("error",function(e){E=!0,m.error("Error in creating directory=",e),h(e)})})})},module.exports={getControllerSoftwareUpdatesService:function(e,r,o){return e&&r&&r.database?new f(e,r,o):void 0}}}();