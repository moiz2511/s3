"use strict";var _=require("underscore"),boxAuthErrors=require("NetUtility").boxAuth.errors;module.exports.downloadPayload=function(a,o,e,r,d,s,t,n){var i=t.query&&"downloadPayload"===t.query.capability,l=t.body&&t.body.downloadPayloadUrl,u=t.params&&t.params.softwareUpdateId,p=t.headers&&t.headers["x-capability"];p=p&&p.split(",");var y=_.contains(p,"donorEcuV3");a.info("Received request to download payload: "+(u||l));var c=t.body;if(!t.accepts(s))return void n.send(406);i&&n.send();var f={status:200,id:u||l};o.downloadPayload(u,c,e,!1,function(o,e,s,l){o?(o.message&&o.message.toUpperCase()===boxAuthErrors.BOX_UNAUTHORIZED.toUpperCase()&&(f.data={messageCode:"BOX_UNAUTHORIZED"}),f.status=500,a.error("Error downloading payload",o)):e?(f.data={fileName:l},_.isUndefined(s)||(f.data.isSoftwareManagerOpen=s),a.info("Successfully downloaded payload")):(f.status=500,a.error("Bad response from server while downloading payload"));var u=function(){i?r.broadcast("payloadDownloaded",f):n.send(f.status,f.data)};if(y&&c.donorEcuId){var p={id:c.donorEcuId,userId:t.headers["x-user"],payloadFileName:t.body.fileName||l};d(p,function(o){o&&a.error("Error updating donor ecu details",o),u()})}else u()})};