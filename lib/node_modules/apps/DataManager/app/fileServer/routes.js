"use strict";var acceptsCheck=require("Middleware/acceptsCheck.js"),_=require("underscore"),fs=require("fs"),winreg=require("Winreg"),environment=require("Environment"),path=require("path"),setup=function(e,r){var n,i,a,t=r.webServer,o=function(){var r=new winreg({hive:winreg.HKLM,key:a});r.values(function(r,i){if(r)e.error("ERROR while fetching FileServer Path ",r);else for(var a=0;a<i.length;a++)if("FileServer"===i[a].name){n=i[a].value;break}})},u=new winreg({hive:winreg.HKLM,key:"\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Environment"});u.values(function(r,n){if(r)e.error("ERROR while fetching Architecture version ",r);else for(var i=0;i<n.length;i++)if("PROCESSOR_ARCHITECTURE"===n[i].name){"AMD64"===n[i].value.toUpperCase()?(a="\\SOFTWARE\\Wow6432Node\\ServiceADVISOR5\\FileLocation",o()):"X86"===n[i].value.toUpperCase()&&(a="\\SOFTWARE\\ServiceADVISOR5\\FileLocation",o());break}}),t.get("/SAWeb/services/fileServer/:applicationLanguage",acceptsCheck("application/vnd.johndeere.sa.fileServer.v1"),function(a,t){if(!n)return void t.send(404,"exe not found");var o=a.params.applicationLanguage?a.params.applicationLanguage:"en";i=path.join(path.join(n,o),environment.FileServerExecutable),fs.exists(i,function(n){if(!n)return void t.send(404,"exe not found");var a=function(e){_.isEqual(e.result,"true")?t.send(200,"Success"):t.send(500),o()},o=function(){r.ONEManager.offEXEInvokeCall(a)};try{r.ONEManager.invokeApp(i,"")}catch(r){return e.err("Error in calling One Manager",r),void t.send(500)}r.ONEManager.onEXEInvokeCall(a)})}),r.onReady()};module.exports=setup;