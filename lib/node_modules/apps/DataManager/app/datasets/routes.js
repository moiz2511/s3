"use strict";var BoxDataProvider=require("../dataProviders/BoxDataProvider.js"),DatasetsProvider=require("../dataProviders/DatasetsProvider.js"),acceptsCheck=require("Middleware/acceptsCheck.js"),express=require("express"),_=require("underscore"),async=require("async"),setup=function(e,r,t){var s=r.webServer,a=new BoxDataProvider(e,r.databaseManager,r.configStoreClient),o=new DatasetsProvider(e,r.databaseManager);s.post("/SAWeb/services/datasets/:lang",acceptsCheck("application/vnd.johndeere.sa.getDatasetsResponse.v2+json"),express.json(),function(r,t){return _.isObject(r.body)&&_.isArray(r.body.locations)?void a.getBoxInformation(function(s,a){if(s)return e.error("Error retrieving setup Locations and DataSets: ",s),void t.send(500);var i=a&&a.setupDataProperties;if(!_.isObject(i))return e.error("No setup data properties for this box."),void t.send(500);var n=_.pluck(i.locations,"id").sort(),d=i.datasets,c=r.body.locations.sort();return _.isEqual(n,c)?void o.getDatasetObjects(d,function(r,s){return r?(e.error("Error retrieving setup datasets: ",r),void t.send(500)):void t.status(200).json(s)}):(e.error("Locations and DataSets in the request do not match the setup Locations and DataSets."),void t.send(403))}):(e.error("Request for datasets body does not contain locationIds."),void t.send(500))}),t()};module.exports=setup;