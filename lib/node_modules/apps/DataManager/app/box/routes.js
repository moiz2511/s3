"use strict";var acceptsCheck=require("Middleware/acceptsCheck.js"),environment=require("Environment"),express=require("express"),_=require("underscore"),async=require("async"),hostIdProvider=require(environment.getLocalAddonPath("GetHostId")),BoxDataProvider=require("../dataProviders/BoxDataProvider.js"),ModelsDataProvider=require("../dataProviders/ModelsDataProvider.js"),UsersDataProvider=require("../dataProviders/UsersDataProvider.js"),SystemUpdateProvider=require("../dataProviders/SystemUpdateProvider.js"),jsonToXml=require("JsonToXml"),protocol=require("Protocol"),frontEndServerClient=require("apps/FrontEndServer/Client"),syncUtils=require("../databaseManagement/syncManagement/utils.js"),setupStateUtils=require("./setupStateUtils.js"),boxAuth=require("NetUtility").boxAuth,fs=require("fs"),hbs=require("handlebars"),setup=function(e,t,n){var o,s,i=t.databaseManager,a=t.networkContext,r=new BoxDataProvider(e,i,t.configStoreClient),d=new UsersDataProvider(e,i,t.registrationClient),u=new SystemUpdateProvider(e,t.database,t.systemUpdateInstallerClient),c=new ModelsDataProvider(e,i,t.database,t.registrationClient),p=t.configStoreClient,l=t.dataPathsClient,S=t.registrationClient,f=t.connectorClient,g=!1,y=frontEndServerClient.create(e),v=y.getNamespaceWrapper("/box"),m=boxAuth.messages,b=boxAuth.errors,x="CUSTOMER";async.parallel([function(e){S.getBoxId(function(t){o=t,e()})},function(e){S.on("boxIdChanged",function(e){o=e}),e()}],function(y){if(y)return void n(y);var h=function(e){Z(function(t,n){if(t)e(t);else if(n.systemSoftware.newVersion&&!n.systemSoftware.forceInstallAfter){var o=new Date,s=new Date(o.getTime()+2592e6);n.systemSoftware.forceInstallAfter=s,u.setForceInstallAfter(s,function(){e(null,n)})}else e(null,n)})};e.on("stop",function(){clearTimeout(s)}),e.on("start",function(){s=setInterval(function(){h(function(t,n){t?e.error("Failed to get the box status"):v.broadcast("status",n)})},5e3)});var P=t.webServer,I=!1;P.all("/SAWeb/services/boxes/:id*",function(e,t,n){o!=e.params.id?t.send(404):n()}),f.on("networkDisconnected",function(){D(!1)}),f.on("networkConnected",function(){D(!0)}),e.on(protocol.outOfSpace,function(){g=!0});var D=function(e){I=e},U=function(e){r.getBoxInformation(e)},C=function(e){r.getBoxInformation(function(t,n){return t||!n?void e(t):void e(void 0,n.setupDataProperties&&n.setupDataProperties.locations||[])})},E=function(e){r.getBoxInformation(function(t,n){return t||!n?void e(t):void e(void 0,n.setupDataProperties&&n.setupDataProperties.datasets||[])})},A=function(e){p.getParameter("lastPingTime",function(t){e(null,t)})},k=function(e){l.doesDatasetExist(function(t,n){e(t,n)})},q=function(e){l.getDataLocationInformation(function(t,n){e(t,n&&n.path)})},T=function(e){S.getRegistrationState(function(t){e(null,S.isRegistered(t)?"registered":"unregistered")})},R=function(e){S.getSetupState(function(t,n){var o="unknown";o=S.isSetup(t)?"setup":S.isSetupInProgress(t)?"setup_pending":S.isSetupInProgressError(t)?"setup_pending_error":S.isSetupInProgressReady(t)?"setup_pending_ready":S.isSetupInProgressCopying(t)?"setup_pending_copying":S.isSetupInProgressSyncing(t)?"setup_pending_syncing":S.isSetupInProgressSyncingError(t)?"setup_pending_syncing_error":S.isSetupPendingIdentifiedSync(t)?"setup_pending_identified_sync":S.isSetupStartOver(t)?"setup_start_over":S.isSetupInWiping(t)?"setup_wiping":S.isSetupInWipingFailure(t)?"setup_wiping_failure":"not_setup";var s={state:o,errCode:n};e(null,s)})},F=function(e){S.getAuthorizationState(function(t){e(null,t)})},L=function(e){S.getAuthorizationState(function(t){e(null,t==S.getAuthorizedState())})},j=function(e){S.getBoxId(function(t){e(null,t||"")})},w=function(e){e(null,I.toString())},B=function(e){r.getBoxInformation(function(t,n){return t||!n?void e(t):void e(void 0,n.savedUpdateProfile&&n.savedUpdateProfile.nextScheduledDataSync)})},O=function(e){p.getParameter("lastDataSyncTime",function(t){e(void 0,t)})},z=function(e){p.getParameter("lastQuickSyncTime",function(t){e(void 0,t)})},N=function(e){r.getBoxInformation(function(t,n){return t||!n?void e(t):void e(void 0,n.boxType)})},M=function(e){u.getPendingSystemUpdate(function(t,n){e(t,n||{})})},Q=function(e){u.checkForPendingSystemUpdate(function(t,n){e(t,n||{})})},V=function(e){u.getInstalledSoftwareVersion(function(t,n){e(t,n||"")})},W=function(e){S.getDaysUntilRegistrationExpires(function(t){e(null,t)})},Y=function(e){var t=i.getSyncStatus();e(void 0,t)},G=function(e){e(void 0,i.isInCopyProcess())},H=function(){return hostIdProvider.GetHostId()},X=function(e){S.getDaysUntilAuthorizationExpires(function(t){e(null,t)})},K=function(e){async.parallel({boxId:j,registrationState:T,setupState:R,box:U,pendingSystemUpdate:Q,installedSoftwareVersion:V,syncInProgress:Y,copyInProgress:G,datasetLocation:q,hasDatasets:k,boxType:N,authorizationState:F,daysUntilAuthorizationExpires:X,isAuthorized:L},function(t,n){if(t)return void e(t);var o=n.box.setupDataProperties||{},s=n.box.savedUpdateProfile||{},i=n.box.savedDataProperties||{};e(null,{boxId:_.isEmpty(n.boxId)?void 0:n.boxId,mode:"box",capabilities:environment.capabilities,registrationState:n.registrationState,setupState:n.setupState&&n.setupState.state,setupStateError:n.setupState&&n.setupState.errCode,isSyncInProgress:n.syncInProgress.fullSyncRunning,isQuickSyncInProgress:n.syncInProgress.quickSyncRunning,isCopyInProgress:n.copyInProgress,boxType:n.boxType,savedUpdateProfile:{syncFrequency:s.syncFrequency,customSyncFrequency:s.customSyncFrequency,models:s.models,nextScheduledDataSync:s.nextScheduledDataSync},setupDataProperties:{languages:o.languages,locations:o.locations,datasets:o.datasets,models:o.models},savedDataProperties:{languages:i.languages,locations:i.locations,datasets:i.datasets,models:i.models},systemSoftware:{installedVersion:n.installedSoftwareVersion,newVersion:n.pendingSystemUpdate.newVersion,installationStartTime:n.pendingSystemUpdate.installationStartTime,installationInitiatedBy:n.pendingSystemUpdate.installationInitiatedBy,forceInstallAfter:n.pendingSystemUpdate.forceInstallAfter,isCriticalUpdateRequired:n.pendingSystemUpdate.isCriticalUpdateRequired},selectedDatasetContracts:n.box.selectedDatasetContracts,selectedDatasetVersion:n.box.selectedDatasetVersion,newModels:n.box.newModels,outOfSpace:g,datasetLocation:n.datasetLocation,hasDatasets:n.hasDatasets,authorizationState:n.authorizationState,daysUntilAuthorizationExpires:n.daysUntilAuthorizationExpires,isAuthorized:n.isAuthorized})})},Z=function(e){async.parallel({registrationState:T,setupState:R,online:w,nextScheduledDataSync:B,lastDataSync:O,lastQuickSync:z,lastCallIn:A,pendingSystemUpdate:M,installedSoftwareVersion:V,daysUntilRegistrationExpires:W,syncInProgress:Y,copyInProgress:G,datasetLocation:q,hasDatasets:k,boxType:N,daysUntilAuthorizationExpires:X,authorizationState:F,isAuthorized:L},function(t,n){t?e(t):e(void 0,{boxId:_.isEmpty(o)?void 0:o,description:n.description,registrationState:n.registrationState,setupState:n.setupState&&n.setupState.state,setupStateError:n.setupState&&n.setupState.errCode,mode:"box",online:n.online,lastDataSync:n.lastDataSync,lastQuickSync:n.lastQuickSync,lastCallIn:n.lastCallIn,nextScheduledDataSync:n.nextScheduledDataSync,isSyncInProgress:n.syncInProgress.fullSyncRunning,isQuickSyncInProgress:n.syncInProgress.quickSyncRunning,isCopyInProgress:n.copyInProgress,boxType:n.boxType,systemSoftware:{installedVersion:n.installedSoftwareVersion,newVersion:n.pendingSystemUpdate.newVersion,installationStartTime:n.pendingSystemUpdate.installationStartTime,installationInitiatedBy:n.pendingSystemUpdate.installationInitiatedBy,forceInstallAfter:n.pendingSystemUpdate.forceInstallAfter,isCriticalUpdateRequired:n.pendingSystemUpdate.isCriticalUpdateRequired},daysUntilRegistrationExpires:n.daysUntilRegistrationExpires,outOfSpace:g,datasetLocation:n.datasetLocation,hasDatasets:n.hasDatasets,authorizationState:n.authorizationState,daysUntilAuthorizationExpires:n.daysUntilAuthorizationExpires,isAuthorized:n.isAuthorized})})};P.get("/box/services/box/authorize",function(t,n){var o=t.query.code,s=t.query.state;t.query.error&&e.error("Error getting auth code. Error: "+t.query.error+" Description: "+t.query.error_description);var i=function(e,t){var o=hbs.compile(fs.readFileSync("./static/postMessage.htm",{encoding:"utf-8"}));n.status(e).send(o(_.extend(t,{clientLocation:boxAuth.getClientLocation()}))),v.broadcast("authorization",{messageCode:t.messageCode,message:t.message})};async.waterfall([function(t){boxAuth.verifyState(s,function(n){return n?(e.error("Request states do not match: ",n.messageCode),void t(n)):void t()})},function(t){boxAuth.getToken(o,x,a,function(n,o){return n?(e.error("No token found in authorization server response: ",n.messageCode),void t(n)):void t(null,o)})},function(t,n){boxAuth.validateToken(t,x,a,function(o,s){return o?(e.error("Unable to validate access token: "+o.messageCode),void n(o)):void n(null,t,s)})},function(t,n,o){S.updateAuthorizationDetails(t,n,function(t){return t?(e.error("Unable to update access token: "+t),void o(m.UPDATE_TOKEN_FAILURE)):void o()})},function(t){S.setUserType(x,function(n){return n?(e.error("Unable to store the user type: "+n),void t(m.UPDATE_USER_TYPE_FAILURE)):void t()})}],function(e){e?i(500,e):i(200,m.UPDATE_TOKEN_SUCCESS)})}),P.get("/box/services/box/oktaRedirect",function(e,t){t.redirect(boxAuth.getRedirectUrl(e.query.clientLocation,x))}),P.post("/box/services/box",acceptsCheck("application/vnd.johndeere.sa.box.registerBoxResponse.v1+json"),express.json(),function(t,n){S.getRegistrationState(function(o){if(S.isRegistered(o))return void K(function(e,t){n.send(t||{})});if(!t.body.activationToken)return void n.send(400);var s={url:environment.serverLocation+"bms/oauth/boxes",headers:{"Content-Type":"application/vnd.johndeere.sa.boxNetwork.registerBox.v1+json",accepts:"application/vnd.johndeere.sa.boxNetwork.registerBoxResponse.v1+json"},json:{hostId:H(),token:t.body.activationToken}};a.postJson(a.getNetworkOptions(s),function(t,o,s){if(t)return e.error(t.message),void n.send(500);switch(o.statusCode){case 200:if(!s||!s.boxId)return e.error("Server did not return box id"),void n.send(400);e.info("********BOX ID: "+s.boxId),async.series([function(e){S.setBoxId(s.boxId,function(t){e(t)})},function(e){S.setRegistrationState(S.getRegisteredState(),function(t){e(t)})},function(t){i.startQuickSync(function(n,o){if(n)return e.error("Starting Quick Sync Error: ",n),void t(n);var s=function(e){e===o&&(d(),t())},a=function(){i.getSyncStatus().quickSyncRunning||(d(),t(new Error("Received event: quickSyncStartFailed")))},r=function(){d(),t(new Error("Received event: quickSyncFailed"))},d=function(){i.removeListener("quickSyncFinished",s),i.removeListener("quickSyncStartFailed",a),i.removeListener("quickSyncError",r)};i.on("quickSyncFinished",s),i.on("quickSyncStartFailed",a),i.on("quickSyncError",r)})}],function(t){return t?(e.error("Unable to update registration state or box id"),void n.send(500)):void K(function(e,t){n.send(t||{})})});break;case 403:n.send(403);break;case 404:n.send(404);break;default:n.send(400)}})})}),P.get("/SAWeb/services/boxes",acceptsCheck("application/vnd.johndeere.sa.boxes.v1+json, application/json"),function(e,t){Z(function(e,n){e?t.send(404):t.send([n])})}),P.get("/SAWeb/services/boxes/:id",acceptsCheck("application/vnd.johndeere.sa.boxDetails.v1+json, application/json"),function(e,t){K(function(e,n){e?t.send(404):t.send(n)})}),P.post("/box/services/box/changeDataLocation",function(e,t){i.changeDataLocation(),t.send(200)}),P.get("/box/services/box/getUserDataFencingGroups/:userId",acceptsCheck("application/vnd.johndeere.sa.userDataFencingGroups.v1+xml, application/xml"),function(e,t){d.getUsersDataFencingGroups(e.params.userId,function(e,n,o){return e?void t.send(500):n&&o?void t.send(jsonToXml.convertObject({userDataFencingGroups:n,lastLoggedInDataFencingGroups:o},"dataFencingGroups").end()):void t.send(403)})}),P.get("/box/services/box",acceptsCheck("application/vnd.johndeere.sa.box.getBox.v1+json, application/json"),function(e,t){K(function(e,n){e?t.send(500):t.send(n)})}),P.post("/box/services/box/copy",function(e,t){i.startCopyProcess(),t.send(200)}),P.post("/box/services/box/fullSync",express.json(),function(e,t){var n;if("application/vnd.johndeere.sa.requestCustomFullSync.v1+json"===e.headers["content-type"]){var o=e.body.dtacData,s=e.body.models;n=function(e){i.startCustomFullSync(s,o,e)}}else{if(!_.isUndefined(e.headers["content-type"]))return void t.send(406,m.COMMON.UNACCEPTABLE_CONTENT_TYPE);n=function(e){i.startFullSync(e)}}n(function(e){if(e)t.send(500,m.FULL_SYNC.START_FAILED);else{var n=function(){i.removeListener("fullSyncStartFailed",o),i.removeListener("fullSyncStartSessionFailed",o),t.send(201,m.FULL_SYNC.STARTED)},o=function(e,s){i.removeListener("fullSyncSessionStarted",n),i.removeListener("fullSyncStartFailed",o),i.removeListener("fullSyncStartSessionFailed",o),i.removeListener("fullSyncError",o),s&&s.message&&s.message.toUpperCase()===b.BOX_UNAUTHORIZED.toUpperCase()?t.send(500,m.COMMON.BOX_UNAUTHORIZED):i.getSyncStatus().fullSyncRunning?t.send(201,m.FULL_SYNC.IN_PROGRESS):t.send(202,m.FULL_SYNC.START_FAILED)};i.once("fullSyncSessionStarted",n),i.once("fullSyncStartFailed",o),i.once("fullSyncStartSessionFailed",o),i.once("fullSyncError",o)}})}),P.post("/box/services/box/quickSync",function(t,n){i.startQuickSync(function(t,o){if(t)return e.error("Starting Quick Sync Error: ",t),void n.send(500,m.QUICK_SYNC.START_FAILED);var s=function(e){e===o&&(d(),n.send(200,m.QUICK_SYNC.COMPLETED))},a=function(){i.getSyncStatus().quickSyncRunning||(d(),n.send(202,m.QUICK_SYNC.START_FAILED))},r=function(e,t){d(),t&&t.message&&t.message.toUpperCase()===b.BOX_UNAUTHORIZED.toUpperCase()?n.send(500,m.COMMON.BOX_UNAUTHORIZED):n.send(424,m.QUICK_SYNC.FAILED)},d=function(){i.removeListener("quickSyncFinished",s),i.removeListener("quickSyncStartFailed",a),i.removeListener("quickSyncError",r)};i.on("quickSyncFinished",s),i.on("quickSyncStartFailed",a),i.on("quickSyncError",r)})}),P.post("/box/services/box/resumeSync",function(e,t){i.resumeSyncs(function(e){e?t.status(500).end():t.status(200).end()})}),P.put("/box/services/box",acceptsCheck("application/vnd.johndeere.sa.box.updateBoxDetailsResponse.v1+json"),express.json(),function(t,n,o){S.getAuthorizationState(function(t){t==S.getAuthorizedState()?o():(e.error("Halting setup process: Box is not authorized."),n.status(403).end())})},function(t,n){return _.isEmpty(t.body)?void n.status(400).end():void async.parallel({setupState:function(e){S.getSetupState(function(t){e(void 0,t)})},registrationState:function(e){S.getRegistrationState(function(t){e(void 0,t)})}},function(o,s){var a=s.setupState,d=S.isRegistered(s.registrationState);return S.isSetup(a)||S.isNotSetup(a)||S.isSetupInProgressReady(a)||S.isSetupInProgressError(a)||S.isSetupPendingIdentifiedSync(a)?void async.waterfall([function(e){r.getBoxInformation(function(t,n){e(t,n)})},function(n,o){var s=(t.body&&t.body.dataProperties&&t.body.dataProperties.languages||[]).sort(),u=(t.body&&t.body.dataProperties&&t.body.dataProperties.locations||[]).sort(),c=t.body&&t.body.dataProperties&&t.body.dataProperties.models?t.body.dataProperties.models.sort():void 0,p=t.body&&t.body.dataProperties&&t.body.dataProperties.datasets?t.body.dataProperties.datasets.sort():void 0,l=(n&&n.setupDataProperties&&n.setupDataProperties.languages||[]).sort(),f=_.pluck(n&&n.setupDataProperties&&n.setupDataProperties.locations||[],"id").sort(),g=n&&n.setupDataProperties&&n.setupDataProperties.models&&c?n.setupDataProperties.models.sort():void 0,y=n&&n.setupDataProperties&&n.setupDataProperties.datasets&&p?n.setupDataProperties.datasets.sort():void 0,v=(n&&n.savedDataProperties&&n.savedDataProperties.languages||[]).sort(),m=(n&&n.savedDataProperties&&n.savedDataProperties.locations||[]).sort(),b=n&&n.savedDataProperties&&n.savedDataProperties.models&&c?n.savedDataProperties.models.sort():void 0,x=n&&n.savedDataProperties&&n.savedDataProperties.datasets&&p?n.savedDataProperties.datasets.sort():void 0,h=_.isEqual(s,l),P=_.isEqual(u,f),I=_.isEqual(c,g),D=_.isEqual(p,y),U=h&&P&&I&&D,C=_.isEqual(s,v),E=_.isEqual(u,m),A=_.isEqual(c,b),k=_.isEqual(p,x),q=!(C&&E&&A&&k);C||e.info("The setup languages have changed",{adds:_.difference(s,v),deletes:_.difference(v,s)}),E||e.info("The setup locations have changed",{adds:_.difference(u,m),deletes:_.difference(m,u)}),A||e.info("The setup models have changed",{adds:_.difference(c,b),deletes:_.difference(b,c)}),k||e.info("The setup data sets have changed",{adds:_.difference(p,x),deletes:_.difference(x,p)});var T=!_.isEmpty(s),R=!_.isEmpty(u),F=!_.isEmpty(c),L=!_.isEmpty(p),j=T||R||F||L;U&&q?(e.info("Update Box Details: All updates equal the setup state and at least one update changed the saved state."),i.revertPendingCopy(function(n){function s(){var n=d?S.getIsSetupState:S.getSetupPendingIdentifiedSyncState;setupStateUtils.changeStateFromSetupStartOver(S,S.isSetupStartOver,n,function(o){return o?(e.error(o),e.debug("Failed to transition from SetupStartOver to "+n()+"We will remain in SetupStartOver state until next quick sync"),void syncUtils.onAnyQuickSyncComplete(i,s)):(d||r.updateBoxInformation(t.body,function(t){t&&e.error(t),e.debug("Added BoxInformation state change after changing to "+n())}),void e.info('Successfully transitioned from "SetupStartOver" to "'+n()+'".'))})}return n?void o(n):void(j?async.series([function(e){S.setSetupState(S.getSetupStartOverState(),e)},function(e){r.updateBoxInformation(t.body,e)},function(t){e.info('Starting quick sync because we are in "SetupStartOver" state'),i.startQuickSync(function(n,o){var a=function(t){e.error(t),e.debug('Failed to do a quick sync.We will remain in "SetupStartOver" state until next quick sync'),syncUtils.onAnyQuickSyncComplete(i,s)};n?a(n):syncUtils.bindQuickSyncComplete(o,i,function(e){e?a(e):s()}),t()})}],function(e,t){o(e,t[1])}):S.setSetupState(S.getIsNotSetupState(),function(n){return n?void o(n):(e.debug("Adding BoxInformation state change."),void r.updateBoxInformation(t.body,o))}))})):q||U&&S.isSetupPendingIdentifiedSync(a)?(e.info("Update Box Details: At least one update changed the saved state."),S.isSetupPendingIdentifiedSync(a)||S.isSetupInProgressReady(a)||S.isSetup(a)||S.isNotSetup(a)?i.stopCopyProcess(function(){S.setSetupState(S.getSetupInProgressState(),function(n){return n?void o(n):(e.debug("Adding BoxInformation state change and starting a quick sync to become setup."),void r.updateBoxInformationAndSync(t.body,o))})}):(e.debug("Adding BoxInformation state change and starting a quick sync."),r.updateBoxInformationAndSync(t.body,o))):(e.debug("Adding BoxInformation state change and starting a quick sync."),r.updateBoxInformationAndSync(t.body,o))},function(e,t){K(t)}],function(t,o){t?(e.error("Updating Box Details Error: ",t),n.status(t.statusCode||500).end()):n.status(200).json(o)}):void n.status(500).end()})}),P.get("/box/services/box/status",function(e,t){h(function(e,n){e?t.send(500):t.send(n)})}),P.get("/box/services/box/authorizationState",acceptsCheck("application/vnd.johndeere.sa.box.authorizationState.v1+json"),function(e,t){F(function(e,n){var o={isAuthorized:!_.isEmpty(n)&&"AUTHORIZED"===n.toUpperCase()};t.status(200).send(o)})}),P.get("/SAWeb/services/dealer/locations",function(e,t){C(function(e,n){return e?void t.status(e.statusCode||500).end():void t.status(200).json(n||[])})}),P.post("/SAWeb/services/models/:lang",acceptsCheck("application/vnd.johndeere.sa.getModelListResponse.v2+json"),express.json(),function(t,n){async.series({locationIds:function(e){C(function(t,n){e(t,_.pluck(n,"id").sort())})},datasets:function(e){E(function(t,n){e(t,_.isArray(n)?n.sort():void 0)})}},function(o,s){if(o)return e.error("Error retrieving setup Locations and DataSets: ",o),void n.send(500);var i=s.locationIds,a=s.datasets,r=t.body.locations&&t.body.locations.sort(),d=t.body.datasets&&t.body.datasets.sort();return _.isEqual(i,r)&&_.isEqual(d,a)?void c.getAllModels(t.params.lang,t.headers["x-user"],function(t,o){return t?(e.error("Error retrieving all models: ",t),void n.send(500)):void n.status(200).json({modelList:o})}):(e.error("Locations and DataSets in the request do not match the setup Locations and DataSets."),void n.send(403))})}),n()})};module.exports=setup;