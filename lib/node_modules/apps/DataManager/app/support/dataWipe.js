var environment=require("Environment"),async=require("async"),_=require("underscore"),exec=require("child_process").exec,DataWipe=function(e,t,n,r,o,i,a,s){this._app=e,this._db=t,this._networkContext=n,this._solrClient=r,this._wiping=!1,this._fileUtility=o,this._dataPathsClient=i,this._configStoreClient=a,this._config=s};DataWipe.prototype.wipeData=function(e,t,n){var r=this,o=this._db,i=this._networkContext,a=this._solrClient,s=this._fileUtility,c=this._config,p=this._dataPathsClient,u=this._configStoreClient;if(r._wiping)return void n(new Error("alreadyWiping"));r._wiping=!0;var d=function(n){var o={url:environment.serverLocation.concat("bms/oauth/boxes/",e,"/dataWipe"),headers:{"Content-Type":"application/vnd.johndeere.sa.dataWipe.v1+json"},json:{userId:t}};i.post(i.getNetworkOptions(o),function(e,t){t?e?(r._app.error("Error deleting box data from server. ",e),n(e)):200!==t.statusCode&&404!==t.statusCode?(r._app.error("Invalid response status code when attempting to delete the box data. ",t.statusCode),n(new Error(t.statusCode))):(r._app.info("Successfully removed the box data from the server. Server response: ",t.statusCode),n()):(r._app.error("No server response when attempting to delete the box data."),n(new Error("serverNoResponse")))})},f=function(e){o.dropDatabase(function(t){e(t)})},h=function(e,t){async.eachSeries(e,function(e,t){s.deleteDirectoryOrFile(e,function(e){t(e)})},function(e){return e?void t(e):void exec("net start SolrService",function(e){e&&r._app.error("Error occurred while attempting to start SOLR using the exec function. ",e),_.delay(t,1e4,e)})})},l=function(e){a.clearIndexes(function(t){e(t)})},g=function(e){p.clearDataLocationInformation(function(t){e(t)})},v=function(e){exec("net stop SolrService",function(t){t&&r._app.error("Error occurred while attempting to stop SOLR using the exec function. ",t),e(t)})},x=function(e){u.clearConfigStore(function(t){t?r._app.error("Error clearing config store",t):r._app.info("Cleared config store"),e(t)})},C=c.dataWipePaths;C.push(p.getDataPath()),C=C.concat(p.getTarAndIndexDirectories()),async.series([d,f,v,g,h.bind(void 0,C),l,x],function(e){r._wiping=!1,n(e)})},module.exports=DataWipe;