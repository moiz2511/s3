var dataWiper=require("./dataWipe"),async=require("async"),solr=require("apps/SolrManager/Client"),_=require("underscore"),config=require("../config.js"),setup=function(e,t){var n=require("FileUtility/index.js"),r=solr.create(e),i=t.database,a=t.registrationClient,o=t.configStoreClient,s=t.webServer,u=t.networkContext,p=t.dataPathsClient,c=new dataWiper(e,i,u,r,n,p,o,config),d=function(t,n){n=n||_.noop,async.waterfall([function(e){e()},function(t){a.setSetupState(a.getSetupInWipingState(),function(n){n?(e.error("Could not set state to Wiping: ",n),t(new Error("StageChangeFailure"))):t()})},function(e){a.getBoxId(function(t){e(void 0,t)})},function(n,r){c.wipeData(n,t,function(t){t?(e.error("Data Wipe Failed: ",t),a.setSetupState(a.getSetupInWipingFailureState(),function(n){n&&e.error("Could not set state to Wiping Failure: ",n),r(t)})):(e.info("Data wipe successful!"),r())})}],function(e){n(e)})};a.getSetupState(function(e){a.isSetupInWiping(e)&&o.getParameter("DataWipeRequestUserId",function(e){d(e)})}),s.post("/box/services/box/support/DataWipe",function(t,n){o.setParameter("DataWipeRequestUserId",t.headers["x-user"],function(r){return r?(e.error("Error setting DataWipeRequestUserId.",r),void n.send(500)):void d(t.headers["x-user"],function(e){e?"serverNoResponse"===e.message?n.send(504):"alreadyWiping"===e.message?n.send(202):n.send(500):n.send(200)})})})};module.exports=setup;