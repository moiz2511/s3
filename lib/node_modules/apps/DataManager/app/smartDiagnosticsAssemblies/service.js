!function(){"use strict";var e=require("underscore"),r=require("Environment"),i=require(r.getLocalAddonPath("GetPayloadInfo")),t=require("../dataProviders/UsersDataProvider.js"),a=require("iniFiles/PayloadProcessorSA5.js"),o=require("path"),n=require("fs"),d=require("async"),s=function(e,r,i){this._app=e,this._dm=r.database,this._sdaDataProvider=i,this._networkContext=r.networkContext,this._usersProvider=this._usersProvider=new t(e,r.databaseManager,r.registrationClient);var o=a(e);this._sdaFilePath="",o?this._sdaFilePath=o.Files.SDAFolder:e.error("Not able to find payloadProcessor.ini file"),""!=this._sdaFilePath&&null!=this._sdaFilePath||(this._sdaFilePath="C:/sds/sda")};s.prototype.updatePayloadData=function(r,i){var t=this._app,a=this._sdaDataProvider,s=this._sdaFilePath,u=function(r,i){var t=[];n.readdir(s,function(a,d){return a?void i(null,t,r):(e.each(d,function(r){if(r.toUpperCase().indexOf("_SDA")!=-1&&e.isEqual(o.extname(r).toUpperCase(),".PLD")){var i=o.join(s,r),a=n.statSync(i),d=a.mtime.toString();t.push({fileName:r,dateMod:d})}}),void i(null,t,r))})},c=function(r){var i=[];a.getSdaFileData(function(a,o){return a?(t.error("Error occurred while fetching payload info in getSdaFileData(): ",a),void r(!1,void 0,a)):(e.isEmpty(o)||e.each(o,function(e){i.push({fileName:e.sdaFileName,dateMod:e.dateModified})}),void r(null,i))})},f=function(e,r,i){var t=l(r,e),a=l(e,r);i(null,a,t)};d.waterfall([c,u,f],function(e,r,a){e&&t.error("Error occured while updating sda data",e),i(e,r,a)})};var l=function(e,r){var i=e.filter(function(e){return 0==r.filter(function(r){return r.fileName==e.fileName&&r.dateMod==e.dateMod}).length});return i};s.prototype.performDbOperations=function(r,t,a,n){var d=this._app,s=this._sdaDataProvider,l=this._usersProvider,c=this._sdaFilePath,f=function(t,a){t&&t.length>0?l.getUserObject(r,function(r,n){if(r)return void a(r);try{var l=[];t&&t.length>0&&e.each(t,function(r){var t,a,n=o.join(c,r.fileName);t=i.getPayloadHeaderInfo(n),a=e.isEqual(t.dateRequested,"Not_Available")?new Date:t.dateRequested,t&&l.push({sdaFileName:r.fileName,dateRequested:a,dateModified:r.dateMod,sdaFileSize:t.payloadFileSize})})}catch(e){return e&&d.error("Exception occurred while inserting sda file information: ",e),void a(e)}s.addSdaFileInDB(l,function(e){e&&d.error("Error occurred while inserting sda file information: ",e),a(e)})}):a(null)};u(a,s,d,function(e){e&&d.error("Error occurred in deleteSdaFromDB() callback: ",e),f(t,function(e){e&&d.error("Error occurred in addSdaToDB() callback: ",e),n()})})};var u=function(e,r,i,t){return e&&e.length>0?void r.deleteSdaFileFromDB(e,function(e){e&&i.error("Error occurred in deleteSdaFileFromDB(): ",e),t()}):void t()};s.prototype.deleteSDA=function(e,r){var i=this._app,t=this._sdaDataProvider,a=this._sdaFilePath,o="";o=a+"\\"+e[0].fileName,n.exists(o,function(a){return a?(n.unlink(o,function(r){if(r)throw r;i.info("file ",e[0].fileName," deleted successfully from the device")}),void t.deleteSdaFileFromDB(e,function(e){e&&i.error("Error occurred in deleteSdaFileFromDB(): ",e),r()})):(i.error("file ",e[0].fileName," doesn't exist on the device"),void r())})},module.exports={getSmartDiagnosticsAssembliesService:function(e,r,i){return e&&r&&r.database?new s(e,r,i):void 0}}}();