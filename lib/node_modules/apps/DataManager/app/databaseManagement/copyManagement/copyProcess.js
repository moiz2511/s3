"use strict";var _=require("underscore"),async=require("async"),CopyProcess=function(e,n,o,r){this._filesToCopy=e,this._filesToRemove=n,this._filesToHave=o,this._initiallyCompletedOperations=r};CopyProcess.prototype.summarize=function(){var e=_.reduce(this._filesToCopy,function(e,n){return e+n.sizeInKB},0),n=_.reduce(this._initiallyCompletedOperations,function(e,n){return e+n.sizeInKB},0),o=this._filesToRemove.length-this._initiallyCompletedOperations.length,r=o>=0?o:0,t=this._filesToCopy.length+(o>=0?0:o);return{remainingSizeInKb:e,partialProgressSizeInKb:n,copyOperationCount:t,removeOperationCount:r}},CopyProcess.prototype.getNumberOfFilesToCopy=function(){return this._filesToCopy.length},CopyProcess.prototype.removeFilesToCopy=function(e){var n=this,o=_.filter(n._filesToCopy,function(n){return _.indexOf(e,n.filepath,!0)===-1}),r=_.filter(n._filesToHave,function(n){return _.indexOf(e,n.filepath,!0)===-1});return new CopyProcess(o,n._filesToRemove,r,n._initiallyCompletedOperations)},CopyProcess.prototype.getSortedFilepathsToHave=function(){var e=this;return _.pluck(e._filesToHave,"filepath").sort()},CopyProcess.prototype.copyFromDataSet=function(e,n,o){var r=this,t=_.clone(r._initiallyCompletedOperations),i=r._filesToCopy,u=function(){if(_.isEmpty(i))o(void 0,"complete");else{var r=_.first(i);i=_.rest(i),e("add",r,function(e){t.push({op:"add",fileInfo:r});var i=n(e,"added",r,t);e?o(e,"failed"):i===!1?o(void 0,"cancel"):u()})}};u()};var create=function(e,n,o,r,t,i,u,s,a,c){var f=function(e,n,o){var r=function(e,n,o){var r=function(e,n){for(var o=0;o<n.length;++o)e.union[n[o]]=1,e.maxIndex=Math.max(e.maxIndex,n[o]);return e},t=_.map(e,function(e){return o&&o.languages&&o.languages[e]||[]});return _.reduce(t,r,n)},t=o.concat(["*"]),i=function(n,o){return n[e]=r(t,n[e],o),n};return _.map(n,function(e){return{model:e,reducer:i}})},l=function(e,n){var o=[];return _.each(e,function(e,r){e&&!n[r]&&o.push(r)}),o},d=function(e,n){return _.each(n,function(n){for(var o=n.index;o>=0;o-=1)e[o]=0}),e},p=function(e,n){return _.map(e,function(e){return _.extend({},{index:e},n.files[e])})},v=_.union(_.difference(u,s),i),m=_.union(_.difference(r,t),o),y=function(e){return _.isEmpty(e)?e:e.concat(["general"])},h={currentIndexes:{models:y(u),languages:r},indexesToHave:{models:y(v),languages:m}},x=_.chain(h).map(function(e,n){return f(n,e.models,e.languages)}).flatten().groupBy("model").map(function(e,n){return{modelId:n,reducers:_.pluck(e,"reducer")}}).value(),g=function(){return{maxIndex:-1,union:new Uint32Array(e.files.length)}},C=function(e,n,o,r){function t(e,n,i){for(var u=e,s=n,a=i;void 0!==u&&s;){var c=_.first(a),f=_.rest(a);u=o(u,s,function(e,n){e?r(e):t(n,c,f)}),s=c,a=f}void 0!==u&&r(void 0,u)}_.isEmpty(e)?r(void 0,n):t(n,_.first(e),_.rest(e))};C(x,_.object(_.keys(h),_.map(h,g)),function(n,o,r){function t(e){return _.reduce(o.reducers,function(n,o){return o(n,e)},n)}var i=a(e,o.modelId,function(e,n){e?r(e):r(void 0,t(n))});return i?t(i):void 0},function(o,r){if(o)return void c(o,null);var t=[];_.each(r.indexesToHave.union,function(e,n){1===e&&t.push(n)});var i=l(d(r.indexesToHave.union,_.where(n,{op:"add"})),r.currentIndexes.union),u=l(d(r.currentIndexes.union,_.where(n,{op:"remove"})),r.indexesToHave.union),s=p(i,e),a=p(u,e),f=p(t,e),v=r.currentIndexes.maxIndex>=e.files.length||r.indexesToHave.maxIndex>=e.files.length;v?c(new Error("invalid manifest"),null):c(void 0,new CopyProcess(s,a,f,n))})};exports.create=create;