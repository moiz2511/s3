"use strict";var _=require("underscore"),async=require("async"),DataCopyCollection="DataCopy",CompletedCopyCollection="CompletedCopyOperations",ModelsCollection="Models",PendingState="pending",ProcessingState="inProgress",DuplicateEntryError=11e3,DatabaseHelper=function(e,t,o){this._database=t,this._app=e,t.collection(DataCopyCollection).ensureIndex({state:!0},{unique:!0},function(t){t&&e.error("Ensuring index for CopyData collection failed."),o(t)})};DatabaseHelper.prototype.getPendingCopyDocument=function(e){var t=this;t._database.collection(DataCopyCollection).findOne({state:PendingState},function(t,o){e(t,o)})},DatabaseHelper.prototype.setPendingCopyDocument=function(e,t,o,a,n,s,i,l,r){var p=this,c={state:PendingState,modelAdds:e,modelDeletes:t,languages:o,languageAdds:a,languageDeletes:n,locations:l,requiredDatasets:s,totalDatasets:i,finishedDatasets:[],modelsDeleted:!1,modelsCopied:!1,fullSyncCompleted:!1,copyProcessCompleted:!1,currentCompletedSizeInKB:0};c=_.pick(c,function(e){return!_.isUndefined(e)}),p._database.collection(DataCopyCollection).update({state:PendingState},c,{upsert:!0},function(e){r(e)})},DatabaseHelper.prototype.markPendingCopyDocumentAsInProgress=function(e,t){var o=this;o._database.collection(DataCopyCollection).update({state:PendingState},{$set:{state:ProcessingState,datasetPriorityOrder:e}},function(e){e&&e.code===DuplicateEntryError&&(e=void 0),t(e)})},DatabaseHelper.prototype.markPendingCopyDocumentAsReverted=function(e){var t=this;t._database.collection(DataCopyCollection).update({state:PendingState},{$set:{reverted:!0}},function(t){e(t)})},DatabaseHelper.prototype.markPendingCopyDocumentAsCurrent=function(e){var t=this;t._database.collection(DataCopyCollection).update({state:PendingState},{$set:{reverted:!1}},function(t){e(t)})},DatabaseHelper.prototype.getInProgressCopyDocument=function(e){var t=this;t._database.collection(DataCopyCollection).findOne({state:ProcessingState},function(t,o){e(t,o)})},DatabaseHelper.prototype.getAvailableCopyDocument=function(e){var t=this;t.getInProgressCopyDocument(function(o,a){o?e(o):a?e(void 0,a):t.getPendingCopyDocument(function(t,o){e(t,o)})})},DatabaseHelper.prototype.flagInProgressCopyDocumentModelsDeleted=function(e){var t=this;t._database.collection(DataCopyCollection).update({state:ProcessingState},{$set:{modelsDeleted:!0}},function(t){e(t)})},DatabaseHelper.prototype.setDatasetAsFinished=function(e,t){var o=this;o._database.collection(DataCopyCollection).findAndModify({state:ProcessingState},[],{$push:{finishedDatasets:e}},{new:!0},function(e,o){t(e,o)})},DatabaseHelper.prototype.flagInProgressCopyDocumentModelsCopied=function(e){var t=this;t._database.collection(DataCopyCollection).update({state:ProcessingState},{$set:{modelsCopied:!0}},function(t){e(t)})},DatabaseHelper.prototype.flagInProgressCopyDocumentFullSyncCompleted=function(e){var t=this;t._database.collection(DataCopyCollection).update({state:ProcessingState},{$set:{fullSyncCompleted:!0}},function(t){e(t)})},DatabaseHelper.prototype.flagInProgressCopyDocumentCopyProcessCompleted=function(e){var t=this;t._database.collection(DataCopyCollection).update({state:ProcessingState},{$set:{copyProcessComplete:!0}},function(t){e(t)})},DatabaseHelper.prototype.updateCurrentCompletedSize=_.throttle(function(e){var t=this;t._database.collection(DataCopyCollection).update({state:ProcessingState},{$set:{currentCompletedSizeInKB:e}},function(e){e&&t._app.error("Error updating current completed size: ",e)})},1e3,{trailing:!1}),DatabaseHelper.prototype.getCompletedOperations=function(e){var t=this;t._database.collection(CompletedCopyCollection).find({}).toArray(e)},DatabaseHelper.prototype.addCompletedOperation=function(e,t,o,a){var n=this;n._database.collection(CompletedCopyCollection).update(e,{$inc:{sizeInKB:_.isNumber(o)?o:0},$set:{index:t,currentCompletedSizeInKB:0}},{w:1,upsert:!0},a)},DatabaseHelper.prototype.clearCompletedOperations=function(e){var t=this;t._database.collection(CompletedCopyCollection).remove({},e)},DatabaseHelper.prototype.deletePendingCopyDocument=function(e){var t=this;t._database.collection(DataCopyCollection).remove({state:PendingState},function(t){e(t)})},DatabaseHelper.prototype.deleteInProgressCopyDocument=function(e){var t=this;t._database.collection(DataCopyCollection).remove({state:ProcessingState},function(t){e(t)})},module.exports=DatabaseHelper;