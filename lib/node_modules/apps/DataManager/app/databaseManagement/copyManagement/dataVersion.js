"use strict";var fs=require("fs"),path=require("path"),_=require("underscore"),xmljs=require("xml2js"),async=require("async"),fileUtility=require("FileUtility"),DataVersion=function(e,a,t,i,r){this.dataSetName=a,this.dataSetVersion=t,this.dataFormatVersion=i,this.dataSetPath=path.dirname(e),this._manifests=r};DataVersion.prototype.eachManifest=function(e,a){var t=this;async.eachSeries(_.values(t._manifests),function(a,t){e(a.dataset,a.path,a.fileName,t)},a)};var readVersion=function(e,a){function t(t,i){if(t)return void a(t);if(!i)return t=new Error("Empty xml file"),void a(t);var r=i.dataset,s=r&&r.datasetversion&&r.datasetversion[0],n=r&&r.manifests&&r.manifests[0]&&r.manifests[0].manifest;if(s){var o=s.$.data_format_version,f=s.$.dataset_version,d=s.$.dataset_name,m=_.chain(n).map(function(e){var a=e.$.dataset,t=e.$.filename,i=e.$.path;return a&&t&&i?[a,{dataset:a,fileName:t,path:i}]:void 0}).compact().object().value();a(void 0,new DataVersion(e,d,f,o,m))}else a(new Error("invalid version info"))}fs.readFile(e,function(e,i){e?a(e):_.isUndefined(i)?(e=new Error("Empty file"),a(e)):xmljs.parseString(i,t)})};exports.readVersion=readVersion;