"use strict";var _=require("underscore"),async=require("async"),RetryError=require("./RetryError.js"),CancelError=require("./CancelError.js"),StateProcessor=function(e,t,n,o,i,a,r,s,c,l){this._app=e,this._copyManager=l,this._copyHelper=t,this._dbHelper=n,this._dbManager=o,this._registrationClient=i,this._dataPathsClient=a,this._boxDataProvider=r,this._modelsDataProvider=s,this._ONEManager=c};StateProcessor.prototype.initialize=function(e,t,n){var o=this;if(t.reverted)return void n(void 0,e,"requestQuickSync");var i=!1,a=function(){i=!0};o._copyHelper.once("cancel",a),async.waterfall([function(n){o._copyHelper.calculateFinishedAndUnfinishedDatasets(t,function(t,o,a){t?n(t):i?n(new CancelError):(e.unfinishedDatasets=o,e.finishedDatasets=a,n())})},function(t){o._app.debug("There are some unfinished data sets. Prompting for one of them. The data sets that are unfinished are: "+JSON.stringify(e.unfinishedDatasets)),e.unfinishedDatasets.length>0?o._copyHelper.promptForDatasetLocation(e.unfinishedDatasets,e.finishedDatasets,function(n,a){n?t(n):i?t(new CancelError):(o._copyHelper.showCalculatingSize(),e.selectedDatasetPath=a,o._copyHelper.parseDataSet(a,function(n,i,a){n?(o._app.error("The selected data set wasn't valid",n),t(new RetryError)):"cancel"===a?t(new CancelError):_.contains(e.unfinishedDatasets,i.dataSetName)?t(void 0,i):t(new RetryError)}))}):t(void 0,void 0)},function(t,n){t?(e.selectedDataSetVersion=t,o._copyHelper.copyManifests(e.selectedDatasetPath,t,function(e){e?n(e):i?n(new CancelError):n()})):n()}],function(t){i&&!t&&(t=new CancelError),o._copyHelper.removeListener("cancel",a),n(t,e,"getAuthorization")})},StateProcessor.prototype.requestQuickSync=function(e,t,n){var o=this;t.reverted?(o._dbManager.startQuickSync(),o._copyManager.once("copyDocumentCurrent",function(){o._dbHelper.markPendingCopyDocumentAsCurrent(function(t){return t?void n(t):void n(void 0,e,"initialize")})})):n(void 0,e,"initialize")},StateProcessor.prototype.getAuthorization=function(e,t,n){var o=this,i=!1,a=function(){i=!0};o._copyHelper.once("cancel",a),async.waterfall([function(e){o._dbHelper.getCompletedOperations(function(t,n){t?e(t):i?e(new CancelError):e(void 0,n)})},function(e,t){o._boxDataProvider.getBoxInformation(function(n,o){t(n,e,o&&o.setupDataProperties)})},function(n,a,r){o._app.info("Computing the files that need to be copied."),o._copyHelper.calculateCopyInfo(a,t.totalDatasets,e.selectedDataSetVersion,n,t.languageAdds,t.languageDeletes,_.pluck(t.modelAdds,"mG"),_.pluck(t.modelDeletes,"mG"),t.datasetPriorityOrder,function(n,a){n?(o._app.error("Unable to calculate all data for copy.",n),r(n)):i?r(new CancelError):(e.isDataUpdate=a.isDataUpdate,e.size=a.sizeInKB-t.currentCompletedSizeInKB,e.originalSize=a.originalSizeInKB,e.copyProcesses=a.copyProcesses,e.datasetPriorityOrder=a.datasetPriorityOrder,e.filesToKeepInfo=a.filesToKeepInfo,e.filesToDeleteInfo=a.filesToDeleteInfo,r(void 0,e.size,e.filesToDeleteInfo.sizeInKB))})},function(t,n,a){o._app.info(t+" KB worth of data was found to copy."),o._app.info(n+"KB worth of data was found to delete."),t>0||n>0?o._copyHelper.getUserApproval(t,n,e.selectedDatasetPath,function(e){e?a(e):i?a(new CancelError):a()}):a()},function(e){o._registrationClient.getSetupState(function(t){o._registrationClient.isSetup(t)||o._registrationClient.isNotSetup(t)||o._registrationClient.isSetupInProgress(t)||o._registrationClient.isSetupInProgressReady(t)?o._registrationClient.setSetupState(o._registrationClient.getSetupInProgressCopyingState(),function(t){t?e(t):i?e(new CancelError):e()}):e()})},function(t){o._dbHelper.markPendingCopyDocumentAsInProgress(e.datasetPriorityOrder,function(e){e?t(e):i?t(new CancelError):t()})}],function(t){i&&!t&&(t=new CancelError),o._copyHelper.removeListener("cancel",a),n(t,e,"deleteModels")})},StateProcessor.prototype.selectDataset=function(e,t,n){var o=this,i=!1,a=function(){i=!0};o._copyHelper.once("cancel",a),o._copyHelper.promptForDatasetLocation(e.unfinishedDatasets,e.finishedDatasets,function(t,r){t?(o._copyHelper.removeListener("cancel",a),n(t)):i?(o._copyHelper.removeListener("cancel",a),n(new CancelError)):(e.selectedDatasetPath=r,o._copyHelper.parseDataSet(r,function(t,r){i&&!t&&(t=new CancelError),o._copyHelper.removeListener("cancel",a),e.selectedDataSetVersion=r,n(t,e,"checkUnfinishedDatasets")}))})},StateProcessor.prototype.deleteModels=function(e,t,n){var o=this;if(t.modelsDeleted===!1){var i=!1,a=function(){i=!0};o._copyHelper.once("cancel",a),async.waterfall([function(t){o._copyHelper.processDeletes(e.filesToDeleteInfo.files,e.isDataUpdate,function(e){e?t(e):i?t(new CancelError):t()})},function(e){o._dbHelper.flagInProgressCopyDocumentModelsDeleted(function(t){t?e(t):i?e(new CancelError):e()})}],function(t){i&&!t&&(t=new CancelError),o._copyHelper.removeListener("cancel",a),n(t,e,"checkUnfinishedDatasets")})}else n(void 0,e,"checkUnfinishedDatasets")},StateProcessor.prototype.checkUnfinishedDatasets=function(e,t,n){var o=this;t.modelsCopied||_.isEmpty(e.unfinishedDatasets)?o._dbHelper.flagInProgressCopyDocumentModelsCopied(function(t){t?n(t):(e.finishedFullSync=!1,n(void 0,e,"requestFullSync"))}):n(void 0,e,"copyModels")},StateProcessor.prototype.copyModels=function(e,t,n){var o=this,i=!1,a=function(){i=!0};o._copyHelper.once("cancel",a),async.waterfall([function(e){o._dbHelper.getCompletedOperations(function(t,n){if(t)return void e(t);var o=_.reduce(n,function(e,t){return"add"===t.op?t.sizeInKB+e:e},0);e(void 0,o)})},function(n,a){var r=e.selectedDataSetVersion.dataSetName,s=e.copyProcesses[r];if(!s)return o._app.error("The selected data set wasn't one of the required data sets."),void a(new RetryError);e.completedSize=n||0,o._copyHelper.sendCopyProgress(e.completedSize,e.originalSize,void 0),o._app.info("Starting data copy from ",e.selectedDatasetPath,". Estimated file size to copy: ",e.size-e.completedSize," KB.");var c=new Date;o._copyHelper.copyFromDataSet(e.selectedDatasetPath,e.selectedDataSetVersion.dataSetName,e.completedSize,e.originalSize,s,function(t){o._app.info("Data copy from ",e.selectedDatasetPath," suspended.  Total copy time: ",Math.ceil((new Date-c)/6e4)," minutes.  Estimated file size remaining to be copied: ",e.size-t," KB."),a(new CancelError)},function(n,s){n||i?o._app.info("Data copy from ",e.selectedDatasetPath," suspended.  Total copy time: ",Math.ceil((new Date-c)/6e4)," minutes.  Estimated file size remaining to be copied: ",e.size-s," KB."):o._app.info("Data copy from ",e.selectedDatasetPath," complete.  Total copy time: ",Math.ceil((new Date-c)/6e4)," minutes."),n?(o._app.error("The copy process failed",n),a(n)):i?a(new CancelError):(e.completedSize=s,o._dbHelper.setDatasetAsFinished(r,function(e,n){e?a(e):i?a(new CancelError):(t=n,a())}))})},function(n){o._copyHelper.calculateFinishedAndUnfinishedDatasets(t,function(t,o,a){t?n(t):i?n(new CancelError):(e.unfinishedDatasets=o,e.finishedDatasets=a,n())})},function(t){0===e.unfinishedDatasets.length?t(void 0,"checkUnfinishedDatasets"):t(void 0,"selectDataset")}],function(t,r){i&&!t&&(t=new CancelError),o._copyHelper.removeListener("cancel",a),n(t,e,r)})},StateProcessor.prototype.requestFullSync=function(e,t,n){var o=this;o._dbManager.getSyncStatus().fullSyncRunning===!1?o._registrationClient.setSetupState(o._registrationClient.getSetupInProgressSyncingState(),function(t){t?n(t):(o._dbManager.startFullSync(function(e,t){if(e)return void n(e);var i=function(){o._dbManager.removeListener("fullSyncStartFailed",a)},a=function(){o._dbManager.getSyncStatus().fullSyncRunning||o._ONEManager.sendSyncErrorMessage()};o._dbManager.once("fullSyncStarted",i),o._dbManager.on("fullSyncStartFailed",a)}),n(void 0,e,"waitForFullSyncComplete"))}):n(void 0,e,"waitForFullSyncComplete")},StateProcessor.prototype.waitForFullSyncComplete=function(e,t,n){var o=this,i=function(){o._dbManager.removeListener("fullSyncFinished",i),o._dbHelper.flagInProgressCopyDocumentFullSyncCompleted(function(t){n(t,e,"updateModelsCollection")})};t.fullSyncCompleted===!1?e.finishedFullSync===!0?i():o._dbManager.on("fullSyncFinished",i):n(void 0,e,"updateModelsCollection")},StateProcessor.prototype.updateModelsCollection=function(e,t,n){var o=this;t.copyProcessCompleted===!1?async.waterfall([function(e){o._modelsDataProvider.removeModelsFromModelsCollection(t.modelDeletes,function(t){e(t)})},function(e){o._dbHelper.flagInProgressCopyDocumentCopyProcessCompleted(function(t){e(t)})}],function(t){t?n(t):n(void 0,e,"completeCopyProcess")}):n(void 0,e,"completeCopyProcess")},StateProcessor.prototype.completeCopyProcess=function(e,t,n){var o=this;async.waterfall([function(e){o._boxDataProvider.getBoxInformation(function(n,i){return n?void e(n):void o._boxDataProvider.updateBoxInformation({setupDataProperties:{datasets:t.totalDatasets,languages:t.languages,locations:t.locations,models:_.difference(_.union(i.setupDataProperties.models,_.pluck(t.modelAdds,"mG")),_.pluck(t.modelDeletes,"mG"))}},function(t){e(t)})})},function(e){o._dbHelper.clearCompletedOperations(function(t){e(t)})},function(e){o._dbHelper.deleteInProgressCopyDocument(function(t){e(t)})},function(e){async.parallel({copyDocument:function(e){o._dbHelper.getAvailableCopyDocument(function(t,n){e(t,n)})},registrationState:function(e){o._registrationClient.getRegistrationState(function(t){e(void 0,t)})},setupState:function(e){o._registrationClient.getSetupState(function(t){e(void 0,t)})}},function(t,n){e(t,n)})},function(e,t){e.copyDocument||o._registrationClient.isRegistered(e.registrationState)?!e.copyDocument&&o._registrationClient.isRegistered(e.registrationState)?o._registrationClient.setSetupState(o._registrationClient.getIsSetupState(),function(e){return e?void t(e):(o._ONEManager.sendSyncCompleteMessage(),void o._dataPathsClient.setTarAndIndexDirectoryLocations([o._dataPathsClient.getDataSetsPath()],function(e){t(e)}))}):o._registrationClient.setSetupState(o._registrationClient.getSetupInProgressCopyingState(),function(e){t(e)}):o._registrationClient.setSetupState(o._registrationClient.getSetupPendingIdentifiedSyncState(),function(e){return e?void t(e):(o._copyHelper.sendCopyCompleteMessage(),void o._dataPathsClient.setTarAndIndexDirectoryLocations([o._dataPathsClient.getDataSetsPath()],function(e){t(e)}))})}],function(e){e?n(e):n(void 0,{},"initialize")})},module.exports=StateProcessor;