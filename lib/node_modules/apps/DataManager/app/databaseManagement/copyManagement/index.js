"use strict";var path=require("path"),async=require("async"),_=require("underscore"),events=require("events"),util=require("util"),dbHelperApp=require("./DbHelper.js"),CopyHelper=require("./CopyHelper.js"),StateProcessor=require("./StateProcessor.js"),BoxDataProvider=require("../../dataProviders/BoxDataProvider.js"),ModelsDataProvider=require("../../dataProviders/ModelsDataProvider.js"),DatasetsProvider=require("../../dataProviders/DatasetsProvider.js"),CopyManager=function(e,t,n,o,r,a,i,s,c){var d=this;d._app=e,d._dbManager=o,d._copyState="notCopying",d._copySessionInfo={},d._registrationClient=r,d._oneManager=t,d._dataPathsClient=i,d._boxDataProvider=new BoxDataProvider(e,o,s),d._modelsDataProvider=new ModelsDataProvider(e,o,n,r),d._datasetsProvider=new DatasetsProvider(e,o),events.EventEmitter.call(d),o.on("fullSyncFinished",function(){d._copySessionInfo.finishedFullSync=!0}),o.on("quickSyncFinished",function(){d._dbHelper.markPendingCopyDocumentAsCurrent(function(t){return t?void e.error("Database error marking copy document as current",t):void d.emit("copyDocumentCurrent")})}),async.waterfall([function(t){d._dbHelper=new dbHelperApp(e,n,t)},function(n){d._copyHelper=new CopyHelper(e,t,d._dbHelper,a,d._dataPathsClient,d._boxDataProvider,d._datasetsProvider),d._stateProcessor=new StateProcessor(e,d._copyHelper,d._dbHelper,o,d._registrationClient,d._dataPathsClient,d._boxDataProvider,d._modelsDataProvider,d._oneManager,d),n()},function(e){d._dbHelper.getInProgressCopyDocument(function(t,n){return t?void e(t):(n&&n.modelsCopied===!0&&_startDataCopyProcess(d),void e())})}],function(e){c(e)})};util.inherits(CopyManager,events.EventEmitter),CopyManager.prototype.isInCopyProcess=function(){var e=this;return"notCopying"!==e._copyState},CopyManager.prototype.addNewCopyData=function(e,t,n,o,r,a){var i=this,s=_.pluck(e,"mG"),c=function(){i._dbManager.removeListener("fullSyncStartFailed",d)},d=function(){i._dbManager.getSyncStatus().fullSyncRunning||i._ONEManager.sendSyncErrorMessage(),i._registrationClient.setSetupState(i._registrationClient.getSetupInProgressSyncingErrorState(),function(e){a(e)})},p=function(){i._registrationClient.getRegistrationState(function(e){i._registrationClient.isRegistered(e)?i._registrationClient.setSetupState(i._registrationClient.getIsSetupState(),function(e){i._oneManager.sendSyncCompleteMessage(),i._dbManager.removeListener("fullSyncStartFailed",d),i._dbManager.removeListener("fullSyncFinished",p),a(e)}):i._registrationClient.setSetupState(i._registrationClient.getSetupPendingIdentifiedSyncState(),function(e){i._copyHelper.sendCopyCompleteMessage(),i._dbManager.removeListener("fullSyncStartFailed",d),i._dbManager.removeListener("fullSyncFinished",p),a(e)})})};async.waterfall([function(e){i._boxDataProvider.getBoxInformation(function(t,n){e(t,n)})},function(a,c){var d=_.difference(n,a.setupDataProperties.languages),p=_.difference(a.setupDataProperties.languages,n);i._dbHelper.getPendingCopyDocument(function(u,l){if(u)return void c(u);if(l){var g=_.pluck(l.modelAdds,"mG"),y=l.modelDeletes,f=_.difference(_.union(s,g),t),C=_.difference(_.union(t,y),f),v=e.concat(l.modelAdds),S=_.map(f,function(e){return _.findWhere(v,{mG:e})});_calculateRequiredDatasets(i,a,d,p,S,C,o,function(e,t){return e?void c(e):void i._dbHelper.setPendingCopyDocument(S,C,n,d,p,t,o,r,c)})}else e.length>0||t.length>0||d.length>0||p.length>0||_.difference(o,a.setupDataProperties.datasets).length>0?_calculateRequiredDatasets(i,a,n,p,e,t,o,function(a,s){return a?void c(a):void i._dbHelper.setPendingCopyDocument(e,t,n,d,p,s,o,r,c)}):c()})},function(e){i._registrationClient.getSetupState(function(t){e(void 0,t)})},function(e,t){i._dbHelper.getPendingCopyDocument(function(n,o){t(n,o,e)})},function(e,t,n){_isCopyDocumentEmpty(e)?i._dbHelper.deletePendingCopyDocument(function(e){n(e,t)}):n(void 0,t)},function(e,t){i._dbHelper.getPendingCopyDocument(function(n,o){t(n,o,e)})},function(e,t,n){i._registrationClient.isSetupInProgress(t)?_.isNull(e)?i._dbManager.getSyncStatus().fullSyncRunning===!1?i._registrationClient.setSetupState(i._registrationClient.getSetupInProgressSyncingState(),function(e){return e?void n(e):void i._dbManager.startFullSync(function(e){return e?void n(e):(i._dbManager.once("fullSyncStarted",c),i._dbManager.on("fullSyncStartFailed",d),void i._dbManager.on("fullSyncFinished",p))})}):n():(_startDataCopyProcess(i),i._registrationClient.setSetupState(i._registrationClient.getSetupInProgressReadyState(),function(e){n(e)})):n()}],function(e){a(e)})},CopyManager.prototype.startDataCopy=function(){var e=this;_startDataCopyProcess(e)},CopyManager.prototype.stopDataCopy=function(e){var t=this;"notCopying"!==t._copyState?(t.once("copyProcessEnded",e),t._oneManager.sendCancelMessage(),t._copyHelper.cancel()):e()},CopyManager.prototype.revertPendingCopy=function(e){var t=this;t.stopDataCopy(function(n){return n?void e(n):void t._dbHelper.markPendingCopyDocumentAsReverted(function(t){e(t)})})};var _isCopyDocumentEmpty=function(e){return e&&e.languageAdds&&e.languageDeletes&&e.modelAdds&&e.modelDeletes&&0===e.languageAdds.length&&0===e.languageDeletes.length&&0===e.modelAdds.length&&0===e.modelDeletes.length&&0===e.requiredDatasets.length},_calculateRequiredDatasets=function(e,t,n,o,r,a,i,s){e._copyHelper.checkIfManifestExists(_.first(i),function(c,d){return c?void s(c):d?void e._dbHelper.getCompletedOperations(function(c,d){return c?void s(c):void e._copyHelper.calculateCopyInfo(t.setupDataProperties,i,void 0,d,n,o,r,a,[],function(e,t){if(e)return void s(e);var n=[];_.each(t.copyProcesses,function(e,t){e.getNumberOfFilesToCopy()>0&&n.push(t)}),s(void 0,n)})}):void s(void 0,i)})},_quitCopyProcess=function(e){e._copyState="notCopying",e._copySessionInfo={},e.emit("copyProcessEnded")},_sendError=function(e,t){var n=function(){r(),e._copyState="initialize",_dataCopyLoop(e)},o=function(){r(),_quitCopyProcess(e)},r=function(){e._oneManager.offNextStartCopy(n),e._copyHelper.removeListener("cancel",o),e._oneManager.offNextCancelCopy(o)};e._app.error("Sending Copy Error Message. ",t),e._oneManager.sendCopyErrorMessage(),e._oneManager.onNextStartCopy(n),e._oneManager.onNextCancelCopy(o),e._copyHelper.once("cancel",o)},_startDataCopyProcess=function(e){"notCopying"===e._copyState&&(e._copyState="initialize",_dataCopyLoop(e))},_dataCopyLoop=function(e){e._dbHelper.getAvailableCopyDocument(function(t,n){return t?void _sendError(e,t):n?(e._app.debug("Entering data copy loop, state = "+e._copyState),void e._stateProcessor[e._copyState](e._copySessionInfo,n,function(t,n,o){t&&"RetryError"===t.name?_dataCopyLoop(e):t&&"CancelError"===t.name?(e._oneManager.sendCancelMessage(),_quitCopyProcess(e)):t?_sendError(e,t):(e._copyState=o,e._copySessionInfo=n,_dataCopyLoop(e))})):void _quitCopyProcess(e)})};module.exports=CopyManager;