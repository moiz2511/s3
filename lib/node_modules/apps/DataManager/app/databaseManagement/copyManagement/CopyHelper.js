"use strict";var fs=require("fs"),path=require("path"),events=require("events"),util=require("util"),_=require("underscore"),async=require("async"),uuid=require("uuid"),environment=require("Environment"),fileUtility=require("FileUtility"),systemInfo=require(environment.getLocalAddonPath("SystemInfo")),copyProcess=require("./copyProcess"),dataVersion=require("./dataVersion"),copyOps=require("./copyOperations"),manifestUtilities=require("./manifestUtilities"),CopyHelper=function(e,t,n,i,a,o,r){var s=this;events.EventEmitter.call(s),s._app=e,s._dbHelper=n,s._oneManager=t,s._solrClient=i,s._dataPathsClient=a,s._boxDataProvider=o,s._datasetsProvider=r,s._errors={noError:0,invalidLocation:1,invalidPermissions:2,genericError:3,noSpace:4},s._oneManager.onCancelCopy(function(){s.emit("cancel")})};util.inherits(CopyHelper,events.EventEmitter),CopyHelper.prototype.cancel=function(){this.emit("cancel")},CopyHelper.prototype.copyManifests=function(e,t,n){manifestUtilities.copyManifests(fileUtility,e,t,function(e){n(e)})},CopyHelper.prototype.processDeletes=function(e,t,n){var i=this,a=function(e){i._dataPathsClient.clearTarAndIndexDirectoryInformation(function(t){e(t)})},o=function(e){t,e()},r=function(n){var a=_.chain(e).map(function(e){switch(e.type){case"static":return path.join(i._dataPathsClient.getDataSetsRoot(),e.filepath);default:return}}).compact().value();t&&a.push(i._dataPathsClient.getDataPath()),async.eachSeries(a,fileUtility.deleteDirectoryOrFile,function(e){n(e)})};async.series([a,o,r],function(e){n(e)})},CopyHelper.prototype.showCalculatingSize=function(){var e=this;e._oneManager.showCalculatingSize()},CopyHelper.prototype.checkIfManifestExists=function(e,t){manifestUtilities.checkManifestExists(fileUtility,e,function(e){t(void 0,e)})},CopyHelper.prototype.getUserApproval=function(e,t,n,i){var a,o,r=this,s=function(e){clearTimeout(a);var t=e&&e.path;r._oneManager.offRequestLocationValidation(o),r._oneManager.offNextStartCopy(s),r.removeListener("cancel",s),t?l(n,t,function(e){return e?void i(e):void r._dataPathsClient.setPublicDataRoot(t,function(e){i(e)})}):i()},c=function(i,o){var s=systemInfo.getDiskSpace(i).totalFreeSpaceInKB,p=0;_.first(i).toLowerCase()===_.first(environment.dataDrive).toLowerCase()&&(p=environment.minimumSpaceRemainingThresholdInKB),s<0||s-p+t>e?l(n,i,function(a,s){r._oneManager.requestUserConfirmation(e,t,s<0?0:s,i,o.canChange,n,a&&a.code)}):a=setTimeout(function(){c(i,o)},5e3)},p=function(i,o){clearTimeout(a);var s=i.canChange?o&&o.path:i.path;l(n,s,function(a,o){r._oneManager.requestUserConfirmation(e,t,o<0?0:o,s,i.canChange,n,a&&a.code),a&&a.code===r._errors.noSpace&&c(s,i)})};r.once("cancel",s),r._dataPathsClient.getDataLocationInformation(function(a,f){return a?(r._oneManager.offNextStartCopy(s),r.removeListener("cancel",s),void i(a)):(o=p.bind(void 0,f),r._oneManager.onRequestLocationValidation(o),r._oneManager.onNextStartCopy(s),void l(n,f.path,function(n,i){r._oneManager.requestUserConfirmation(e,t,i<0?0:i,f.path,f.canChange,n&&n.code),n&&n.code===r._errors.noSpace&&c(f.path,f)}))});var l=function(n,i,a){var o=systemInfo.getDiskSpace(i).totalFreeSpaceInKB,s=0;_.first(i).toLowerCase()===_.first(environment.dataDrive).toLowerCase()&&(s=environment.minimumSpaceRemainingThresholdInKB);try{n=path.normalize(n),i=path.normalize(i)}catch(e){return r._app.error("Error Normalizing Paths: ",e),e.code=r._errors.genericError,void a(e,o)}var c=function(e){if(i.length>=n.length&&i.substring(0,n.length)===n){var t=new Error("The copy location cannot be the same as the source location, or a child of the source location.");t.code=r._errors.invalidLocation,r._app.error(t),e(t)}else e()},p=function(e){var t=uuid(),n=path.join(i,t);fs.writeFile(n,t,function(i){return i?(i.code=r._errors.invalidPermissions,r._app.error("Error Writing Test File: ",i),void fs.unlink(n,function(){e(i)})):void fs.readFile(n,"utf8",function(i,a){return i?(i.code=r._errors.invalidPermissions,r._app.error("Error Reading Test File: ",i),void fs.unlink(n,function(){e(i)})):a!==t?void fs.unlink(n,function(){var t=new Error("Invalid File Access Privileges.");t.code=r._errors.invalidPermissions,r._app.error("Data in test file doesn't match original data."),e(t)}):void fs.unlink(n,function(t){t&&(r._app.error("Error Unlinking Test File: ",t),t.code=r._errors.invalidPermissions),e(t)})})})},l=function(n){if(o-s+t<e&&o>=0){var i=new Error("Not enough free disk space.");i.code=r._errors.noSpace,n(i)}else n()};async.series([c,p,l],function(e){a(e,o)})}},CopyHelper.prototype.promptForDatasetLocation=function(e,t,n){var i=this,a=!1,o=function(e){a=!0,i._oneManager.offNextDataSetSelected(o),i.removeListener("cancel",o),n(void 0,e&&e.path)},r=function(e,t){return _.chain(t).filter(function(t){return _.contains(e,t.id)}).map(function(e){return{datasetId:e.id,displayName:e.datasetName}}).value()};i._datasetsProvider.getDatasetObjects(_.union(e,t),function(s,c){if(!a)return s?(i._oneManager.offNextDataSetSelected(o),i.removeListener("cancel",o),void n(s)):void i._oneManager.promptForDatasetLocation(r(e,c),r(t,c))}),i._oneManager.onNextDataSetSelected(o),i.on("cancel",o)},CopyHelper.prototype.sendCopyProgress=_.throttle(function(e,t,n){var i=this;i._oneManager.sendCopyProgress(e,t,n)},500,{trailing:!1}),CopyHelper.prototype.sendCopyCompleteMessage=function(){var e=this;e._oneManager.sendCopyCompleteMessage()},CopyHelper.prototype.calculateFinishedAndUnfinishedDatasets=function(e,t){var n=this;n._app.debug("Calculating unfinished data sets: "+JSON.stringify({requiredDataSets:e.requiredDatasets,finishedDatasets:e.finishedDatasets}));var i=_.difference(e.requiredDatasets,e.finishedDatasets);t(void 0,i,e.finishedDatasets)},CopyHelper.prototype.parseDataSet=function(e,t){dataVersion.readVersion(path.join(e,"dataset_version.xml"),function(e,n){e?t(e):t(void 0,n)})},CopyHelper.prototype.determineIfIsDataUpdate=function(e,t,n){var i=this;i._app.debug("Determining data update status: "+JSON.stringify({setupDatasets:e,newDatasets:t,datasetObjectIds:_.pluck(n,"id")}));var a=_.find(n,function(t){return _.contains(e,t.id)}),o=_.find(n,function(e){return _.contains(t,e.id)});return!a||!!o&&a.version!==o.version},CopyHelper.prototype.calculateCopyInfo=function(e,t,n,i,a,o,r,s,c,p){var l=this,f=function(e,t,i){return e.models&&e.models[t]?e.models[t]:e.modelManifests&&e.modelManifests[t]?void fileUtility.readPossiblyGzippedFile(path.join(n.dataSetPath,e.modelManifests[t]),function(e,t){try{var n=JSON.parse(t.toString("utf8"))}catch(e){var a=e}i(e||a,n)}):[]},u=function(e,t,n,i,a,o,r){async.mapSeries(e,function(e,r){manifestUtilities.readManifest(fileUtility,e,function(s,c){s?(console.log(s),r(new Error("missing manifest"))):copyProcess.create(c,_.where(t,{dataset:e}),n,[],i,a,[],o,f,function(t,n){r(t,{dataSetName:e,process:n,manifest:c})})})},function(e,t){r(e,t)})},d=function(e,t,n){var i=[],a=[],o=_.pluck(t,"manifest"),r=function(e,t){var n=_.mapObject(_.object(t,[]),function(){return null});return _.each(e,function(e){_.each(e.files,function(e){null===n[e.filepath]&&(n[e.filepath]=e)})}),_.values(n)};if(_.each(n,function(e){i=_.union(i,e.process.getSortedFilepathsToHave())}),_.each(t,function(e){a=_.union(a,e.process.getSortedFilepathsToHave())}),l._app.debug("I have these files: "+JSON.stringify(a)),l._app.debug("I want to have these files: "+JSON.stringify(i)),!e)var s=r(o,_.intersection(i,a)),c=_.reduce(s,function(e,t){return e+t.sizeInKB},0);var p=r(o,_.difference(a,i)),f=_.reduce(p,function(e,t){return e+t.sizeInKB},0);return{filesToKeepInfo:{files:s||[],sizeInKB:c||0},filesToDeleteInfo:{files:p,sizeInKB:f}}},m=_.union(c,t),v=_.difference(_.union(a,e.languages),o);l._app.debug("I am setup with the following: "+JSON.stringify({datasets:e.datasets,lanaguages:e.languages})),l._app.debug("I am trying to get setup with the following: "+JSON.stringify({datasets:m,languages:v})),async.parallel({previousCopyProcesses:u.bind(void 0,e.datasets,[],e.languages,[],e.models,[]),currentCopyProcesses:u.bind(void 0,m,i,v,o,_.difference(_.union(r,e.models),s),s),datasets:function(t){l._datasetsProvider.getDatasetObjects(_.union(m,e.datasets),function(e,n){t(e,n)})}},function(t,i){if(t)p(t);else{var a=l.determineIfIsDataUpdate(e.datasets,m,i.datasets);l._app.debug("Is this a data update? "+(a?"yes":"no"));var o=d(a,i.previousCopyProcesses,i.currentCopyProcesses);l._app.debug("Here's the information about what files to remove and which to keep: "+JSON.stringify(o));var r=i.currentCopyProcesses;n&&(c?r=_.sortBy(r,function(e){return _.indexOf(c,e.dataSetName)}):(r.sort(function(e,t){return n.dataSetName===t.dataSetName?1:n.dataSetName===e.dataSetName?-1:t.process.getNumberOfFilesToCopy()-e.process.getNumberOfFilesToCopy()}),c=_.map(r,function(e){return e.dataSetName})));var s=_.pluck(o.filesToKeepInfo.files,"filepath").sort();_.first(r).process=_.first(r).process.removeFilesToCopy(s),_.each(r,function(e,t){var n=e.process.getSortedFilepathsToHave();n=n.concat(s).sort(),_.each(_.rest(r,t+1),function(e){e.process=e.process.removeFilesToCopy(n)})});var f={};_.each(r,function(e){f[e.dataSetName]=e.process});var u=_.reduce(_.values(f),function(e,t){var n=t.summarize();return e+n.remainingSizeInKb},0),v=_.reduce(_.values(f),function(e,t){var n=t.summarize();return e+n.remainingSizeInKb+n.partialProgressSizeInKb},0);p(void 0,{copyProcesses:f,sizeInKB:u,originalSizeInKB:v,datasetPriorityOrder:c,filesToKeepInfo:o.filesToKeepInfo,filesToDeleteInfo:o.filesToDeleteInfo,isDataUpdate:a})}})},CopyHelper.prototype.copyFromDataSet=function(e,t,n,i,a,o,r){var s=this,c={startTime:(new Date).getTime(),lastTime:(new Date).getTime(),copyTime:0,databaseTime:0,indexTime:0},p=_.throttle(function(){s._app.info("Time Spent Copying: ",c.copyTime),s._app.info("Time Spent In Database Operations: ",c.databaseTime);var e=(new Date).getTime()-c.startTime;s._app.info("Total Time: ",e),s._app.info(Math.floor(c.copyTime/e*100)+"% Copying, "+Math.floor(c.databaseTime/e*100)+"% Database, "+Math.floor(c.indexTime/e*100)+"% Indexing.")},9e5,{trailing:!1}),l=0,f=0,u=new Date,d=0,m=!1,v=function(){m=!0};s.once("cancel",v);var g=0,h=function(e,t){g+=e.sizeInKB,s._app.warn("Detected a missing file: ",e,t)},y=function(e,t,n,i){s._dbHelper.addCompletedOperation({dataset:e,op:t},n.index,n.sizeInKB,function(e){i(e)})},T=function(e,t,n){var i=function(e,t){_.delay(function(){fs.exists(e,function(e){t(void 0,e)})},1e3)};async.parallel({dataSetAvailable:i.bind(void 0,e),destinationAvailable:i.bind(void 0,t)},function(e,t){n(e,t)})},S=function(){var e=i-(n+l),t=new Date,a=(l-g)/((t.getTime()-u.getTime())/1e3),o=.005,r=a*o+d*(1-o);if(d=r,l-g>1e4)var c=e/r;s.sendCopyProgress(n+l,i,c)};a.copyFromDataSet(function(n,i,a){f=l;var o=s._dataPathsClient.getDataSetsRoot(),r=function(t){T(e,o,function(e,n){return e?void a(e):void(n.destinationAvailable?n.dataSetAvailable?(h(i,t),a(new Error("File is missing: "+i))):(s._app.info("Data Set became unavailable when trying to copy this file: ",i,t),a(new Error("Data Set No Longer Available."))):a(new Error("Destination Is No Longer Available.")))})};switch(i.type){case"static":var u=path.normalize(i.filepath);if("Data"===u||"Data\\"===u)return s._app.info('Ignoring instructions to copy the entire "Data" directory'),void a();var d=new Date,v=setTimeout(function t(){var n=(new Date-d)/1e3;s._app.info("This file is taking a long time to copy. ",n," seconds so far. ",i),v=setTimeout(t,6e4),n>60&&fs.stat(path.join(e,i.filepath),function(e,t){e?s._app.info("Error retrieving stats for slow file! ",e):s._app.info("Able to access stats for slow file! ",t)})},5e3);c.lastTime=(new Date).getTime(),copyOps.copyStaticData(e,o,i.filepath,function(e,t){m&&e.cancel(),l=f+i.sizeInKB*t,s._dbHelper.updateCurrentCompletedSize(i.sizeInKB*t),S()},function(e,o){clearTimeout(v);var s=(new Date).getTime();c.copyTime=c.copyTime+s-c.lastTime,c.lastTime=s,e?r(e):"finished"===o?y(t,n,i,function(e){var t=(new Date).getTime();c.databaseTime=c.databaseTime+t-c.lastTime,c.lastTime=t,p(),a(e)}):a()});break;case"CompressedSearchIndex":s._app.info("Merging SOLR indexes",e,i),c.lastTime=(new Date).getTime(),s._solrClient.mergeCompressedIndex(path.join(e,i.filepath),i.indexType,function(e){l=f+e*i.sizeInKB,S()},function(e){var o=(new Date).getTime();c.indexTime=c.indexTime+o-c.lastTime,c.lastTime=o,e?(s._app.error("Error merging compressed SOLR indexes: ",{error:e,fileInfo:i}),r(e)):(s._app.info("Merged compressed SOLR indexes",i),y(t,n,i,function(e){var t=(new Date).getTime();c.databaseTime=c.databaseTime+t-c.lastTime,c.lastTime=t,p(),a(e)}))});break;case"SearchIndex":s._app.info("Merging SOLR indexes",e,i),c.lastTime=(new Date).getTime(),s._solrClient.mergeIndex(path.join(e,i.filepath),i.indexType,!1,void 0,function(e){l=f+e*i.sizeInKB,S()},function(e){var o=(new Date).getTime();c.indexTime=c.indexTime+o-c.lastTime,c.lastTime=o,e?(s._app.error("An error occurred while merging SOLR indexes: ",{error:e,fileInfo:i}),r(e)):(s._app.info("Successfully merged SOLR indexes"),y(t,n,i,function(e){var t=(new Date).getTime();c.databaseTime=c.databaseTime+t-c.lastTime,c.lastTime=t,p(),a(e)}))});break;default:s._app.warn("Detected a file type that we don't know how to handle.",i),a(void 0)}},function(e,t,n,i){return!m&&(l=f+n.sizeInKB,S(),!0)},function(e,t){s.removeListener("cancel",v),"cancel"===t?o(n+l):r(e,n+l)})},module.exports=CopyHelper;