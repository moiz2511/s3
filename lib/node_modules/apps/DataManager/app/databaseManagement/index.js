"use strict";var _=require("underscore"),async=require("async"),uuid=require("uuid-v4"),dbHelperApp=require("./dbHelper.js"),syncManagerApp=require("./syncManagement"),copyManagerApp=require("./copyManagement"),dataProfiles=require("./dataProfiles"),RevisionIdManager=require("./revisionIdManager.js"),SystemUpdateProvider=require("../dataProviders/SystemUpdateProvider.js"),UsersDataProvider=require("../dataProviders/UsersDataProvider.js"),BoxDataProvider=require("../dataProviders/BoxDataProvider.js"),JobsDataProvider=require("../dataProviders/JobsDataProvider.js"),ActivityProvider=require("../dataProviders/ActivityProvider.js"),ControllerDataProvider=require("../dataProviders/ControllerDataProvider.js"),PayloadProcessorSA5_ini=require("iniFiles/PayloadProcessorSA5.js"),path=require("path"),util=require("util"),events=require("events"),DatabaseManager=function(e,n,t,a,o,i,r,c,s,u,d,l){var y=this;y._app=e,events.EventEmitter.call(y);var p=new RevisionIdManager(e),f=new SystemUpdateProvider(e,n,c),v=new UsersDataProvider(e,y,i),g=new JobsDataProvider(e,y,n,i),S=new ActivityProvider(e,y,n,i),D=new ControllerDataProvider(e,n,y),M=dataProfiles.getDataProfiles(e,n,y,a,r,f,p,v,g,S,D,i,s),P=_.map(M,function(e){return e.getType()});y._dataProfiles=_.object(P,M),y._dbHelper=new dbHelperApp(e,n),y._oneManager=t,y._dataPathsClient=u;var h=function(e){var n="";return _.times(e,function(){n+="!"}),n},m=function(e,t){var a=h(1572864);async.eachSeries(e,function(e,t){var o="junkData";n.collection(e).remove({id:o},function(i){return i?void t(i):void n.collection(e).insert({id:o,data:a},function(a){return a?void t(a):void n.collection(e).remove({id:o},function(e){t(e)})})})},function(e){t(e)})},b=function(e){var t="Database Stats:\n";n.collections(function(a,o){async.eachSeries(o,function(e,n){e.stats({scale:1024},function(e,a){t+="Collection Name: "+a.ns+", Size: "+a.size+"KB, Storage Size: "+a.storageSize+"KB\n",n()})},function(a){n.stats({scale:1048576},function(n,a){t+="Overall Stats - Data Size: "+a.dataSize+"MB, Storage Size: "+a.storageSize+"MB, File Size: "+a.fileSize+"MB",y._app.info(t),e()})})})};async.series([function(a){y._copyManager=new copyManagerApp(e,t,n,y,i,r,u,s,a)},function(l){y._syncManager=new syncManagerApp(e,n,M,y,y._copyManager,t,a,i,o,c,r,u,s,d,l),y._syncManager.on("fullSyncStarted",function(e){y.emit("fullSyncStarted",e)}),y._syncManager.on("fullSyncStartFailed",function(e){y.emit("fullSyncStartFailed",e)}),y._syncManager.on("fullSyncSessionStarted",function(e){y.emit("fullSyncSessionStarted",e)}),y._syncManager.on("fullSyncStartSessionFailed",function(e){y.emit("fullSyncStartSessionFailed",e)}),y._syncManager.on("fullSyncFinished",function(e){y.emit("fullSyncFinished",e)}),y._syncManager.on("fullSyncError",function(e,n){y.emit("fullSyncError",e,n)}),y._syncManager.on("quickSyncStarted",function(e){y.emit("quickSyncStarted",e)}),y._syncManager.on("quickSyncStartFailed",function(e){y.emit("quickSyncStartFailed",e)}),y._syncManager.on("quickSyncFinished",function(e){y.emit("quickSyncFinished",e)}),y._syncManager.on("quickSyncError",function(e,n){y.emit("quickSyncError",e,n)}),y._oneManager.onChangeDataLocation(function(n){var t=n.path;u.changeDatasetLocation(t,function(n){return n?void e.error("Error setting new public data root location",n):void u.setTarAndIndexDirectoryLocations([u.getDataSetsPath()],function(n){n&&e.error("Error setting new tar locations",n)})})})},function(e){n.collection("Counter").findOne({_id:"Counter"},function(t,a){return t||a?void e(t):void n.collection("Counter").insert({_id:"Counter",count:0},e)})},function(t){async.each(M,function(t,a){var o=t.getCollection(),i=function(t){return o?void n.collection(o).ensureIndex({id:!0},{unique:!0,dropDups:!0},function(n){n&&e.error("Ensuring index for "+o+" collection failed."),t(n)}):void t()},r=function(a){return o?void n.collection(o).ensureIndex({localId:!0},{unique:!0,dropDups:!0},function(n){n&&e.error("Ensuring index for "+t.getCollection()+" collection failed."),a(n)}):void a()};async.series([i,r],function(e){a(e)})},function(e){t(e)})},function(e){n.collection("DataCopy").remove({state:null},function(t){n.collection("Sessions").remove({syncType:null},function(n){e()})})},function(t){n.collection("Payloads").find().toArray(function(a,o){var i=PayloadProcessorSA5_ini(e),r=i&&i.Files&&i.Files.PayloadFolderSN||"",c=_.map(o,function(e){return{_id:e.payloadFileName,payloadFileName:e.payloadFileName,addedBy:e.addedBy,isSupportPayload:e.isSupport,fileList:e.fileList||[path.join(r,e.payloadFileName)]}});n.collection("PayloadInfo").insert(c,function(e){n.collection("Payloads").drop(function(e){t()})})})},function(e){y._app.info("Forcing mongo to allocate space for collections..."),m(["DataCopy","QuickSyncUpdates","Sessions"],function(n){y._app.info("Finished allocating space for collections"),n&&y._app.error("Failed to allocate all space",n),b(e)})}],function(e){l(e)})};util.inherits(DatabaseManager,events.EventEmitter),DatabaseManager.prototype.isInCopyProcess=function(){return this._copyManager.isInCopyProcess()},DatabaseManager.prototype.revertPendingCopy=function(e){this._copyManager.revertPendingCopy(e)},DatabaseManager.prototype.startQuickSync=function(e,n){_.isFunction(e)&&(n=e,e=void 0),this._syncManager.startQuickSync(e,n)},DatabaseManager.prototype.startFullSync=function(e){this._syncManager.startFullSync(e)},DatabaseManager.prototype.startCustomFullSync=function(e,n,t){var a=this;a._syncManager.startCustomFullSync(e,n,t)},DatabaseManager.prototype.queueCustomFullSync=function(e,n,t,a){var o=this;o._syncManager.queueCustomFullSync(e,n,t,a)},DatabaseManager.prototype.resumeSyncs=function(e){this._syncManager.resumeSyncs(e)},DatabaseManager.prototype.getSyncStatus=function(){return this._syncManager.getSyncStatus()},DatabaseManager.prototype.isSyncQueueEmpty=function(e){this._syncManager.isSyncQueueEmpty(e)},DatabaseManager.prototype.startCopyProcess=function(){this._copyManager.startDataCopy()},DatabaseManager.prototype.stopCopyProcess=function(e){this._copyManager.stopDataCopy(e)},DatabaseManager.prototype.changeDataLocation=function(){var e=this;e._oneManager.sendChangeDataLocationRequest(e._dataPathsClient.getPublicDataRoot())},DatabaseManager.prototype.addData=function(e,n,t){var a=this._dbHelper,o=this._dataProfiles[e],i=this,r=uuid();return _.isUndefined(o)?void t(new Error("Unknown data type: ",e)):(n.localId=r,void o.validateNewData(n,function(n,o){return n?void t(n):void a.addData(e,r,o,function(n){return n?void t(n):void i.getDataById(e,r,function(e,n){t(e,n)})})}))},DatabaseManager.prototype.undoAdd=function(e,n){var t=this._dbHelper;t.undoAdd({localId:e},function(e){n(e)})},DatabaseManager.prototype.deleteData=function(e,n,t){var a=this._dbHelper,o=this._dataProfiles[e];return _.isUndefined(o)?void t(new Error("Unknown data type: ",e)):void a.getAvailableIds(o.getCollection(),n,function(i,r){return i?void t(i):void a.deleteData(e,r.localId,r.id,function(e){return e?void t(e):void(_.isFunction(o.deleteRequested)?o.deleteRequested(n,t):t())})})},DatabaseManager.prototype.updateData=function(e,n,t,a){var o=this._dbHelper,i=this._dataProfiles[e],r=this;return _.isUndefined(i)?void a(new Error("Unknown data type: ",e)):void o.getAvailableIds(i.getCollection(),n,function(c,s){return c||!s?void a(c):void i.validateUpdate(t,s.localId,function(t,i){return t?void a(t):void o.updateData(e,s.localId,s.id,i,function(t){return t?void a(t):void r.getDataById(e,n,function(e,n){a(e,n)})})})})},DatabaseManager.prototype.getDataById=function(e,n,t){var a=this._dbHelper,o=this._dataProfiles[e];return _.isUndefined(o)?void t(new Error("Unknown data type: ",e)):void a.getDataById(o.getCollection(),e,n,function(e,n,a){return e?void t(e):n||0!==a.length?void o.compactData(n,a,t):void t()})},DatabaseManager.prototype.getDataByIds=function(e,n,t){var a=this;async.map(n,function(n,t){a.getDataById(e,n,t)},function(e,n){t(e,_.compact(n))})},DatabaseManager.prototype.getDataByQuery=function(e,n,t){var a=this._dbHelper,o=this._dataProfiles[e];return _.isUndefined(o)?void t(new Error("Unknown data type.")):void a.getAllData(o.getCollection(),e,function(e,a,i){if(e)return void t(e);if(0===i.length)o.applyQuery(a,n,function(e,n){t(e,n)});else{i=_.groupBy(i,"localId");var r=_.keys(i),c=[];async.each(r,function(e,n){var t=_.findWhere(a,{localId:e});a=_.without(a,t),o.compactData(t,i[e],function(e,t){return e||!t?void n(e):(c.push(t),void n())})},function(e){return e?void t(e):(c=_.union(c,a),void o.applyQuery(c,n,function(e,n){t(e,n)}))})}})},module.exports=DatabaseManager;