"use strict";var async=require("async"),_=require("underscore"),fs=require("fs"),path=require("path"),environment=require("Environment"),utility=require("FileUtility"),errorUtility=require("./../errorUtility.js"),processDataFileUpdates=function(e,t,n,a,i,o,r,s,c,u,d,p){if(u=_.filter(u,function(e){return e.completed===!1}),0===u.length)return void _.defer(p);var l={client:c,hasUpdates:!1,updated:{solutions:!1,manuals:!1}};a.getSetupState(function(f){var y=!a.isSetup(f),v=new Date,D=0,h=0,m=_.filter(u,function(e){return"dataAdd"===e.type&&e.completed===!1}).length,g=function(a,r){switch(a.type){case"dataDelete":processDataFileDelete(e,t,c,o,a,function(e){return e?void r(e):void t.flagUpdateComplete(a._id,e,function(e){r(e)})});break;case"dataAdd":processFullSyncUpdate(e,t,l,i,o,n,a,d,function(e){h=sendSyncProgressUpdate(s,D+e,m,y,v,h)},function(e){return e&&(e=errorUtility.reduceFullSyncFileError(a,e)),e&&"informServerError"!==e.name?void r(e):void t.flagUpdateComplete(a._id,e&&e.descriptor,function(e){e||(D+=1,h=sendSyncProgressUpdate(s,D,m,y,v,h)),r(e)})});break;default:r()}},S=function(t){var n=[];return l.updated.solutions&&n.push("Solutions"),l.updated.manuals&&n.push("Manuals"),_.isEmpty(n)?void t():void async.eachSeries(n,function(t,n){e.info("Requesting reload core for: "+t),c.reloadCore(t,function(a){a&&(e.info("Core "+t+" failed to reload. Try again later and continue full sync now."),e.error(a),_.delay(function(){e.info("Solr core "+t+" needs to be reloaded. Reloading it now."),c.reloadCore(t,function(n){n&&(e.info("Core "+t+" failed to reload. No more attempts to reload it."),e.error(n))})},2e3).unref()),n()})},function(){t()})},x=_.partition(u,function(e){return e&&e.updateData&&"xvdsData"!==e.updateData.type}),P=function(e,t){async.eachSeries(e,function(e,t){g(e,t)},t)};h=sendSyncProgressUpdate(s,0,m,y,v,h),async.series([function(e){P(x[0],function(t){return l.hasUpdates?void S(function(){e(t)}):void e(t)})},function(t){var n=function(e,t,a){r.useResources(e,"fullsync",function(i){i?(t&&t(),r.once("releasedResources",function(t){_.isEmpty(_.intersection(e,t))||n(e,void 0,a)})):a()})};_.isEmpty(x[1])?_.defer(t):n(["xvds"],function(){e.info("Diagnostics is connected while attempting to apply xVDS updates. Pausing..."),_sendSyncPaused(s,!0)},function(){e.info("Applying xVDS updates"),_sendSyncPaused(s,!1),P(x[1],function(){r.releaseResources(["xvds"],"fullsync"),t.apply(this,arguments)})})}],function(e){e||sendSyncProgressUpdate(s,1,1,y,v,h),p(e)})})},_sendSyncPaused=function(e,t){e.sendSyncPausedMessage(t)},sendSyncProgressUpdate=function(e,t,n,a,i,o){var r=new Date,s=t/((r.getTime()-i.getTime())/1e3),c=.01*s+.99*o,u=n-t;return sendMessageToONE(e,t,n,a,c?u/c:void 0),c},sendMessageToONE=_.throttle(function(e,t,n,a,i){e.sendSyncProgress(t,n,a,i)},500,{trailing:!1}),processDataFileDelete=function(e,t,n,a,i,o){var r=i.updateData;switch(r.type){case"manualsData":case"dtacData":utility.deleteDirectoryOrFile(path.join(a.getDataPath(),r.path),function(e){o(e)});break;case"indexData":n.deleteIndex(r.path,"Manuals",function(e){o(e)});break;case"diagnosticsData":case"calData":case"readingsData":break;case"xvdsData":break;default:o(new Error("Unknown File Type: "+r.type))}},processFullSyncUpdate=function(e,t,n,a,i,o,r,s,c,u){var d=function(r,s){var u=3;_downloadFileWithRetry(e,o,r,c,u,function(e,o){return e?void s(e):void processFullSyncFile(t,n,a,i,r,o,function(e){utility.clearDirectory(environment.temporaryDataSyncPath,function(t){s(e||t)})})})},p=function(t,n,a){var i=_.isUndefined(t.versions)||_.contains(t.versions,n);i?d(t,a):(e.debug("Current version is "+n+" but update '"+t.path+"'of type '"+t.type+"' is intended for one of these  versions: "+JSON.stringify(t.versions)+". Skipping update."),_.defer(function(){a()}))};switch(r.updateData.type){case"calData":case"xvdsData":p(r.updateData,s,u);break;default:d(r.updateData,u)}},_downloadFileWithRetry=function(e,t,n,a,i,o){var r=function(s){t.downloadFullSyncFile(n.baseURL,n.path,a,function(t,a){t&&s<=i?(e.error((t.code||t.statusCode)+" Error on attempt number "+s+" for "+n.baseURL+n.path),setTimeout(function(){var e=s+1;r(e)},250)):t?o(t):o(void 0,a)})};r(1)},processFullSyncFile=function(e,t,n,a,i,o,r){r=_.once(r);var s=function(e,n,a,i){fs.stat(e,function(o,r){return o?("ENOENT"==o.code&&(o.info="No Indexes"),void i(o)):r.isDirectory()?void t.client.mergePartialIndex(e,n,a,function(e){e&&"Merge Error"!==e.info||(t.hasUpdates=!0,t.updated[d.toLowerCase()]=!0),i(e)}):(o=new Error("Path "+e+" is not a folder. Expecting a folder to index "+a),o.info="No Indexes",void i(o))})};switch(i.type){case"manualsData":case"dtacData":var c,u,d;if("manualsData"===i.type){var p=i.path.split("/");c=p.splice(-2,1),u="Manuals.zip",d="Manuals"}else"dtacData"===i.type&&(u="DTAC.zip",d="Solutions");utility.extractZipToLocation(o,environment.temporaryDataSyncPath,function(e){return e?void r(e):void async.series([function(e){fs.exists(path.join(environment.temporaryDataSyncPath,u),function(t){return t?void utility.extractZipToLocation(path.join(environment.temporaryDataSyncPath,u),a.getDataPath(),function(t){t&&"ENOENT"===t.code&&(t.info="destinationLocationNotPresent"),e(t)}):void e()})},function(e){fs.exists(path.join(environment.temporaryDataSyncPath,"indexes.zip"),function(t){if(!t)return void e();u="indexes.zip";var n=path.join(environment.temporaryDataSyncPath,"Indexes");utility.extractZipToLocation(path.join(environment.temporaryDataSyncPath,u),n,function(t){t?(t&&"ENOENT"===t.code&&(t.info="destinationLocationNotPresent"),e(t)):"dtacData"===i.type?fs.readdir(n,function(t,a){if(t||!a)return void e(t);var i,o=a.length,r=function(p){var l=a[p];c=l;var f=path.join(n,l);fs.statSync(f).isDirectory()?utility.extractZipToLocation(path.join(f,u),path.join(f,"Indexes"),function(t){t?(i=t,p++,p<o?r(p):e(i)):s(path.join(f,"Indexes"),d,c,function(t){t&&(i=t),p++,p<o?r(p):e(i)})}):(i=t,p++,p<o?r(p):e(i))};r(0)}):s(path.join(n),d,c,function(t){e(t)})})})}],function(e){r(e)})});break;case"pinData":utility.getFileBuffersFromZip(o,[],function(e,t){e&&r(e);var a=_.chain(t).map(function(e){try{return JSON.parse(e)}catch(e){return}});if(a.some(function(e){return void 0===e}).value())return void r(new Error("Invalid pinMapJSON"));var i=a.reduce(function(e,t){return _.extend(e,t)},{});n.insertPinModelMapping(i.value(),r)});break;case"xvdsData":var l=function(){utility.extractZipToLocation(o,path.dirname(environment.xvdsInstallationDirectory),function(e){return e?void r(e):void r()})};l();break;case"calData":utility.extractZipToLocation(o,path.dirname(environment.SACalDirectory),function(e){r(e)});break;case"diagnosticsData":utility.extractZipToLocation(o,path.dirname(a.getDiagnosticsDataPath()),function(e){r(e)});break;case"readingsData":utility.extractZipToLocation(o,path.dirname(environment.readingsDataPath),function(e){r(e)});break;case"training":utility.extractZipToLocation(o,environment.trainingDataPath,function(e){r(e)});break;default:r(new Error("Unknown Full Sync File Type"))}};exports.processDataFileUpdates=processDataFileUpdates;