"use strict";var util=require("util"),utility=require("FileUtility"),environment=require("Environment"),events=require("events"),async=require("async"),_=require("underscore"),prepareUpdatesHelper=require("./prepareUpdatesHelper.js"),processUpdatesHelper=require("./processUpdatesHelper.js"),syncSessions=require("../syncSessions"),syncSequences=require("../syncSequences"),syncOptionTypes=require("../syncOptions"),syncErrors=require("../syncErrors"),_getSyncsForCustomSyncType=function(e,n){return _.filter(n,function(n){return _.isEqual(syncOptionTypes.CustomFullSyncOptions.fromJSON(n.data),e)})},_getCustomSyncOptionsFromPendingSyncs=function(e){var n=_.pluck(e,"data");return syncOptionTypes.CustomFullSyncOptions.fromJSON(_.first(_.compact(n)))},FullSyncManager=function(e,n,r,t,s,i,o,a,c,l,u,d,p,y){var S=this;S._app=e,S._syncManager=n,S._serverHelper=r,S._dbHelper=t,S._pinDataProvider=s,S._modelsDataProvider=i,S._boxDataProvider=o,S._systemUpdateProvider=a,S._oneManager=c,S._connectorClient=l,S._registrationClient=u,S._solrClient=p,S._dataPathsClient=d,S._exclusiveResourceClient=y,S._isSyncRunning=!1,S._syncNumber=1,events.EventEmitter.call(S)};util.inherits(FullSyncManager,events.EventEmitter);var getBoundFunctions=function(e,n,r){return{beginSession:beginSession.bind(void 0,e,n,r),beginPreRegistrationFullSyncSession:syncSessions.beginPreRegistrationFullSyncSession.bind(void 0,e,n,r),clearDataUpdatesCollection:clearDataUpdatesCollection.bind(void 0,e),collectSyncErrors:collectSyncErrors.bind(void 0,e),saveSyncErrors:saveSyncErrors.bind(void 0,e),clearSyncErrors:clearSyncErrors.bind(void 0,e),completeSession:completeSession.bind(void 0,e),createSession:syncSessions.createFullSyncSession.bind(void 0,e,n,r),endSession:endSession.bind(void 0,e),flagAllModelsHasData:flagAllModelsHasData.bind(void 0,e),getDataFileUpdates:getDataFileUpdates.bind(void 0,e),getDataFileUpdatesForSetup:getDataFileUpdatesForSetup.bind(void 0,e),processDataFileUpdates:processDataFileUpdates.bind(void 0,e),removeSession:removeSession.bind(void 0,e)}};FullSyncManager.prototype.startSync=function(e,n){var r=this,t=r._app,s=e&&!e.canQueue;return n||(n=e,e=void 0),n=n||_.noop,r._connectorClient.isOnline()===!1?(t.info("Full Sync Not Started Due To Lack Of Internet Connectivity."),s?void n(new Error("Custom full sync can't be started while offline.")):(n(void 0,r._syncNumber+1),void r.emit("fullSyncStartFailed",r._syncNumber+1))):r._isSyncRunning===!0?(t.info("Full Sync Already Running. New Full Sync Wasn't Started."),s?void n(new Error("Custom full sync can't be started while another sync is running.")):(n(void 0,r._syncNumber+1),void r.emit("fullSyncStartFailed",r._syncNumber+1))):(r._isSyncRunning=!0,void r._dbHelper.getPendingSyncs(function(i,o){var a=_getSyncsForCustomSyncType(e,o||[]);r._dbHelper.getSyncSession(function(i,o){if(i)return t.error("FullSync: Database retrieve error: ",i),r._isSyncRunning=!1,void n(i);var c=function(){r.emit("fullSyncStarted",r._syncNumber),t.info("Successful full sync start, sync number: ",r._syncNumber)},l=function(){c(),r.emit("fullSyncStartFailed",r._syncNumber+1)};if(o){if(s)return void n(new Error("Current full sync must complete before initiating a custom full sync."));n(void 0,r._syncNumber+1),l()}else n(void 0,r._syncNumber),c();var u=getBoundFunctions(r,e,a);r._registrationClient.getRegistrationState(function(e){var n=r._registrationClient.isRegistered(e),s=syncSequences.getFunctions(u,syncSequences.fullSyncSequences,n),a=syncSequences.getFirstStep(syncSequences.fullSyncCriteria,o,n);if(i)return void(r._isSyncRunning=!1);var c=a.stepName;t.info(a.stepDescription);var l=_.findWhere(s,{name:c}),d=_.indexOf(s,l);if(d===-1)return void(r._isSyncRunning=!1);var p=_.chain(s).rest(d).map(function(e){return e.function}).value();o&&(p[0]=p[0].bind(void 0,o)),async.waterfall(p,function(e,n){var s=function(e,n){var t=-1;"Box Unauthorized"===e.message?t=-2:"destinationLocationNotPresent"===e.info&&(t=-3),r._registrationClient.getSetupState(function(e){r._registrationClient.isSetupInProgressSyncing(e)?r._registrationClient.setSetupState(r._registrationClient.getSetupInProgressSyncingErrorState(),t,function(e){n(e)}):n()})};if(e&&(r._oneManager.sendSyncErrorMessage(e.info),r.emit("fullSyncError",r._syncNumber,e),t.error("Error that terminated the sync session:",e)),e&&"404"===e.message){var i=function(e){r._dbHelper.getSyncSession(function(n,s){return n||!s?void e(n,null):void r._dbHelper.setSessionFailed(s.syncSessionId,function(n,r){n&&t.error("FullSync: Database update error, ",n),e(n,r)})})};async.waterfall([function(n){s(e,n)},i,clearDataUpdatesCollection.bind(void 0,r),function(e,n){clearTemporaryDataSyncDirectory(function(r){n(r,e)})},removeSession.bind(void 0,r)],function(){r._isSyncRunning=!1})}else e?async.waterfall([function(n){s(e,n)},clearTemporaryDataSyncDirectory],function(e){e&&t.error(e),r._isSyncRunning=!1}):clearTemporaryDataSyncDirectory(function(e){e&&t.error(e),r._isSyncRunning=!1,t.info("Sync Session Complete."),n.isCustom||r._boxDataProvider.setLastFullSyncTime(new Date),r._registrationClient.getSetupState(function(e){r._registrationClient.isSetup(e)&&r._oneManager.sendSyncCompleteMessage()}),r.emit("fullSyncFinished",r._syncNumber),r._syncNumber=r._syncNumber+1,r._syncManager.resumeSyncs()})})})})}))},FullSyncManager.prototype.resumeSync=function(e){var n=this,r=n._app;_.isFunction(e)||(e=_.noop),n._dbHelper.getSyncSession(function(t,s){return t?(r.error("FullSyncManager: Retrieving sync session failed, ",t),void e(t)):n._isSyncRunning?void e():void(s?n._syncManager.runFullSync(syncOptionTypes.CustomFullSyncOptions.fromJSON(s.customSyncOptions),!1,function(n,r){e(n)}):n._dbHelper.getPendingSyncs(function(t,s){if(t)r.error("FullSyncManager: Retrieving requested syncs failed, ",t),e(t);else if(n._isSyncRunning)e();else if(_.isEmpty(s))e();else{var i=_getCustomSyncOptionsFromPendingSyncs(s);n._syncManager.runFullSync(i,!1,function(n,r){e(n)})}}))})},FullSyncManager.prototype.getCurrentSyncNumber=function(){var e=this;return e._syncNumber},FullSyncManager.prototype.getSyncStatus=function(){var e=this;return e._isSyncRunning},FullSyncManager.prototype.isSyncQueueEmpty=function(e){var n=this;return n._isSyncRunning?void e(void 0,!1):void n._dbHelper.getSyncSession(function(r,t){t||r?e(r,!1):n._dbHelper.getPendingSyncs(function(n,r){e(n,_.isEmpty(r))})})};var beginSession=function(e,n,r,t){var s=e._app;e._serverHelper.startSession("full",n,function(n,r,i){return n?(s.error("FullSync: serverHelper.startSession post to server error",n),t(n),void e.emit("fullSyncStartSessionFailed",e._syncNumber)):201!==r.statusCode?(n=new Error(r.statusCode),s.error("FullSync: beginSession bad response: ",r.statusCode,i),t(n),void e.emit("fullSyncStartSessionFailed",e._syncNumber)):(e.emit("fullSyncSessionStarted",e._syncNumber),s.info("Start sync session server response:",i),void t(void 0,i.syncSessionId))})},getDataFileUpdates=function(e,n,r){var t=e._app;e._registrationClient.getSetupState(function(s){e._oneManager.sendSyncProgress(0,1,!e._registrationClient.isSetup(s),void 0,!e._registrationClient.isSetup(s)),e._serverHelper.getDataFileUpdates(n.syncSessionId,n.syncType,function(s,i){if(s)return void r(s);if(200!==i.statusCode)return s=new Error(i.statusCode),t.error("FullSync: getDataFileUpdates bad response: ",i.statusCode),void r(s);var o=i.body;prepareUpdatesHelper.prepareDataFileUpdates(e._dbHelper,o,function(s,i){return s?void r(s):(t.info("Total Number of Full Sync Updates: ",i.length),void e._dbHelper.insertUpdates(i,function(t){return t?void r(t):void e._dbHelper.flagDataFileUpdatesRetrieved(n.syncSessionId,function(e,n){r(e,n)})}))})})})},getDataFileUpdatesForSetup=function(e,n,r){var t=e._app;e._registrationClient.getSetupState(function(s){e._oneManager.sendSyncProgress(0,1,!e._registrationClient.isSetup(s),void 0,!e._registrationClient.isSetup(s)),async.auto({getBoxProperties:function(n){e._boxDataProvider.getBoxInformation(function(e,r){n(e,{datasets:r.savedDataProperties.datasets,languages:r.savedDataProperties.languages,locations:r.savedDataProperties.locations,incrementalUpdateModels:r.savedUpdateProfile.models})})},getSoftwareVersion:function(n){e._systemUpdateProvider.getInstalledSoftwareVersion(function(e,r){n(void 0,r)})},getIncrementalUpdates:["getBoxProperties","getSoftwareVersion",function(n,r){e._serverHelper.getDataFileUpdatesForSetup(r.getBoxProperties.incrementalUpdateModels,r.getBoxProperties.datasets,r.getBoxProperties.locations,r.getBoxProperties.languages,r.getSoftwareVersion,function(e,r){n(e,r)})}]},function(s,i){if(s)return void r(s);var o=i&&i.getIncrementalUpdates,a=o&&o.lastFullSyncTime;prepareUpdatesHelper.prepareDataFileUpdates(e._dbHelper,o,function(s,i){return s?void r(s):(t.info("Number of Full Sync Updates:",i.length),void e._dbHelper.insertUpdates(i,function(t){return t?void r(t):void async.waterfall([function(r){e._dbHelper.flagDataFileUpdatesRetrieved(n.syncSessionId,function(e,n){r(e,n)})},function(n,r){e._dbHelper.setLastFullSyncTime(n.syncSessionId,a,function(e,n){r(e,n)})}],function(e,n){r(e,n)})}))})})})},processDataFileUpdates=function(e,n,r){var t=e._app;async.parallel({updates:function(n){t.debug("Getting full sync updates to process..."),e._dbHelper.retrieveUpdates(function(e,r){e?t.error("An error occurred retrieving full sync updates: ",e):t.debug("Got full sync updates to process:"),n(e,r)})},installedVersion:function(n){t.debug("Getting installed software version for full sync..."),e._systemUpdateProvider.getInstalledSoftwareVersion(function(e,r){e?t.error("An error occured getting the installed application version during full sync:",e):t.debug("Got installed application version for full sync: "+r),n(e,r)})}},function(s,i){s?r(s):processUpdatesHelper.processDataFileUpdates(t,e._dbHelper,e._serverHelper,e._registrationClient,e._pinDataProvider,e._dataPathsClient,e._exclusiveResourceClient,e._oneManager,e._solrClient,i.updates,i.installedVersion,function(t){t?r(t):(e._boxDataProvider.setLastFullSyncTime(n.lastFullSyncTime),r(void 0,n))})})},endSession=function(e,n,r){var t=e._app;t.info("Ending Full Sync Session: ",n.syncSessionId),e._serverHelper.endSession(n.syncSessionId,n.syncErrors,function(e,s,i){return e?(t.error("FullSync: serverHelper.endSession error:",e),void r(e)):200!==s.statusCode?(t.error("FullSync: serverHelper.endSession error: ",s.statusCode,i),e=new Error(s.statusCode),void r(e)):(t.info("Full Sync Session: ",n.syncSessionId," successfully ended."),void r(void 0,n))})},completeSession=function(e,n,r){var t=e._app,s=e._dbHelper;s.setSessionComplete(n.syncSessionId,function(e,n){e&&t.error("FullSync: dbHelper.setSessionComplete error: ",e),r(e,n)})},flagAllModelsHasData=function(e,n,r){var t=e._app;e._modelsDataProvider.flagAllModelsAsHasData(function(e){e&&t.error("FullSync: dbHelper.flagModelsHasData error: ",e),r(e,n)})},clearDataUpdatesCollection=function(e,n,r){var t=e._app;e._dbHelper.clearUpdatesCollection(function(e){e&&t.error("FullSync: dbHelper.clearUpdatesCollection error: ",e),r(e,n)})},removeSession=function(e,n,r){var t=e._app;e._dbHelper.removeSession(function(e){e&&t.error("FullSync: dbHelper.removeSession error: ",e),r(e,n)})},clearTemporaryDataSyncDirectory=function(e){utility.clearDirectory(environment.temporaryDataSyncPath,function(n){e(n)})},clearSyncErrors=syncErrors.clearSyncErrors,collectSyncErrors=syncErrors.collectSyncErrors,saveSyncErrors=syncErrors.saveSyncErrors;module.exports=FullSyncManager;