"use strict";var _=require("underscore"),async=require("async"),DuplicateEntryError=11e3,pendingSyncsDocumentId="PendingSyncsDocument",pendingSyncsCollection="PendingSyncs",sessionsCollection="Sessions",errorUtility=require("ErrorUtility"),Grid=require("mongodb").Grid,ObjectID=require("mongodb").ObjectID,uuid=require("uuid-v4"),DatabaseHelper=function(e,t,n,o){var s=this;switch(s._database=t,s._app=e,s._grid=new Grid(t,sessionsCollection),n){case"full":s._updatesCollection="FullSyncUpdates",s._syncType=n,s._syncsList="pendingFullSyncs";break;case"quick":s._updatesCollection="QuickSyncUpdates",s._syncType=n,s._syncsList="pendingQuickSyncs";break;default:return void o(new Error("Invalid Sync Type."))}t.collection(sessionsCollection).ensureIndex({syncType:!0},{unique:!0,dropDups:!0},function(t){t&&e.error("Ensuring index for "+sessionsCollection+" collection failed."),o(t)})};DatabaseHelper.prototype.getPendingSyncs=function(e){var t=this,n=t._database;n.collection(pendingSyncsCollection).findOne({id:pendingSyncsDocumentId},function(n,o){return n||!o?void e(n):void(o[t._syncType]?t.addPendingSync(function(n){t.getPendingSyncs(e)}):e(void 0,o[t._syncsList]))})},DatabaseHelper.prototype.addPendingSync=function(e,t){t||(t=e,e=void 0);var n=this,o=n._database,s={};s[n._syncType]=!1;var i={},a=uuid(),r={cookie:a,data:e};i[n._syncsList]=r,o.collection(pendingSyncsCollection).update({id:pendingSyncsDocumentId},{$set:s,$push:i},{upsert:!0},function(e){t(e,r)})},DatabaseHelper.prototype.removePendingSyncs=function(e,t){if(_.isEmpty(e))return void _.defer(function(){t()});var n=this,o=n._database,s={};s[n._syncsList]=e,o.collection(pendingSyncsCollection).update({id:pendingSyncsDocumentId},{$pullAll:s},{upsert:!0},function(e){t(e)})},DatabaseHelper.prototype._addServerState=function(e,t){var n=this._grid,o=this;e&&e.serverState?n.get(e.serverState,function(n,s){if(!n&&s)try{var i=s.toString();e.serverState=JSON.parse(i)}catch(t){e.serverState=void 0,o._app.error("Failed to parse server state",t)}else e.serverState=void 0;t(null,e)}):_.defer(function(){t(null,e)})},DatabaseHelper.prototype.getSyncSession=function(e){var t=this,n=t._database;t._grid;n.collection(sessionsCollection).findOne({syncType:t._syncType},{dataFileUpdatesRetrieved:!0,syncSessionId:!0,syncType:!0,sessionChangeIds:!0,serverState:!0,completed:!0,copyManagerNotified:!0,failed:!0,sessionStartTime:!0,updatesPrepared:!0},function(n,o){n?e(n,null):t._addServerState(o,function(t,n){e(t,n)})})},DatabaseHelper.prototype.createNewSyncSession=function(e,t,n){var o=this,s=o._database;s.collection(sessionsCollection).insert({syncSessionId:e,syncType:o._syncType,completed:!1,failed:!1,isCustom:!!t,customSyncOptions:t,sessionStartTime:new Date},function(e,t){n(e,_.first(t))})},DatabaseHelper.prototype._deleteServerState=function(e,t){this._grid.delete(e,function(e){t(e)})},DatabaseHelper.prototype.setServerState=function(e,t,n){var o=this,s=this._database,i=this._grid,a=function(){var a=new ObjectID;s.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{serverState:a}},{new:!0},function(e,s){o._app.debug("Storing server state for sync session");try{var r=JSON.stringify(t);r=new Buffer(r)}catch(e){return o._app.error("Error creating the server state buffer",e),void n(e)}i.put(r,{_id:a},function(e){e?s.serverState=void 0:(s.serverState=t,o._app.debug("Successfully stored server state for sync session")),n(e,s)})})};s.collection(sessionsCollection).findOne({syncSessionId:e},function(e,t){return e?void n(e):void(t.serverState?o._deleteServerState(t.serverState,function(e){a()}):a())})},DatabaseHelper.prototype.setSessionChangeIds=function(e,t,n,o){var s=this,i=this._database;i.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{sessionChangeIds:t,remainingSessionChangeIds:n}},{new:!0},function(e,t){e?o(e):s._addServerState(t,function(e,t){o(e,t)})})},DatabaseHelper.prototype.getStateChangeIds=function(e){var t=this._database;t.collection("StateChanges").find({},{index:!0}).toArray(function(t,n){if(t)return void e(t);var o=_.map(n,function(e){return e.index});e(null,o)})},DatabaseHelper.prototype.getStateChangeIdsAndTypes=function(e){var t=this._database;t.collection("StateChanges").find({},{index:!0,type:!0}).toArray(function(t,n){if(t)return void e(t);var o=_.map(n,function(e){return{id:e.index,type:e.type}});e(null,o)})},DatabaseHelper.prototype.setLastFullSyncTime=function(e,t,n){var o=this;this._database.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{lastFullSyncTime:t}},{new:!0},function(e,t){e?n(e):o._addServerState(t,function(e,t){n(e,t)})})},DatabaseHelper.prototype.setQuickSyncTimestamp=function(e,t,n){var o=this;this._database.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{quickSyncTimestamp:t}},{new:!0},function(e,t){e?n(e):o._addServerState(t,function(e,t){n(e,t)})})},DatabaseHelper.prototype.flagDataFileUpdatesRetrieved=function(e,t){var n=this,o=this._database;o.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{dataFileUpdatesRetrieved:!0}},{new:!0},function(e,o){e?t(e):n._addServerState(o,function(e,n){t(e,n)})})},DatabaseHelper.prototype.insertUpdates=function(e,t){var n=this;if(!_.isArray(e)||0===e.length)return void t();var o=this._database;o.collection("Counter").findAndModify({_id:"Counter"},[],{$inc:{count:e.length}},{new:!0},function(s,i){return s?void t(s):(e=_.map(e,function(t,n){return t.index=i.count-e.length+n+1,t}),void async.eachSeries(e,function(e,t){o.collection(n._updatesCollection).insert(e,function(e){return e&&e.code!=DuplicateEntryError?void t(e):void t()})},function(e){t(e)}))})},DatabaseHelper.prototype.setUpdatesPrepared=function(e,t){var n=this,o=this._database;o.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{updatesPrepared:!0}},{new:!0},function(e,o){e?t(e):n._addServerState(o,function(e,n){t(e,n)})})},DatabaseHelper.prototype.retrieveUpdates=function(e){var t=this,n=t._database;n.collection(t._updatesCollection).find().sort({index:1}).toArray(function(t,n){e(t,n)})},DatabaseHelper.prototype.setSessionComplete=function(e,t){var n=this,o=this._database;o.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{completed:!0}},{new:!0},function(e,o){e?t(e):n._addServerState(o,function(e,n){t(e,n)})})},DatabaseHelper.prototype.setSessionCopyManagerNotified=function(e,t){var n=this,o=this._database;o.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{copyManagerNotified:!0}},{new:!0},function(e,o){e?t(e):n._addServerState(o,function(e,n){t(e,n)})})},DatabaseHelper.prototype.setSessionFailed=function(e,t){var n=this,o=this._database;o.collection(sessionsCollection).findAndModify({syncSessionId:e},[],{$set:{failed:!0}},{new:!0},function(e,o){e?t(e):n._addServerState(o,function(e,n){t(e,n)})})},DatabaseHelper.prototype.clearUpdatesCollection=function(e){var t=this,n=t._database;n.collection(t._updatesCollection).remove({},function(t){e(t)})},DatabaseHelper.prototype.removeSyncedStateChanges=function(e){var t=this,n=t._database;async.waterfall([function(e){n.collection(t._updatesCollection).find({completed:!0},{}).toArray(function(t,n){e(t,n)})},function(e,t){if(e){var o=_.flatten(_.pluck(e,"stateChangeIndexes"));n.collection("StateChanges").remove({index:{$in:o}},function(e){t(e)})}else t()}],function(t){e(t)})},DatabaseHelper.prototype.removeSession=function(e){var t=this,n=t._database;n.collection(sessionsCollection).find({syncType:t._syncType}).toArray(function(o,s){return o?void e(o):0===s.length?void e():(t._app.debug("Deleting server state for sync sessions"),void async.each(s,function(e,n){e.serverState?t._deleteServerState(e.serverState,function(e){n()}):_.defer(function(){n()})},function(o){t._app.debug("Sever state for sync sessions has been deleted"),n.collection(sessionsCollection).remove({syncType:t._syncType},function(t){e(t)})}))})},DatabaseHelper.prototype.getSessionChanges=function(e,t){var n=this._database;e.sessionChangeIds?n.collection("StateChanges").find({index:{$in:e.sessionChangeIds}}).toArray(function(e,n){t(e,n)}):t(null,[])},DatabaseHelper.prototype.updateObject=function(e,t,n){var o=this._database;if(_.isArray(t)){if(0===t.length)return void n();var s=o.collection(e).initializeUnorderedBulkOp();_.each(t,function(e){s.find({localId:e.localId}).upsert().replaceOne(e)}),s.execute(function(e){n(e)})}else o.collection(e).update({localId:t.localId},t,{upsert:!0},function(e){n(e)})},DatabaseHelper.prototype.flagUpdateComplete=function(e,t,n){var o=this,s=o._database;t=errorUtility.encodeErrorObject(t),t&&o._app.error("Error Processing Update: ",t),s.collection(o._updatesCollection).update({_id:e},{$set:{completed:!0,updateError:t}},function(e){n(e)})},DatabaseHelper.prototype.getSyncedObject=function(e,t,n){var o=this._database;o.collection(e).findOne({id:t},function(e,t){n(e,t)})},DatabaseHelper.prototype.deleteObject=function(e,t,n){var o=this._database;_.isArray(t)||(t=[t]),o.collection(e).remove({localId:{$in:t}},function(e){n(e)})},DatabaseHelper.prototype.getSoftwareUpdate=function(e){var t=this._database;t.collection("SystemUpdateInformation").findOne({},function(t,n){t?e(t):e(t,n)})},DatabaseHelper.prototype.hasRtnFileUploadAccess=function(e){var t=this._database;t.collection("Users").find({returnFileUploadAccess:"false"},{_id:!1}).count(function(t,n){t?(app.error("Error while retrieving return file upload access",t),e(!0)):e(n>0?!1:!0)})},DatabaseHelper.prototype.checkCalComponentValuesExist=function(e){var t=this,n=t._database;n.collection("CalComponentsToExcludeForCustomer").find().toArray(function(t,n){t?(app.error("Error while retrieving CAL components to exclude for customer",t),e("true")):e(n.length>0?"true":"false")})},DatabaseHelper.prototype.insertSyncErrors=function(e,t){var n=this._database;async.each(e,function(e,t){n.collection("SyncErrors").insert(e,function(e){t(e)})},function(e){t(e)})},DatabaseHelper.prototype.getSyncErrors=function(e){this._database.collection("SyncErrors").find().toArray(function(t,n){e(t,n)})},DatabaseHelper.prototype.clearSyncErrors=function(e){this._database.collection("SyncErrors").remove({},function(t){e(t)})},module.exports=DatabaseHelper;