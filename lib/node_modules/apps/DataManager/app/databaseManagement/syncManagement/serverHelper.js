"use strict";var config=require("../../config.js"),url=require("url"),uuid=require("uuid-v4"),fs=require("fs"),_=require("underscore"),environment=require("Environment"),path=require("path"),mkdirp=require("mkdirp"),utility=require("FileUtility"),async=require("async"),protocol=require("Protocol"),serverHelper=function(e,t,o,r){var n=this;n._app=e,n._networkContext=t,n.outOfSpace=!1,o.on("boxIdChanged",function(e){n._boxId=e}),o.getBoxId(function(e){n._boxId=e,r()}),e.on(protocol.outOfSpace,function(){n.outOfSpace=!0})},serverBaseUrl=url.parse(environment.serverLocation);serverHelper.prototype.startSession=function(e,t,o){var r=this._app,n=this._networkContext,a=t?t.getBodyForStartSession():{},i=_.defaults({type:e},a);if(this.outOfSpace)return void o(new Error("Low disk space"));var s=url.format({protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.urlBegin.concat(this._boxId,config.syncPath)});r.info("startSyncUrl==>"+s);var p={url:s,method:"POST",headers:{"Content-Type":"application/vnd.johndeere.sa.startSyncSession.v1+json",accepts:"application/vnd.johndeere.sa.startSyncSessionResponse.v1+json"},json:i};r.info("Options sent to server to start sync:",p),n.requestWithTokenValidation(n.getNetworkOptions(p),function(e,t,r){o(e,t,r)})},serverHelper.prototype.uploadState=function(e,t,o){var r=this._app,n=this._networkContext;if(this.outOfSpace)return void o(new Error("Low disk space"));var a=url.format({protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.urlBegin.concat(this._boxId,config.syncPath,t,config.uploadStatePath)}),i={url:a,headers:{"Content-Type":"application/vnd.johndeere.sa.boxState.v3+json",Accept:"application/vnd.johndeere.sa.boxStateResponse.v3+json"},json:e};r.info("Options sent to the server to exchange states for sync:",i),n.putJson(n.getNetworkOptions(i),function(e,t,r){if(!e&&_.isObject(r)&&!_.has(r,"errorCode")){var n=_.omit(r,"models");n.models={adds:r.models&&r.models.adds&&r.models.adds.length,deletes:r.models&&r.models.deletes&&r.models.deletes.length}}o(e,t,r)})},serverHelper.prototype.endSession=function(e,t,o){var r=this._app,n=this._networkContext,a=url.format({protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.urlBegin.concat(this._boxId,config.syncPath,e)}),i={url:a,headers:{"Content-Type":"application/vnd.johndeere.sa.endSyncSession.v1+json"},json:t};r.info("Ending sync session: ",i),n.deleteJson(n.getNetworkOptions(i),function(e,t,r){o(e,t,r)})},serverHelper.prototype.downloadSoftwareUpdate=function(e,t,o){var r=this._app,n=this._networkContext;if(r.info("Downloading software update "+t),this.outOfSpace)return void o(new Error("Low disk space"));var a=function(e){utility.clearDirectory(environment.updatesPath,function(t){e(t)})},i=function(o){var r=t+".zip";n.downloadFile(e,environment.updatesPath,r,o)};async.waterfall([a,i],function(e){e?r.error("Error downloading software update",e):r.info("Software update "+t+" downloaded successfully"),o(e)})},serverHelper.prototype.downloadRecording=function(e,t,o){var r=this._app,n=this._networkContext;if(this.outOfSpace)return void o(new Error("Low disk space"));var a={protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,path:config.recordingDownloadPath.concat(e.recordingInfo.serverRecordingId),method:"GET",headers:{accepts:"application/octet-stream"}};n.requestForProtocol(n.getNetworkOptions(a),function(n,a){if(n)return void o(n);if(r.info("recording "+e.recordingInfo.serverRecordingId+" status: "+a.statusCode),200!=a.statusCode)return void o();var i=uuid()+".zip";e.recordingInfo.path=path.join(e.recordingInfo.dirPath,i),mkdirp(e.recordingInfo.dirPath,function(r){if(r)return void o(r);var n=fs.createWriteStream(e.recordingInfo.path);a.pipe(n),n.on("finish",function(){n.close(function(r){return r?void o(r):void t.insertRecording(e.recordingInfo,function(r){return r?void o(r):void t.flagAsDownloaded(e._id,o)})})}),n.on("error",o)})})},serverHelper.prototype.downloadFullSyncFile=function(e,t,o,r){r=_.once(r);var n=this._app,a=this._networkContext;if(this.outOfSpace)return void r(new Error("Low disk space"));if(!_.isString(e))return void r(new Error("Invalid base url"));var i=url.parse(e.concat(t)),s={protocol:i.protocol,hostname:i.hostname,port:i.port,path:i.pathname,method:"GET",headers:{accepts:"application/octet-stream"}};n.info("Downloading full sync file: "+url.format({protocol:s.protocol,hostname:s.hostname,port:s.port,pathname:s.path})),a.requestForProtocol(a.getNetworkOptions(s),function(e,a){if(e)return n.error("A request error occurred while downloading a file for full sync: ",d,d),void r(e);var i=parseInt(a.headers["content-length"]),s=0;if(a.on("data",function(e){s+=e.length,o(s/i)}),503==a.statusCode){var p=JSON.stringify(a.headers),l="";return a.on("data",function(e){l=new Buffer(e).toString("utf-8")}).on("end",function(){p=p.concat(l);var e=new Error("Bad Server Response");e.statusCode=a.statusCode,e.info=p,r(e)}),void n.info("Status of full sync file with 503 error "+t+": "+a.statusCode)}if(200!=a.statusCode){n.info("Status of full sync file "+t+": "+a.statusCode);var d=new Error("Bad Server Response");return d.statusCode=a.statusCode,void r(d)}var c=path.join(environment.temporaryDataSyncPath,uuid()),u=fs.createWriteStream(c);a.pipe(u).on("error",function(e){n.error("A file error occurred while downloading a file for full sync: ",e,e),r(e)}),u.on("finish",function(e){r(e,c)}),a.on("error",function(e){n.error("A network error occurred while downloading a file for full sync: ",e,e),r(e)});var f=!1;a.on("end",function(){f=!0}),a.on("close",function(){f||n.warning("Request aborted while downloading a file for full sync.")})})},serverHelper.prototype.uploadReturnFileData=function(e,t){var o=this._app,r=this._networkContext;if(this.outOfSpace)return void t(new Error("Low disk space"));var n=url.format({protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.uploadReturnFileDataPath}),a={url:n,headers:{"Content-Type":"application/vnd.johndeere.sa.returnFileData.v1+json",accepts:"application/vnd.johndeere.sa.returnFileDataResponse.v1+json"},json:e};o.info("Options sent to the server to upload return file data:",a),r.postJson(r.getNetworkOptions(a),function(e,o,r){t(e,o,r)})};var _isReturnFile=function(e){var t=path.extname(e);return _.contains([".RTN",".RTZ"],t.toUpperCase())},_isReturnErrorFile=function(e){var t=path.extname(e);return".RTE"===t.toUpperCase()};serverHelper.prototype.uploadReturnFile=function(e){var t=this._app,o=this._networkContext,r=this.outOfSpace;this.getFileNamesFrmLocation(function(n){_.isEmpty(n)?e():_.each(n,function(n){var a={fileName:n,returnFilePath:path.dirname(n)},i=path.basename(n),s=path.extname(a.fileName),p=path.basename(i,s),l="";_isReturnFile(a.fileName)?l="C:/sds/returnArchive":_isReturnErrorFile(a.fileName)&&(l="C:/sds/returnerrorArchive");var d=s.split(".");if(fs.exists(l)||mkdirp(l,function(t){if(t)return void e(t)}),r)return void e(new Error("Low disk space"));if(!a||!_.isString(a.returnFilePath)||!fs.existsSync(a.returnFilePath))return void e(new Error("Return File Not Found"));var c={protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,path:config.returnFileUploadPath.concat(p.concat("/?extn=").concat(d[1])),method:"PUT",headers:{"Content-Type":"application/octet-stream"}};t.info("Uploading return file: "+a.fileName),t.info("Uploading option: ",c),fs.exists(n,function(r){return r?void o.uploadStream(utility.getFileReadStreamGenerator(n),o.getNetworkOptions(c),function(o,r){return o?(t.info("serverHelper.prototype.uploadReturnFile err with req",o),void e(o)):(t.info("Status of uploading return file "+a.fileName+": "+r.statusCode),r.on("data",function(){t.info("serverHelper.prototype.uploadReturnFile data")}),void r.on("end",function(){if(t.info("serverHelper.prototype.uploadReturnFile end"+r.statusCode),200!==r.statusCode)return void e(new Error("Return File Upload failed!!!"));t.info("Return file uploaded successfully!!!"),console.log("archiveFilePath",l);var o=fs.createReadStream(n);o.on("open",function(){o.pipe(fs.createWriteStream(l+"/"+i))}),o.on("error",function(t){e(t)}),o.on("end",function(){fs.unlink(n,function(o){return o?(t.info("Error in unlink",o),void e(o)):void e()})})}))}):(t.info("File does not exist!!!"),void e())})})})},serverHelper.prototype.uploadUsageDataFile=function(e){var t=this._app,o=this._networkContext;this.getEEPROMFileNamesFrmLocation(function(r){_.isEmpty(r)?e():_.each(r,function(r){var n={fileName:r,staFilePath:path.dirname(r)},a=path.basename(r),i=a.split("."),s=path.extname(n.fileName),p=s.split(".");if(!n||!_.isString(n.staFilePath)||!fs.existsSync(n.staFilePath))return void e(new Error("STA File Not Found ",n));var l={protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,path:config.returnStaFileUploadPath.concat(encodeURIComponent(i[0]).concat("?extn=").concat(p[1])),method:"PUT",headers:{"Content-Type":"application/octet-stream"}};t.info("options:",l),fs.exists(r,function(a){return a?void o.uploadStream(utility.getFileReadStreamGenerator(r),o.getNetworkOptions(l),function(o,r){return o?(t.info("serverHelper.prototype.uploadUsageDataFile err with req",o),void e(o)):(t.info("serverHelper.prototype.uploadUsageDataFile end",r.statusCode),200!==r.statusCode?void e(new Error("STA File Upload failed!!!")):void fs.unlink(n.fileName,function(o){return o?(t.info("Error in deleting STA file",o),void e(o)):void e()}))}):(t.info("File does not exist!!!"),void e())})})})},serverHelper.prototype.getFileNamesFrmLocation=function(e){var t="C:/sds/return",o="C:/sds/returnerror",r=function(e,t){fs.readdir(e,function(o,r){var n=[];o&&t(o),_.isEmpty(r)?t():(_.each(r,function(t){if(_isReturnFile(t)||_isReturnErrorFile(t)){var o=path.join(e,t);n.push(o)}}),t(n))})};r(t,function(t){r(o,function(o){if(t&&t.length>0){o&&o.length>0&&t.push(o);var r=_.flatten(t);e(r)}else o&&o.length>0?e(o):e()})})},serverHelper.prototype.getEEPROMFileNamesFrmLocation=function(e){var t="C:/sds/MachineDataUpload",o=function(e,t){fs.readdir(e,function(o,r){var n=[];o&&t(o),_.isEmpty(r)?t():(_.each(r,function(t){if(".STA"===path.extname(t).toUpperCase()){var o=path.join(e,t);n.push(o)}}),t(n))})};o(t,function(t){var o=[];t&&t.length>0&&o.push(t);var r=_.flatten(o);e(r)})},serverHelper.prototype.getDataFileUpdates=function(e,t,o){var r=(this._app,this._networkContext);if(this.outOfSpace)return void o(new Error("Low disk space"));var n=url.format({protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:config.urlBegin.concat(this._boxId,config.syncPath,e,config.getModelDeletesPath)}),a={url:n,headers:{"Content-Type":"application/vnd.johndeere.sa.serverState.v1+json",Accept:"application/vnd.johndeere.sa.serverState.v1+json"},json:!0};r.getJson(r.getNetworkOptions(a),function(e,t,r){o(e,t,r)})},serverHelper.prototype.getDataFileUpdatesForSetup=function(e,t,o,r,n,a){var i=this,s=i._app,p=url.format({protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,pathname:"/bms/oauth/modelDataUpdates"}),l={url:p,headers:{Accept:"application/vnd.johndeere.sa.modelDataUpdates.v1+json","Content-Type":"application/vnd.johndeere.sa.modelDataUpdates.v1+json"},json:{modelGUIDs:e,datasetIDs:t,locationIDs:o,languages:r,installedSoftwareVersion:n}};i._networkContext.postJson(i._networkContext.getNetworkOptions(l),function(e,t,o){if(e)a(e);else if(200!==t.statusCode)e=new Error(t.statusCode),s.error("Error downloading data file updates:",t.statusCode),a(e);else if(_.isUndefined(t.headers&&t.headers.etag))e=new Error("Server Response Was Missing ETag Header"),s.error("Received bad response:",e,t.statusCode),a(e);else{var r=new Date(t.headers.etag);a(void 0,_.extend(_.clone(o),{lastFullSyncTime:r.toLocaleTimeString()}))}})},module.exports=serverHelper;