"use strict";var async=require("async"),config=require("../../config.js"),_=require("underscore"),util=require("util"),events=require("events"),dbHelperApp=require("./dbHelper.js"),QuickSyncManager=require("./quickSyncManagement"),FullSyncManager=require("./fullSyncManagement"),serverHelperApp=require("./serverHelper.js"),BoxDataProvider=require("../../dataProviders/BoxDataProvider.js"),PinSearchDataProvider=require("../../dataProviders/PinSearchDataProvider.js"),ModelsDataProvider=require("../../dataProviders/ModelsDataProvider.js"),SystemUpdateProvider=require("../../dataProviders/SystemUpdateProvider.js"),syncOptionTypes=require("./syncOptions"),uuid=require("uuid"),SyncManager=function(n,e,t,i,r,u,c,a,S,y,o,l,s,g,p){var d=this;d._registrationClient=a,d._connectorClient=S,d._app=n;var f,_,v=new BoxDataProvider(n,i,s),m=new PinSearchDataProvider(n,e),M=new ModelsDataProvider(n,i,e,a),k=new SystemUpdateProvider(n,e,y);d._pendingQuickSync=!1,d._pendingFullSync=!1,events.EventEmitter.call(d),async.parallel([function(t){_=new dbHelperApp(n,e,"quick",t)},function(t){f=new dbHelperApp(n,e,"full",t)},function(e){d._serverHelper=new serverHelperApp(n,c,a,e)}],function(e){return e?void p(e):(d._quickSyncDbHelper=_,d._fullSyncDbHelper=f,d._fullSyncManager=new FullSyncManager(n,d,d._serverHelper,f,m,M,v,k,u,d._connectorClient,d._registrationClient,l,o,g),d._quickSyncManager=new QuickSyncManager(n,d,d._serverHelper,_,v,r,t,d._connectorClient,d._registrationClient,y),d._quickSyncManager.on("quickSyncStarted",function(n){d.emit("quickSyncStarted",n)}),d._quickSyncManager.on("quickSyncStartFailed",function(n){d.emit("quickSyncStartFailed",n)}),d._quickSyncManager.on("quickSyncFinished",function(n){d.emit("quickSyncFinished",n),d._pendingFullSync&&d.startFullSync()}),d._quickSyncManager.on("quickSyncError",function(n,e){d.emit("quickSyncError",n,e)}),d._fullSyncManager.on("fullSyncStarted",function(n){d.emit("fullSyncStarted",n)}),d._fullSyncManager.on("fullSyncStartFailed",function(n){d.emit("fullSyncStartFailed",n)}),d._fullSyncManager.on("fullSyncFinished",function(n){d.emit("fullSyncFinished",n),d._pendingQuickSync&&d.startQuickSync()}),d._fullSyncManager.on("fullSyncError",function(n,e){d.emit("fullSyncError",n,e)}),d._fullSyncManager.on("fullSyncStartSessionFailed",function(n){d.emit("fullSyncStartSessionFailed",n)}),d._fullSyncManager.on("fullSyncSessionStarted",function(n){d.emit("fullSyncSessionStarted",n)}),void async.parallel({isQuickSyncQueueEmpty:function(n){d._quickSyncManager.isSyncQueueEmpty(function(e,t){n(e,t)})},setupState:function(n){d._registrationClient.getSetupState(function(e){n(void 0,e)})}},function(e,t){return e?void p(e):(t.isQuickSyncQueueEmpty&&d._registrationClient.isSetupInProgress(t.setupState)&&_.addPendingSync(function(n){d._quickSyncManager.startSync()}),void d.resumeSyncs(function(e){e&&n.error("An error occurred while resuming syncs during startup. Syncs will be retried later.",e),p()}))}))})};util.inherits(SyncManager,events.EventEmitter),SyncManager.prototype.startQuickSync=function(n,e){var t=this;_.isFunction(n)&&(e=n,n=void 0),t.runQuickSync(n,!0,e)},SyncManager.prototype.runQuickSync=function(n,e,t){var i=this;t=t||_.noop;var r=function(t){i._pendingQuickSync=!1,e?i._quickSyncDbHelper.addPendingSync(n,function(e){i._quickSyncManager.startSync(n,t)}):i._quickSyncManager.startSync(n,t)};i._registrationClient.getSetupState(function(n){i._app.info("Checking setup state before quick sync: ",n),i._registrationClient.isSetup(n)||i._registrationClient.isSetupStartOver(n)?r(t):i._registrationClient.isSetupInProgress(n)||i._registrationClient.isSetupInProgressError(n)||i._registrationClient.isSetupPendingIdentifiedSync(n)?i.isSyncQueueEmpty(function(n,e){return n?(i._pendingQuickSync=!0,void t(n)):void(e.fullSyncQueueIsEmpty?i._registrationClient.setSetupState(i._registrationClient.getSetupInProgressState(),function(n){n?(i._pendingQuickSync=!0,t(n)):r(t)}):(i._pendingQuickSync=!0,e.quickSyncQueueIsEmpty?t(void 0,i._quickSyncManager.getCurrentSyncNumber()):t(void 0,i._quickSyncManager.getCurrentSyncNumber()+1)))}):(i._pendingQuickSync=!0,i.isSyncQueueEmpty(function(n,e){return n?(i._pendingQuickSync=!0,void t(n)):void(e.quickSyncQueueIsEmpty?t(void 0,i._quickSyncManager.getCurrentSyncNumber()):t(void 0,i._quickSyncManager.getCurrentSyncNumber()+1))}))})},SyncManager.prototype.startFullSync=function(n){var e=this;e.runFullSync(void 0,!0,n)},SyncManager.prototype.runFullSync=function(n,e,t){var i=this;t=t||_.noop,this._app.info("Got request to run a full sync: "+JSON.stringify({customSync:n,isNewSync:e}));var r=function(t){i._pendingFullSync=!1,e?i._fullSyncDbHelper.addPendingSync(n,function(e){i._fullSyncManager.startSync(n,t)}):i._fullSyncManager.startSync(n,t)};i._registrationClient.getSetupState(function(n){i._registrationClient.isSetup(n)?r(t):i._registrationClient.isSetupInProgress(n)?i.isSyncQueueEmpty(function(n,e){var u=i.getSyncStatus();n?(i._pendingFullSync=!0,t(n)):e.quickSyncQueueIsEmpty?r(t):e.fullSyncQueueIsEmpty||u.quickSyncRunning||u.fullSyncRunning?(i._pendingFullSync=!0,e.fullSyncQueueIsEmpty?t(void 0,i._fullSyncManager.getCurrentSyncNumber()):t(void 0,i._fullSyncManager.getCurrentSyncNumber()+1)):r(t)}):i._registrationClient.isSetupInProgressSyncing(n)||i._registrationClient.isSetupInProgressSyncingError(n)?i._registrationClient.setSetupState(i._registrationClient.getSetupInProgressSyncingState(),function(n){n?(i._pendingQuickSync=!0,t(n)):r(t)}):(i._pendingFullSync=!0,i.isSyncQueueEmpty(function(n,e){return n?void t(n):void(e.fullSyncQueueIsEmpty?t(void 0,i._fullSyncManager.getCurrentSyncNumber()):t(void 0,i._fullSyncManager.getCurrentSyncNumber()+1))}))})},SyncManager.prototype.startCustomFullSync=function(n,e,t){var i=this;i._registrationClient.getSetupState(function(r){i._registrationClient.isSetup(r)?i.isSyncQueueEmpty(function(r,u){return r?void t(r):void(u.fullSyncQueueIsEmpty&&!i._pendingFullSync?i._fullSyncManager.startSync(new syncOptionTypes.CustomFullSyncOptions(n,e),t):t(new Error("Custom full sync cannot be initiated while a full sync is running.")))}):t(new Error("Must be setup to do a custom full sync."))})},SyncManager.prototype.queueCustomFullSync=function(n,e,t,i){var r=this;r._registrationClient.getSetupState(function(u){if(r._registrationClient.isSetup(u)){var c=new syncOptionTypes.CustomFullSyncOptions(n,e,t,!0);r.runFullSync(c,!0,i)}else i(new Error("Must be setup to do a custom full sync."))})},SyncManager.prototype.getSyncStatus=function(){var n=this;return{fullSyncRunning:n._fullSyncManager.getSyncStatus(),quickSyncRunning:n._quickSyncManager.getSyncStatus()}},SyncManager.prototype.isSyncQueueEmpty=function(n){var e=this;async.parallel({fullSyncQueueIsEmpty:e._fullSyncManager.isSyncQueueEmpty.bind(e._fullSyncManager),quickSyncQueueIsEmpty:e._quickSyncManager.isSyncQueueEmpty.bind(e._quickSyncManager)},function(e,t){n(e,t)})},SyncManager.prototype.resumeSyncs=function(n){var e=this;n=n||_.noop,async.parallel([function(n){e._fullSyncManager.resumeSync(n)},function(n){e._quickSyncManager.resumeSync(n)}],function(e){n(e)})},module.exports=SyncManager;