"use strict";var util=require("util"),events=require("events"),uuid=require("uuid-v4"),async=require("async"),_=require("underscore"),prepareUpdatesHelper=require("./prepareUpdatesHelper.js"),exchangeStatesHelper=require("./exchangeStatesHelper.js"),systemUpdate=require("./getSystemUpdate.js"),dataProfiles=require("../../dataProfiles"),syncSessions=require("../syncSessions"),syncSequences=require("../syncSequences"),syncOptionTypes=require("../syncOptions"),syncErrors=require("../syncErrors"),_getSyncsForCustomSyncType=function(e,n){return _.filter(n,function(n){return _.isEqual(syncOptionTypes.QuickSyncOptions.fromJSON(n.data),e)})},_getSyncOptionsFromPendingSyncs=function(e){var n=_.pluck(e,"data");return syncOptionTypes.QuickSyncOptions.fromJSON(_.first(n))},QuickSyncManager=function(e,n,r,t,i,o,s,a,c,d){var u=this;u._app=e,u._isSyncRunning=!1,u._downloadFlag=!1,u._syncManager=n,u._dataProfiles=s,u._boxDataProvider=i,u._copyManager=o,u._dbHelper=t,u._serverHelper=r,u._registrationClient=c,u._connectorClient=a,u._systemUpdateInstallerClient=d,u._syncNumber=1,u.isUploading=!1,events.EventEmitter.call(u)};util.inherits(QuickSyncManager,events.EventEmitter),QuickSyncManager.prototype.startSync=function(e,n){var r=this,t=r._app;return n=n||_.noop,r._connectorClient.isOnline()===!1?(t.info("Quick Sync Not Started Due To Lack Of Internet Connectivity."),n(void 0,r._syncNumber+1),void r.emit("quickSyncStartFailed",r._syncNumber+1)):r._isSyncRunning===!0?(t.info("Quick Sync Already Running. New Quick Sync Wasn't Started."),n(void 0,r._syncNumber+1),void r.emit("quickSyncStartFailed",r._syncNumber+1)):(r._isSyncRunning=!0,void r._dbHelper.getPendingSyncs(function(i,o){var s=_getSyncsForCustomSyncType(e,o||[]);r._dbHelper.getSyncSession(function(i,o){if(i)return t.error("QuickSync: Database retrieve error: ",i),r._isSyncRunning=!1,void n(i);var a=function(){r.emit("quickSyncStarted",r._syncNumber),t.info("Successful quick sync start, sync number: ",r._syncNumber)},c=function(){a(),r.emit("quickSyncStartFailed",r._syncNumber+1)};o?(n(void 0,r._syncNumber+1),c()):(n(void 0,r._syncNumber),a());var d=function(n,i,o,s){n&&(r.emit("quickSyncError",r._syncNumber,n),t.error("Error that terminated the sync session: ",n));var a=function(e,n){r._registrationClient.getSetupState(function(o){!r._registrationClient.isSetupInProgress(o)||i&&i.copyManagerNotified?r._registrationClient.isSetupInProgress(o)&&i&&i.copyManagerNotified?(t.error('CopyManager was notified, setup state remained "inProgress".'),n()):n():r._registrationClient.setSetupState(r._registrationClient.getSetupInProgressErrorState(),e?-1:0,function(e){n(e)})})},c=function(n){r._dbHelper.addPendingSync(e,n)};if(n&&"404"===n.message){var u=function(e,n){return i?void r._dbHelper.setSessionFailed(i.syncSessionId,function(e,r){e&&t.error("QuickSync: Database update error, ",e),n(e,r)}):void n(null,null)};async.waterfall([a.bind(void 0,!1),c,u,clearUpdatesCollection.bind(void 0,r),function(e,n){n()},removeSession.bind(void 0,r)],function(e){e&&t.error(e),r._isSyncRunning=!1})}else if(n)a(!0,function(e){e&&t.error(e),r._isSyncRunning=!1});else{t.info("Sync Session Complete.");var p=function(){r._boxDataProvider.setLastQuickSyncTime(i.quickSyncTimestamp),t.debug("Finished quick sync number ",r._syncNumber),r.emit("quickSyncFinished",r._syncNumber),r._syncNumber=r._syncNumber+1,r._registrationClient.getSetupState(function(e){r._registrationClient.isSetupInProgressReady(e)&&r._copyManager.startDataCopy(),r._syncManager.resumeSyncs()})};_.isEmpty(o)?(r._isSyncRunning=!1,t.debug("No more items to sync, finalizing sync session"),p()):(t.debug("Have more items to sync, syncing..."),_doSyncForSession(r,void 0,e,o,d,s?[s]:[]))}};_doSyncForSession(r,o,e,[],d,s)})}))};var getBoundFunctions=function(e,n,r,t,i){return{beginSession:beginSession.bind(void 0,e,n,r),beginPreRegistrationQuickSyncSession:syncSessions.beginPreRegistrationQuickSyncSession.bind(void 0,e,n,r),createSession:syncSessions.createQuickSyncSession.bind(void 0,e,n,r),clearUpdatesCollection:clearUpdatesCollection.bind(void 0,e),completeSession:completeSession.bind(void 0,e),endSession:endSession.bind(void 0,e),exchangeStates:exchangeStates.bind(void 0,e),getReturnFileUpdate:getReturnFileUpdate.bind(void 0,e),setServerStateForSetup:setServerStateForSetup.bind(void 0,e),getStateChanges:_.isEmpty(i)?getStateChanges.bind(void 0,e):t,getSystemUpdate:getSystemUpdate.bind(void 0,e),getUsageDataFileUpdate:getUsageDataFileUpdate.bind(void 0,e),notifyCopyManager:notifyCopyManager.bind(void 0,e),prepareUpdates:prepareUpdates.bind(void 0,e),processBoxDeletes:processBoxDeletes.bind(void 0,e),processUpdates:processUpdates.bind(void 0,e),removeSyncedStateChanges:removeSyncedStateChanges.bind(void 0,e),saveServerState:saveServerState.bind(void 0,e),updateSupportPayloadInfo:updateSupportPayloadInfo.bind(void 0,e),getSyncErrors:getSyncErrors.bind(void 0,e),saveSyncErrors:saveSyncErrors.bind(void 0,e),clearSyncErrors:clearSyncErrors.bind(void 0,e)}},_doSyncForSession=function(e,n,r,t,i,o){var s=e._app,a=function(n,r){e._dbHelper.setSessionChangeIds(n.syncSessionId,t,[],function(e,n){e&&s.error("QuickSync: dbHelper.setSessionChangeIds error: ",e),r(e,n)})},c=getBoundFunctions(e,r,o,a,t);e._registrationClient.getRegistrationState(function(r){var t=e._registrationClient.isRegistered(r),o=syncSequences.getFunctions(c,syncSequences.quickSyncSequences,t),a=syncSequences.getFirstStep(syncSequences.quickSyncCriteria,n,t),d=a.stepName;s.info(a.stepDescription);var u=_.findWhere(o,{name:d}),p=_.indexOf(o,u);if(p===-1)return e._isSyncRunning=!1,void i(new Error("couldn't do sync"));var S=_.chain(o).rest(p).map(function(e){return e.function}).value();n&&(S[0]=S[0].bind(void 0,n)),async.waterfall(S,function(n,r){var t,o;if(s.debug("Finished sync workflow",{haveError:!!n,haveSession:!!r}),r&&(t=r.remainingSessionChangeIds,s.debug("Need to sync more items: "+JSON.stringify(t)),o=syncOptionTypes.QuickSyncOptions.fromJSON(r.customSyncOptions)),n)i(n,r);else if(_.isEmpty(t)){var a=[_.defer];o&&o.runFullSync&&a.push(function(n){e._syncManager.runFullSync(o.fullSyncOptions,!0,function(e){n(e)})}),async.series(a,function(o){removeSession(e,function(){i(n,r,t)})})}else e._dbHelper.addPendingSync(o,function(n,o){removeSession(e,function(){i(n,r,t,o)})})})})};QuickSyncManager.prototype.resumeSync=function(e){var n=this,r=n._app;_.isFunction(e)||(e=_.noop),n._dbHelper.getSyncSession(function(t,i){return t?(r.error("QuickSyncManager: Retrieving sync session failed, ",t),void e(t)):n._isSyncRunning?void e():void(i?n._syncManager.runQuickSync(syncOptionTypes.QuickSyncOptions.fromJSON(i.customSyncOptions),!1,function(n,r){e(n)}):n._dbHelper.getPendingSyncs(function(t,i){if(t)return r.error("QuickSyncManager: Retrieving requested syncs failed, ",t),void e(t);if(n._isSyncRunning)return void e();if(_.isEmpty(i))e();else{var o=_getSyncOptionsFromPendingSyncs(i);n._syncManager.runQuickSync(o,!1,function(n,r){e(n)})}}))})},QuickSyncManager.prototype.getCurrentSyncNumber=function(){var e=this;return e._syncNumber},QuickSyncManager.prototype.getSyncStatus=function(){var e=this;return e._isSyncRunning},QuickSyncManager.prototype.isSyncQueueEmpty=function(e){var n=this;return n._isSyncRunning?void e(void 0,!1):void n._dbHelper.getSyncSession(function(r,t){t||r?e(r,!1):n._dbHelper.getPendingSyncs(function(n,r){e(n,_.isEmpty(r))})})};var beginSession=function(e,n,r,t){var i=e._app;e._serverHelper.startSession("quick",n,function(e,n,r){e?(i.error("QuickSyncManager: serverHelper.startSession post to server error, ",e),t(e)):201!==n.statusCode?(e=new Error(n.statusCode),i.error("QuickSync: beginSession bad response: ",n.statusCode,r),t(e)):(i.info("Start sync session server response:",r),t(void 0,r.syncSessionId))})},getStateChanges=function(e,n,r){var t=e._app,i=[dataProfiles.BoxInformation.getType()];e._dbHelper.getStateChangeIdsAndTypes(function(o,s){var a=_.groupBy(s,"type");t.debug("Have state changes of the following types to upload: "+JSON.stringify(_.keys(a)));var c=_.find(i,function(e){return _.has(a,e)});if(t.debug("Isolated profile found? "+c),c)var d=_.pluck(a[c],"id"),u=_.chain(s).pluck("id").reject(function(e){return _.contains(d,e)}).value();else d=_.pluck(s,"id"),u=[];return t.debug("Syncing the following state change IDs: "+JSON.stringify(d)),o?(t.error("QuickSync: dbHelper.getStateChangeIds error: ",o),void r(o,n)):void e._dbHelper.setSessionChangeIds(n.syncSessionId,d,u,function(e,n){e&&t.error("QuickSync: dbHelper.setSessionChangeIds error: ",e),r(e,n)})})},setServerStateForSetup=function(e,n,r){e._boxDataProvider.getBoxInformation(function(e,t){var i=t.savedDataProperties,o=i.locations,s=i.models,a={boxProperties:{dataProperties:_.extend(i,{locations:_.map(o,function(e){return{id:e}})})},models:{adds:_.map(s,function(e){return{mG:e}})},datasets:t.datasetMetadata};r(e,a,n)})},exchangeStates=function(e,n,r){var t=e._app;exchangeStatesHelper.returnFormattedMessageToServer(e._dbHelper,e._dataProfiles,n,function(i,o){return i||!o?(t.error("QuickSync: exchangeStatesHelper error"),void r(i||new Error("Formatted Message Missing"),n)):void e._dbHelper.checkCalComponentValuesExist(function(i){o.areCalComponentsAvailable=i,e._serverHelper.uploadState(o,n.syncSessionId,function(i,o,s){return i?(t.error("QuickSync: serverHelper.uploadState error: ",i),void r(i,n)):200!==o.statusCode?(i=new Error(o.statusCode),t.error("QuickSync: exchangeStates bad response: ",o.statusCode,s),void r(i,n)):_.has(s,"errorCode")?(t.error("QuickSync: exchangeStates response contained error code: ",s.errorCode),void e._registrationClient.setSetupState(e._registrationClient.getSetupInProgressErrorState(),s.errorCode,function(e){r(e,{errorCode:s.errorCode},n)})):s?void e._dbHelper.setQuickSyncTimestamp(n.syncSessionId,new Date,function(e,n){e&&t.error("QuickSync: dbHelper.setQuickSyncTimestamp error: ",e),r(e,s,n)}):void r(new Error("No body provided in upload box state response."))})})})},getVersionFromUrl=function(e){var n=e.split("/"),r=_.last(n).substr(0,_.last(n).lastIndexOf("?"));return r?r:null},getSystemUpdate=systemUpdate.getSystemUpdate,getReturnFileUpdate=function(e,n,r,t){var i=e._app;e.isUploading||(e.isUploading=!0,e._dbHelper.hasRtnFileUploadAccess(function(n){n?e._serverHelper.uploadReturnFile(function(n){e.isUploading=!1,n&&i.error("ERROR",n)}):e.isUploading=!1})),t(void 0,n,r)},getUsageDataFileUpdate=function(e,n,r,t){var i=e._app;e._serverHelper.uploadUsageDataFile(function(e){e&&i.error("ERROR while uploading usage data file",e)}),t(void 0,n,r)},updateSupportPayloadInfo=function(e,n,r,t){var i=e._app,o=n.payloads?n.payloads:void 0;o&&o.length>0?(_.each(o,function(n){e._dbHelper.updateSupportPayloads(n,function(r){r?i.error("ERROR",r):e._dbHelper.updateActivitiesOfSupportPayloads(n,function(e){e&&i.error("ERROR",e)})})}),t(void 0,n,r)):t(void 0,n,r)},saveServerState=function(e,n,r,t){e._dbHelper.setServerState(r.syncSessionId,n,function(e,n){t(e,n)})},prepareUpdates=function(e,n,r){var t=e._app;prepareUpdatesHelper.prepareUpdates(e._dbHelper,e._dataProfiles,n,function(i,o){return i?void r(i,n):_.isArray(o)&&0!==o.length?void e._dbHelper.insertUpdates(o,function(i){return i?(t.error("QuickSync: dbHelper.insertUpdates error: ",i),void r(i,n)):void e._dbHelper.setUpdatesPrepared(n.syncSessionId,function(e,n){e&&t.error("QuickSync: dbHelper.setUpdatesPrepared error: ",e),r(e,n)})}):void r(void 0,n)})},processUpdates=function(e,n,r){var t=e._app,i=function(n){e._dbHelper.retrieveUpdates(function(e,r){n(e,r),t.info("Processing Updates Collection...")})},o=function(n,r){async.eachSeries(e._dataProfiles,function(r,t){var i=_.where(n,{type:r.getType()});r.processUpdatesDuringSync(i,function(n,t){s(r,n,function(n,i){return n?void t(n):void e._dbHelper.updateObject(r.getCollection(),i,function(e){t(e)})})},function(n,t){e._dbHelper.deleteObject(r.getCollection(),n,function(e){t(e)})},function(n,r,t){return r?void t(r):void e._dbHelper.flagUpdateComplete(n,r,function(e){t(e)})},function(e){t(e)})},function(e){r(e)})},s=function(n,r,t){e._dbHelper.getSyncedObject(n.getCollection(),r.id,function(e,n){return e?void t(e):void(n?(r.localId=n.localId,t(void 0,r)):(r.localId=r.localId||uuid(),t(void 0,r)))})};async.waterfall([i,o],function(e){r(e,n)})},endSession=function(e,n,r){var t=e._app;e._serverHelper.endSession(n.syncSessionId,n.syncErrors,function(e,i,o){e?(t.error("QuickSync: serverHelper.endSession error: ",e),r(e,n)):200!==i.statusCode?(t.error("QuickSync: serverHelper.endSession error: ",i.statusCode,o),e=new Error(i.statusCode),r(e,n)):r(void 0,n)})},completeSession=function(e,n,r){var t=e._app;t.info("Ending Quick Sync Session",n.syncSessionId,"locally."),e._dbHelper.setSessionComplete(n.syncSessionId,function(e,n){e&&t.error("QuickSync: dbHelper.setSessionComplete error: ",e),r(e,n)})},notifyCopyManager=function(e,n,r){var t=e._app,i=e._registrationClient,o=n.serverState||{},s=o.models,a=s&&s.adds||[],c=s&&s.deletes||[],d=o.boxProperties&&o.boxProperties.dataProperties&&o.boxProperties.dataProperties.languages,u=o.boxProperties&&o.boxProperties.dataProperties&&o.boxProperties.dataProperties.datasets,p=o.boxProperties&&o.boxProperties.dataProperties&&o.boxProperties.dataProperties.locations,S=function(){e._dbHelper.setSessionCopyManagerNotified(n.syncSessionId,function(e,n){e&&t.error("QuickSync: dbHelper.setSessionCopyManagerNotified error: ",e),r(e,n)})};a.length>0||c.length>0||d&&u&&p?(t.info("CopyManager notified of new data.",{modelAddsCount:a.length,modelDeletesCount:c.length,languages:d,datasets:u,locations:p}),e._copyManager.addNewCopyData(a,c,d,u,p,function(e){return e?void r(e,n):void S()})):async.parallel({setupState:function(e){i.getSetupState(function(n){e(void 0,n)})},registrationState:function(e){i.getRegistrationState(function(n){e(void 0,n)})}},function(e,n){if(e)return void r(e);var t=n.registrationState,o=n.setupState;i.isSetupInProgress(o)&&i.isRegistered(t)?i.setSetupState(i.getIsSetupState(),function(e){e?r(e):S()}):i.isSetup(o)?S():r(new Error("Unexpected Setup State"))})},processBoxDeletes=function(e,n,r){r(void 0,n)},removeSyncedStateChanges=function(e,n,r){var t=e._app;n.failed?r(void 0,n):e._dbHelper.removeSyncedStateChanges(function(e){e&&t.error("QuickSync: dbHelper.removeSyncedStateChanges error: ",e),r(e,n)})},clearUpdatesCollection=function(e,n,r){var t=e._app;e._dbHelper.clearUpdatesCollection(function(e){e&&t.error("QuickSync: dbHelper.clearUpdatesCollection error: ",e),r(e,n)})},removeSession=function(e,n){var r=e._app;e._dbHelper.removeSession(function(e){e&&r.error("QuickSync: dbHelper.removeSession error: ",e),n(e)})},clearSyncErrors=syncErrors.clearSyncErrors,getSyncErrors=syncErrors.getSyncErrors,saveSyncErrors=syncErrors.saveSyncErrors;module.exports=QuickSyncManager;