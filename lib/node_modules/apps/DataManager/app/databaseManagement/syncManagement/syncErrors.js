"use strict";var _=require("underscore"),classifySyncErrors=function(r){return _.chain(r).groupBy(function(r){var e=r.type;return delete r._id,delete r.type,e}).value()},normalizeSyncErrors=function(r){return _.chain(r).pairs().reduce(function(r,e){var n=_.first(e),o=_.last(e),s=_.map(o,function(r){return _.extend(r,{type:n})});return r.concat(s)},[]).value()},clearSyncErrors=function(r,e,n){var o=r._app;r._dbHelper.clearSyncErrors(function(r){return r?(o.error("dbHelper.clearSyncErrors error: ",r),void n(r)):void n(r,e)})},getSyncErrors=function(r,e,n){var o=r._app;r._dbHelper.getSyncErrors(function(r,s){if(r)return o.error("dbHelper.getSyncErrors error: ",r),void n(r);var c=classifySyncErrors(s),t=_.keys(c);o.info("Retrieved "+t.length+" types errors for session: "+e.syncSessionId),n(r,_.extend(e,{syncErrors:c}))})},collectSyncErrors=function(r,e,n){var o=r._app;r._dbHelper.retrieveUpdates(function(r,s){if(r)return o.error("dbHelper.retrieveUpdates error: ",r),void n(r);var c=_.chain(s).pluck("updateError").compact().value(),t=classifySyncErrors(c),i=_.keys(t);o.info("Collected "+i.length+" types of errors for session: "+e.syncSessionId),n(void 0,_.extend(e,{syncErrors:t}))})},saveSyncErrors=function(r,e,n){var o=r._app,s=e.syncErrors;if(_.isEmpty(s))return void n(null,e);var c=normalizeSyncErrors(s);o.info("Saving "+c.length+" errors for session: "+e.syncSessionId),r._dbHelper.insertSyncErrors(c,function(r){r&&o.error("dbHelper.insertSyncErrors error: ",r),n(r,e)})};exports.classifySyncErrors=classifySyncErrors,exports.clearSyncErrors=clearSyncErrors,exports.collectSyncErrors=collectSyncErrors,exports.getSyncErrors=getSyncErrors,exports.normalizeSyncErrors=normalizeSyncErrors,exports.saveSyncErrors=saveSyncErrors;