"use strict";var _=require("underscore"),async=require("async"),DatabaseHelper=function(t,e){var a=this;a._app=t,a._database=e},insertStateChange=function(t,e,a){t.collection("Counter").findAndModify({_id:"Counter"},[],{$inc:{count:1}},{new:!0},function(n,o){return n?void a(n):(e.index=o.count,void t.collection("StateChanges").insert(e,a))})};DatabaseHelper.prototype.addData=function(t,e,a,n){insertStateChange(this._database,{action:"add",localId:e,type:t,dataObject:a},n)},DatabaseHelper.prototype.updateData=function(t,e,a,n,o){insertStateChange(this._database,{action:"update",localId:e,id:a,type:t,dataObject:n},o)},DatabaseHelper.prototype.undoAdd=function(t,e){this._database.collection("StateChanges").remove(t,function(t){e(t)})},DatabaseHelper.prototype.deleteData=function(t,e,a,n){insertStateChange(this._database,{action:"delete",localId:e,id:a,type:t},n)},DatabaseHelper.prototype.getAllData=function(t,e,a){var n=this._database,o=function(e){return t?void n.collection(t).find({},{_id:!1}).toArray(function(t,a){e(t,a)}):void e(void 0,[])},i=function(t,a){n.collection("StateChanges").find({type:e},{_id:!1}).toArray(function(e,n){a(e,t,n)})},d=function(t,e,a){var n=_.where(e,{action:"delete"}),o=_.pluck(n,"localId").sort();t=_.reject(t,function(t){return _.indexOf(o,t.localId,!0)!==-1}),e=_.reject(e,function(t){return _.indexOf(o,t.localId,!0)!==-1}),a(void 0,t,e)};async.waterfall([o,i,d],function(t,e,n){a(t,e,n)})},DatabaseHelper.prototype.getAvailableIds=function(t,e,a){var n=this._database;n.collection(t).findOne({$or:[{id:e},{localId:e}]},{_id:!1},function(t,o){return t?void a(t):void(o?a(void 0,{localId:o.localId,id:o.id}):n.collection("StateChanges").findOne({action:"add",localId:e},{_id:!1},function(t,n){return t||!n?void a(t):void a(void 0,{localId:e})}))})},DatabaseHelper.prototype.getDataById=function(t,e,a,n){var o=this._database,i=function(e){return t?void o.collection(t).findOne({$or:[{localId:a},{id:a}]},{_id:!1},e):void e()},d=function(t){o.collection("StateChanges").find({type:e,$or:[{localId:a},{id:a}]},{_id:!1}).sort({index:1}).toArray(function(e,a){t(e,a)})};async.parallel({syncedData:i,notSyncedData:d},function(t,e){n(t,e.syncedData,e.notSyncedData)})},module.exports=DatabaseHelper;