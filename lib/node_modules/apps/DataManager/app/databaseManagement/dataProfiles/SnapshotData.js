"use strict";var uuid=require("uuid"),_=require("underscore"),async=require("async"),fs=require("fs"),url=require("url"),environment=require("Environment"),serverBaseUrl=url.parse(environment.serverLocation),path=require("path"),utilities=require("./utilities.js"),fileUtility=require("FileUtility"),SnapshotData=function(t,a,e,o,i){this._app=t,this._db=a,this._networkContext=o,this._registrationClient=i};SnapshotData.prototype.getCollection=function(){return"Snapshots"},SnapshotData.prototype.getType=function(){return"SnapshotData"},SnapshotData.prototype.validateNewData=function(t,a){if(!t.filePath)return void a(new Error("File path is missing."));if(!_.isString(t.filePath))return void a(new Error("File path is not a string."));var e={id:t.localId,localId:t.localId,userId:t.userId,models:t.models,fileName:t.fileName,filePath:t.filePath},o=!_.contains(e,void 0);t.activityId&&(e.activityId=t.activityId),o?a(void 0,e):a(new Error("Missing fields in Snapshot Data."))},SnapshotData.prototype.validateUpdate=function(t,a,e){e(new Error("Snapshot Data objects cannot be updated."))},SnapshotData.prototype.compactData=function(t,a,e){return t||_.isArray(a)&&0!==a.length?void e(void 0,t||_.first(a)&&_.first(a).dataObject):void e(new Error("No data to compact."))},SnapshotData.prototype.applyQuery=function(t,a,e){e(void 0,_.where(t,a))},SnapshotData.prototype.formatUploadBoxStateMessage=function(t,a){a()},SnapshotData.prototype.createUpdates=function(t,a,e,o){var i=this._db,n=this,r=n._app,s=_.groupBy(t,function(t){return t.action}),d=s.add;_.each(d,function(t){e([t.index],{type:"uploadSnapshotData",data:t.dataObject})}),utilities.getExistingActivitiesAssociatedWithUpdatedJobs(r,i,a,function(t,r){if(t)return void o(t);var s=_.pluck(r,"localId");i.collection(n.getCollection()).find({activityId:{$in:s}}).toArray(function(t,i){if(t)return void o(t);var n=a.activities||[];i=_.indexBy(i,"activityId");var r=_.keys(i),s=_.difference(r,_.pluck(n,"boxActivityId")),d=_.map(s,function(t){var a=i[t];return{id:a.localId,filePath:a.filePath}});_.isEmpty(d)||e(void 0,{type:"snapshotDeletes",data:d});var p=_.chain(n).filter(function(t){return t.snapshotData}).pluck("boxActivityId").value(),u=_.difference(p,r);n=_.indexBy(n,"boxActivityId"),_.each(u,function(t){var a=n[t],o=uuid()+".zip",i=uuid();e(void 0,{type:"snapshotDownload",data:{id:i,localId:i,activityId:t,url:a.snapshotData,fileName:o,filePath:path.join(environment.snapshotDataPath,o)}})}),o()})})},SnapshotData.prototype.processUpdatesDuringSync=function(t,a,e,o,i){var n=this;async.eachSeries(t,function(t,i){if(t.completed)return void i();var r=t.updateData&&t.updateData.type;if("uploadSnapshotData"===r)n._registrationClient.getBoxId(function(e){_prepareSnapshotDataUpload(n._app,t.updateData.data,n._networkContext,e,t.index,function(e){!e&&t.updateData.data.activityId?a(t.updateData.data,function(a){o(t._id,a,i)}):o(t._id,e,i)})});else if("snapshotDeletes"===r)async.eachSeries(t.updateData.data,function(t,a){fs.unlink(t.filePath,function(o){return o&&"ENOENT"!==o.code?void a(o):void e(t.id,a)})},function(a){o(t._id,a,i)});else if("snapshotDownload"===r){var s=t.updateData.data,d=_.omit(s,"url");a(d,function(a){return a?void o(t._id,a,i):void _downloadSnapshot(n._app,s,n._networkContext,function(a){a?n._app.error("Error downloading snapshot. ",a):n._app.info("Snapshot downloaded successfully."),o(t._id,a,i)})})}else i(new Error("Invalid Type: "+r))},function(t){i(t)})};var _downloadSnapshot=function(t,a,e,o){o=_.once(o);try{var i=url.parse(a.url)}catch(a){return t.error("Error parsing snapshot URL: ",a),void o(a)}var n={protocol:i.protocol,hostname:i.hostname,port:i.port,path:i.path,method:"GET",headers:{accepts:"application/zip"}};e.requestForProtocol(e.getNetworkOptions(n),function(t,e){if(t)return void o(t);if(200!==e.statusCode){var t=new Error("Invalid statusCode while downloading recording file.");return t.statusCode=e.statusCode,void o(t)}var i=fs.createWriteStream(a.filePath);i.on("error",function(t){o(t)}).on("finish",function(){i.close(function(t){o(t)})}),e.pipe(i)})},_prepareSnapshotDataUpload=function(t,a,e,o,i,n){fs.readFile(a.filePath,function(r,s){if(r&&"ENOENT"===r.code)return t.error("Failed to find the snapshot file"),void n();if(r)return void n(r);var d=function(t){t(void 0,{url:{protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,path:"/bms/oauth/boxes/"+o+"/snapshots"},formData:{metadata:{value:function(){return JSON.stringify({boxActionId:i,userId:a.userId,equipment:a.models,boxActivityId:a.activityId})},options:{contentType:"application/vnd.johndeere.sa.boxNetwork.uploadSnapshots.v1+json"}},file:{value:fileUtility.getFileReadStreamGenerator(a.filePath),options:{filename:a.fileName,contentType:"application/octet-stream"}}}})};d(function(o,i){return o?void n(o):void _uploadSnapshotData(t,e,i,a.filePath,!a.activityId,function(a){return a&&"Invalid statusCode."!==a.message?void n(a):a&&"Invalid statusCode."===a.message?(t.error("Bad Server Response Uploading Snapshot Data: ",i),t.error("Server Response For Snapshot Data: ",a),void n(a)):void n()})})})},_uploadSnapshotData=function(t,a,e,o,i,n){t.info("Uploading snapshot files"),a.uploadMultipartFormData(a.getNetworkOptions(e),function(a,e){!a&&e.statusCode>=200&&e.statusCode<300?(t.info("Snapshots have been uploaded"),i?fs.unlink(o,function(a){a&&t.error("Error Unlinking Snapshot Data File: ",a),n(a)}):n(a)):a?n(a):(a=new Error("Invalid statusCode."),a.statusCode=e.statusCode,n(a))})};module.exports=SnapshotData;