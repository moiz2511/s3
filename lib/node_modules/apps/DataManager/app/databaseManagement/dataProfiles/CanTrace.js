"use strict";var uuid=require("uuid"),_=require("underscore"),async=require("async"),fs=require("fs"),url=require("url"),environment=require("Environment"),serverBaseUrl=url.parse(environment.serverLocation),path=require("path"),utilities=require("./utilities.js"),fileUtility=require("FileUtility"),CanTrace=function(e,t,a,r,i){this._app=e,this._db=t,this._networkContext=r,this._registrationClient=i};CanTrace.prototype.getCollection=function(){return"CanTrace"},CanTrace.prototype.getType=function(){return"CanTrace"},CanTrace.prototype.validateNewData=function(e,t){if(!e.filePath)return void t(new Error("File path is missing."));if(!_.isString(e.filePath))return void t(new Error("File path is not a string."));var a={id:e.localId,localId:e.localId,userId:e.userId,models:e.models,fileName:e.fileName,filePath:e.filePath},r=!_.contains(a,void 0);e.activityId&&(a.activityId=e.activityId),r?t(void 0,a):t(new Error("Missing fields in CAN Trace Data."))},CanTrace.prototype.validateUpdate=function(e,t,a){a(new Error("CAN Trace Data objects cannot be updated."))},CanTrace.prototype.compactData=function(e,t,a){return e||_.isArray(t)&&0!==t.length?void a(void 0,e||_.first(t)&&_.first(t).dataObject):void a(new Error("No data to compact."))},CanTrace.prototype.applyQuery=function(e,t,a){a(void 0,_.where(e,t))},CanTrace.prototype.formatUploadBoxStateMessage=function(e,t){t()},CanTrace.prototype.createUpdates=function(e,t,a,r){var i=this._db,o=this,n=o._app,c=_.groupBy(e,function(e){return e.action}),d=c.add;_.each(d,function(e){a([e.index],{type:"uploadCanTraceData",data:e.dataObject})}),utilities.getExistingActivitiesAssociatedWithUpdatedJobs(n,i,t,function(e,n){if(e)return void r(e);var c=_.pluck(n,"localId");i.collection(o.getCollection()).find({activityId:{$in:c}}).toArray(function(e,i){if(e)return void r(e);var o=t.activities||[];i=_.indexBy(i,"activityId");var n=_.keys(i),c=_.difference(n,_.pluck(o,"boxActivityId")),d=_.map(c,function(e){var t=i[e];return{id:t.localId,filePath:t.filePath}});_.isEmpty(d)||a(void 0,{type:"canTraceDeletes",data:d});var u=_.chain(o).filter(function(e){return e.canTraceUrl}).pluck("boxActivityId").value(),s=_.difference(u,n);o=_.indexBy(o,"boxActivityId"),_.each(s,function(e){var t=o[e],r=uuid()+".zip",i=uuid();a(void 0,{type:"canTraceDownload",data:{id:i,localId:i,activityId:e,url:t.canTraceUrl,fileName:t.fileName||r,filePath:path.join(environment.canTraceDataPath,r)}})}),r()})})},CanTrace.prototype.processUpdatesDuringSync=function(e,t,a,r,i){var o=this;async.eachSeries(e,function(e,i){if(e.completed)return void i();var n=e.updateData&&e.updateData.type;if("uploadCanTraceData"===n)o._registrationClient.getBoxId(function(a){_prepareCanTraceDataUpload(o._app,e.updateData.data,o._networkContext,a,e.index,function(a){!a&&e.updateData.data.activityId?t(e.updateData.data,function(t){r(e._id,t,i)}):r(e._id,a,i)})});else if("canTraceDeletes"===n)async.eachSeries(e.updateData.data,function(e,t){fs.unlink(e.filePath,function(r){return r&&"ENOENT"!==r.code?void t(r):void a(e.id,t)})},function(t){r(e._id,t,i)});else if("canTraceDownload"===n){var c=e.updateData.data,d=_.omit(c,"url");t(d,function(t){return t?void r(e._id,t,i):void _downloadCanTrace(o._app,c,o._networkContext,function(t){t?o._app.error("Error downloading can trace. ",t):o._app.info("CAN Trace downloaded successfully."),r(e._id,t,i)})})}else i(new Error("Invalid Type: "+n))},function(e){i(e)})};var _downloadCanTrace=function(e,t,a,r){r=_.once(r);try{var i=url.parse(t.url)}catch(t){return e.error("Error parsing CAN Trace URL: ",t),void r(t)}var o={protocol:i.protocol,hostname:i.hostname,port:i.port,path:i.path,method:"GET",headers:{accepts:"application/zip"}};a.requestForProtocol(a.getNetworkOptions(o),function(e,a){if(e)return void r(e);if(200!==a.statusCode)return e=new Error("Invalid statusCode while downloading CAN Trace file."),e.statusCode=a.statusCode,void r(e);var i=fs.createWriteStream(t.filePath);i.on("error",function(e){r(e)}).on("finish",function(){i.close(function(e){r(e)})}),a.pipe(i)})},_prepareCanTraceDataUpload=function(e,t,a,r,i,o){fs.readFile(t.filePath,function(n,c){if(n&&"ENOENT"===n.code)return e.error("Failed to find the CAN Trace file"),void o();if(n)return void o(n);var d={url:{protocol:serverBaseUrl.protocol,hostname:serverBaseUrl.hostname,port:serverBaseUrl.port,path:"/bms/oauth/boxes/"+r+"/canTrace"},formData:{metadata:{value:function(){return JSON.stringify({boxActionId:i,userId:t.userId,equipment:t.models,boxActivityId:t.activityId})},options:{contentType:"application/vnd.johndeere.sa.boxNetwork.uploadCantrace.v1+json"}},file:{value:fileUtility.getFileReadStreamGenerator(t.filePath),options:{contentType:"application/octet-stream",filename:t.fileName}}}};_uploadCanTraceData(e,a,d,t.filePath,!t.activityId,function(t){return t&&"Invalid statusCode."!==t.message?void o(t):t&&"Invalid statusCode."===t.message?(e.error("Bad Server Response Uploading CAN Trace Data: ",d),e.error("Server Response For CAN Trace Data: ",t),void o(t)):void o()})})},_uploadCanTraceData=function(e,t,a,r,i,o){e.info("Uploading can trace files"),t.uploadMultipartFormData(t.getNetworkOptions(a),function(t,a){!t&&a.statusCode>=200&&a.statusCode<300?(e.info("A CAN Trace has been uploaded"),i?fs.unlink(r,function(t){t&&e.error("Error Unlinking CAN Trace Data File: ",t),o(t)}):o(t)):t?o(t):(t=new Error("Invalid statusCode."),t.statusCode=a.statusCode,o(t))})};module.exports=CanTrace;