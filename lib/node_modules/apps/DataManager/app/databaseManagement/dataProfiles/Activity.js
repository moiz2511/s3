"use strict";var _=require("underscore"),async=require("async"),uuid=require("uuid-v4"),dbHelperApp=require("../dbHelper.js"),utilities=require("./utilities.js"),Activity=function(t,e,i,n,o,r){this._app=t,this._db=e,this._dbHelper=new dbHelperApp(t,e),this._revisionIdManager=i,this._usersDataProvider=n,this._jobsDataProvider=o,this._activityProvider=r};Activity.prototype.getCollection=function(){return"Activities"},Activity.prototype.getType=function(){return"Activity"},Activity.prototype.validateNewData=function(t,e){var i=this,n=_.some(t.equipment,function(t){return t.pin});return t&&(t.jobId||n)?void replaceUserIdWithUserObject(i,[t],function(n,o){o=_.first(o),!n&&t.jobId&&t.createdBy?i._jobsDataProvider.updateJob(o.jobId,{},o.createdBy.userId||o.createdBy,function(){e(n,o)}):e(n,o)}):void e(new Error("Activity does not have a job ID or equipment with a PIN."))},Activity.prototype.validateUpdate=function(t,e,i){var n=this;t.lastModifiedTime=new Date,async.waterfall([function(i){validateActivityCanBeUpdated(n._activityProvider,n._revisionIdManager,e,t,function(t,e){i(t,e)})},function(i,o){var r=_.compact(_.union([t],t.notes));replaceUserIdWithUserObject(n,r,function(r,a){if(r)return void o(r);n._revisionIdManager.incrementBoxRevisionId(e),delete t.revisionId;var d=_.first(a);d.notes&&(d.notes=_.rest(a)),o(void 0,i,d)})},function(t,e,i){t.jobId&&e.lastModifiedBy?n._jobsDataProvider.updateJobWithoutSync(t.jobId,{},e.lastModifiedBy.userId,function(){i(void 0,e)}):i(void 0,e)}],function(t,e){i(t,e)})};var validateActivityCanBeUpdated=function(t,e,i,n,o){t.getActivity(i,void 0,function(t,i){return t?void o(t):i?n.revisionId&&e.getBoxRevisionId(i.id)!==n.revisionId?(t=new Error('Invalid "revisionId" provided.'),t.statusCode=409,void o(t)):i.isJobShared&&null===n.jobId?(t=new Error("Activity belongs to a Job which is shared"),t.statusCode=403,void o(t)):void o(void 0,i):(t=new Error("Activity does not exist."),t.statusCode=404,void o(t))})},replaceUserIdWithUserObject=function(t,e,i){var n={};return _.isArray(e)?void async.mapSeries(e,function(e,i){var o=_.filter(_.unique([e.lastModifiedBy,e.createdBy]),function(t){return _.isString(t)});async.eachSeries(o,function(e,i){return n[e]?void i():void t._usersDataProvider.getUserObject(e,function(t,o){t?i():o?(n[e]={valid:!0,user:o},i()):(n[e]={valid:!1},i())})},function(t){if(t)return void i(t);if(_.isString(e.lastModifiedBy)){var o=n[e.lastModifiedBy];e.lastModifiedBy=o&&o.valid?o.user:e.lastModifiedBy}if(_.isString(e.createdBy)){var r=n[e.createdBy];e.createdBy=r&&r.valid?r.user:e.createdBy}i(void 0,e)})},function(t,e){i(t,e)}):void i(new Error("replaceUserIdWithUserObject Function Requires an Array."))};Activity.prototype.compactData=function(t,e,i){return t=_.clone(t),t||_.isArray(e)&&0!==e.length?(e=_sortStateChanges(e),t=t||{},_.each(e,function(e){t=_.extend(t,e.dataObject)}),void(_.isEmpty(t)?i(void 0,{}):(t.boxRevisionId=this._revisionIdManager.getBoxRevisionId(t.localId),i(void 0,t)))):void i(new Error("No data to compact."))},Activity.prototype.applyQuery=function(t,e,i){var n=this;e.context=e.context||{};var o,r,a=e.context.PIN,d=e.context.jobId,c=e.PIN,s=e.jobId,u=e.types,v=e.startDate,l=e.endDate,f=e.startModifiedDate,y=e.count,p=e.startDateInclusive?1:0,I=e.endDateInclusive?1:0,m=e.recordingDetailsId,b=e.donorEcuDetailsId,D=_.filter(t,function(t){return _.isUndefined(t.activityTime)}),g=_.reject(t,function(t){return _.isUndefined(t.activityTime)}),h={larger:function(t,e,i){return i?t>=e:t>e},smaller:function(t,e,i){return i?t<=e:t<e}},A=function(t,e,i){return t.activityTime?h.larger(new Date(t.lastModifiedTime),e,p)&&h.larger(new Date(t.activityTime),i,!0):h.larger(new Date(t.lastModifiedTime),e,p)&&h.larger(new Date(t.lastModifiedTime),i,!0)},B=function(t,e,i){return h.larger(new Date(t.createdTime),e,p)&&(h.larger(new Date(t.activityTime),i,!0)||h.larger(new Date(t.lastModifiedTime),i,!0))},w=function(t,e){return h.larger(new Date(t.activityTime),e,p)},M=function(t,e){return!!_.isEmpty(e)||_.contains(e,t.jobId)},x=function(t,e){return!!_.isEmpty(e)||_.some(_.pluck(t.equipment,"pin"),function(t){return _.contains(e,t)})},T=function(t,e,i){return t=t?new Date(t):void 0,e=e?new Date(e):void 0,i=i?new Date(i):void 0,function(n){return!(t||e||i)||(i&&t?A(n,t,i)||B(n,t,i)||w(n,t):!t||e||i?e&&!t?n.activityTime?h.smaller(new Date(n.activityTime),e,I):h.smaller(new Date(n.lastModifiedTime),e,I):e&&t?n.activityTime?h.larger(new Date(n.activityTime),t,p)&&h.smaller(new Date(n.activityTime),e,I):h.larger(new Date(n.lastModifiedTime),t,p)&&h.smaller(new Date(n.lastModifiedTime),e,I):void 0:w(n,t))}},j=function(t,e){return t?function(i){return e(i,t)}:function(){return!0}},E=function(t){return j(t,M)},S=function(t){return j(t,function(t,e){return _.contains(e,t.type)})},U=function(t){return j(t,x)},R=function(t){return _.map(t,function(t){return t.boxRevisionId=n._revisionIdManager.getBoxRevisionId(t.localId),t})},C=function(t){return!m||(t.boxRecordingDetailsId===m||t.recordingDetailsId===m)},q=function(t){return!b||(t.boxDonorEcuDetailsId===b||t.donorEcuDetailsId===b)},P=function(t,e,i,n,o,r,a){var d=_.chain(t).filter(function(t){return _.isEmpty(e)&&_.isEmpty(i)||_.isEmpty(e)||_.isEmpty(i)?x(t,e)&&M(t,i):x(t,e)||M(t,i)}).sortBy(function(t){return t.activityTime?-new Date(t.activityTime).getTime():-new Date(t.lastModifiedTime).getTime()}).value();return _.filter(d,function(t){return n(t)&&o(t)&&r(t)&&a(t)&&C(t)&&q(t)})},J=P(g,a,d,T(v,l,f),U(c),E(s),S(u)),O=P(D,a,d,T(v,l,f),U(c),E(s),S(u)),N=function(t,e){return t?e&&t.activityTime>e.lastModifiedTime?e:t:e};o=N(_.last(J),_.last(O)),!v&&y&&(J=J.slice(0,y)),r=O.concat(J),r=R(r),i(void 0,{activities:r,lastActivity:o})};var _applySpecificIds=function(t){if(t)return t.boxActivityId=t.localId,_.omit(t,"localId")},_getGroupedStateChanges=function(t){return _.values(_.groupBy(t,function(t){return t.localId}))},_applyGeneralizedIds=function(t){if(t)return t.localId=t.boxActivityId,_.omit(t,"boxActivityId")},_sortStateChanges=function(t){return _.sortBy(t,"index")};Activity.prototype.formatUploadBoxStateMessage=function(t,e){var i=this,n=this._db,o=_getGroupedStateChanges(t);async.map(o,function(t,e){n.collection("Activities").findOne({localId:_.first(t).localId},{_id:!1},function(n,o){return n?void e(n):void i.compactData(o,t,function(n,r){return n||!r?void e(n):_.isEmpty(r)?void e():o||null!==r.boxJobId?(r.createdBy&&(r.createdBy=r.createdBy&&r.createdBy.userId||r.createdBy),r.lastModifiedBy&&(r.lastModifiedBy=r.lastModifiedBy&&r.lastModifiedBy.userId||r.lastModifiedBy),_.isArray(r.notes)&&(r.notes=_.map(r.notes,function(t){return t.noteId&&delete t.boxNoteId,t.lastModifiedBy=t.lastModifiedBy&&t.lastModifiedBy.userId,t})),o?i._revisionIdManager.setServerRevisionId(r.localId,r.revisionId):delete r.revisionId,delete r.boxRevisionId,r.boxActionId=_.last(t).index.toString(),void i._dbHelper.getAvailableIds("Jobs",r.jobId,function(t,i){return t?void e(t):(i&&(i.id?r.jobId=i.id:(delete r.jobId,r.boxJobId=i.localId)),r.id&&delete r.localId,void e(void 0,_applySpecificIds(r)))})):void e()})})},function(t,i){i=_.compact(i),e(t,i.length>0?{activities:i}:void 0)})},Activity.prototype.createUpdates=function(t,e,i,n){var o=this,r=o._db,a=o._app;utilities.getExistingActivitiesAssociatedWithUpdatedJobs(a,r,e,function(o,r){if(o)return void n(o);_.isArray(t)&&t.length>0&&i(_.pluck(t,"index"));var a=_.pluck(r,"id"),d=_.pluck(e.activities,"id"),c=_.difference(a,d);c.length>0&&i(void 0,{type:"activityIdDeletes",data:c});var s={};_.each(r,function(t){s[t.id]=t.localId}),_.each(e.activities,function(t){i(void 0,{type:"newActivities",data:{activities:[t],localId:s[t.id]}})}),n()})},Activity.prototype.processUpdatesDuringSync=function(t,e,i,n,o){var r=this,a=this._db,d=this._revisionIdManager;if(_.isEmpty(t))return void o();var c=_.filter(t,function(t){return t.updateData&&"activityIdDeletes"===t.updateData.type});t=_.difference(t,c);var s=function(t){async.each(c,function(t,e){if(t.completed)return void e();switch(t.updateData.type){case"activityIdDeletes":a.collection(r.getCollection()).remove({id:{$in:t.updateData.data}},function(i){n(t._id,i,e)})}},function(e){t(e)})},u=function(i){async.each(t,function(t,i){if(t.completed)return void i();if(t.updateData)switch(t.updateData.type){case"newActivities":var o=t.updateData.data.localId,r=_.map(t.updateData.data.activities,function(t){t=_applyGeneralizedIds(t),t.localId=o||t.localId||uuid();var e=d.getServerRevisionId(t.localId);return d.setServerRevisionId(t.localId,t.revisionId),e&&t.revisionId-e>1&&d.incrementBoxRevisionId(t.localId),t});e(r,function(e){n(t._id,e,i)});break;default:i(new Error("Invalid Type: "+t.updateData.type))}else n(t._id,void 0,i)},function(t){i(t)})};async.series([s,u],function(t){o(t)})},Activity.prototype.processUpdatesAfterSync=function(t,e){e()},module.exports=Activity;