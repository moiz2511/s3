"use strict";var _=require("underscore"),async=require("async"),documentId="BoxInformationDocument",BoxInformation=function(e,t,o){this._app=e,this._db=t,this._configStore=o};BoxInformation.getType=function(){return"BoxInformation"},BoxInformation.prototype.getCollection=function(){return"BoxInformation"},BoxInformation.prototype.getType=function(){return BoxInformation.getType()},BoxInformation.prototype.validateNewData=function(e,t){t(new Error("New Box Information objects cannot be created."))},BoxInformation.prototype.validateUpdate=function(e,t,o){var a={};e.datasetMetadata&&(a.datasetMetadata=e.datasetMetadata),e.updateProfile&&(a.syncFrequency=e.updateProfile.syncFrequency,a.customSyncFrequency=e.updateProfile.customSyncFrequency,a.incrementalUpdateModels=e.updateProfile.models),e.dataProperties&&(a.locationIds=e.dataProperties.locations,a.languages=e.dataProperties.languages,a.models=e.dataProperties.models,a.datasets=e.dataProperties.datasets),e.setupDataProperties&&(a.setupLocations=e.setupDataProperties.locations,a.setupLanguages=e.setupDataProperties.languages,a.setupDatasets=e.setupDataProperties.datasets,a.setupModels=e.setupDataProperties.models),e.viewedModels&&(a.viewedModels=e.viewedModels),e.dataLocationInformation&&(a.dataLocationInformation={path:e.dataLocationInformation.path,canChange:e.dataLocationInformation.canChange}),e.selectedDatasetContracts&&(a.selectedDatasetContracts=e.selectedDatasetContracts),e.selectedDatasetVersion&&(a.selectedDatasetVersion=e.selectedDatasetVersion),o(void 0,a)};var _sortStateChanges=function(e){return _.sortBy(e,"index")};BoxInformation.prototype.compactData=function(e,t,o){if(!(e||_.isArray(t)&&0!==t.length))return void o(new Error("No data to compact."));if(!e&&0===t.length)return void o();t=_sortStateChanges(t);var a=_.map(t,function(e){return e.dataObject});e=_.clone(e)||{},_.each(a,function(t){t.viewedModels&&(e.newModels=_.difference(e.newModels,t.viewedModels),delete t.viewedModels,delete t.newModels),e=_.extend(e,t)}),o(void 0,e)},BoxInformation.prototype.applyQuery=function(e,t,o){o(void 0,_.findWhere(e,{localId:documentId}))},BoxInformation.prototype.formatUploadBoxStateMessage=function(e,t){var o=this;return 0===e.length?void t():void o._db.collection("BoxInformation").findOne({localId:documentId},function(a,n){return a?void t(a):n?void o.compactData(n,e,function(e,a){if(e)return void t(e);var r=["languages","locationIds","models","datasets","syncFrequency","customSyncFrequency","incrementalUpdateModels"],s=!_.isEqual(_.pick(n,r),_.pick(a,r));async.series({completedFirstSync:function(e){o._configStore.getParameter("completedFirstSync",function(t){e(void 0,t)})},lastUpdatedTime:function(e){o._configStore.getParameter("lastDataSyncTime",function(t){e(void 0,t)})}},function(e,o){var n=!o.completedFirstSync,r={};n?(r.setupState="notSetup",r.lastUpdatedTime=o.lastUpdatedTime):r.setupState="setup",(s||n)&&(r.boxProperties={dataProperties:{languages:a.languages,locations:a.locationIds,models:a.models,datasets:a.datasets},updateProfile:{syncFrequency:a.syncFrequency,customSyncFrequency:a.customSyncFrequency,models:a.incrementalUpdateModels}}),t(null,r)})}):void t(new Error("Missing box information."))})},BoxInformation.prototype.createUpdates=function(e,t,o,a){var n=this;n._db.collection("BoxInformation").findOne({localId:documentId},function(r,s){return r?void a(r):s?void n.compactData(s,e,function(n,r){if(n)return void a(n);var s=_.map(e,function(e){return e.index});if(t.boxProperties=t.boxProperties||{},t.models){var i=t.models,d=i&&i.adds;t.boxProperties.newModels=_.filter(d,function(e){return e.datasets&&_.isEmpty(e.datasets)});var c={deletes:t.models.deletes,adds:_.compact(_.pluck(t.models.adds,"mG"))}}delete r.datasetMetadata,o(s,{errorCode:t.errorCode,serverBoxProperties:t.boxProperties,originalState:r,models:c}),a()}):void a(new Error("Missing box information."))})},BoxInformation.prototype.processUpdatesDuringSync=function(e,t,o,a,n){var r=this,s=r._app;async.each(e,function(e,o){if(e.completed===!0)return void o();var n=e.updateData.serverBoxProperties,i=e.updateData.models,d=e.updateData.originalState;if(!n)return s.error("The server box properties are missing from the box information update"),void o();if(e.updateData.errorCode)return s.info("Skipping the box information update because it has an error"),void o();n.id=documentId;var c=_.clone(d);if((n.boxType||_.isNull(n.boxType))&&(c.boxType=n.boxType),n.dataProperties&&(c.languages=n.dataProperties.languages,c.locationIds=_.pluck(n.dataProperties.locations,"id"),c.datasets=n.dataProperties.datasets,c.setupLocations&&n.dataProperties.locations&&(c.setupLocations=r._processSetupLocationsUpdatesHelper(c,n))),n.updateProfile&&(c.syncFrequency=n.updateProfile.syncFrequency,c.customSyncFrequency=n.updateProfile.customSyncFrequency,c.incrementalUpdateModels=n.updateProfile.models),i){var u=i.adds;c.models=_.difference(_.union(d.setupModels,u),i.deletes)}c.nextScheduledDataSync=n.nextScheduledDataSync||d.nextScheduledDataSync;var p=d.newModels||[];c.newModels=_.union(p,_.map(n.newModels,function(e){return e.mG})),t(c,function(t){a(e._id,t,o)})},function(e){n(e)})},BoxInformation.prototype._processSetupLocationsUpdatesHelper=function(e,t){return e.setupLocations=_.map(e.setupLocations,function(e){var o=_.find(t.dataProperties.locations,function(t){try{return t.id===e.id}catch(e){return}});return o?o:e}),e.setupLocations},module.exports=BoxInformation;