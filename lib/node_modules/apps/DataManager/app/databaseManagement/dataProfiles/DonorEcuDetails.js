"use strict";function _validate(t,e){var a=_.map(t.equipment,function(t){return{modelGUID:t.modelGUID,pin:t.pin}}),o={currentStep:t.currentStep,status:t.status,equipment:_.isEmpty(a)?void 0:a,donorEcuDetails:t.donorEcuDetails,finalDonorEcuDetails:t.finalDonorEcuDetails,suspectEcuDetails:t.suspectEcuDetails,finalSuspectEcuDetails:t.finalSuspectEcuDetails,boxRevisionId:t.boxRevisionId||1};e(null,_.pick(o,_.identity))}var _=require("underscore"),async=require("async"),DonorEcuDetails=function(t,e,a){this._app=t,this._db=e,this._dbManager=a};DonorEcuDetails.prototype.getCollection=function(){return"DonorEcuDetails"},DonorEcuDetails.prototype.getType=function(){return"DonorEcuDetails"},DonorEcuDetails.prototype.validateNewData=function(t,e){_validate(t,e)},DonorEcuDetails.prototype.validateUpdate=function(t,e,a){_validate(t,a)},DonorEcuDetails.prototype.compactData=function(t,e,a){var o=_.chain(e).map(function(t){return _.extend({localId:t.localId,id:t.id},t.dataObject)}).sortBy("boxRevisionId").value(),i=t||_.first(o);_.each(o,function(t){_.extend(i,t)}),a(void 0,i)},DonorEcuDetails.prototype.applyQuery=function(t,e,a){a(void 0,_.where(t,e))},DonorEcuDetails.prototype.formatUploadBoxStateMessage=function(t,e){var a=this,o=_.chain(t).pluck("localId").unique().value();async.map(o,function(t,e){a._dbManager.getDataById("DonorEcuDetails",t,function(t,a){a.boxDonorEcuDetailsId=a.localId,a.donorEcuDetailsId=a.id,delete a.id,delete a.localId,delete a.boxRevisionId,e(t,a)})},function(t,a){e(null,_.isEmpty(a)?void 0:{donorEcuDetails:a})})},DonorEcuDetails.prototype.createUpdates=function(t,e,a,o){_.isArray(t)&&t.length>0&&a(_.pluck(t,"index"));var i=_.chain(t).groupBy("localId").mapObject(function(t){return _.chain(t).pluck("dataObject").sortBy("boxRevisionId").value()}).value(),n=e.donorEcuDetails;_.each(n,function(t){var e=t.boxDonorEcuDetailsId;i[e]?t.boxRevisionId=_.last(i[e]).boxRevisionId+1:t.boxRevisionId=1,a(void 0,{type:"update",data:t})}),o()},DonorEcuDetails.prototype.processUpdatesDuringSync=function(t,e,a,o,i){return _.isEmpty(t)?void i():void async.each(t,function(t,a){if(!t.updateData&&t.completed===!1)return void o(t._id,void 0,a);if(t.completed===!0)return void a();switch(t.updateData.type){case"update":delete t.updateData.data.action,t.updateData.data.id=t.updateData.data.donorEcuDetailsId,t.updateData.data.localId=t.updateData.data.boxDonorEcuDetailsId,delete t.updateData.data.donorEcuDetailsId,delete t.updateData.data.boxDonorEcuDetailsId,e(t.updateData.data,function(e){o(t._id,e,a)});break;default:a(new Error("Invalid Type: "+t.updateData.type))}},function(t){i(t)})},module.exports=DonorEcuDetails;