"use strict";var _=require("underscore"),async=require("async"),Job=function(e,t,o,i,r,a,d,n){var s=this;this._app=e,this._db=t,this._revisionIdManager=a,this._userProvider=d,this._jobProvider=n,this._solrClient=r,this._solrJobsCoreReloadRequestedAfterSync=!1,o.on("quickSyncFinished",function(){s._solrJobsCoreReloadRequestedAfterSync&&(s._solrJobsCoreReloadRequestedAfterSync=!1,s._solrClient.createJobsIndex(function(e){e&&s._app.error(e)}))})};Job.prototype.getCollection=function(){return"Jobs"},Job.prototype.getType=function(){return"Job"},Job.prototype.validateNewData=function(e,t){var o=this,i=(new Date).toISOString();switch(e.type){case"newJob":var r=e.data;replaceUserIdWithUserObject(o,r,function(o,a){if(o)return void t(o);var d={name:r.name,description:r.description||"",repairOrder:r.repairOrder||"",segment:r.segment||"",models:r.models||[],bookmarks:r.bookmarks||[],state:r.state||"open",shared:r.shared||!1,createdTime:r.createdTime?new Date(r.createdTime).toISOString():i,lastModifiedTime:r.lastModifiedTime?new Date(r.lastModifiedTime).toISOString():i,lastModifiedBy:a.lastModifiedBy||a.createdBy,createdBy:a.createdBy,users:r.createdBy?[r.createdBy.userId]:[],id:r.jobId||null,localId:e.localId};_.contains(d,void 0)&&(o=new Error("Missing required fields.")),t(o,{type:"newJob",data:d})});break;case"jobDownload":t(void 0,{type:"jobDownload",data:e.data});break;default:t(new Error("Invalid Data Type"))}},Job.prototype.validateUpdate=function(e,t,o){var i=this;e.data.lastModifiedTime=(new Date).toISOString(),async.waterfall([function(o){validateJobCanBeUpdated(i._jobProvider,i._revisionIdManager,t,e.revisionId,function(e){o(e)})},function(t){replaceUserIdWithUserObject(i,e.data,function(o,i){return o?void t(o):(e.data=i,void t(void 0,e))})},function(e,o){switch(i._revisionIdManager.incrementBoxRevisionId(t),delete e.data.revisionId,e.type){case"jobUpdate":var r=["name","description","repairOrder","segment","state","shared","models","revisionId","lastModifiedBy","lastModifiedTime"];e.data=_.pick(e.data,r),o(void 0,e);break;case"bookmarkAdd":if(!e.data.type||!e.data.itemId)return void o(new Error("Missing required update fields."));o(void 0,e);break;case"bookmarkDelete":if(!e.data.type||!e.data.itemId)return void o(new Error("Missing required update fields."));o(void 0,e);break;default:o(new Error("Invalid update type."))}}],function(e,t){o(e,t)})};var validateJobCanBeUpdated=function(e,t,o,i,r){e.getJob(o,function(e,o){return e?void r(e):o?i&&t.getBoxRevisionId(o.boxJobId)!==i?void r(new Error('Invalid "revisionId" provided.')):void r(void 0,o):void r(new Error("Job does not exist."))})},replaceUserIdWithUserObject=function(e,t,o){if(!_.isObject(t)||_.isArray(t))return void o(new Error("replaceUserIdWithUserObject Function Requires an Object."));var i={},r=_.filter(_.unique([t.lastModifiedBy,t.createdBy]),function(e){return _.isString(e)});async.eachSeries(r,function(t,o){return i[t]?void o():void e._userProvider.getUserObject(t,function(e,r){e?o(e):r?(i[t]=r,o()):o(new Error("Invalid UserId"))})},function(e){return e?void o(e):(_.isString(t.lastModifiedBy)&&(t.lastModifiedBy=i[t.lastModifiedBy]),_.isString(t.createdBy)&&(t.createdBy=i[t.createdBy]),void o(void 0,t))})};Job.prototype.compactData=function(e,t,o){if(!(e||_.isArray(t)&&0!==t.length))return void o(void 0);var i=[];t=_sortStateChanges(t);var r=_.map(t,function(e){return e.dataObject});e=_.clone(e),_.each(r,function(t){switch(t.type){case"newJob":e=t.data;break;case"jobUpdate":t.data.lastModifiedBy&&i.push(t.data.lastModifiedBy.userId),e=_.extend(e,t.data);break;case"bookmarkAdd":e.bookmarks=_removeBookmark(e.bookmarks,t.data.type,t.data.itemId),e.bookmarks.push(t.data);break;case"bookmarkDelete":e.bookmarks=_removeBookmark(e.bookmarks,t.data.type,t.data.itemId);break;case"jobDownload":}}),e&&(e.users=_.union(e.users||[],i),e.boxRevisionId=this._revisionIdManager.getBoxRevisionId(e.localId)),o(void 0,e)},Job.prototype.applyQuery=function(e,t,o){var i=this;async.waterfall([function(o){if(e=_.sortBy(e||[],function(e){var t=new Date(e.lastModifiedTime).getTime()*-1;return _.isNaN(t)&&(t=0),t}),t.getAllJobs)t={getAllJobs:!0};else{var i,r=new Date(t.startDate),a=new Date(t.endDate),d=function(e){return"Invalid Date"!==e.toString()};i="Invalid Date"===new Date(t.olderThan).toString()?(new Date).getTime():new Date(t.olderThan).getTime();var n=t.state||"open",s=t.user;e=_.filter(e,function(e){var o=new Date(e.lastModifiedTime).getTime();return!_.isNaN(o)&&(d(r)&&d(a)&&!d(new Date(t.olderThan))?o>=r.getTime()&&o<=a.getTime():d(r)&&d(a)&&d(new Date(t.olderThan))?o<i&&o>=r.getTime():o<i)}),n&&"all"!==n&&(e=_.filter(e,function(e){return e.state===n})),s&&"all"!==s&&(e=_.filter(e,function(e){return _.contains(e.users,s.toUpperCase())}))}o(void 0,e)},function(e,t){i._jobProvider.applyDataFencingGroups(e,function(e,o){t(e,o)})},function(e,o){t.requestingUser?i._userProvider.getUsersDataFencingGroups(t.requestingUser,function(t,r,a){return t?void o(t):(e=_.filter(e,function(e){return i._jobProvider.determineAuthorization(r,a,e.dataFencingGroups)}),void o(void 0,e))}):o(void 0,e)}],function(e,r){if(e)return void o(e);var a;a=t.getAllJobs?r.length:t.count||10,r=_.chain(r).first(a).map(function(e){return e.boxRevisionId=i._revisionIdManager.getBoxRevisionId(e.localId),e}).value(),o(void 0,r)})};var _removeBookmark=function(e,t,o){var i=_.findWhere(e,{itemId:o,type:t});return _.without(e,i)},_applySpecificIds=function(e){if(e)return e.boxJobId=e.localId||e.boxJobId,e.jobId=e.id||e.jobId,_.omit(e,"localId","id")},_applyGeneralizedIds=function(e){if(e)return e.id=e.jobId||e.id,e.localId=e.boxJobId||e.localId,_.omit(e,"jobId","boxJobId")},_getGroupedJobStateChanges=function(e){return _.values(_.groupBy(e,function(e){return e.localId}))},_sortStateChanges=function(e){return _.sortBy(e,"index")};Job.prototype.formatUploadBoxStateMessage=function(e,t){var o=this,i=this._db,r=_.partition(e,function(e){return"jobDownload"===e.dataObject.type});e=r[1];var a=r[0],d=_getGroupedJobStateChanges(e),n={jobs:[],jobBookmarks:[],downloadJobs:_.map(a,function(e){return e.dataObject.data})};async.each(d,function(e,t){var r=_.map(e,function(e){return e.dataObject});i.collection("Jobs").findOne({localId:_.first(e).localId},{_id:!1},function(i,a){return i?void t(i):void o.compactData(a,e,function(e,i){if(e||!i)return void t(e);if(i.createdBy=i.createdBy.userId,i.lastModifiedBy=i.lastModifiedBy.userId,i=_applySpecificIds(i),delete i.boxRevisionId,(_.findWhere(r,{type:"newJob"})||_.findWhere(r,{type:"jobUpdate"}))&&(i.jobId&&(i=_.omit(i,"boxJobId")),n.jobs.push(_.omit(i,"bookmarks"))),a){var d=[],s=[];if(_.each(i.bookmarks,function(e){return e.itemId&&e.type?void(_.findWhere(a.bookmarks,{itemId:e.itemId,type:e.type})||d.push(e)):void o._app.warn("Attempting to add a bookmark without the required fields. ",e)}),_.each(a.bookmarks,function(e){return e.itemId&&e.type?void(_.findWhere(i.bookmarks,{itemId:e.itemId,type:e.type})||s.push({itemId:e.itemId,type:e.type})):void o._app.warn("Attempting to delete bookmark without specifying the required identifiers. ",e)}),!_.isEmpty(d)||!_.isEmpty(s)){var c={};i.jobId?c.jobId=i.jobId:c.boxJobId=i.boxJobId,c.bookmarkAdds=d,c.bookmarkDeletes=s,n.jobBookmarks.push(c)}}else _.isEmpty(i.jobBookmarks)||n.jobBookmarks.push({boxJobId:i.boxJobId,bookmarkAdds:i.bookmarks,bookmarkDeletes:[]});t(e)})})},function(e){_.isEmpty(n.jobs)&&delete n.jobs,_.isEmpty(n.jobBookmarks)&&delete n.jobBookmarks,_.isEmpty(n.downloadJobs)&&delete n.downloadJobs,t(e,n)})},Job.prototype.createUpdates=function(e,t,o,i){_.isArray(e)&&e.length>0&&o(_.pluck(e,"index"));var r=t.jobs;_.each(r,function(e){o(void 0,{type:"update",data:_.omit(e,"action")})}),i()},Job.prototype.processUpdatesDuringSync=function(e,t,o,i,r){var a=this;return _.isEmpty(e)?void r():void async.each(e,function(e,o){if(!e.updateData&&e.completed===!1)return void i(e._id,void 0,o);if(e.completed===!0)return void o();switch(e.updateData.type){case"update":var r=e.updateData.data,d=a._revisionIdManager.getServerRevisionId(r.localId);a._revisionIdManager.setServerRevisionId(r.localId,r.revisionId),d&&r.revisionId-d>1&&a._revisionIdManager.incrementBoxRevisionId(r.localId),t(_applyGeneralizedIds(e.updateData.data),function(t){i(e._id,t,o)});break;default:o(new Error("Invalid Type: "+e.updateData.type))}},function(e){e?r(e):(a._solrJobsCoreReloadRequestedAfterSync=!0,r())})},Job.prototype.processUpdatesAfterSync=function(e,t){t()},module.exports=Job;