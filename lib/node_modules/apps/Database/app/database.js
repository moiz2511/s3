"use strict";function connectToDb(e,n,o,a){mongo.MongoClient.connect(e,function(t,i){t&&0!==n?(app.error("Connection to the database failed, retrying",t),_.delay(function(){connectToDb(e,n-1,o,a)},o)):a(t,i)})}var path=require("path"),spawn=require("child_process").spawn,handlebars=require("handlebars"),fs=require("fs"),mkdirp=require("mkdirp"),_=require("underscore"),mongo=require("mongodb"),startManagingLogs=require("./logManager/mongoLogManager.js"),environment=require("Environment"),box=require("BoxApplication"),config=require("./config.js"),app=box(config),hasConnected=!1,clearedLockFile=!1;mkdirp.sync(path.dirname(config.databaseConfig)),mkdirp.sync(config.databaseData),mkdirp.sync(environment.mongoLogs);try{var dbConfig=fs.readFileSync(path.join(__dirname,config.databaseConfigTemplate),{encoding:"utf-8"}),template=handlebars.compile(dbConfig);fs.writeFileSync(config.databaseConfig,template({dataPath:config.databaseData,logPath:environment.mongoLogs}))}catch(e){throw app.error("An error occurred while attempting to rewrite the database configuration file.",e),e}var dbPath=path.join(__dirname,config.mongoRelease,"bin","mongod.exe"),createDbProcess=function(e){var n=spawn(dbPath,["--config",config.databaseConfig],{cwd:__dirname,detached:!0});n.stdout.pipe(process.stdout),n.stderr.pipe(process.stderr),n.on("exit",e)},disconnectApp=function(){app.info("Database process stopped."),app.disconnect()};createDbProcess(function(){hasConnected||clearedLockFile?disconnectApp():(app.info("The database process failed to start. Trying to recover by deleting the mongo lock file."),fs.unlink(config.databaseLockFile,function(){clearedLockFile=!0,createDbProcess(disconnectApp)}))}),connectToDb("mongodb://localhost",12,5e3,function(e,n){hasConnected=!0,e?(app.on("stop",function(){app.disconnect()}),app.error("Unable to connect to the database.",e),app.ready(e)):(app.on("stop",function(){app.info("Stopping database process.");var e=n.admin();e.command({shutdown:1},function(){n.close()})}),app.ready(),startManagingLogs(app,n))}),process.on("SIGINT",function(){console.log("database got sigint")});