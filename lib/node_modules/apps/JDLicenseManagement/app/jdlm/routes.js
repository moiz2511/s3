!function(){"use strict";var e=require("express"),r=require("Middleware/acceptsCheck.js"),n=require("underscore"),o=require("path"),t=require("fs"),i=require("uuid"),a=require("Environment"),d=require(a.getLocalAddonPath("GetHostId")),s=function(s,c){var l=c.dataManagerClient.create(s),u=c.webServer;u.get("/SAWeb/services/jdlmService/getLicenseFile",r("application/vnd.johndeere.sa.JDLM.get.v1+json, application/json"),function(e,r){var n=o.join(a.dataRoot,"JDLM\\JDLM.LIC");t.readFile(n,function(e,n){if(e){if("ENOENT"===e.code){var o={};return o.trackingId=i.v4(),o.hostId=d.GetHostId(),void r.send(200,JSON.stringify(o))}return s.error("An error occurred while reading JDLM.LIC",e),void r.send(500,"Internal Server Error")}try{var o={};o.trackingId=i.v4(),o.hostId=d.GetHostId();var t=o.licenseValues=[],a=n.toString().split("\n");a.forEach(function(e,r){t.push({licenseValue:e.replace(/\r/g,""),type:"SDS",securityKeyOrder:"2"})}),r.send(200,JSON.stringify(o))}catch(e){return s.error("An error occurred while processing JDLM.LIC",e),void r.send(500,"Internal Server Error")}})}),u.post("/SAWeb/services/jdlmService/updateLicense",e.json(),r("application/vnd.johndeere.sa.JDLM.get.v1+json, application/json"),function(e,r){if(n.isEmpty(e.body))return void res.status(400).end();var i=o.join(a.dataRoot,"JDLM"),d=o.join(a.dataRoot,"JDLM\\JDLM.LIC");t.stat(i,function(o,a){if(o){if("ENOENT"!==o.code)return s.error("Error occurred while checking JDLM directory",o),void r.send(500,"Internal Server Error");try{t.mkdirSync(i)}catch(e){return s.error("Error occurred while creating JDLM directory",e),void r.send(500,"Internal Server Error")}}var c=t.createWriteStream(d,{flags:"w+"});c.on("error",function(e){s.error("Error occurred while writing JDLM.LIC file",e),r.send(500,"Internal Server Error")}),c.on("close",function(e){l.resetJDLMDetail(function(e){e&&s.error("Error occurred while reset of LMInformation collection",e)}),r.send(200,!0)}),n.each(e.body,function(e){c.write(e.licenseValue+"\n")}),c.end()})}),u.get("/SAWeb/services/jdlmService/getModifiedDate",r("application/vnd.johndeere.sa.JDLM.get.v1+json"),function(e,r){var n=o.join(a.dataRoot,"JDLM\\JDLM.LIC");t.stat(n,function(e,n){e?(s.error("An error occurred while reading JDLM.LIC for modified date",e),r.send(200,{modifiedDate:null})):r.send(200,{modifiedDate:n.mtime})})}),u.get("/SAWeb/services/jdlmService/processLM",r("application/vnd.johndeere.sa.validateLicense.v1+json"),function(e,r){l.getJDLMDetail(function(e,o){if(e||n.isEmpty(o)||n.isEmpty(o.lastDownload))return s.error("Error occurred while getting LMInformation collection",e),void r.send("500","Internal Server Error");try{var t=Date.parse((new Date).toUTCString()),i=Date.parse(o.lastDownload),a=t-i,d=o.lastDifference}catch(e){return s.error("Error occurred while processing LMInformation dates",e),void r.send("500","Internal Server Error")}return a<0?(s.info("Current system time is less than last license download time"),void r.send("200",{processed:"false"})):d&&0!=d&&a<d?(s.info("Current difference for license is less than last stored difference"),void r.send("200",{processed:"false"})):void l.updateJDLMDetail({lastDifference:a},function(e){return e?(s.error("Error occurred while updating LMInformation collection with current difference",e),void r.send("500","Internal Server Error")):void r.send("200",{processed:"true"})})})})};module.exports=s}();