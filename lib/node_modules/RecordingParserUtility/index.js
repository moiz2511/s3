var FileStream=require("./FileStream.js"),DataView=require("buffer-dataview"),_=require("underscore"),dataTypes={1:"dataPointValues",2:"dtcStates",3:"dataPointUpdates",4:"dtcUpdates",5:"connectXmls",6:"frameIndexes",7:"dataPoints",8:"triggers",9:"controllers",10:"dtcs",11:"notes"},parseFunctions={1:function(e){return{id:e.readInt4(),value:e.readValue(),resources:e.readMap(e.readInt4,e.readInt4)}},2:function(e){return{id:e.readInt4(),status:e.readByte(),count:e.readInt4(),validCount:e.readByte()}},3:function(e){var r={id:null,value:null,time:null,resources:null};return r.id=e.readInt4(),r.value=e.readValue(),e.readValue(),r.time=e.readFloat4(),r.resources=e.readMap(e.readInt4,e.readInt4),e.readMap(e.readInt4,e.readInt4),r},4:function(e){var r={id:null,time:null,count:null,status:null,validCount:null};return r.id=e.readInt4(),r.time=e.readFloat4(),r.count=e.readInt4(),e.readInt4(),r.status=e.readInt4(),e.readInt4(),r.validCount=e.readByte(),e.readByte(),r},5:function(e){return{connection:e.readStringObj()}},6:function(e){return{id:e.readInt4(),startTime:e.readFloat4(),stopTime:e.readFloat4(),offset:e.readUInt8()}},7:function(e){return{id:e.readInt4(),uniqueKey:e.readStringObj(),key:e.readStringObj(),rawUnits:e.readStringObj(),controllerId:e.readInt4(),resourceIds:e.readSet(e.readInt4)}},8:function(e){return{trigger:e.readStringObj()}},9:function(e){return{id:e.readInt4(),name:e.readStringObj(),description:e.readStringObj(),sourceAddress:e.readStringObj(),bus:e.readStringObj(),strId:e.readStringObj(),idDetail:e.readStringObj(),disconnected:e.readByte()}},10:function(e){return{id:e.readInt4(),code:e.readStringObj(),controllerId:e.readInt4(),dtcId:e.readStringObj()}},11:function(e){return{noteTime:e.readFloat4(),noteDescription:e.readStringObj()}}},parseRecording=function(e,r){var t=FileStream(new DataView(e,0)),a=t.readString(4),n=t.readInt4();if("rec\0"!=a||7!=n)return void r(null);var d=t.length();t.seek(d-8);var i=t.readUInt8(),o=8;t.seek(o);try{var u={header:_parseHeader(t,i)}}catch(e){return void r(null)}r(u)},_parseFrames=function(e,r){for(var t=[];e.getPosition()<r-1;){var a=e.getPosition(),n=e.readInt4(),d=e.readInt4(),i=e.readFloat4(),o=e.readFloat4();e.readByte();var u=_parseDataBlocks(e,a+n-5),s={number:d,start:i,stop:o,dataBlocks:u},c=e.readInt4();if(n!=c)return null;t.push(s)}return t},_parseHeader=function(e,r){e.seek(r);var t=e.getPosition(),a=e.readInt4();return e.readByte(),_parseDataBlocks(e,t+a)},_parseDataBlocks=function(e,r){for(var t={};e.getPosition()<r;){for(var a=e.getPosition(),n=e.readInt4(),d=e.readByte(),i=[];e.getPosition()<a+n;)i.push(parseFunctions[d](e));t[dataTypes[d]]=i}if(t.dataPoints){var o={};_.each(t.dataPoints,function(e){o[e.id]=e}),t.dataPoints=o}if(t.dtcs){var u={};_.each(t.dtcs,function(e){u[e.id]=e}),t.dtcs=u}return t};exports.parseRecording=parseRecording;