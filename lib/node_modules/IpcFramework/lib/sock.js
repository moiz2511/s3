function Socket(){this.opts={},this.server=null,this.socks=[],this.settings={},this.set("hwm",1/0),this.set("identity",String(process.pid)),this.set("retry timeout",100),this.set("retry max timeout",5e3)}var Emitter=require("events").EventEmitter,Configurable=require("configurable"),debug=require("debug")("axon:sock"),Message=require("amp-message"),Parser=require("amp").Stream,url=require("url"),net=require("net"),fs=require("fs"),ignore=["ECONNREFUSED","ECONNRESET","ETIMEDOUT","EHOSTUNREACH","ENETUNREACH","ENETDOWN","EPIPE","ENOENT"];module.exports=Socket,Socket.prototype.__proto__=Emitter.prototype,Configurable(Socket.prototype),Socket.prototype.use=function(e){return e(this),this},Socket.prototype.pack=function(e){var t=new Message(e);return t.toBuffer()},Socket.prototype.closeSockets=function(){debug("closing %d connections",this.socks.length),this.socks.forEach(function(e){e.destroy()})},Socket.prototype.close=function(e){debug("closing"),this.closing=!0,this.closeSockets(),this.server&&this.closeServer(e)},Socket.prototype.closeServer=function(e){debug("closing server"),this.server.on("close",this.emit.bind(this,"close")),this.server.close(),e&&e()},Socket.prototype.address=function(){if(this.server){var e=this.server.address();return e.string="tcp://"+e.address+":"+e.port,e}},Socket.prototype.removeSocket=function(e){var t=this.socks.indexOf(e);~t&&(debug("remove socket %d",t),this.socks.splice(t,1))},Socket.prototype.addSocket=function(e){var t=new Parser,o=this.socks.push(e)-1;debug("add socket %d",o),e.pipe(t),t.on("data",this.onmessage(e))},Socket.prototype.handleErrors=function(e){var t=this;e.on("error",function(o){return debug("error %s",o.code||o.message),t.emit("socket error",o),t.removeSocket(e),~ignore.indexOf(o.code)?(debug("ignored %s",o.code),void t.emit("ignored error",o)):t.emit("error",o)})},Socket.prototype.onmessage=function(e){var t=this;return function(e){var o=new Message(e);t.emit.apply(t,["message"].concat(o.args))}},Socket.prototype.connect=function(e,t,o){var r=this;if("server"==this.type)throw new Error("cannot connect() after bind()");"function"==typeof t&&(o=t,t=void 0),"string"==typeof e?(e=url.parse(e),"unix:"==e.protocol?(t=o,o=void 0,e=e.pathname):(t=e.hostname||"0.0.0.0",e=parseInt(e.port,10))):t=t||"0.0.0.0";var n=r.get("retry max timeout"),s=new net.Socket;return s.setNoDelay(),this.type="client",e=e,this.handleErrors(s),s.on("close",function(){if(r.connected=!1,r.removeSocket(s),r.closing)return r.emit("close");var o=r.retry||r.get("retry timeout");setTimeout(function(){debug("attempting reconnect"),r.emit("reconnect attempt"),s.destroy(),r.connect(e,t),r.retry=Math.min(n,1.5*o)},o)}),s.on("connect",function(){debug("connect"),r.connected=!0,r.addSocket(s),r.retry=r.get("retry timeout"),r.emit("connect"),o&&o()}),debug("connect attempt %s:%s",t,e),s.connect(e,t),this},Socket.prototype.onconnect=function(e){var t=this,o=e.remoteAddress+":"+e.remotePort;debug("accept %s",o),this.addSocket(e),this.handleErrors(e),this.emit("connect",e),e.on("close",function(){debug("disconnect %s",o),t.emit("disconnect",e),t.removeSocket(e)})},Socket.prototype.bind=function(e,t,o){var r=this;if("client"==this.type)throw new Error("cannot bind() after connect()");"function"==typeof t&&(o=t,t=void 0);var n=!1;return"string"==typeof e?(e=url.parse(e),"unix:"==e.protocol?(t=o,o=void 0,e=e.pathname,n=!0):(t=e.hostname||"0.0.0.0",e=parseInt(e.port,10))):t=t||"0.0.0.0",this.type="server",this.server=net.createServer(this.onconnect.bind(this)),debug("bind %s:%s",t,e),this.server.on("listening",this.emit.bind(this,"bind")),n&&this.server.on("error",function(n){if("EADDRINUSE"==n.code){var s=new net.Socket;s.on("error",function(n){"ECONNREFUSED"==n.code&&(fs.unlink(e),r.server.listen(e,t,o))}),s.connect({path:e},function(){throw n})}}),this.server.listen(e,t,o),this};