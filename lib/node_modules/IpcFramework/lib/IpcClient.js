!function(){"use strict";var e=require("underscore"),t=require("events"),s=require("util"),n=require("./IpcSocket").IpcSocket,o=parseInt(process.env.npm_config_adl_ipc_port,10)||12345,i=function(){t.EventEmitter.call(this);var s=this;this._requests={},this._socket=new n,this._socket.connect(o,"127.0.0.1"),this._socket.on("error",function(e){}),this._socket.on("connect",function(){s.clientId=s._socket.socks[0].localPort}),this._socket.on("message",function(e,t){s.message(t)}),this.on("newListener",function(n,o){e.contains(["removeListener","newListener","*"],n)||0===t.EventEmitter.listenerCount(s,n)&&s._socket.send({message:"_channel:subscribe",subscribeMessage:n})}),this.on("removeListener",function(n,o){e.contains(["removeListener","newListener","*"],n)||0===t.EventEmitter.listenerCount(s,n)&&s._socket.send({message:"_channel:unsubscribe",subscribeMessage:n})}),this.on("_channel:reply",function(e){var t=s._requests[e.cookie];delete s._requests[e.cookie],t&&t(e.response)})};s.inherits(i,t.EventEmitter),i.prototype.message=function(e){var t=this;if(this.emit("*",e),"q"===e.type&&e.cookie&&"_channel:reply"!==e.message){var s=function(s){t._socket.send({type:"q",message:"_channel:reply",to:[e.from],data:{cookie:e.cookie,response:s}})};this.emit(e.message,e.data,s,e)}else this.emit(e.message,e.data,e)},i.prototype.register=function(e,t){this.request("_channel:name",{name:e},t||function(){})},i.prototype.request=function(t,s,n,o){n||o||(o=s,s=void 0),o||(o=n,n=void 0),n&&(n=[n]);var i=e.uniqueId();this._requests[i]=o;var c={type:"q",message:t,cookie:i,to:n,data:s};this._socket.send(c)},i.prototype.queue=function(t,s,n,o){n&&e.isFunction(n)&&(o=n,n=void 0),n&&n instanceof Array==!1&&(n=[n]);var i={type:"q",message:t,to:n,data:s};this._socket.send(i,o)},i.prototype.broadcast=function(t,s,n){!n&&e.isFunction(s)&&(n=s,s=void 0);var o={type:"p",message:t,data:s};this._socket.send(o,n)},i.prototype.disconnect=function(){this._socket.close()},exports.IpcClient=i}();