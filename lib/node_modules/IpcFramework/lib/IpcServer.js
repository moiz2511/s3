!function(){"use strict";var e=require("underscore"),s=require("events"),n=require("util"),t=require("./IpcSocket").IpcSocket,i=parseInt(process.env.npm_config_adl_ipc_port,10)||12345,o=e.map(require("./common.js").internalMessages,function(e){return"message:"+e}),r=function(){var s=this,n=new t,r={},c={},u={};n.bind(i,"127.0.0.1"),n.on("bind",function(){s.emit("listening")}),n.on("connect",function(e){s.emit("connection:connect",e),r[e.remotePort]=e}),n.on("disconnect",function(e){s.emit("connection:disconnect",e),delete r[e.remotePort]}),n.on("message",function(e,n){n.from||(n.from=e.remotePort),s.message(n,e),s.emit("message:data",e,n)});var a=function(){this.subscriptions=[],this.queue=[]},m=function(e){return c[e]=c[e]||new a},f=function(e){return r[e]||r[u[e]]},p=function(s,t,i){var o=e.filter(s.queue,function(s){return!s.to||e.contains(s.to,t.remotePort)||e.contains(s.to,i)}),r=e.map(o,function(s){n.send(s,t),s.to=e.without(s.to,t.remotePort,i);var o=e.isEmpty(s.to);return{done:o,message:s}});s.queue=e.reduce(r,function(s,n){return n.done===!0?e.without(s,n.message):s},s.queue)};this.broadcast=function(s,t){t||(t=s,s=void 0),s?e.each(s,function(e){n.send(t,e)}):n.send(t)},s.on("message:_channel:subscribe",function(s,t){var i=m(s.subscribeMessage);i.subscriptions.push(t),n.send({message:"_channel:subscribed",subscribeMessage:s.subscribeMessage},t);var o=e.find(e.keys(u),function(e){return u[e]===t.remotePort});p(i,t,o)}),s.on("message:_channel:unsubscribe",function(s,t){var i=m(s.subscribeMessage);i.subscriptions=e.without(i.subs,t),n.send({message:"_channel:unsubscribed",subscribeMessage:s.subscribeMessage},t)}),s.on("message:_channel:name",function(s,t){var i=!!u[s.data.name];i===!1&&(u[s.data.name]=t.remotePort),n.send({message:"_channel:reply",data:{cookie:s.cookie,response:!1}},t);var o=e.filter(c,function(s){return e.contains(s.subscriptions,t)});e.each(o,function(e){p(e,t,s.data.name)})}),s.on("message:_channel:disconnect",function(s,n){c=e.chain(c).map(function(s,t){return[t,{queue:s.queue,subscriptions:e.without(s.subscriptions,n)}]}).object().value(),delete r[n.remotePort],n.disconnect()}),s.on("message:*",function(t,i){if(!e.contains(o,t.message)){var r=m(t.message);r.subscriptions;if("p"===t.type)s.broadcast(r.subscriptions,t);else if(t.to){var c=e.inject(t.to,function(s,n){var t=f(n);return t&&e.contains(r.subscriptions,t)?s.present.push(t):s.missing.push(n),s},{present:[],missing:[]});e.isEmpty(c.missing)===!1&&(t.to=c.missing,r.queue.push(t)),s.broadcast(c.present,t)}else if(e.isEmpty(r.subscriptions))r.queue.push(t);else{var u=r.subscriptions.shift();r.subscriptions.push(u),n.send(t,u)}}}),this.message=function(e,n){s.emit("message:"+e.message,e,n),s.emit("message:*",e,n)},this.close=function(){n.on("close",function(){s.emit("close")}),n.closeServer()}};n.inherits(r,s.EventEmitter),exports.IpcServer=r}();