var fs=require("fs"),path=require("path"),util=require("util"),events=require("events"),_=require("underscore"),async=require("async"),TarReader=function(r,e,t){var n=this;n._tarFd=fs.openSync(e,"r"),n._indexFd=fs.openSync(t,"r"),n._readStreams=[],n._cachedBuffers=[],n._app=r,n.path=e;var a=0,i=function(){var r=new Buffer(8);return fs.readSync(n._indexFd,r,0,8,a),a+=8,r.toString("utf8")},o=function(){for(var r="";;){var e=new Buffer(1);if(fs.readSync(n._indexFd,e,0,1,a),a+=1,"\0"===e.toString())return r;r+=e.toString()}},f=function(){var r=new Buffer(8);return fs.readSync(n._indexFd,r,0,8,a),a+=8,combineTwoFourByteBuffers(r.slice(0,4),r.slice(4,8))},u=i();if("SA5Index"!==u)throw new Error("Invalid Index File. Starts with "+u+" instead of SA5Index.");n._topLevelName=o(),n._topLevelSize=f(),n._startPosition=a};util.inherits(TarReader,events.EventEmitter),TarReader.prototype.testTarReader=function(r){var e=this;fs.fstat(e._tarFd,function(e,t){r(e||!t?!1:!0)})},TarReader.prototype.getFileStreamFromTar=function(r){var e=this,t=e.getLocationObject(r);if(t){var n=fs.createReadStream(void 0,{fd:e._tarFd,start:t.offset,end:t.offset+t.size-1,autoClose:!1});e._readStreams.push(n);var a=function(){e._readStreams=_.without(e._readStreams,n),n.removeListener("end",a),n.removeListener("error",a),_.isEmpty(e._readStreams)&&e.emit("readStreamArrayEmpty")};return n.once("end",a),n.once("error",a),n}},TarReader.prototype.checkFileExistence=function(r){var e=this,t=e.getLocationObject(r);return!!t},TarReader.prototype.destroyWhenDone=function(r){var e=this,t=function(){async.each([e._tarFd,e._indexFd],function(r,t){fs.close(r,function(r){r&&0===r.errno&&(r=void 0),r&&e._app.error("Error closing tar or index file: ",r),t(r)})},function(e){r(e)})};_.isEmpty(e._readStreams)?t():e.once("readStreamArrayEmpty",t)},TarReader.prototype.getLocationObject=function(r){var e=this;try{var t=path.normalize(r.toUpperCase()).split(path.sep)}catch(r){return void e._app.error("Error creating path array: ",r)}var n=0;if(t[n]!==e._topLevelName)return void e._app.error("File Not Found In Tar: "+r);n+=1;try{return e._binarySearch(e._startPosition,e._indexFd,t,n,e._topLevelSize)}catch(r){e._app.error("Error performing binary search through index: ",r)}};var combineTwoFourByteBuffers=function(r,e){var t=e.readUInt32BE(0),n=r.readUInt32BE(0);return t+4294967296*n},determineEntryLength=function(r){return r+1+8+8};TarReader.prototype._binarySearch=function(r,e,t,n,a){var i=this,o=function(){var r=y.readUInt16BE(_);return _+=2,r},f=function(){var r=y.readUInt32BE(_);return _+=4,r},u=function(){var r=y.toString("utf8",_,_+1);return _+=1,r},c=function(){var r=y.toString("utf8",_,_+l).replace(/\0/g,"");return _+=l,r},s=function(){return p()},d=function(){return p()},p=function(){var r=combineTwoFourByteBuffers(y.slice(_,_+4),y.slice(_+4,_+8));return _+=8,r},v=function(){var r=u(),e=c(),t=d(),n=s();return{type:r,pathPiece:e,size:t,offset:n}},h=function(r,e){r<t[n]?g=e+1:E=e-1},y=new Buffer(a);fs.readSync(e,y,0,a,r);for(var _=0,l=o(),m=f(),S=determineEntryLength(l),F=_,g=0,E=m-1;E>=g;){var T=Math.floor((E+g)/2);_=F+T*S;var B=v(),x=B.type,b=B.pathPiece,w=B.size,L=B.offset;switch(x){case"f":if(n===t.length-1&&b===t[n])return{offset:L,size:w};if(E===g)return;h(b,T);break;case"d":if(n!==t.length-1&&b===t[n])return i._binarySearch(L,e,t,n+1,w);if(E===g)return;h(b,T);break;default:return void i._app.error("Invalid Entry Type: "+x+" at position "+F)}}},module.exports=TarReader;