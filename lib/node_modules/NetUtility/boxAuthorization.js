"use strict";var url=require("url"),uuid=require("uuid"),environment=require("Environment"),randomstring=require("randomstring"),querystring=require("querystring"),_=require("underscore"),crypto=require("crypto"),request=require("request"),CUSTOMER="CUSTOMER",DEALER="DEALER",messages={TOKEN_NOT_ACTIVE:{message:"Token not active.",messageCode:"TOKEN_NOT_ACTIVE"},UPDATE_TOKEN_FAILURE:{message:"Failed to update token.",messageCode:"UPDATE_TOKEN_FAILURE"},UPDATE_TOKEN_SUCCESS:{message:"Token updated successfully.",messageCode:"UPDATE_TOKEN_SUCCESS"},REQUEST_STATE_NOT_RECOGNIZED:{message:"Request state is not recognized.",messageCode:"REQUEST_STATE_NOT_RECOGNIZED"},UNABLE_TO_MAKE_REQUEST:{message:"Unable to make the request.",messageCode:"UNABLE_TO_MAKE_REQUEST"},UPDATE_USER_TYPE_FAILURE:{message:"Failed to update the user type.",messageCode:"UPDATE_USER_TYPE_FAILURE"},COMMON:{BOX_UNAUTHORIZED:{message:"The box is unauthorized.",messageCode:"BOX_UNAUTHORIZED"},UNACCEPTABLE_CONTENT_TYPE:{message:"The request content-type is not acceptable.",messageCode:"UNACCEPTABLE_CONTENT_TYPE"}},FULL_SYNC:{STARTED:{message:"Full sync has started.",messageCode:"FULL_SYNC_STARTED"},START_FAILED:{message:"Full sync has failed to start.",messageCode:"FULL_SYNC_START_FAILED"},IN_PROGRESS:{message:"A full sync is already in progress.",messageCode:"FULL_SYNC_IN_PROGRESS"}},QUICK_SYNC:{FAILED:{message:"Quick sync has failed.",messageCode:"QUICK_SYNC_FAILED"},START_FAILED:{message:"Quick sync has failed to start.",messageCode:"QUICK_SYNC_START_FAILED"},COMPLETED:{message:"Quick has completed.",messageCode:"QUICK_SYNC_COMPLETED"}}},errors={BOX_UNAUTHORIZED:"Box Unauthorized"},_requestState={},getPaths=function(e){return{redirect:environment.offlineLocation+"/box/services/box/authorize",authorize:"/oauth2/"+e.serverId+"/v1/authorize",introspect:"/oauth2/"+e.serverId+"/v1/introspect",token:"/oauth2/"+e.serverId+"/v1/token"}},getTenantOptions=function(e){return environment.oktaTenants.customer},getUrl=function(e,t,r){var s=url.parse(getTenantOptions(t).baseUrl),o={protocol:s.protocol,hostname:s.hostname,port:s.port,pathname:e};return r&&(o.search=querystring.stringify(r)),url.format(o)},validateToken=function(e,t,r,s){var o=e.refresh_token;introspectToken(o,t,r,function(e,t){e?s(messages.UNABLE_TO_MAKE_REQUEST):t.active?s(null,new Date(1e3*t.exp)):s(messages.TOKEN_NOT_ACTIVE)})},getToken=function(e,t,r,s){var o=getTenantOptions(t),n=getPaths(o),a=getUrl(n.token,t);r.postJson({url:a,headers:{"Content-Type":"application/x-www-form-urlencoded"},body:querystring.stringify({grant_type:"authorization_code",redirect_uri:n.redirect,code:e,code_verifier:_requestState.codeVerifier,client_id:o.clientId})},function(e,t,r){e?s(messages.UNABLE_TO_MAKE_REQUEST):200!=t.statusCode?s({messageCode:r.error,message:r.error_description}):s(null,r)})},introspectToken=function(e,t,r,s){var o=getTenantOptions(t),n=getPaths(o),a=getUrl(n.introspect,t);r.postJson({url:a,headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},body:querystring.stringify({token:e,client_id:o.clientId})},function(e,t,r){e?s(e,r):200!=t.statusCode?s({messageCode:r.error,message:r.error_description}):s(null,r)})},getRedirectUrl=function(e,t){var r=getTenantOptions(t),s=getPaths(r),o={response_type:"code",client_id:r.clientId,redirect_uri:s.redirect,scope:"openid offline_access",code_challenge_method:"S256"},n=e||"";_requestState.clientLocation=n,_requestState.state=n+"-"+uuid();var a=_.extend({state:_requestState.state,nonce:uuid(),code_challenge:getCodeChallenge()},o);return getUrl(s.authorize,t,a)},getCodeChallenge=function(){var e=crypto.createHash("sha256");_requestState.codeVerifier=randomstring.generate(43),e.update(_requestState.codeVerifier);var t=e.digest("base64");return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},getClientLocation=function(){return _requestState.clientLocation},verifyState=function(e,t){e!=_requestState.state?t(messages.REQUEST_STATE_NOT_RECOGNIZED):t()},refreshAccessToken=function(e,t,r){var s=getTenantOptions(t),o=getPaths(s),n={method:"POST",url:getUrl(o.token,t),headers:{"Content-Type":"application/x-www-form-urlencoded"},json:!0,form:{grant_type:"refresh_token",refresh_token:e,client_id:s.clientId}};request.post(n,function(e,t,s){r(e,s)})},makeAuthorizationError=function(e,t){var r=new Error(errors.BOX_UNAUTHORIZED),s=_.omit(t,"agent","json");return s.url=_.isObject(t.url)?url.format(t.url):t.url,r.options=s,r.statusCode=e,r},updateAuthorizationHeader=function(e,t){return t.headers=t.headers||{},t.headers.authorization="Bearer "+e,t};exports.errors=errors,exports.messages=messages,exports.validateToken=validateToken,exports.introspectToken=introspectToken,exports.getToken=getToken,exports.getRedirectUrl=getRedirectUrl,exports.getClientLocation=getClientLocation,exports.verifyState=verifyState,exports.refreshAccessToken=refreshAccessToken,exports.makeAuthorizationError=makeAuthorizationError,exports.updateAuthorizationHeader=updateAuthorizationHeader;