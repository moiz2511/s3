"use strict";var fs=require("fs"),events=require("events"),util=require("util"),http=require("http"),https=require("https"),_=require("underscore"),async=require("async"),url=require("url"),crypto=require("crypto"),path=require("path"),request=require("request"),environment=require("Environment"),downloadFile=require("./downloadFile.js").downloadFile,boxAuth=require("./boxAuthorization"),uploadStream=require("./uploadStream").uploadStream,HTTP_UNAUTHORIZED=401,NetworkContext=function(t,e){var o=this;this._registrationClient=t,o._httpsAgent=new https.Agent,o._httpAgent=new http.Agent;var n=crypto.createCredentials(),r=environment.certsDirectory,i=fs.readdirSync(r),a=_.map(i,function(t){return path.resolve(r,t)});_.each(a,function(t){n.context.addCACert(fs.readFileSync(t))});var s=o._httpsAgent.createConnection;o._httpsAgent.createConnection=function(t,e,o){var n=s(t,e,o);return n.setKeepAlive(!0),n};var u=o._httpAgent.createConnection;o._httpAgent.createConnection=function(t){var e=u(t);return e.setKeepAlive(!0),e},this._registrationClient.on("accessTokenChanged",function(t){o._accessToken=t||""}),this._registrationClient.on("authorizationStateChanged",function(t){o._authorizationState=t||""}),this._registrationClient.on("authorizationExpirationChanged",function(t){o._authorizationExpireTimestamp=t||""}),this._registrationClient.on("userTypeChanged",function(t){o._userType=t});var c=environment.legacyBms,h=environment.clientLocation,p=environment.serverLocation,l=environment.staticContent,f="/bms/",d="/bms/oauth/",v="/WebSA/Data/box/",g="/box/",A=url.resolve(c,f),C=url.resolve(h,v),m=url.resolve(p,d),k=url.resolve(l,g),y=url.parse(c),T=url.parse(h),w=url.parse(p),q=url.parse(l);this._updateLegacyUrls=function(t){if(_.isObject(t)&&t.hostname)return t=_.clone(t),t.hostname.toUpperCase()===y.hostname.toUpperCase()?(t.protocol=w.protocol,t.hostname=w.hostname,t.host=w.host,delete t.href,t.port=w.port,t.path=t.path.replace(/^\/*bms\//i,"/bms/oauth/")):t.hostname.toUpperCase()===T.hostname.toUpperCase()&&(t.protocol=q.protocol,t.hostname=q.hostname,t.host=q.host,delete t.href,t.port=q.port,t.path=t.path.replace(/^\/*WebSA\/Data\/box\//i,"/box/")),t;if(_.isString(t)){var e=t.replace(A,m);return e=e.replace(C,k)}return t},this._setAgent=function(t){switch(t=_.clone(t),t.url.protocol){case"http:":return t.agent=o._httpAgent,t;case"https:":return t.agent=o._httpsAgent,t;default:throw new Error("Invalid protocol: "+requestProtocol)}},async.series([function(t){o._registrationClient.getAccessToken(function(e){o._accessToken=e||"",t()})},function(t){o._registrationClient.getAuthorizationExpiration(function(e){o._authorizationExpireTimestamp=e||"",t()})},function(t){o._registrationClient.getAuthorizationState(function(e){o._authorizationState=e||"",t()})},function(t){o._registrationClient.getUserType(function(e){o._userType=e,t()})}],function(){e(o)})},clientSslInformation=function(){try{return{cert:fs.readFileSync(environment.ssl.client.certPath),key:fs.readFileSync(environment.ssl.client.keyPath),ca:_.map(environment.ssl.client.authorityChain,function(t){return fs.readFileSync(t)})}}catch(t){return{}}}();NetworkContext.prototype.getSslOptions=function(t){return _.defaults({},t,clientSslInformation)},NetworkContext.prototype.getNetworkOptions=function(t){var e=this;return boxAuth.updateAuthorizationHeader(e._accessToken,t)},NetworkContext.prototype.requestForProtocol=function(t,e){e=_.once(e);var o=this;t=o._updateLegacyUrls(t);var n=this._registrationClient,r=this.nativeRequest(t,function(r){return r.statusCode!==HTTP_UNAUTHORIZED?void e(null,r):void o.refreshAuthorization(function(r){if(r)return void n.setAuthorizationState(n.getUnauthorizedState(),function(){e(r)});t=boxAuth.updateAuthorizationHeader(o._accessToken,t);var i=o.nativeRequest(t,function(o){return o.statusCode!==HTTP_UNAUTHORIZED?void e(null,o):(r=boxAuth.makeAuthorizationError(o.statusCode,t),void n.setAuthorizationState(n.getUnauthorizedState(),function(){e(r)}))});i.on("error",function(t){e(t)}),i.end()})});r.on("error",function(t){e(t)}),r.end()},NetworkContext.prototype.nativeRequest=function(t,e){var o=this;switch(_.isObject(t.headers)&&!_.isEmpty(t.headers.authorization)||(t=o.getNetworkOptions(t)),t.protocol){case"http:":return t.agent=o._httpAgent,http.request(t,e);case"https:":return t.agent=o._httpsAgent,https.request(t,e);default:return new invalidRequestObject(t.protocol)}},NetworkContext.prototype.request=function(t,e){var o=this,n=[];return o.makeRequestWithRetry(t,function(t){n.push(t)},function(t,o,n){e(t,o,n)}),{abort:function(){_.invoke(n,"abort")}}},NetworkContext.prototype.makeRequestWithRetry=function(t,e,o){var n=this,r=this._registrationClient;if(t=_.clone(t),_.isString(t)&&(t={url:t}),t.uri&&(t.url=t.uri,delete t.uri),_.isString(t.url))try{t.url=url.parse(t.url)}catch(t){return void o(t)}t.url=n._updateLegacyUrls(t.url);var i=t.url.protocol;switch(i){case"http:":t.agent=n._httpAgent;break;case"https:":t.agent=n._httpsAgent;break;default:return void o(new Error("Invalid protocol: ",i))}var a=function(t,o){var n=request(t,function(e,n,i){if(n.statusCode!==HTTP_UNAUTHORIZED)o(e,n,i);else{var a=boxAuth.makeAuthorizationError(n.statusCode,t);r.setAuthorizationState(r.getUnauthorizedState(),function(){o(a)})}});e(n)},s=function(t,o){var i=request(t,function(e,i,s){e||i.statusCode!==HTTP_UNAUTHORIZED?o(e,i,s):n.refreshAuthorization(function(e){if(e)r.setAuthorizationState(r.getUnauthorizedState(),function(){o(e)});else{var i=boxAuth.updateAuthorizationHeader(n._accessToken,t);a(i,o)}})});e(i)};s(t,function(t,e,n){o(t,e,n)})},NetworkContext.prototype.uploadMultipartFormData=function(t,e){var o=this,n=t.formData;t.method="POST",o.makeRequestWithRetry(t,function(t){var e=t.form();_.each(n,function(t,o){var r=t.value();_.isEmpty(t.options)?e.append(o,r):e.append(o,r,n[o].options)})},function(t,o,n){e(t,o,n)})},NetworkContext.prototype.requestJson=function(t,e){return t=_.clone(t),t.json=t.json||!0,this.request(t,function(t,o,n){!t&&!_.isObject(n)&&o.statusCode>=200&&o.statusCode<300&&!_.isUndefined(n)&&(t=new Error("HTTP request did not return a valid JSON object"),t.code="INVALID_RESPONSE"),e(t,o,n)})},NetworkContext.prototype.requestWithTokenValidation=function(t,e){var o=this,n=o._registrationClient;if(o._authorizationState==n.getUnauthorizedState())return e(new Error("Revoking the request as BOX is not Authorized."));if(o.isAccessTokenValid())return o.requestJson(t,e);if(o.isRefreshTokenValid())return o.refreshAuthorization(function(n){var r=boxAuth.updateAuthorizationHeader(o._accessToken,t);o.requestJson(r,e)});var r=n.getUnauthorizedState();return void n.setAuthorizationState(r,function(){e(new Error("Revoking the request as authorization has expired."))})},NetworkContext.prototype.put=function(t,e){return t=_.clone(t),t.method="PUT",this.request(t,e)},NetworkContext.prototype.putJson=function(t,e){return t=_.clone(t),t.method="PUT",this.requestJson(t,e)},NetworkContext.prototype.post=function(t,e){return t=_.clone(t),t.method="POST",this.request(t,e)},NetworkContext.prototype.postJson=function(t,e){return t=_.clone(t),t.method="POST",this.requestJson(t,e)},NetworkContext.prototype.delete=function(t,e){return t=_.clone(t),t.method="DELETE",this.request(t,e)},NetworkContext.prototype.deleteJson=function(t,e){return t=_.clone(t),t.method="DELETE",this.requestJson(t,e)},NetworkContext.prototype.get=function(t,e){return t=_.clone(t),t.method="GET",this.request(t,e)},NetworkContext.prototype.getJson=function(t,e){return t=_.clone(t),t.method="GET",this.requestJson(t,e)},NetworkContext.prototype.stop=function(){var t=this;_.each(t._httpAgent.sockets,function(t){_.each(t,function(t){t.destroy()})}),_.each(t._httpsAgent.sockets,function(t){_.each(t,function(t){t.destroy()})})},NetworkContext.prototype.refreshAuthorization=function(t){var e=this._userType,o=this._registrationClient;async.waterfall([function(t){o.getRefreshToken(function(e){t(null,e)})},function(t,o){boxAuth.refreshAccessToken(t,e,function(t,e){o(t,e&&e.access_token)})},function(t,e){o.setAccessToken(t,function(){e()})}],function(e){t(e)})},NetworkContext.prototype.requestStream=function(t,e){var o=this,n=this._registrationClient;t.url=o._updateLegacyUrls(t.url);try{t=o._setAgent(t)}catch(t){return void e(t)}var r=request(t).on("response",function(i){return i.statusCode!==HTTP_UNAUTHORIZED?void e(null,r,i):void o.refreshAuthorization(function(r){if(r){var i=n.getUnauthorizedState();return void n.setAuthorizationState(i,function(){e(r)})}var a=boxAuth.updateAuthorizationHeader(o._accessToken,t),s=request(a).on("response",function(t){if(t.statusCode!==HTTP_UNAUTHORIZED)return void e(null,s,t);var o=boxAuth.makeAuthorizationError(t.statusCode,a),r=n.getUnauthorizedState();n.setAuthorizationState(r,function(){e(o)})});s.on("error",function(t){e(t)})})});r.on("error",function(t){e(t)})},NetworkContext.prototype.downloadFile=downloadFile,NetworkContext.prototype.uploadStream=uploadStream;var invalidRequestObject=function(t){var e=this;e.end=_.noop,_.defer(function(){e.emit("error",new Error("Invalid protocol: ",t))})};NetworkContext.prototype.isAccessTokenValid=function(){var t=this,e=t._accessToken.split(".")[1];if(e){var o=JSON.parse(new Buffer(e,"base64").toString("utf8"));if(new Date(1e3*o.exp)>new Date(Date.now()+3e5))return!0}return!1},NetworkContext.prototype.isRefreshTokenValid=function(){var t=this;return new Date(t._authorizationExpireTimestamp)>new Date},util.inherits(invalidRequestObject,events.EventEmitter),module.exports=NetworkContext;