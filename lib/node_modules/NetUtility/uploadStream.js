"use strict";var _=require("underscore"),async=require("async"),boxAuth=require("./boxAuthorization"),HTTP_UNAUTHORIZED=401,_pipeReadStream=function(e,t,n){var r=function(e){n(e)},o=t();o.on("error",r),e.on("error",r),o.pipe(e)},_retryRequest=function(e,t,n,r){var o=e._registrationClient,u=e.nativeRequest(n,function(e){if(e.statusCode!==HTTP_UNAUTHORIZED)return void r(null,e);var t=boxAuth.makeAuthorizationError(e.statusCode,n);o.setAuthorizationState(o.getUnauthorizedState(),function(){r(t)})});_pipeReadStream(u,t,r)},_refreshAuthorization=function(e,t,n){e.refreshAuthorization(function(r){return r?void n(r):(t=boxAuth.updateAuthorizationHeader(e._accessToken,t),void n(null,t))})},_remakeRequest=function(e,t,n,r){async.waterfall([function(t){_refreshAuthorization(e,n,function(e,n){t(e,n)})},function(n,r){_retryRequest(e,t,n,function(e,t){r(e,t)})}],function(e,t){r(e,t)})},_makeRequest=function(e,t,n,r){n=e._updateLegacyUrls(n);var o=e.nativeRequest(n,function(e){r(null,e)});_pipeReadStream(o,t,r)},uploadStream=function(e,t,n){var r=this;n=_.once(n),_makeRequest(r,e,t,function(o,u){o?n(o):u.statusCode===HTTP_UNAUTHORIZED?_remakeRequest(r,e,t,function(e,t){n(e,t)}):n(null,u)})};exports.uploadStream=uploadStream;