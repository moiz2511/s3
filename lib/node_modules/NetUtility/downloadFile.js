"use strict";function _getRequestOptions(e,r){var t={};return _.isString(e)?(t.method="GET",t.url=url.parse(e),t.headers={accepts:"application/octet-stream"}):t=e,t=r.getNetworkOptions(t)}var fs=require("fs"),crypto=require("crypto"),_=require("underscore"),url=require("url"),FileUtility=require("FileUtility"),Download=require("./models/Download"),CountingStream=require("FileUtility/CountingStream"),contentDispositionLib=require("content-disposition");module.exports.downloadFile=function(e,r,t,i){var o,n=new CountingStream({}),s=this;i=_.once(i);try{var a=_getRequestOptions(e,s)}catch(e){return void i(e)}return s.requestStream(a,function(e,s,u){if(e)return void i(e);if(200!==u.statusCode){var d=new Error("Error downloading file: Unexpected state code: "+u.statusCode);return d.options=a,d.statusCode=u.statusCode,void i(d)}if(!t){var l=u.headers["content-disposition"];l&&(t=contentDispositionLib.parse(l).parameters.filename)}if(!t)return void i(new Error("Error downloading file: Missing filename"));o.onResponse(u,s,t);var c=r+"/"+t,p=fs.createWriteStream(c),f=crypto.createHash("sha256");f.setEncoding("base64"),p.on("finish",function(){p.close(function(e){if(o.aborted)return FileUtility.deleteDirectoryOrFile(c,_.noop),void i(new Error("aborted"));var r=fs.createReadStream(c);r.on("error",function(e){FileUtility.deleteDirectoryOrFile(c,_.noop),i(e)}),r.on("end",function(r){f.end(),o.digest="sha-256="+f.read(),i(e,o)}),r.pipe(f)})}),p.on("error",function(e){FileUtility.deleteDirectoryOrFile(c,_.noop),i(e)}),u.pipe(n).pipe(p)}),o=new Download(n)};